[{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\accessibility\\a11y.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\api\\api-routes.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\api\\courses.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\components\\CourseCard.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\lib\\auth-hostile.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\lib\\card-validator.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\lib\\firestore.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\lib\\local-cache.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\lib\\logger.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\lib\\validation-schemas.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\performance\\performance.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\security\\auth-routes.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\security\\ddos-protection.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\__tests__\\seo\\seo.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\analytics\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\coupons\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\courses\\[id]\\edit\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\courses\\[id]\\edit\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'draggedComponentId' is assigned a value but never used.","line":116,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":116,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleDeleteLesson' is assigned a value but never used.","line":224,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":224,"endColumn":29}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'copiedComponent' is assigned a value but never used.","line":108,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":108,"endColumn":27,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setCopiedComponent' is assigned a value but never used.","line":108,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":108,"endColumn":47,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_saveTimeoutRef' is assigned a value but never used.","line":118,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":118,"endColumn":26,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Lesson, Course } from \"@/lib/types\";\r\nimport { Component } from \"@/lib/cms/types\";\r\nimport {\r\n    ChevronDown,\r\n    Eye,\r\n    Save,\r\n    ChevronLeft,\r\n    Plus,\r\n    GripVertical,\r\n    Trash2\r\n} from \"lucide-react\";\r\nimport { useState, useEffect, useRef, use } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { DragDropContext, Droppable, Draggable } from \"@hello-pangea/dnd\";\r\nimport { ComponentRenderer } from \"@/components/cms/ComponentRenderer\";\r\nimport { ComponentPalette } from \"@/components/cms/ComponentPalette\";\r\nimport { DesignControls } from \"@/components/cms/DesignControls\";\r\nimport { ContextMenu } from \"@/components/cms/ContextMenu\";\r\nimport { CourseSettings } from \"@/components/cms/CourseSettings\";\r\nimport { fetchCourse, updateCourse } from \"@/lib/api/courseApi\";\r\nimport { saveCourseMetadata } from \"@/lib/firebase/firestore\";\r\nimport { createComponent } from \"@/lib/cms/registry\";\r\n\r\n\r\nconst TopBar = ({\r\n    onSave,\r\n    isSaving,\r\n    onPreview,\r\n    isPreview,\r\n    activeView,\r\n    onViewChange,\r\n    isPublished\r\n}: {\r\n    onSave: () => void;\r\n    isSaving: boolean;\r\n    onPreview: () => void;\r\n    isPreview: boolean;\r\n    activeView: 'content' | 'settings';\r\n    onViewChange: (view: 'content' | 'settings') => void;\r\n    isPublished: boolean;\r\n}) => (\r\n    <header className=\"h-14 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between px-4 shrink-0\">\r\n        <div className=\"flex items-center space-x-3\">\r\n            <Link href=\"/courses\" className=\"text-zinc-500 hover:text-white transition-colors\">\r\n                <ChevronLeft size={20} />\r\n            </Link>\r\n            <div className=\"flex space-x-1 bg-zinc-900/50 p-1 rounded-lg border border-zinc-800/50\">\r\n                <button\r\n                    onClick={() => onViewChange('content')}\r\n                    className={`px-3 py-1 text-xs font-semibold rounded-md transition-colors ${activeView === 'content' ? 'bg-zinc-800 text-white shadow-sm border border-zinc-700' : 'text-zinc-500 hover:text-zinc-300'}`}\r\n                >\r\n                    Content\r\n                </button>\r\n                <button\r\n                    onClick={() => onViewChange('settings')}\r\n                    className={`px-3 py-1 text-xs font-semibold rounded-md transition-colors ${activeView === 'settings' ? 'bg-zinc-800 text-white shadow-sm border border-zinc-700' : 'text-zinc-500 hover:text-zinc-300'}`}\r\n                >\r\n                    Settings\r\n                </button>\r\n            </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center space-x-3\">\r\n            <span className=\"text-xs text-zinc-500 bg-zinc-900 px-2.5 py-1 rounded-full border border-zinc-800 hidden md:inline-block\">\r\n                {isSaving ? \"Saving...\" : \"Saved\"}\r\n            </span>\r\n\r\n            <button\r\n                onClick={onPreview}\r\n                className={`text-zinc-400 hover:text-white transition-colors p-1.5 rounded ${isPreview ? 'bg-indigo-500/10 text-indigo-400' : ''}`}\r\n                title=\"Toggle Preview\"\r\n            >\r\n                <Eye size={18} />\r\n            </button>\r\n\r\n            <button\r\n                onClick={onSave}\r\n                disabled={isSaving}\r\n                className={`flex items-center space-x-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-colors shadow-lg ${isPublished\r\n                    ? 'bg-green-600 hover:bg-green-500 text-white shadow-green-900/20'\r\n                    : 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-900/20'\r\n                    }`}\r\n            >\r\n                <Save size={14} />\r\n                <span>{isSaving ? 'Saving...' : isPublished ? 'Update' : 'Publish'}</span>\r\n            </button>\r\n\r\n            <div className=\"w-7 h-7 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-full border border-zinc-800\"></div>\r\n        </div>\r\n    </header>\r\n);\r\n\r\n// --- Main Page Component ---\r\n\r\nexport default function CourseEditorPage({ params }: { params: Promise<{ id: string }> }) {\r\n    const { id: courseId } = use(params);\r\n\r\n    const [course, setCourse] = useState<Course | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [lessons, setLessons] = useState<Lesson[]>([]);\r\n    const [editingIndex, setEditingIndex] = useState<number | null>(null);\r\n    const [selectedComponentId, setSelectedComponentId] = useState<string | null>(null);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [previewMode, setPreviewMode] = useState(false);\r\n    const [contextMenu, setContextMenu] = useState<{ x: number; y: number; componentId: string } | null>(null);\r\n    const [copiedComponent, setCopiedComponent] = useState<Component | null>(null); // eslint-disable-line @typescript-eslint/no-unused-vars\r\n    const [activeView, setActiveView] = useState<'content' | 'settings'>('content');\r\n    const [courseTitle, setCourseTitle] = useState('');\r\n    const [courseDescription, setCourseDescription] = useState('');\r\n    const [courseThumbnail, setCourseThumbnail] = useState('');\r\n    const [courseAuthor, setCourseAuthor] = useState('');\r\n    const [isPublished, setIsPublished] = useState(false);\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [draggedComponentId, setDraggedComponentId] = useState<string | null>(null);\r\n    // Reserved for future use - auto-save functionality\r\n    const _saveTimeoutRef = useRef<NodeJS.Timeout | null>(null); // eslint-disable-line @typescript-eslint/no-unused-vars\r\n    const idCounterRef = useRef(0);\r\n\r\n\r\n    // Load course from API\r\n    useEffect(() => {\r\n        fetchCourse(courseId).then(serverCourse => {\r\n            if (serverCourse) {\r\n                setCourse(serverCourse);\r\n                setLessons(serverCourse.lessons || []);\r\n                setCourseTitle(serverCourse.title);\r\n                setCourseDescription(serverCourse.description);\r\n                setCourseThumbnail(serverCourse.thumbnail || '');\r\n                setCourseAuthor(serverCourse.instructor || '');\r\n                setIsPublished(serverCourse.isPublished || false);\r\n\r\n                if (serverCourse.lessons && serverCourse.lessons.length > 0) {\r\n                    setEditingIndex(0);\r\n                }\r\n            }\r\n            setIsLoading(false);\r\n        }).catch(() => setIsLoading(false));\r\n    }, [courseId]);\r\n\r\n    if (isLoading) {\r\n        return <div className=\"flex items-center justify-center h-screen bg-zinc-950 text-zinc-500\">Loading...</div>;\r\n    }\r\n\r\n    if (!course) return <div className=\"text-zinc-500 p-10\">Course not found</div>;\r\n\r\n    const currentLesson = editingIndex !== null ? lessons[editingIndex] : null;\r\n    const components = currentLesson?.components || [];\r\n    const selectedComponent = components.find(c => c.id === selectedComponentId);\r\n\r\n    const handleSave = async () => {\r\n        setIsSaving(true);\r\n\r\n        const updatedCourse = {\r\n            ...course,\r\n            title: courseTitle,\r\n            description: courseDescription,\r\n            thumbnail: courseThumbnail,\r\n            instructor: courseAuthor,\r\n            lessons,\r\n            isPublished: true,\r\n            publishedAt: new Date().toISOString(),\r\n        };\r\n\r\n        // Publish to server\r\n        const success = await updateCourse(courseId, updatedCourse);\r\n\r\n        if (success) {\r\n            setIsPublished(true);\r\n            console.log('âœ… Course published');\r\n        } else {\r\n            console.error('âŒ Publish failed');\r\n        }\r\n\r\n        // Fire-and-forget Firebase sync\r\n        saveCourseMetadata({\r\n            courseId,\r\n            title: courseTitle,\r\n            description: courseDescription,\r\n            instructor: courseAuthor,\r\n            isPublished: true,\r\n            lessonsCount: lessons.length,\r\n            enrolledCount: course.enrolledCount || 0,\r\n            createdBy: \"admin\",\r\n        }).catch(() => {\r\n            // Intentional silent fail - metadata save is non-critical, main save already succeeded\r\n        });\r\n\r\n        setIsSaving(false);\r\n    };\r\n\r\n    const handleAddLesson = () => {\r\n        const newLesson: Lesson = {\r\n            id: `${courseId}-lesson-${lessons.length + 1}`,\r\n            title: `Lesson ${lessons.length + 1}`,\r\n            type: \"cms\",\r\n            duration: \"10 min\",\r\n            content: \"\",\r\n            order: lessons.length + 1,\r\n            components: [],\r\n        };\r\n        setLessons([...lessons, newLesson]);\r\n        setEditingIndex(lessons.length);\r\n    };\r\n\r\n    const handleUpdateLesson = async (index: number, updates: Partial<Lesson>) => {\r\n        setIsSaving(true); // Show saving state\r\n        const updated = [...lessons];\r\n        updated[index] = { ...updated[index], ...updates };\r\n        setLessons(updated);\r\n\r\n        const updatedCourse = {\r\n            ...course,\r\n            title: courseTitle,\r\n            description: courseDescription,\r\n            lessons: updated,\r\n        };\r\n\r\n        await updateCourse(courseId, updatedCourse);\r\n        setIsSaving(false); // Hide saving state\r\n    };\r\n\r\n    const handleDeleteLesson = (index: number) => {\r\n        if (confirm(\"Delete this lesson?\")) {\r\n            const newLessons = lessons.filter((_, i) => i !== index);\r\n            setLessons(newLessons);\r\n            setEditingIndex(newLessons.length > 0 ? 0 : null);\r\n\r\n            // Trigger save\r\n            const updatedCourse = {\r\n                ...course,\r\n                title: courseTitle,\r\n                description: courseDescription,\r\n                lessons: newLessons,\r\n            };\r\n            updateCourse(courseId, updatedCourse);\r\n        }\r\n    };\r\n\r\n    const handleAddComponent = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const newComponents = [...components, component];\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setSelectedComponentId(component.id);\r\n    };\r\n\r\n    const handleUpdateComponent = (updatedComponent: Component) => {\r\n        if (editingIndex === null) return;\r\n        const newComponents = components.map(c =>\r\n            c.id === updatedComponent.id ? updatedComponent : c\r\n        );\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n    };\r\n\r\n    const handleDeleteComponent = () => {\r\n        if (editingIndex === null || !selectedComponentId) return;\r\n        const newComponents = components.filter(c => c.id !== selectedComponentId);\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setSelectedComponentId(null);\r\n    };\r\n\r\n    // Context menu handlers\r\n    const handleDuplicateComponent = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        idCounterRef.current += 1;\r\n        const newComponent = { ...component, id: `${component.type}-dup-${idCounterRef.current}` };\r\n        const index = components.findIndex(c => c.id === component.id);\r\n        const newComponents = [...components];\r\n        newComponents.splice(index + 1, 0, newComponent);\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleDeleteFromContextMenu = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const newComponents = components.filter(c => c.id !== component.id);\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleMoveComponentUp = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const index = components.findIndex(c => c.id === component.id);\r\n        if (index <= 0) return;\r\n        const newComponents = [...components];\r\n        [newComponents[index - 1], newComponents[index]] = [newComponents[index], newComponents[index - 1]];\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleMoveComponentDown = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const index = components.findIndex(c => c.id === component.id);\r\n        if (index >= components.length - 1) return;\r\n        const newComponents = [...components];\r\n        [newComponents[index], newComponents[index + 1]] = [newComponents[index + 1], newComponents[index]];\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleCopyComponent = (component: Component) => {\r\n        navigator.clipboard.writeText(JSON.stringify(component, null, 2));\r\n        setContextMenu(null);\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-screen bg-zinc-950 text-gray-300 font-sans antialiased overflow-hidden selection:bg-indigo-500/30 selection:text-indigo-200\">\r\n            <style>{`\r\n                .custom-scrollbar::-webkit-scrollbar { width: 5px; }\r\n                .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }\r\n                .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 20px; }\r\n                .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #52525b; }\r\n            `}</style>\r\n\r\n            <TopBar\r\n                onSave={handleSave}\r\n                isSaving={isSaving}\r\n                onPreview={() => setPreviewMode(!previewMode)}\r\n                isPreview={previewMode}\r\n                activeView={activeView}\r\n                onViewChange={setActiveView}\r\n                isPublished={isPublished}\r\n            />\r\n\r\n            <div className=\"flex-1 flex overflow-hidden\">\r\n                <main\r\n                    className=\"flex-1 overflow-y-auto bg-zinc-900/30 custom-scrollbar p-0\"\r\n                    onClick={(e) => {\r\n                        // Deselect if clicking on blank area (not a component)\r\n                        if (!(e.target as HTMLElement).closest('[data-component-wrapper]')) {\r\n                            setSelectedComponentId(null);\r\n                        }\r\n                    }}\r\n                    onContextMenu={(e) => {\r\n                        // Always prevent browser context menu in editor\r\n                        e.preventDefault();\r\n                    }}\r\n                >\r\n                    {activeView === 'content' ? (\r\n                        <div\r\n                            className=\"max-w-5xl mx-auto\"\r\n                            onDragOver={(e) => {\r\n                                e.preventDefault();\r\n                                e.dataTransfer.dropEffect = 'copy';\r\n                            }}\r\n                            onDrop={(e) => {\r\n                                e.preventDefault();\r\n                                const componentType = e.dataTransfer.getData('componentType');\r\n                                if (componentType && editingIndex !== null) {\r\n                                    const newComponent = createComponent(componentType);\r\n                                    handleAddComponent(newComponent);\r\n                                }\r\n                            }}\r\n                        >\r\n                            {/* Lesson Header */}\r\n                            {currentLesson && (\r\n                                <div className=\"flex items-center justify-between mb-4 pb-3 border-b border-zinc-800/50\">\r\n                                    <div className=\"flex-1\">\r\n                                        <div className=\"flex items-center space-x-2 text-zinc-500 text-xs mb-1.5\">\r\n                                            <span className=\"text-zinc-600\">{course.title}</span>\r\n                                            <ChevronDown size={10} className=\"-rotate-90\" />\r\n                                            <span className=\"text-indigo-400\">{currentLesson.title}</span>\r\n                                        </div>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={currentLesson.title}\r\n                                            onChange={(e) => {\r\n                                                const updated = [...lessons];\r\n                                                updated[editingIndex!] = { ...updated[editingIndex!], title: e.target.value };\r\n                                                setLessons(updated);\r\n                                            }}\r\n                                            onBlur={() => handleUpdateLesson(editingIndex!, { title: currentLesson.title })}\r\n                                            className=\"text-xl font-bold text-white tracking-tight bg-transparent border-none focus:outline-none focus:ring-0 placeholder-zinc-700 w-full\"\r\n                                            placeholder=\"Lesson Title\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2 ml-4\">\r\n                                        <select\r\n                                            className=\"bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500\"\r\n                                            value={editingIndex ?? \"\"}\r\n                                            onChange={(e) => {\r\n                                                setEditingIndex(Number(e.target.value));\r\n                                                setSelectedComponentId(null);\r\n                                            }}\r\n                                        >\r\n                                            {lessons.map((l, idx) => (\r\n                                                <option key={l.id} value={idx}>{l.title}</option>\r\n                                            ))}\r\n                                        </select>\r\n                                        <button onClick={handleAddLesson} className=\"p-1 bg-zinc-800 hover:bg-zinc-700 rounded-md text-zinc-400 hover:text-white transition-colors\">\r\n                                            <Plus size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Components Canvas */}\r\n                            <div className=\"space-y-4\">\r\n                                {components.length === 0 ? (\r\n                                    <div\r\n                                        className=\"flex flex-col items-center justify-center py-16 border-2 border-dashed border-zinc-800 rounded-lg bg-zinc-900/20 cursor-context-menu\"\r\n                                        onContextMenu={(e) => {\r\n                                            if (!previewMode) {\r\n                                                e.preventDefault();\r\n                                                document.querySelector<HTMLButtonElement>('[data-add-block-btn]')?.click();\r\n                                            }\r\n                                        }}\r\n                                    >\r\n                                        <p className=\"text-zinc-500 mb-3 text-sm\">Start building your lesson</p>\r\n                                        <p className=\"text-zinc-600 text-xs mb-3\">Right-click or use button below to add components</p>\r\n                                        <ComponentPalette onAddComponent={handleAddComponent} />\r\n                                    </div>\r\n                                ) : (\r\n                                    <DragDropContext\r\n                                        onDragStart={(start) => {\r\n                                            setIsDragging(true);\r\n                                            setDraggedComponentId(start.draggableId);\r\n                                        }}\r\n                                        onDragEnd={(result) => {\r\n                                            setIsDragging(false);\r\n                                            setDraggedComponentId(null);\r\n\r\n                                            // Check if dropped in trash zone\r\n                                            if (result.destination?.droppableId === 'trash') {\r\n                                                if (editingIndex === null) return;\r\n                                                const newComponents = components.filter(c => c.id !== result.draggableId);\r\n                                                handleUpdateLesson(editingIndex, { components: newComponents });\r\n                                                setSelectedComponentId(null);\r\n                                                return;\r\n                                            }\r\n\r\n                                            if (!result.destination || editingIndex === null) return;\r\n                                            const newComponents = Array.from(components);\r\n                                            const [removed] = newComponents.splice(result.source.index, 1);\r\n                                            newComponents.splice(result.destination.index, 0, removed);\r\n                                            handleUpdateLesson(editingIndex, { components: newComponents });\r\n                                        }}>\r\n                                        <Droppable droppableId=\"components\">\r\n                                            {(provided) => (\r\n                                                <div ref={provided.innerRef} {...provided.droppableProps} className=\"space-y-4\">\r\n                                                    {components.map((component, index) => (\r\n                                                        <Draggable key={component.id} draggableId={component.id} index={index}>\r\n                                                            {(dragProvided, snapshot) => (\r\n                                                                <div\r\n                                                                    ref={dragProvided.innerRef}\r\n                                                                    {...dragProvided.draggableProps}\r\n                                                                    className={`group relative flex items-center gap-2 ${snapshot.isDragging ? 'opacity-75 z-50' : ''}`}\r\n                                                                >\r\n                                                                    {/* VISIBLE Drag Handle */}\r\n                                                                    <div\r\n                                                                        {...dragProvided.dragHandleProps}\r\n                                                                        className=\"p-2 bg-zinc-800 border border-zinc-700 rounded-lg text-zinc-400 hover:text-white hover:bg-zinc-700 cursor-grab active:cursor-grabbing transition-all shrink-0 flex items-center justify-center\"\r\n                                                                        title=\"Drag to reorder or drop in trash\"\r\n                                                                    >\r\n                                                                        <GripVertical size={20} />\r\n                                                                    </div>\r\n                                                                    <div\r\n                                                                        className=\"flex-1 min-w-0\"\r\n                                                                        data-component-wrapper\r\n                                                                        onContextMenu={(e) => {\r\n                                                                            e.preventDefault();\r\n                                                                            e.stopPropagation();\r\n                                                                            console.log('ðŸŽ¯ Context menu triggered for:', component.id);\r\n                                                                            setSelectedComponentId(component.id);\r\n                                                                            setContextMenu({ x: e.clientX, y: e.clientY, componentId: component.id });\r\n                                                                        }}\r\n                                                                    >\r\n                                                                        <ComponentRenderer\r\n                                                                            component={component}\r\n                                                                            isEditing={!previewMode}\r\n                                                                            isSelected={selectedComponentId === component.id}\r\n                                                                            onUpdate={handleUpdateComponent}\r\n                                                                            onSelect={() => setSelectedComponentId(component.id)}\r\n                                                                        />\r\n                                                                    </div>\r\n                                                                </div>\r\n                                                            )}\r\n                                                        </Draggable>\r\n                                                    ))}\r\n                                                    {provided.placeholder}\r\n                                                </div>\r\n                                            )}\r\n                                        </Droppable>\r\n\r\n                                        {/* Trash Zone - fixed overlay during drag */}\r\n                                        <Droppable droppableId=\"trash\">\r\n                                            {(trashProvided, trashSnapshot) => (\r\n                                                <div\r\n                                                    ref={trashProvided.innerRef}\r\n                                                    {...trashProvided.droppableProps}\r\n                                                    className={`fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 rounded-xl border-2 border-dashed transition-all z-[100] flex items-center gap-3 ${!isDragging ? 'opacity-0 pointer-events-none scale-90' : 'opacity-100 scale-100'\r\n                                                        } ${trashSnapshot.isDraggingOver\r\n                                                            ? 'bg-red-500/40 border-red-500 scale-110'\r\n                                                            : 'bg-zinc-900/95 border-zinc-500 backdrop-blur-md shadow-2xl'\r\n                                                        }`}\r\n                                                >\r\n                                                    <Trash2 size={24} className={trashSnapshot.isDraggingOver ? 'text-red-400' : 'text-zinc-300'} />\r\n                                                    <span className={`text-sm font-semibold ${trashSnapshot.isDraggingOver ? 'text-red-300' : 'text-zinc-300'}`}>\r\n                                                        {trashSnapshot.isDraggingOver ? 'Release to delete!' : 'Drop here to delete'}\r\n                                                    </span>\r\n                                                    <div style={{ display: 'none' }}>{trashProvided.placeholder}</div>\r\n                                                </div>\r\n                                            )}\r\n                                        </Droppable>\r\n                                    </DragDropContext>\r\n                                )}\r\n\r\n                                {!previewMode && components.length > 0 && (\r\n                                    <div className=\"mt-4 pt-4 border-t border-zinc-800/50 flex justify-center\">\r\n                                        <ComponentPalette onAddComponent={handleAddComponent} />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <CourseSettings\r\n                            courseTitle={courseTitle}\r\n                            courseDescription={courseDescription}\r\n                            courseThumbnail={courseThumbnail}\r\n                            courseAuthor={courseAuthor}\r\n                            onTitleChange={setCourseTitle}\r\n                            onDescriptionChange={setCourseDescription}\r\n                            onThumbnailChange={setCourseThumbnail}\r\n                            onAuthorChange={setCourseAuthor}\r\n                            createdAt={course.createdAt}\r\n                            lastModified={new Date().toISOString()}\r\n                            isPublished={isPublished}\r\n                        />\r\n                    )}\r\n                </main>\r\n\r\n                {/* Right Panel */}\r\n                <aside className=\"w-80 shrink-0\">\r\n                    <DesignControls\r\n                        component={selectedComponent || null}\r\n                        onUpdate={handleUpdateComponent}\r\n                        onDelete={handleDeleteComponent}\r\n                        onAddComponent={handleAddComponent}\r\n                    />\r\n                </aside>\r\n            </div>\r\n\r\n            {/* Context Menu */}\r\n            {contextMenu && (() => {\r\n                const component = components.find(c => c.id === contextMenu.componentId) || null;\r\n                return (\r\n                    <ContextMenu\r\n                        x={contextMenu.x}\r\n                        y={contextMenu.y}\r\n                        component={component}\r\n                        onClose={() => setContextMenu(null)}\r\n                        onDuplicate={() => component && handleDuplicateComponent(component)}\r\n                        onDelete={() => component && handleDeleteFromContextMenu(component)}\r\n                        onMoveUp={() => component && handleMoveComponentUp(component)}\r\n                        onMoveDown={() => component && handleMoveComponentDown(component)}\r\n                        onCopy={() => component && handleCopyComponent(component)}\r\n                        canMoveUp={components.findIndex(c => c.id === contextMenu.componentId) > 0}\r\n                        canMoveDown={components.findIndex(c => c.id === contextMenu.componentId) < components.length - 1}\r\n                    />\r\n                );\r\n            })()}\r\n        </div>\r\n    );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\courses\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[636,639],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[636,639],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":155,"column":41,"nodeType":"JSXOpeningElement","endLine":159,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Plus, Edit, Trash2, BookOpen, Loader2 } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRequireAdmin } from \"@/hooks/useRequireAdmin\";\r\nimport { SimpleModal } from \"@/components/ui/SimpleModal\";\r\n\r\nexport default function CoursesManagementPage() {\r\n    const router = useRouter();\r\n    const { isAdmin, isLoading: authLoading } = useRequireAdmin();\r\n    const [isCreating, setIsCreating] = useState(false);\r\n    const [courses, setCourses] = useState<any[]>([]);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [deleteId, setDeleteId] = useState<string | null>(null);\r\n    const [isDeleting, setIsDeleting] = useState(false);\r\n\r\n    const handleDeleteConfirm = async () => {\r\n        if (!deleteId) return;\r\n        setIsDeleting(true);\r\n        try {\r\n            const res = await fetch(`/api/courses?id=${deleteId}`, { method: 'DELETE' });\r\n            if (!res.ok) throw new Error('Failed to delete');\r\n\r\n            // Remove from state immediately\r\n            setCourses(prev => prev.filter(c => c.id !== deleteId));\r\n            setDeleteId(null);\r\n        } catch (error) {\r\n            console.error('Delete failed:', error);\r\n            alert('Failed to delete course');\r\n        } finally {\r\n            setIsDeleting(false);\r\n        }\r\n    };\r\n\r\n    // Load courses from API - MUST be before any early returns!\r\n    useEffect(() => {\r\n        if (!isAdmin) return; // Don't fetch if not admin yet\r\n\r\n        fetch('/api/courses', { cache: 'no-store' })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                // DEFENSIVE: Ensure data is an array\r\n                setCourses(Array.isArray(data) ? data : []);\r\n                setIsLoading(false);\r\n            })\r\n            .catch(err => {\r\n                console.error('Failed to load courses:', err);\r\n                setCourses([]); // Ensure state is always an array\r\n                setIsLoading(false);\r\n            });\r\n    }, [isAdmin]);\r\n\r\n    // Show loading while checking auth - AFTER all hooks\r\n    if (authLoading || !isAdmin) {\r\n        return (\r\n            <div className=\"flex items-center justify-center min-h-screen bg-neutral-50 dark:bg-neutral-950\">\r\n                <Loader2 className=\"w-8 h-8 animate-spin text-blue-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const handleCreateCourse = async () => {\r\n        setIsCreating(true);\r\n        try {\r\n            const response = await fetch('/api/courses', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    title: 'Untitled Course',\r\n                    description: 'Start building your course...',\r\n                }),\r\n            });\r\n\r\n            if (!response.ok) throw new Error('Failed to create course');\r\n\r\n            const { id } = await response.json();\r\n            router.push(`/editor/${id}`);\r\n        } catch (error) {\r\n            console.error('Creation failed:', error);\r\n            alert('Failed to create course');\r\n            setIsCreating(false);\r\n        }\r\n    };\r\n\r\n    if (isLoading) {\r\n        return <div className=\"flex items-center justify-center h-screen text-neutral-500\">Loading courses...</div>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6 p-6\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-bold text-neutral-900 dark:text-white\">Content Management</h1>\r\n                    <p className=\"text-neutral-600 dark:text-neutral-400 mt-1\">Manage all courses and content</p>\r\n                </div>\r\n                <Button\r\n                    onClick={handleCreateCourse}\r\n                    disabled={isCreating}\r\n                    className=\"bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50\"\r\n                >\r\n                    <Plus className=\"w-4 h-4 mr-2\" />\r\n                    {isCreating ? 'Creating...' : 'Add Course'}\r\n                </Button>\r\n            </div>\r\n\r\n            {/* Stats */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                <div className=\"p-4 bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl\">\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Total Courses</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">{courses.length}</p>\r\n                </div>\r\n                <div className=\"p-4 bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl\">\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Published</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">{courses.filter(c => c.isPublished).length}</p>\r\n                </div>\r\n                <div className=\"p-4 bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl\">\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Total Lessons</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">\r\n                        {courses.reduce((sum, c) => sum + (c.lessons?.length || 0), 0)}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Courses Table */}\r\n            <div className=\"bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl overflow-hidden\">\r\n                <table className=\"w-full\">\r\n                    <thead className=\"bg-neutral-50 dark:bg-neutral-900/50 border-b border-neutral-200 dark:border-neutral-800\">\r\n                        <tr>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase\">\r\n                                Course\r\n                            </th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase\">\r\n                                Category\r\n                            </th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase\">\r\n                                Lessons\r\n                            </th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase\">\r\n                                Level\r\n                            </th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase\">\r\n                                Actions\r\n                            </th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"divide-y divide-neutral-100 dark:divide-neutral-800\">\r\n                        {courses.map((course) => (\r\n                            <tr key={course.id} className=\"hover:bg-neutral-50 dark:hover:bg-neutral-800/30 transition-colors\">\r\n                                <td className=\"px-6 py-4\">\r\n                                    <div className=\"flex items-center gap-3 min-w-0\">\r\n                                        <img\r\n                                            src={course.thumbnail}\r\n                                            alt={course.title}\r\n                                            className=\"w-12 h-12 rounded-lg object-cover flex-shrink-0\"\r\n                                        />\r\n                                        <div className=\"min-w-0\">\r\n                                            <p className=\"text-sm font-medium text-neutral-900 dark:text-white truncate max-w-[200px]\">{course.title}</p>\r\n                                            <p className=\"text-xs text-neutral-500 dark:text-neutral-400 truncate\">{course.instructor}</p>\r\n                                        </div>\r\n                                    </div>\r\n                                </td>\r\n                                <td className=\"px-6 py-4\">\r\n                                    <span className=\"text-sm text-neutral-700 dark:text-neutral-300\">{course.category}</span>\r\n                                </td>\r\n                                <td className=\"px-6 py-4\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <BookOpen className=\"w-4 h-4 text-neutral-500 dark:text-neutral-400\" />\r\n                                        <span className=\"text-sm text-neutral-900 dark:text-white\">{course.lessons.length}</span>\r\n                                    </div>\r\n                                </td>\r\n                                <td className=\"px-6 py-4\">\r\n                                    <span\r\n                                        className={`px-2 py-1 rounded text-xs font-medium ${course.level === \"Beginner\"\r\n                                            ? \"bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400\"\r\n                                            : course.level === \"Intermediate\"\r\n                                                ? \"bg-amber-100 dark:bg-amber-500/20 text-amber-700 dark:text-amber-400\"\r\n                                                : \"bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400\"\r\n                                            }`}\r\n                                    >\r\n                                        {course.level}\r\n                                    </span>\r\n                                </td>\r\n                                <td className=\"px-6 py-4\">\r\n                                    <div className=\"flex items-center justify-end gap-2\">\r\n                                        <Link href={`/editor/${course.id}`}>\r\n                                            <button className=\"p-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors\">\r\n                                                <Edit className=\"w-4 h-4\" />\r\n                                            </button>\r\n                                        </Link>\r\n                                        <button\r\n                                            onClick={() => setDeleteId(course.id)}\r\n                                            className=\"p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 transition-colors\"\r\n                                        >\r\n                                            <Trash2 className=\"w-4 h-4\" />\r\n                                        </button>\r\n                                    </div>\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n\r\n            <SimpleModal\r\n                isOpen={!!deleteId}\r\n                onClose={() => setDeleteId(null)}\r\n                onConfirm={handleDeleteConfirm}\r\n                title=\"Delete Course?\"\r\n                description=\"This action cannot be undone. This will permanently delete the course and all its lessons.\"\r\n                isDestructive\r\n                isLoading={isDeleting}\r\n            />\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\dashboard\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":407,"column":33,"nodeType":"JSXOpeningElement","endLine":411,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { Course } from \"@/lib/types\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Users, BookOpen, TrendingUp, DollarSign, Eye, Edit, Trash2, Settings, Zap, CreditCard, Cloud } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { useState, useEffect } from \"react\";\r\n\r\ninterface FeatureFlags {\r\n    subscriptionsEnabled: boolean;\r\n    aiEnabled: boolean;\r\n    freeCoursesMode: boolean;\r\n    disableRateLimits: boolean;\r\n    aiUnlimitedMode: boolean;\r\n    aiUnlockUntil?: string;\r\n    aiWhitelist: string[];\r\n    updatedAt: string;\r\n    updatedBy?: string;\r\n}\r\n\r\ninterface DashboardStats {\r\n    totalUsers: number;\r\n    activeCourses: number;\r\n    totalRevenue: number;\r\n    avgCompletion: number;\r\n}\r\n\r\ninterface RecentUser {\r\n    id: string;\r\n    name: string;\r\n    email: string;\r\n    enrolledCourses?: string[];\r\n    createdAt?: string;\r\n}\r\n\r\nexport default function AdminDashboard() {\r\n    const { user } = useAuth();\r\n    const [courses, setCourses] = useState<Course[]>([]);\r\n    const [stats, setStats] = useState<DashboardStats | null>(null);\r\n    const [recentUsers, setRecentUsers] = useState<RecentUser[]>([]);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [features, setFeatures] = useState<FeatureFlags | null>(null);\r\n    const [isTogglingFeature, setIsTogglingFeature] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const fetchDashboardData = async () => {\r\n            try {\r\n                // Fetch all data in parallel for faster loading\r\n                const [coursesRes, statsRes, usersRes, featuresRes] = await Promise.all([\r\n                    fetch('/api/courses', { cache: 'no-store' }),\r\n                    fetch('/api/admin/dashboard'),\r\n                    fetch('/api/admin/users?limit=5&page=1'),\r\n                    fetch('/api/admin/features'),\r\n                ]);\r\n\r\n                // Process courses\r\n                if (coursesRes.ok) {\r\n                    const coursesData = await coursesRes.json();\r\n                    setCourses(Array.isArray(coursesData) ? coursesData : []);\r\n                }\r\n\r\n                // Process stats\r\n                if (statsRes.ok) {\r\n                    const statsData = await statsRes.json();\r\n                    setStats(statsData);\r\n                }\r\n\r\n                // Process users\r\n                if (usersRes.ok) {\r\n                    const usersData = await usersRes.json();\r\n                    setRecentUsers(usersData.users || []);\r\n                }\r\n\r\n                // Process feature flags\r\n                if (featuresRes.ok) {\r\n                    const featuresData = await featuresRes.json();\r\n                    setFeatures(featuresData);\r\n                }\r\n            } catch (error) {\r\n                console.error('Failed to fetch dashboard data:', error);\r\n            } finally {\r\n                setIsLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchDashboardData();\r\n    }, []);\r\n\r\n    // Toggle feature handler\r\n    const handleToggleFeature = async (feature: 'subscriptionsEnabled' | 'aiEnabled' | 'freeCoursesMode' | 'disableRateLimits' | 'aiUnlimitedMode') => {\r\n        if (!features || isTogglingFeature) return;\r\n\r\n        setIsTogglingFeature(feature);\r\n        try {\r\n            const res = await fetch('/api/admin/features', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ [feature]: !features[feature] }),\r\n            });\r\n\r\n            if (res.ok) {\r\n                const data = await res.json();\r\n                setFeatures(data.flags);\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to toggle feature:', error);\r\n        } finally {\r\n            setIsTogglingFeature(null);\r\n        }\r\n    };\r\n\r\n    if (!user || user.role !== \"admin\") {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-[50vh]\">\r\n                <div className=\"text-neutral-400\">Access denied. Admin only.</div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (isLoading) {\r\n        return <div className=\"text-neutral-400\">Loading dashboard...</div>;\r\n    }\r\n\r\n    // Format date helper - with NaN protection\r\n    const formatJoinedDate = (dateString?: string) => {\r\n        if (!dateString) return 'Recently';\r\n        const date = new Date(dateString);\r\n        if (isNaN(date.getTime())) return 'Recently';\r\n\r\n        const now = new Date();\r\n        const diffMs = now.getTime() - date.getTime();\r\n        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\r\n\r\n        if (diffDays === 0) return 'Today';\r\n        if (diffDays === 1) return '1 day ago';\r\n        if (diffDays < 7) return `${diffDays} days ago`;\r\n        if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;\r\n        const months = Math.floor(diffDays / 30);\r\n        if (months === 0) return 'Recently';\r\n        return `${months} month${months > 1 ? 's' : ''} ago`;\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-8\">\r\n            {/* Header */}\r\n            <div className=\"animate-in fade-in slide-in-from-top-4 duration-500\">\r\n                <h1 className=\"text-3xl font-bold text-neutral-900 dark:text-white\">Admin Dashboard</h1>\r\n                <p className=\"text-neutral-600 dark:text-neutral-400 mt-1\">Platform overview and management</p>\r\n            </div>\r\n\r\n            {/* Feature Toggles - Admin Controls */}\r\n            {features && (\r\n                <Card className=\"p-4 bg-amber-50 dark:bg-amber-950/30 border-amber-200 dark:border-amber-800/50 animate-in fade-in duration-300\">\r\n                    <div className=\"flex items-center gap-2 mb-3\">\r\n                        <Settings className=\"w-4 h-4 text-amber-600 dark:text-amber-400\" />\r\n                        <span className=\"text-sm font-semibold text-amber-800 dark:text-amber-300\">Quick Controls</span>\r\n                        <span className=\"text-xs text-amber-600 dark:text-amber-500\">(Admin Only)</span>\r\n                    </div>\r\n\r\n                    {/* Row 1: Main Toggles */}\r\n                    <div className=\"flex flex-wrap gap-3 mb-3\">\r\n                        {/* Subscriptions Toggle */}\r\n                        <button\r\n                            onClick={() => handleToggleFeature('subscriptionsEnabled')}\r\n                            disabled={isTogglingFeature === 'subscriptionsEnabled'}\r\n                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm transition-all ${features.subscriptionsEnabled\r\n                                ? 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-700 text-green-800 dark:text-green-300'\r\n                                : 'bg-red-100 dark:bg-red-900/30 border-red-300 dark:border-red-700 text-red-800 dark:text-red-300'\r\n                                } ${isTogglingFeature === 'subscriptionsEnabled' ? 'opacity-50' : 'hover:opacity-80'}`}\r\n                        >\r\n                            <CreditCard className=\"w-3.5 h-3.5\" />\r\n                            <span className=\"font-medium\">Payments</span>\r\n                            <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${features.subscriptionsEnabled ? 'bg-green-500 text-white' : 'bg-red-500 text-white'\r\n                                }`}>\r\n                                {features.subscriptionsEnabled ? 'ON' : 'OFF'}\r\n                            </span>\r\n                        </button>\r\n\r\n                        {/* AI Toggle */}\r\n                        <button\r\n                            onClick={() => handleToggleFeature('aiEnabled')}\r\n                            disabled={isTogglingFeature === 'aiEnabled'}\r\n                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm transition-all ${features.aiEnabled\r\n                                ? 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-700 text-green-800 dark:text-green-300'\r\n                                : 'bg-red-100 dark:bg-red-900/30 border-red-300 dark:border-red-700 text-red-800 dark:text-red-300'\r\n                                } ${isTogglingFeature === 'aiEnabled' ? 'opacity-50' : 'hover:opacity-80'}`}\r\n                        >\r\n                            <Zap className=\"w-3.5 h-3.5\" />\r\n                            <span className=\"font-medium\">AI</span>\r\n                            <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${features.aiEnabled ? 'bg-green-500 text-white' : 'bg-red-500 text-white'\r\n                                }`}>\r\n                                {features.aiEnabled ? 'ON' : 'OFF'}\r\n                            </span>\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Row 2: Special Modes */}\r\n                    <div className=\"flex flex-wrap gap-3 pt-3 border-t border-amber-200 dark:border-amber-800/50\">\r\n                        {/* Free Courses Mode */}\r\n                        <button\r\n                            onClick={() => handleToggleFeature('freeCoursesMode')}\r\n                            disabled={isTogglingFeature === 'freeCoursesMode'}\r\n                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm transition-all ${features.freeCoursesMode\r\n                                ? 'bg-purple-100 dark:bg-purple-900/30 border-purple-300 dark:border-purple-700 text-purple-800 dark:text-purple-300'\r\n                                : 'bg-neutral-100 dark:bg-neutral-800/50 border-neutral-300 dark:border-neutral-700 text-neutral-600 dark:text-neutral-400'\r\n                                } ${isTogglingFeature === 'freeCoursesMode' ? 'opacity-50' : 'hover:opacity-80'}`}\r\n                        >\r\n                            <BookOpen className=\"w-3.5 h-3.5\" />\r\n                            <span className=\"font-medium\">Free Courses</span>\r\n                            {features.freeCoursesMode && (\r\n                                <span className=\"px-1.5 py-0.5 rounded text-xs font-bold bg-purple-500 text-white\">ACTIVE</span>\r\n                            )}\r\n                        </button>\r\n\r\n                        {/* Disable Rate Limits */}\r\n                        <button\r\n                            onClick={() => handleToggleFeature('disableRateLimits')}\r\n                            disabled={isTogglingFeature === 'disableRateLimits'}\r\n                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm transition-all ${features.disableRateLimits\r\n                                ? 'bg-orange-100 dark:bg-orange-900/30 border-orange-300 dark:border-orange-700 text-orange-800 dark:text-orange-300'\r\n                                : 'bg-neutral-100 dark:bg-neutral-800/50 border-neutral-300 dark:border-neutral-700 text-neutral-600 dark:text-neutral-400'\r\n                                } ${isTogglingFeature === 'disableRateLimits' ? 'opacity-50' : 'hover:opacity-80'}`}\r\n                        >\r\n                            <TrendingUp className=\"w-3.5 h-3.5\" />\r\n                            <span className=\"font-medium\">No Limits</span>\r\n                            {features.disableRateLimits && (\r\n                                <span className=\"px-1.5 py-0.5 rounded text-xs font-bold bg-orange-500 text-white\">ACTIVE</span>\r\n                            )}\r\n                        </button>\r\n\r\n                        {/* Unlock All AI */}\r\n                        <button\r\n                            onClick={() => handleToggleFeature('aiUnlimitedMode')}\r\n                            disabled={isTogglingFeature === 'aiUnlimitedMode'}\r\n                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm transition-all ${features.aiUnlimitedMode\r\n                                ? 'bg-indigo-100 dark:bg-indigo-900/30 border-indigo-300 dark:border-indigo-700 text-indigo-800 dark:text-indigo-300'\r\n                                : 'bg-neutral-100 dark:bg-neutral-800/50 border-neutral-300 dark:border-neutral-700 text-neutral-600 dark:text-neutral-400'\r\n                                } ${isTogglingFeature === 'aiUnlimitedMode' ? 'opacity-50' : 'hover:opacity-80'}`}\r\n                        >\r\n                            <Zap className=\"w-3.5 h-3.5\" />\r\n                            <span className=\"font-medium\">Unlock All AI</span>\r\n                            {features.aiUnlimitedMode && (\r\n                                <span className=\"px-1.5 py-0.5 rounded text-xs font-bold bg-indigo-500 text-white\">PRO FOR ALL</span>\r\n                            )}\r\n                        </button>\r\n\r\n                        {/* Google Drive Storage */}\r\n                        <Link href=\"/api/admin/authorize-drive\">\r\n                            <button\r\n                                className=\"flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm transition-all bg-blue-100 dark:bg-blue-900/30 border-blue-300 dark:border-blue-700 text-blue-800 dark:text-blue-300 hover:opacity-80\"\r\n                            >\r\n                                <Cloud className=\"w-3.5 h-3.5\" />\r\n                                <span className=\"font-medium\">Google Drive</span>\r\n                                <span className=\"px-1.5 py-0.5 rounded text-xs font-bold bg-blue-500 text-white\">Setup</span>\r\n                            </button>\r\n                        </Link>\r\n                    </div>\r\n\r\n                    {features.updatedBy && (\r\n                        <p className=\"text-xs text-amber-600 dark:text-amber-500 mt-3\">\r\n                            Last updated by {features.updatedBy}\r\n                        </p>\r\n                    )}\r\n                </Card>\r\n            )}\r\n\r\n            {/* Stats Cards */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n                <Card className=\"p-6 bg-neutral-100 dark:bg-white/5 border-neutral-200 dark:border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-100 hover:bg-neutral-200 dark:hover:bg-white/10 transition-all\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center\">\r\n                            <Users className=\"w-5 h-5 text-blue-400\" />\r\n                        </div>\r\n                        <span className=\"text-xs text-green-400\">+12%</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Total Users</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">{stats?.totalUsers.toLocaleString() || '0'}</p>\r\n                </Card>\r\n\r\n                <Card className=\"p-6 bg-neutral-100 dark:bg-white/5 border-neutral-200 dark:border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-200 hover:bg-neutral-200 dark:hover:bg-white/10 transition-all\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center\">\r\n                            <BookOpen className=\"w-5 h-5 text-blue-400\" />\r\n                        </div>\r\n                        <span className=\"text-xs text-green-400\">+3</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Active Courses</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">{stats?.activeCourses || courses.length}</p>\r\n                </Card>\r\n\r\n                <Card className=\"p-6 bg-neutral-100 dark:bg-white/5 border-neutral-200 dark:border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-300 hover:bg-neutral-200 dark:hover:bg-white/10 transition-all\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center\">\r\n                            <DollarSign className=\"w-5 h-5 text-green-400\" />\r\n                        </div>\r\n                        <span className=\"text-xs text-green-400\">+8%</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Total Revenue</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">${stats?.totalRevenue.toLocaleString() || '0'}</p>\r\n                </Card>\r\n\r\n                <Card className=\"p-6 bg-neutral-100 dark:bg-white/5 border-neutral-200 dark:border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-400 hover:bg-neutral-200 dark:hover:bg-white/10 transition-all\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center\">\r\n                            <TrendingUp className=\"w-5 h-5 text-yellow-400\" />\r\n                        </div>\r\n                        <span className=\"text-xs text-green-400\">+5%</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">Avg Completion</p>\r\n                    <p className=\"text-2xl font-bold text-neutral-900 dark:text-white mt-1\">{stats?.avgCompletion || 0}%</p>\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Recent Users */}\r\n            <div className=\"space-y-4 animate-in fade-in duration-500 delay-500\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <h2 className=\"text-xl font-semibold text-neutral-900 dark:text-white\">Recent Users</h2>\r\n                    <Link href=\"/users\">\r\n                        <Button variant=\"ghost\" className=\"text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300\">\r\n                            View All â†’\r\n                        </Button>\r\n                    </Link>\r\n                </div>\r\n\r\n                <Card className=\"bg-white dark:bg-white/5 border-neutral-200 dark:border-white/10 overflow-hidden\">\r\n                    <div className=\"overflow-x-auto\">\r\n                        <table className=\"w-full\">\r\n                            <thead className=\"bg-neutral-100 dark:bg-white/5\">\r\n                                <tr>\r\n                                    <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase tracking-wider\">\r\n                                        User\r\n                                    </th>\r\n                                    <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase tracking-wider\">\r\n                                        Email\r\n                                    </th>\r\n                                    <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-400 uppercase tracking-wider\">\r\n                                        Courses\r\n                                    </th>\r\n                                    <th className=\"px-6 py-3 text-left text-xs font-semibold text-neutral-400 uppercase tracking-wider\">\r\n                                        Joined\r\n                                    </th>\r\n                                    <th className=\"px-6 py-3 text-right text-xs font-semibold text-neutral-400 uppercase tracking-wider\">\r\n                                        Actions\r\n                                    </th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-neutral-200 dark:divide-white/5\">\r\n                                {recentUsers.length === 0 ? (\r\n                                    <tr>\r\n                                        <td colSpan={5} className=\"px-6 py-8 text-center text-neutral-500\">\r\n                                            No recent users\r\n                                        </td>\r\n                                    </tr>\r\n                                ) : (\r\n                                    recentUsers.map((user) => (\r\n                                        <tr key={user.id} className=\"hover:bg-neutral-50 dark:hover:bg-white/5 transition-colors\">\r\n                                            <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                                                <div className=\"flex items-center\">\r\n                                                    <div className=\"w-8 h-8 rounded-full bg-neutral-300 dark:bg-neutral-700 flex items-center justify-center text-sm font-medium text-neutral-700 dark:text-white\">\r\n                                                        {user.name?.charAt(0) || 'U'}\r\n                                                    </div>\r\n                                                    <span className=\"ml-3 text-sm font-medium text-neutral-900 dark:text-white\">{user.name || 'Unknown'}</span>\r\n                                                </div>\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4 whitespace-nowrap text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                                {user.email}\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4 whitespace-nowrap text-sm text-neutral-900 dark:text-white\">\r\n                                                {user.enrolledCourses?.length || 0} courses\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4 whitespace-nowrap text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                                {formatJoinedDate(user.createdAt)}\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm\">\r\n                                                <Link href={`/users?search=${encodeURIComponent(user.email)}`}>\r\n                                                    <Button variant=\"ghost\" size=\"sm\" className=\"text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300\">\r\n                                                        View\r\n                                                    </Button>\r\n                                                </Link>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))\r\n                                )}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Course Management */}\r\n            <div className=\"space-y-4 animate-in fade-in duration-500 delay-600\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <h2 className=\"text-xl font-semibold text-neutral-900 dark:text-white\">Course Management</h2>\r\n                    <Link href=\"/courses\">\r\n                        <Button className=\"bg-blue-600 hover:bg-blue-700 text-white\">\r\n                            Manage Courses â†’\r\n                        </Button>\r\n                    </Link>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n                    {courses.map((course) => (\r\n                        <Card key={course.id} className=\"p-4 bg-white dark:bg-white/5 border-neutral-200 dark:border-white/10 hover:bg-neutral-50 dark:hover:bg-white/10 transition-all group\">\r\n                            <div className=\"flex gap-4\">\r\n                                <img\r\n                                    src={course.thumbnail}\r\n                                    alt={course.title}\r\n                                    className=\"w-24 h-24 rounded-lg object-cover\"\r\n                                />\r\n                                <div className=\"flex-1 space-y-2\">\r\n                                    <div className=\"flex items-start justify-between\">\r\n                                        <div>\r\n                                            <h3 className=\"font-semibold text-neutral-900 dark:text-white line-clamp-1\">{course.title}</h3>\r\n                                            <p className=\"text-xs text-neutral-600 dark:text-neutral-400\">{course.category} â€¢ {course.instructor}</p>\r\n                                        </div>\r\n                                        <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                            <button className=\"p-1.5 rounded hover:bg-neutral-200 dark:hover:bg-white/10 text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white\">\r\n                                                <Eye className=\"w-4 h-4\" />\r\n                                            </button>\r\n                                            <Link href={`/courses/${course.id}/edit`}>\r\n                                                <button className=\"p-1.5 rounded hover:bg-neutral-200 dark:hover:bg-white/10 text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white\">\r\n                                                    <Edit className=\"w-4 h-4\" />\r\n                                                </button>\r\n                                            </Link>\r\n                                            <button className=\"p-1.5 rounded hover:bg-neutral-200 dark:hover:bg-white/10 text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300\">\r\n                                                <Trash2 className=\"w-4 h-4\" />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-4 text-xs text-neutral-600 dark:text-neutral-400\">\r\n                                        <span>{course.lessons.length} lessons</span>\r\n                                        <span>{course.duration}</span>\r\n                                        <span className=\"text-yellow-400\">â˜… {course.rating}</span>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <span className={`px-2 py-0.5 rounded text-xs ${course.level === \"beginner\" ? \"bg-green-500/20 text-green-400\" :\r\n                                            course.level === \"intermediate\" ? \"bg-yellow-500/20 text-yellow-400\" :\r\n                                                \"bg-red-500/20 text-red-400\"\r\n                                            }`}>\r\n                                            {course.level}\r\n                                        </span>\r\n                                        <span className=\"text-xs text-neutral-400\">247 enrolled</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </Card>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\notifications\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5532,5535],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5532,5535],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":373,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":373,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18336,18339],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18336,18339],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Bell, Send, CheckCircle, Info, AlertTriangle, XCircle, Users, History, Search, Check, X, UserPlus, Megaphone } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\nimport Image from \"next/image\";\r\n\r\ninterface User {\r\n    id: string;\r\n    name: string;\r\n    email: string;\r\n    avatar?: string;\r\n    role: string;\r\n}\r\n\r\ninterface SentNotification {\r\n    id: string;\r\n    recipientCount: number;\r\n    title: string;\r\n    type: string;\r\n    createdAt: string;\r\n}\r\n\r\nexport default function AdminNotificationsPage() {\r\n    const { t } = useTranslation();\r\n    const [activeTab, setActiveTab] = useState<'compose' | 'history'>('compose');\r\n\r\n    // Modal State\r\n    const [isPickerOpen, setIsPickerOpen] = useState(false);\r\n    const [users, setUsers] = useState<User[]>([]);\r\n    const [loadingUsers, setLoadingUsers] = useState(false);\r\n    const [searchQuery, setSearchQuery] = useState(\"\");\r\n    const [selectedUsers, setSelectedUsers] = useState<Map<string, User>>(new Map());\r\n    const [isBroadcast, setIsBroadcast] = useState(false);\r\n\r\n    // Compose State\r\n    const [title, setTitle] = useState(\"\");\r\n    const [message, setMessage] = useState(\"\");\r\n    const [type, setType] = useState<'info' | 'success' | 'warning' | 'error'>('info');\r\n    const [loading, setLoading] = useState(false);\r\n    const [status, setStatus] = useState<{ type: 'success' | 'error', message: string } | null>(null);\r\n\r\n    // History State\r\n    const [history, setHistory] = useState<SentNotification[]>([]);\r\n\r\n    // Fetch Users when modal opens\r\n    const openPicker = async () => {\r\n        setIsPickerOpen(true);\r\n        if (users.length === 0) {\r\n            setLoadingUsers(true);\r\n            try {\r\n                const res = await fetch('/api/admin/users?limit=50');\r\n                const data = await res.json();\r\n                if (data.users) {\r\n                    setUsers(data.users);\r\n                }\r\n            } catch (error) {\r\n                console.error('Failed to fetch users:', error);\r\n            } finally {\r\n                setLoadingUsers(false);\r\n            }\r\n        }\r\n    };\r\n\r\n    // Search users\r\n    const searchUsers = async (query: string) => {\r\n        setSearchQuery(query);\r\n        if (query.length >= 2) {\r\n            setLoadingUsers(true);\r\n            try {\r\n                const res = await fetch(`/api/admin/users?search=${encodeURIComponent(query)}&limit=50`);\r\n                const data = await res.json();\r\n                if (data.users) {\r\n                    setUsers(data.users);\r\n                }\r\n            } catch (error) {\r\n                console.error('Search failed:', error);\r\n            } finally {\r\n                setLoadingUsers(false);\r\n            }\r\n        }\r\n    };\r\n\r\n    const toggleUser = (user: User) => {\r\n        const newSelected = new Map(selectedUsers);\r\n        if (newSelected.has(user.id)) {\r\n            newSelected.delete(user.id);\r\n        } else {\r\n            newSelected.set(user.id, user);\r\n        }\r\n        setSelectedUsers(newSelected);\r\n    };\r\n\r\n    const removeUser = (userId: string) => {\r\n        const newSelected = new Map(selectedUsers);\r\n        newSelected.delete(userId);\r\n        setSelectedUsers(newSelected);\r\n    };\r\n\r\n    const handleSend = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n\r\n        if (!isBroadcast && selectedUsers.size === 0) {\r\n            setStatus({ type: 'error', message: 'Please select at least one recipient' });\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setStatus(null);\r\n\r\n        try {\r\n            if (isBroadcast) {\r\n                // TODO: Implement broadcast endpoint\r\n                setStatus({ type: 'error', message: 'Broadcast not yet implemented' });\r\n                setLoading(false);\r\n                return;\r\n            }\r\n\r\n            // Send to each selected user\r\n            const userIds = Array.from(selectedUsers.keys());\r\n            const results = await Promise.all(\r\n                userIds.map(userId =>\r\n                    fetch('/api/admin/notifications/send', {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify({ userId, title, message, type }),\r\n                    })\r\n                )\r\n            );\r\n\r\n            const failed = results.filter(r => !r.ok).length;\r\n\r\n            if (failed > 0) {\r\n                setStatus({ type: 'error', message: `Sent to ${results.length - failed}/${results.length} users` });\r\n            } else {\r\n                setStatus({ type: 'success', message: `Sent to ${results.length} user${results.length > 1 ? 's' : ''}!` });\r\n            }\r\n\r\n            // Add to history\r\n            setHistory(prev => [{\r\n                id: Date.now().toString(),\r\n                recipientCount: userIds.length,\r\n                title,\r\n                type,\r\n                createdAt: new Date().toISOString()\r\n            }, ...prev]);\r\n\r\n            // Reset form\r\n            setTitle(\"\");\r\n            setMessage(\"\");\r\n            setSelectedUsers(new Map());\r\n        } catch (error: any) {\r\n            setStatus({ type: 'error', message: error.message });\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const tabs = [\r\n        { id: 'compose', label: 'Compose', icon: Send },\r\n        { id: 'history', label: 'History', icon: History },\r\n    ];\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Header */}\r\n            <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold tracking-tight text-neutral-900 dark:text-white flex items-center gap-3\">\r\n                        <div className=\"p-2 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl\">\r\n                            <Bell className=\"w-6 h-6 text-white\" />\r\n                        </div>\r\n                        {t.settingsPage.notifications}\r\n                    </h1>\r\n                    <p className=\"mt-1 text-neutral-500 dark:text-neutral-400\">\r\n                        Send real-time notifications to users\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Tab Switcher */}\r\n                <div className=\"flex bg-neutral-100 dark:bg-neutral-800 p-1 rounded-xl\">\r\n                    {tabs.map((tab) => (\r\n                        <button\r\n                            key={tab.id}\r\n                            onClick={() => setActiveTab(tab.id as 'compose' | 'history')}\r\n                            className={cn(\r\n                                \"flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all\",\r\n                                activeTab === tab.id\r\n                                    ? \"bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white shadow-sm\"\r\n                                    : \"text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white\"\r\n                            )}\r\n                        >\r\n                            <tab.icon size={16} />\r\n                            {tab.label}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Compose Tab */}\r\n            {activeTab === 'compose' && (\r\n                <form onSubmit={handleSend} className=\"space-y-6\">\r\n                    {/* Status Message */}\r\n                    <AnimatePresence mode=\"wait\">\r\n                        {status && (\r\n                            <motion.div\r\n                                initial={{ opacity: 0, y: -10 }}\r\n                                animate={{ opacity: 1, y: 0 }}\r\n                                exit={{ opacity: 0, y: -10 }}\r\n                                className={cn(\r\n                                    \"p-4 rounded-xl flex items-center gap-3 text-sm font-medium\",\r\n                                    status.type === 'success'\r\n                                        ? \"bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-300\"\r\n                                        : \"bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300\"\r\n                                )}\r\n                            >\r\n                                {status.type === 'success' ? <CheckCircle size={18} /> : <XCircle size={18} />}\r\n                                {status.message}\r\n                            </motion.div>\r\n                        )}\r\n                    </AnimatePresence>\r\n\r\n                    {/* Recipient Selection */}\r\n                    <div className=\"bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-6\">\r\n                        <Label className=\"text-base font-semibold mb-4 block\">Recipients</Label>\r\n\r\n                        {/* Mode Toggle */}\r\n                        <div className=\"flex gap-3 mb-4\">\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => setIsBroadcast(false)}\r\n                                className={cn(\r\n                                    \"flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all\",\r\n                                    !isBroadcast\r\n                                        ? \"border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300\"\r\n                                        : \"border-neutral-200 dark:border-neutral-700 text-neutral-600\"\r\n                                )}\r\n                            >\r\n                                <UserPlus size={18} />\r\n                                Select Users\r\n                            </button>\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => setIsBroadcast(true)}\r\n                                className={cn(\r\n                                    \"flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all\",\r\n                                    isBroadcast\r\n                                        ? \"border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300\"\r\n                                        : \"border-neutral-200 dark:border-neutral-700 text-neutral-600\"\r\n                                )}\r\n                            >\r\n                                <Megaphone size={18} />\r\n                                Broadcast All\r\n                            </button>\r\n                        </div>\r\n\r\n                        {!isBroadcast && (\r\n                            <>\r\n                                {/* Selected Users Pills */}\r\n                                {selectedUsers.size > 0 && (\r\n                                    <div className=\"flex flex-wrap gap-2 mb-4\">\r\n                                        {Array.from(selectedUsers.values()).map(user => (\r\n                                            <div\r\n                                                key={user.id}\r\n                                                className=\"flex items-center gap-2 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 pl-1 pr-2 py-1 rounded-full\"\r\n                                            >\r\n                                                <div className=\"w-6 h-6 rounded-full overflow-hidden bg-blue-200\">\r\n                                                    {user.avatar ? (\r\n                                                        <Image src={user.avatar} alt={user.name} width={24} height={24} className=\"object-cover\" />\r\n                                                    ) : (\r\n                                                        <div className=\"w-full h-full flex items-center justify-center text-blue-600 text-xs font-bold\">\r\n                                                            {user.name?.charAt(0).toUpperCase()}\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                                <span className=\"text-sm font-medium\">{user.name?.split(' ')[0]}</span>\r\n                                                <button\r\n                                                    type=\"button\"\r\n                                                    onClick={() => removeUser(user.id)}\r\n                                                    className=\"w-4 h-4 rounded-full bg-blue-200 dark:bg-blue-800 flex items-center justify-center hover:bg-blue-300\"\r\n                                                >\r\n                                                    <X size={12} />\r\n                                                </button>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Open Picker Button */}\r\n                                <Button\r\n                                    type=\"button\"\r\n                                    variant=\"outline\"\r\n                                    onClick={openPicker}\r\n                                    className=\"w-full h-12 border-dashed border-2 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20\"\r\n                                >\r\n                                    <Users className=\"mr-2\" size={18} />\r\n                                    {selectedUsers.size > 0 ? `Add More Recipients (${selectedUsers.size} selected)` : 'Click to Select Recipients'}\r\n                                </Button>\r\n                            </>\r\n                        )}\r\n\r\n                        {isBroadcast && (\r\n                            <div className=\"p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-200 dark:border-indigo-800\">\r\n                                <p className=\"text-sm text-indigo-700 dark:text-indigo-300\">\r\n                                    <strong>Broadcast Mode:</strong> This notification will be sent to all registered users.\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Message Composition */}\r\n                    <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                        <div className=\"lg:col-span-2 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-6 space-y-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label>Title</Label>\r\n                                <Input\r\n                                    placeholder=\"e.g. New Course Available!\"\r\n                                    value={title}\r\n                                    onChange={(e) => setTitle(e.target.value)}\r\n                                    required\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"space-y-2\">\r\n                                <Label>Message</Label>\r\n                                <Textarea\r\n                                    placeholder=\"Write your message here...\"\r\n                                    className=\"min-h-[120px] resize-none\"\r\n                                    value={message}\r\n                                    onChange={(e) => setMessage(e.target.value)}\r\n                                    required\r\n                                />\r\n                            </div>\r\n\r\n                            <Button\r\n                                type=\"submit\"\r\n                                className=\"w-full h-11 text-base bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white\"\r\n                                disabled={loading || (!isBroadcast && selectedUsers.size === 0)}\r\n                            >\r\n                                {loading ? (\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\" />\r\n                                        Sending...\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Send size={18} />\r\n                                        {isBroadcast ? 'Broadcast to All' : `Send to ${selectedUsers.size} User${selectedUsers.size !== 1 ? 's' : ''}`}\r\n                                    </div>\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n\r\n                        {/* Type Selector */}\r\n                        <div className=\"bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-6\">\r\n                            <Label className=\"mb-4 block\">Type</Label>\r\n                            <div className=\"grid grid-cols-2 gap-3\">\r\n                                {[\r\n                                    { id: 'info', icon: Info, label: 'Info', bg: 'bg-blue-500' },\r\n                                    { id: 'success', icon: CheckCircle, label: 'Success', bg: 'bg-green-500' },\r\n                                    { id: 'warning', icon: AlertTriangle, label: 'Warning', bg: 'bg-amber-500' },\r\n                                    { id: 'error', icon: XCircle, label: 'Error', bg: 'bg-red-500' },\r\n                                ].map((item) => (\r\n                                    <button\r\n                                        key={item.id}\r\n                                        type=\"button\"\r\n                                        onClick={() => setType(item.id as any)}\r\n                                        className={cn(\r\n                                            \"flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all\",\r\n                                            type === item.id\r\n                                                ? \"border-neutral-900 dark:border-white bg-neutral-50 dark:bg-neutral-800\"\r\n                                                : \"border-neutral-200 dark:border-neutral-800 hover:border-neutral-300\"\r\n                                        )}\r\n                                    >\r\n                                        <div className={cn(\"w-8 h-8 rounded-full flex items-center justify-center mb-2\", item.bg)}>\r\n                                            <item.icon className=\"w-4 h-4 text-white\" />\r\n                                        </div>\r\n                                        <span className=\"text-xs font-medium\">{item.label}</span>\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n            )}\r\n\r\n            {/* History Tab */}\r\n            {activeTab === 'history' && (\r\n                <div className=\"bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl overflow-hidden\">\r\n                    {history.length === 0 ? (\r\n                        <div className=\"p-12 text-center\">\r\n                            <History className=\"w-12 h-12 mx-auto text-neutral-300 dark:text-neutral-600 mb-4\" />\r\n                            <p className=\"text-neutral-500\">No notifications sent yet</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"divide-y divide-neutral-100 dark:divide-neutral-800\">\r\n                            {history.map((item) => (\r\n                                <div key={item.id} className=\"p-4 flex items-center justify-between\">\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className={cn(\r\n                                            \"w-10 h-10 rounded-full flex items-center justify-center\",\r\n                                            item.type === 'info' && \"bg-blue-100 dark:bg-blue-900/30\",\r\n                                            item.type === 'success' && \"bg-green-100 dark:bg-green-900/30\",\r\n                                            item.type === 'warning' && \"bg-amber-100 dark:bg-amber-900/30\",\r\n                                            item.type === 'error' && \"bg-red-100 dark:bg-red-900/30\",\r\n                                        )}>\r\n                                            <Bell className={cn(\r\n                                                \"w-5 h-5\",\r\n                                                item.type === 'info' && \"text-blue-600\",\r\n                                                item.type === 'success' && \"text-green-600\",\r\n                                                item.type === 'warning' && \"text-amber-600\",\r\n                                                item.type === 'error' && \"text-red-600\",\r\n                                            )} />\r\n                                        </div>\r\n                                        <div>\r\n                                            <p className=\"font-medium text-sm\">{item.title}</p>\r\n                                            <p className=\"text-xs text-neutral-500\">\r\n                                                Sent to {item.recipientCount} user{item.recipientCount > 1 ? 's' : ''}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                    <span className=\"text-xs text-neutral-400\">\r\n                                        {new Date(item.createdAt).toLocaleString()}\r\n                                    </span>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* User Picker Modal */}\r\n            <AnimatePresence>\r\n                {isPickerOpen && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        exit={{ opacity: 0 }}\r\n                        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4\"\r\n                        onClick={() => setIsPickerOpen(false)}\r\n                    >\r\n                        <motion.div\r\n                            initial={{ scale: 0.95, opacity: 0 }}\r\n                            animate={{ scale: 1, opacity: 1 }}\r\n                            exit={{ scale: 0.95, opacity: 0 }}\r\n                            className=\"bg-white dark:bg-neutral-900 rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-hidden\"\r\n                            onClick={e => e.stopPropagation()}\r\n                        >\r\n                            {/* Modal Header */}\r\n                            <div className=\"p-4 border-b border-neutral-200 dark:border-neutral-800\">\r\n                                <div className=\"flex items-center justify-between mb-3\">\r\n                                    <h2 className=\"text-lg font-semibold\">Select Recipients</h2>\r\n                                    <button\r\n                                        onClick={() => setIsPickerOpen(false)}\r\n                                        className=\"p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-lg\"\r\n                                    >\r\n                                        <X size={20} />\r\n                                    </button>\r\n                                </div>\r\n                                <div className=\"relative\">\r\n                                    <Search className=\"absolute left-3 top-2.5 text-neutral-400\" size={18} />\r\n                                    <Input\r\n                                        placeholder=\"Search by name or email...\"\r\n                                        className=\"pl-10\"\r\n                                        value={searchQuery}\r\n                                        onChange={(e) => searchUsers(e.target.value)}\r\n                                        autoFocus\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Modal Body - User Grid */}\r\n                            <div className=\"p-4 overflow-y-auto max-h-[50vh]\">\r\n                                {loadingUsers ? (\r\n                                    <div className=\"grid grid-cols-4 gap-4\">\r\n                                        {[...Array(8)].map((_, i) => (\r\n                                            <div key={i} className=\"flex flex-col items-center animate-pulse\">\r\n                                                <div className=\"w-16 h-16 rounded-full bg-neutral-200 dark:bg-neutral-800\" />\r\n                                                <div className=\"w-12 h-3 mt-2 rounded bg-neutral-200 dark:bg-neutral-800\" />\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                ) : users.length === 0 ? (\r\n                                    <div className=\"text-center py-8 text-neutral-500\">\r\n                                        <Users className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\r\n                                        <p>No users found</p>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"grid grid-cols-4 gap-4\">\r\n                                        {users.map((user) => {\r\n                                            const isSelected = selectedUsers.has(user.id);\r\n                                            return (\r\n                                                <button\r\n                                                    key={user.id}\r\n                                                    type=\"button\"\r\n                                                    onClick={() => toggleUser(user)}\r\n                                                    className=\"flex flex-col items-center group\"\r\n                                                >\r\n                                                    <div className={cn(\r\n                                                        \"relative w-16 h-16 rounded-full overflow-hidden border-3 transition-all\",\r\n                                                        isSelected\r\n                                                            ? \"border-blue-500 ring-4 ring-blue-500/30 scale-105\"\r\n                                                            : \"border-transparent group-hover:border-neutral-300 dark:group-hover:border-neutral-600\"\r\n                                                    )}>\r\n                                                        {user.avatar ? (\r\n                                                            <Image\r\n                                                                src={user.avatar}\r\n                                                                alt={user.name}\r\n                                                                fill\r\n                                                                className=\"object-cover\"\r\n                                                            />\r\n                                                        ) : (\r\n                                                            <div className=\"w-full h-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-bold text-xl\">\r\n                                                                {user.name?.charAt(0).toUpperCase() || '?'}\r\n                                                            </div>\r\n                                                        )}\r\n                                                        {isSelected && (\r\n                                                            <div className=\"absolute inset-0 bg-blue-500/50 flex items-center justify-center\">\r\n                                                                <Check className=\"w-8 h-8 text-white\" strokeWidth={3} />\r\n                                                            </div>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    <span className={cn(\r\n                                                        \"text-xs mt-2 text-center truncate w-full\",\r\n                                                        isSelected ? \"text-blue-600 dark:text-blue-400 font-semibold\" : \"text-neutral-600 dark:text-neutral-400\"\r\n                                                    )}>\r\n                                                        {user.name?.split(' ')[0] || 'User'}\r\n                                                    </span>\r\n                                                </button>\r\n                                            );\r\n                                        })}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Modal Footer */}\r\n                            <div className=\"p-4 border-t border-neutral-200 dark:border-neutral-800 flex items-center justify-between\">\r\n                                <p className=\"text-sm text-neutral-500\">\r\n                                    {selectedUsers.size} selected\r\n                                </p>\r\n                                <Button\r\n                                    onClick={() => setIsPickerOpen(false)}\r\n                                    className=\"bg-blue-600 hover:bg-blue-700 text-white\"\r\n                                >\r\n                                    Done\r\n                                </Button>\r\n                            </div>\r\n                        </motion.div>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\users\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RefreshCw' is defined but never used.","line":19,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":14},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":184,"column":33,"nodeType":"JSXOpeningElement","endLine":188,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useParams, useRouter } from \"next/navigation\";\r\nimport { useRequireAdmin } from \"@/hooks/useRequireAdmin\";\r\nimport {\r\n    ArrowLeft,\r\n    User,\r\n    Mail,\r\n    Calendar,\r\n    BookOpen,\r\n    Shield,\r\n    ShieldAlert,\r\n    Ban,\r\n    CheckCircle,\r\n    Trash2,\r\n    Loader2,\r\n    Key,\r\n    RefreshCw\r\n} from \"lucide-react\";\r\nimport Link from \"next/link\";\r\n\r\ninterface UserProfile {\r\n    id: string;\r\n    email: string;\r\n    name: string;\r\n    role: 'student' | 'admin';\r\n    avatar?: string;\r\n    phoneNumber?: string;\r\n    bio?: string;\r\n    enrolledCourses?: string[];\r\n    completedCourses?: string[];\r\n    createdAt?: string;\r\n    isDisabled?: boolean;\r\n}\r\n\r\nexport default function UserProfilePage() {\r\n    const params = useParams();\r\n    const router = useRouter();\r\n    const { isAdmin, isLoading: authLoading } = useRequireAdmin();\r\n    const [user, setUser] = useState<UserProfile | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [actionLoading, setActionLoading] = useState<string | null>(null);\r\n\r\n    const userId = params.id as string;\r\n\r\n    useEffect(() => {\r\n        if (!isAdmin || !userId) return;\r\n\r\n        const fetchUser = async () => {\r\n            try {\r\n                const res = await fetch(`/api/admin/users/${userId}`);\r\n                if (!res.ok) throw new Error('User not found');\r\n                const data = await res.json();\r\n                setUser(data);\r\n            } catch (err) {\r\n                setError(err instanceof Error ? err.message : 'Failed to load user');\r\n            } finally {\r\n                setIsLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchUser();\r\n    }, [isAdmin, userId]);\r\n\r\n    const formatDate = (dateStr?: string) => {\r\n        if (!dateStr) return 'Unknown';\r\n        const date = new Date(dateStr);\r\n        if (isNaN(date.getTime())) return 'Unknown';\r\n        return date.toLocaleDateString('en-US', {\r\n            year: 'numeric',\r\n            month: 'long',\r\n            day: 'numeric'\r\n        });\r\n    };\r\n\r\n    const handleAction = async (action: string) => {\r\n        if (!user) return;\r\n        setActionLoading(action);\r\n\r\n        try {\r\n            const res = await fetch('/api/admin/users', {\r\n                method: 'PATCH',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    userId: user.id,\r\n                    updates: action === 'makeAdmin' ? { role: 'admin' } :\r\n                        action === 'makeStudent' ? { role: 'student' } :\r\n                            action === 'disable' ? { isDisabled: true } :\r\n                                action === 'enable' ? { isDisabled: false } : {},\r\n                }),\r\n            });\r\n\r\n            if (!res.ok) throw new Error('Action failed');\r\n\r\n            // Refresh user data\r\n            const updated = await res.json();\r\n            setUser(prev => prev ? { ...prev, ...updated.user } : null);\r\n        } catch (err) {\r\n            alert(err instanceof Error ? err.message : 'Action failed');\r\n        } finally {\r\n            setActionLoading(null);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async () => {\r\n        if (!user) return;\r\n        if (!confirm(`Are you sure you want to DELETE user \"${user.name || user.email}\"? This cannot be undone.`)) return;\r\n\r\n        setActionLoading('delete');\r\n        try {\r\n            const res = await fetch(`/api/admin/users/${user.id}`, { method: 'DELETE' });\r\n            if (!res.ok) throw new Error('Delete failed');\r\n            router.push('/users');\r\n        } catch (err) {\r\n            alert(err instanceof Error ? err.message : 'Delete failed');\r\n            setActionLoading(null);\r\n        }\r\n    };\r\n\r\n    const handleResetPassword = async () => {\r\n        if (!user) return;\r\n        if (!confirm(`Send password reset email to ${user.email}?`)) return;\r\n\r\n        setActionLoading('reset');\r\n        try {\r\n            // This would trigger a password reset email\r\n            alert(`Password reset email would be sent to ${user.email}`);\r\n        } finally {\r\n            setActionLoading(null);\r\n        }\r\n    };\r\n\r\n    if (authLoading || !isAdmin) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96\">\r\n                <Loader2 className=\"w-8 h-8 animate-spin text-blue-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96\">\r\n                <Loader2 className=\"w-8 h-8 animate-spin text-blue-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (error || !user) {\r\n        return (\r\n            <div className=\"p-6\">\r\n                <Link href=\"/users\" className=\"flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline mb-6\">\r\n                    <ArrowLeft size={16} /> Back to Users\r\n                </Link>\r\n                <div className=\"p-8 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-center\">\r\n                    <p className=\"text-red-600 dark:text-red-400\">{error || 'User not found'}</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"p-6 space-y-6\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <Link href=\"/users\" className=\"flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline\">\r\n                    <ArrowLeft size={16} /> Back to Users\r\n                </Link>\r\n            </div>\r\n\r\n            {/* User Profile Card */}\r\n            <div className=\"bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl overflow-hidden\">\r\n                {/* Header Banner */}\r\n                <div className=\"h-20 bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600\" />\r\n\r\n                {/* Profile Info */}\r\n                <div className=\"px-6 pb-6\">\r\n                    <div className=\"flex flex-col sm:flex-row sm:items-end gap-4 -mt-10\">\r\n                        {/* Avatar */}\r\n                        <div className=\"relative flex-shrink-0\">\r\n                            {user.avatar ? (\r\n                                <img\r\n                                    src={user.avatar}\r\n                                    alt={user.name}\r\n                                    className=\"w-20 h-20 rounded-xl object-cover border-4 border-white dark:border-neutral-900 shadow-lg bg-white\"\r\n                                />\r\n                            ) : (\r\n                                <div className=\"w-20 h-20 rounded-xl bg-neutral-100 dark:bg-neutral-700 border-4 border-white dark:border-neutral-900 shadow-lg flex items-center justify-center\">\r\n                                    <User size={28} className=\"text-neutral-400\" />\r\n                                </div>\r\n                            )}\r\n                            {user.isDisabled && (\r\n                                <div className=\"absolute -top-1 -right-1 p-1 bg-red-500 rounded-full\">\r\n                                    <Ban size={12} className=\"text-white\" />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Name & Badge */}\r\n                        <div className=\"flex-1 min-w-0 pt-2 sm:pt-0\">\r\n                            <div className=\"flex flex-wrap items-center gap-2\">\r\n                                <h1 className=\"text-xl font-bold text-neutral-900 dark:text-white\">\r\n                                    {user.name || 'Unknown User'}\r\n                                </h1>\r\n                                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold uppercase tracking-wide ${user.role === 'admin'\r\n                                        ? 'bg-amber-100 dark:bg-amber-500/20 text-amber-700 dark:text-amber-400'\r\n                                        : 'bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400'\r\n                                    }`}>\r\n                                    {user.role === 'admin' ? 'Admin' : 'Student'}\r\n                                </span>\r\n                            </div>\r\n\r\n                            <div className=\"mt-3 flex flex-wrap gap-4 text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                <span className=\"flex items-center gap-1.5\">\r\n                                    <Mail size={14} className=\"text-neutral-400\" />\r\n                                    {user.email}\r\n                                </span>\r\n                                <span className=\"flex items-center gap-1.5\">\r\n                                    <Calendar size={14} className=\"text-neutral-400\" />\r\n                                    Joined {formatDate(user.createdAt)}\r\n                                </span>\r\n                                <span className=\"flex items-center gap-1.5\">\r\n                                    <BookOpen size={14} className=\"text-neutral-400\" />\r\n                                    {user.enrolledCourses?.length || 0} courses\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Admin Actions */}\r\n            <div className=\"bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6\">\r\n                <h2 className=\"text-lg font-semibold text-neutral-900 dark:text-white mb-4\">Admin Actions</h2>\r\n\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3\">\r\n                    {/* Role Toggle */}\r\n                    {user.role === 'student' ? (\r\n                        <button\r\n                            onClick={() => handleAction('makeAdmin')}\r\n                            disabled={!!actionLoading}\r\n                            className=\"flex items-center gap-3 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors disabled:opacity-50\"\r\n                        >\r\n                            {actionLoading === 'makeAdmin' ? (\r\n                                <Loader2 className=\"w-5 h-5 animate-spin text-amber-600\" />\r\n                            ) : (\r\n                                <ShieldAlert className=\"w-5 h-5 text-amber-600 dark:text-amber-400\" />\r\n                            )}\r\n                            <div className=\"text-left\">\r\n                                <p className=\"font-medium text-amber-900 dark:text-amber-200\">Make Admin</p>\r\n                                <p className=\"text-xs text-amber-700 dark:text-amber-400\">Grant admin privileges</p>\r\n                            </div>\r\n                        </button>\r\n                    ) : (\r\n                        <button\r\n                            onClick={() => handleAction('makeStudent')}\r\n                            disabled={!!actionLoading}\r\n                            className=\"flex items-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors disabled:opacity-50\"\r\n                        >\r\n                            {actionLoading === 'makeStudent' ? (\r\n                                <Loader2 className=\"w-5 h-5 animate-spin text-blue-600\" />\r\n                            ) : (\r\n                                <Shield className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\r\n                            )}\r\n                            <div className=\"text-left\">\r\n                                <p className=\"font-medium text-blue-900 dark:text-blue-200\">Make Student</p>\r\n                                <p className=\"text-xs text-blue-700 dark:text-blue-400\">Remove admin privileges</p>\r\n                            </div>\r\n                        </button>\r\n                    )}\r\n\r\n                    {/* Disable/Enable */}\r\n                    {user.isDisabled ? (\r\n                        <button\r\n                            onClick={() => handleAction('enable')}\r\n                            disabled={!!actionLoading}\r\n                            className=\"flex items-center gap-3 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors disabled:opacity-50\"\r\n                        >\r\n                            {actionLoading === 'enable' ? (\r\n                                <Loader2 className=\"w-5 h-5 animate-spin text-green-600\" />\r\n                            ) : (\r\n                                <CheckCircle className=\"w-5 h-5 text-green-600 dark:text-green-400\" />\r\n                            )}\r\n                            <div className=\"text-left\">\r\n                                <p className=\"font-medium text-green-900 dark:text-green-200\">Enable Account</p>\r\n                                <p className=\"text-xs text-green-700 dark:text-green-400\">Restore user access</p>\r\n                            </div>\r\n                        </button>\r\n                    ) : (\r\n                        <button\r\n                            onClick={() => handleAction('disable')}\r\n                            disabled={!!actionLoading}\r\n                            className=\"flex items-center gap-3 p-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors disabled:opacity-50\"\r\n                        >\r\n                            {actionLoading === 'disable' ? (\r\n                                <Loader2 className=\"w-5 h-5 animate-spin text-orange-600\" />\r\n                            ) : (\r\n                                <Ban className=\"w-5 h-5 text-orange-600 dark:text-orange-400\" />\r\n                            )}\r\n                            <div className=\"text-left\">\r\n                                <p className=\"font-medium text-orange-900 dark:text-orange-200\">Disable Account</p>\r\n                                <p className=\"text-xs text-orange-700 dark:text-orange-400\">Suspend user access</p>\r\n                            </div>\r\n                        </button>\r\n                    )}\r\n\r\n                    {/* Reset Password */}\r\n                    <button\r\n                        onClick={handleResetPassword}\r\n                        disabled={!!actionLoading}\r\n                        className=\"flex items-center gap-3 p-4 bg-neutral-50 dark:bg-neutral-800/50 border border-neutral-200 dark:border-neutral-700 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors disabled:opacity-50\"\r\n                    >\r\n                        {actionLoading === 'reset' ? (\r\n                            <Loader2 className=\"w-5 h-5 animate-spin text-neutral-600\" />\r\n                        ) : (\r\n                            <Key className=\"w-5 h-5 text-neutral-600 dark:text-neutral-400\" />\r\n                        )}\r\n                        <div className=\"text-left\">\r\n                            <p className=\"font-medium text-neutral-900 dark:text-neutral-200\">Reset Password</p>\r\n                            <p className=\"text-xs text-neutral-600 dark:text-neutral-400\">Send reset email</p>\r\n                        </div>\r\n                    </button>\r\n\r\n                    {/* Delete User */}\r\n                    <button\r\n                        onClick={handleDelete}\r\n                        disabled={!!actionLoading}\r\n                        className=\"flex items-center gap-3 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors disabled:opacity-50\"\r\n                    >\r\n                        {actionLoading === 'delete' ? (\r\n                            <Loader2 className=\"w-5 h-5 animate-spin text-red-600\" />\r\n                        ) : (\r\n                            <Trash2 className=\"w-5 h-5 text-red-600 dark:text-red-400\" />\r\n                        )}\r\n                        <div className=\"text-left\">\r\n                            <p className=\"font-medium text-red-900 dark:text-red-200\">Delete User</p>\r\n                            <p className=\"text-xs text-red-700 dark:text-red-400\">Permanently remove</p>\r\n                        </div>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* User Activity (placeholder) */}\r\n            <div className=\"bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6\">\r\n                <h2 className=\"text-lg font-semibold text-neutral-900 dark:text-white mb-4\">Enrolled Courses</h2>\r\n                {user.enrolledCourses && user.enrolledCourses.length > 0 ? (\r\n                    <ul className=\"space-y-2\">\r\n                        {user.enrolledCourses.map((courseId, idx) => (\r\n                            <li key={idx} className=\"flex items-center gap-2 text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                <BookOpen size={14} className=\"text-blue-500\" />\r\n                                <span>Course ID: {courseId}</span>\r\n                            </li>\r\n                        ))}\r\n                    </ul>\r\n                ) : (\r\n                    <p className=\"text-neutral-500 text-sm\">No courses enrolled</p>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(admin)\\users\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":190,"column":53,"nodeType":"JSXOpeningElement","endLine":194,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback } from \"react\";\r\nimport { useRequireAdmin } from \"@/hooks/useRequireAdmin\";\r\nimport Link from \"next/link\";\r\nimport {\r\n    Search,\r\n    RefreshCw,\r\n    ChevronLeft,\r\n    ChevronRight,\r\n    User as UserIcon\r\n} from \"lucide-react\";\r\n\r\ninterface User {\r\n    id: string;\r\n    email: string;\r\n    name: string;\r\n    role: 'student' | 'admin';\r\n    avatar?: string;\r\n    enrolledCourses?: string[];\r\n    createdAt?: string;\r\n    isDisabled?: boolean;\r\n}\r\n\r\ninterface UsersResponse {\r\n    users: User[];\r\n    total: number;\r\n    page: number;\r\n    limit: number;\r\n    pages: number;\r\n}\r\n\r\nexport default function UsersPage() {\r\n    const { isAdmin, isLoading: authLoading } = useRequireAdmin();\r\n    const [data, setData] = useState<UsersResponse | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [search, setSearch] = useState(\"\");\r\n    const [roleFilter, setRoleFilter] = useState<'all' | 'student' | 'admin'>('all');\r\n    const [page, setPage] = useState(1);\r\n\r\n    const fetchUsers = useCallback(async () => {\r\n        setIsLoading(true);\r\n        setError(null);\r\n        try {\r\n            const params = new URLSearchParams({\r\n                page: String(page),\r\n                limit: '20',\r\n            });\r\n            if (search) params.set('search', search);\r\n            if (roleFilter !== 'all') params.set('role', roleFilter);\r\n\r\n            const res = await fetch(`/api/admin/users?${params}`);\r\n            if (!res.ok) throw new Error('Failed to fetch users');\r\n            const json = await res.json();\r\n            setData(json);\r\n        } catch (err) {\r\n            setError(err instanceof Error ? err.message : 'Failed to load');\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }, [page, search, roleFilter]);\r\n\r\n    useEffect(() => {\r\n        if (isAdmin) {\r\n            fetchUsers();\r\n        }\r\n    }, [isAdmin, fetchUsers]);\r\n\r\n    const handleSearch = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setPage(1);\r\n        fetchUsers();\r\n    };\r\n\r\n    // Format date - handle NaN safely\r\n    const formatJoinDate = (dateStr?: string) => {\r\n        if (!dateStr) return 'Recently';\r\n        const date = new Date(dateStr);\r\n        if (isNaN(date.getTime())) return 'Recently';\r\n\r\n        const now = Date.now();\r\n        const diff = now - date.getTime();\r\n        const days = Math.floor(diff / (1000 * 60 * 60 * 24));\r\n\r\n        if (days === 0) return 'Today';\r\n        if (days === 1) return 'Yesterday';\r\n        if (days < 7) return `${days} days ago`;\r\n        if (days < 30) return `${Math.floor(days / 7)} weeks ago`;\r\n        if (days < 365) return `${Math.floor(days / 30)} months ago`;\r\n        return `${Math.floor(days / 365)} years ago`;\r\n    };\r\n\r\n    if (authLoading || !isAdmin) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96\">\r\n                <div className=\"animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"p-6 space-y-6\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold text-neutral-900 dark:text-white\">User Management</h1>\r\n                    <p className=\"text-neutral-600 dark:text-neutral-400 text-sm\">\r\n                        {data ? `${data.total} users total` : 'Loading...'}\r\n                    </p>\r\n                </div>\r\n                <button\r\n                    onClick={fetchUsers}\r\n                    disabled={isLoading}\r\n                    className=\"flex items-center gap-2 px-3 py-2 bg-neutral-200 dark:bg-neutral-800 hover:bg-neutral-300 dark:hover:bg-neutral-700 text-neutral-900 dark:text-white rounded-lg text-sm transition-colors\"\r\n                >\r\n                    <RefreshCw size={16} className={isLoading ? 'animate-spin' : ''} />\r\n                    Refresh\r\n                </button>\r\n            </div>\r\n\r\n            {/* Search & Filters */}\r\n            <div className=\"flex flex-col sm:flex-row gap-4\">\r\n                <form onSubmit={handleSearch} className=\"flex-1\">\r\n                    <div className=\"relative\">\r\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500\" size={18} />\r\n                        <input\r\n                            type=\"text\"\r\n                            value={search}\r\n                            onChange={(e) => setSearch(e.target.value)}\r\n                            placeholder=\"Search by name or email...\"\r\n                            className=\"w-full pl-10 pr-4 py-2.5 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-lg text-neutral-900 dark:text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                    </div>\r\n                </form>\r\n                <div className=\"flex gap-2\">\r\n                    {(['all', 'student', 'admin'] as const).map((role) => (\r\n                        <button\r\n                            key={role}\r\n                            onClick={() => { setRoleFilter(role); setPage(1); }}\r\n                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${roleFilter === role\r\n                                ? 'bg-blue-600 text-white'\r\n                                : 'bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white'\r\n                                }`}\r\n                        >\r\n                            {role === 'all' ? 'All' : role.charAt(0).toUpperCase() + role.slice(1)}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            {error && (\r\n                <div className=\"p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-600 dark:text-red-400\">\r\n                    {error}\r\n                </div>\r\n            )}\r\n\r\n            {/* Users Table */}\r\n            <div className=\"bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-xl overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-sm\">\r\n                        <thead>\r\n                            <tr className=\"text-left text-neutral-500 border-b border-neutral-200 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-900/50\">\r\n                                <th className=\"px-4 py-3\">User</th>\r\n                                <th className=\"px-4 py-3\">Email</th>\r\n                                <th className=\"px-4 py-3\">Courses</th>\r\n                                <th className=\"px-4 py-3\">Joined</th>\r\n                                <th className=\"px-4 py-3\">Actions</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"text-neutral-700 dark:text-neutral-300\">\r\n                            {isLoading ? (\r\n                                <tr>\r\n                                    <td colSpan={5} className=\"px-4 py-8 text-center text-neutral-500\">\r\n                                        Loading...\r\n                                    </td>\r\n                                </tr>\r\n                            ) : data?.users.length === 0 ? (\r\n                                <tr>\r\n                                    <td colSpan={5} className=\"px-4 py-8 text-center text-neutral-500\">\r\n                                        No users found\r\n                                    </td>\r\n                                </tr>\r\n                            ) : (\r\n                                data?.users.map((user) => (\r\n                                    <tr key={user.id} className=\"border-b border-neutral-100 dark:border-neutral-800/50 hover:bg-neutral-50 dark:hover:bg-neutral-800/30\">\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                {user.avatar ? (\r\n                                                    <img\r\n                                                        src={user.avatar}\r\n                                                        alt={user.name}\r\n                                                        className=\"w-8 h-8 rounded-full object-cover\"\r\n                                                    />\r\n                                                ) : (\r\n                                                    <div className=\"w-8 h-8 rounded-full bg-neutral-200 dark:bg-neutral-700 flex items-center justify-center\">\r\n                                                        <UserIcon size={16} className=\"text-neutral-500 dark:text-neutral-400\" />\r\n                                                    </div>\r\n                                                )}\r\n                                                <span className=\"font-medium text-neutral-900 dark:text-white\">{user.name || 'Unknown'}</span>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-neutral-600 dark:text-neutral-400\">{user.email}</td>\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <span className=\"text-blue-600 dark:text-blue-400\">\r\n                                                {user.enrolledCourses?.length || 0} courses\r\n                                            </span>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-neutral-600 dark:text-neutral-400\">\r\n                                            {formatJoinDate(user.createdAt)}\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <Link\r\n                                                href={`/users/${user.id}`}\r\n                                                className=\"text-blue-600 dark:text-blue-400 hover:underline text-sm\"\r\n                                            >\r\n                                                View\r\n                                            </Link>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n\r\n                {/* Pagination */}\r\n                {data && data.pages > 1 && (\r\n                    <div className=\"flex items-center justify-between px-4 py-3 border-t border-neutral-200 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-900/30\">\r\n                        <span className=\"text-neutral-500 text-sm\">\r\n                            Page {data.page} of {data.pages}\r\n                        </span>\r\n                        <div className=\"flex gap-2\">\r\n                            <button\r\n                                onClick={() => setPage(p => Math.max(1, p - 1))}\r\n                                disabled={page <= 1}\r\n                                className=\"p-2 bg-neutral-200 dark:bg-neutral-800 hover:bg-neutral-300 dark:hover:bg-neutral-700 rounded disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                            >\r\n                                <ChevronLeft size={16} />\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setPage(p => Math.min(data.pages, p + 1))}\r\n                                disabled={page >= data.pages}\r\n                                className=\"p-2 bg-neutral-200 dark:bg-neutral-800 hover:bg-neutral-300 dark:hover:bg-neutral-700 rounded disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                            >\r\n                                <ChevronRight size={16} />\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(auth)\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'firebaseAuth' is defined but never used.","line":13,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sessionLoading' is assigned a value but never used.","line":20,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { useAnime } from \"@/components/animations/useAnime\";\r\nimport { useState, FormEvent, useEffect, useRef, Suspense } from \"react\";\r\nimport { Loader2, Mail, Lock, AlertCircle, User as UserIcon, Eye, EyeOff, Check, X, Shield, FileText } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { useSession } from \"@/components/providers/SessionProvider\";\r\nimport { firebaseAuth } from \"@/lib/firebase/auth\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nfunction LoginPageContent() {\r\n    const { error: authError, login: authLogin, signup: authSignup } = useAuth();\r\n    const { user: sessionUser, isLoading: sessionLoading } = useSession();\r\n    const searchParams = useSearchParams();\r\n    const router = useRouter();\r\n    const [email, setEmail] = useState(\"\");\r\n    const [password, setPassword] = useState(\"\");\r\n    const [confirmPassword, setConfirmPassword] = useState(\"\");\r\n    const [name, setName] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [mode, setMode] = useState<\"login\" | \"signup\">(\"login\");\r\n    const [showPassword, setShowPassword] = useState(false);\r\n    const [showConfirmPassword, setShowConfirmPassword] = useState(false);\r\n    const [isRecoveringSession, setIsRecoveringSession] = useState(false);\r\n    const [tosAccepted, setTosAccepted] = useState(false);\r\n    const [showTosModal, setShowTosModal] = useState(false);\r\n    const sessionRecoveryAttempted = useRef(false);\r\n\r\n    // Session recovery: After hard refresh, Firebase Auth restores the user from IndexedDB\r\n    // but the server-side cookie (firebase-token) may be missing/expired\r\n    // This effect detects when SessionProvider has restored the user and redirects back\r\n    useEffect(() => {\r\n        // Only attempt recovery once per page load\r\n        if (sessionRecoveryAttempted.current) return;\r\n\r\n        // If session was restored (user exists), redirect to where they were going\r\n        if (sessionUser) {\r\n            sessionRecoveryAttempted.current = true;\r\n            const redirect = searchParams.get('redirect') || '/user';\r\n            logger.info('Session recovered on login page, redirecting back...', { redirect }, 'LoginPage');\r\n            setIsRecoveringSession(true);\r\n\r\n            // The SessionProvider already refreshed the cookie, just redirect\r\n            router.replace(redirect);\r\n        }\r\n    }, [sessionUser, searchParams, router]);\r\n\r\n    useAnime(\".login-card\", {\r\n        translateY: [20, 0],\r\n        opacity: [0, 1],\r\n        ease: \"out-expo\",\r\n        duration: 1000,\r\n        delay: 200,\r\n    });\r\n\r\n\r\n    const validatePassword = (pwd: string): string | null => {\r\n        if (pwd.length < 8) return \"Password must be at least 8 characters\";\r\n        if (!/[A-Z]/.test(pwd)) return \"Password must contain at least one uppercase letter\";\r\n        if (!/[0-9]/.test(pwd)) return \"Password must contain at least one number\";\r\n        return null;\r\n    };\r\n\r\n    const handleSubmit = async (e: FormEvent) => {\r\n        e.preventDefault();\r\n        setError(null);\r\n\r\n        if (mode === \"signup\") {\r\n            // Validate password\r\n            const passwordError = validatePassword(password);\r\n            if (passwordError) {\r\n                setError(passwordError);\r\n                return;\r\n            }\r\n\r\n            // Check confirm password\r\n            if (password !== confirmPassword) {\r\n                setError(\"Passwords don't match\");\r\n                return;\r\n            }\r\n        }\r\n\r\n        setIsLoading(true);\r\n\r\n        try {\r\n            if (mode === \"signup\") {\r\n                await authSignup(email, password, name);\r\n                // Don't set isLoading(false) here - AuthContext handles redirect\r\n                // Setting it false might re-enable button before redirect completes\r\n            } else {\r\n                await authLogin(email, password);\r\n                // Same for login - AuthContext handles redirect\r\n            }\r\n        } catch (err) {\r\n            const errorMessage = err instanceof Error ? err.message : \"Authentication failed\";\r\n            setError(errorMessage);\r\n            setIsLoading(false); // Only reset loading on error\r\n        }\r\n    };\r\n\r\n    const handleGoogleSignIn = async () => {\r\n        setIsLoading(true);\r\n        setError(null);\r\n\r\n        try {\r\n            const user = await hybridStorage.auth.signInWithGoogle();\r\n            router.push(user.role === \"admin\" ? \"/dashboard\" : \"/user\");\r\n        } catch (err) {\r\n            const errorMessage = err instanceof Error ? err.message : \"Google sign-in failed\";\r\n            setError(errorMessage);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    // Show loading state ONLY during active session recovery (user was already logged in)\r\n    // Don't block on sessionLoading - users visiting login page should see the form immediately\r\n    if (isRecoveringSession) {\r\n        return (\r\n            <div className=\"flex min-h-screen items-center justify-center p-4 bg-neutral-50 dark:bg-neutral-950\">\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                    <Loader2 className=\"h-8 w-8 animate-spin text-blue-600 dark:text-white\" />\r\n                    <p className=\"text-neutral-600 dark:text-neutral-400\">\r\n                        Restoring your session...\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex min-h-screen items-center justify-center p-4 bg-neutral-50 dark:bg-neutral-950\">\r\n            {/* Back to Home */}\r\n            <Link\r\n                href=\"/\"\r\n                className=\"fixed top-4 left-4 text-sm font-medium text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors\"\r\n            >\r\n                â† Back to Home\r\n            </Link>\r\n\r\n            <Card className=\"login-card w-full max-w-md border-neutral-200 dark:border-white/10 bg-white dark:bg-black/40 backdrop-blur-xl shadow-2xl opacity-0\">\r\n                <CardHeader className=\"text-center space-y-1\">\r\n                    <CardTitle className=\"text-3xl font-bold tracking-tight text-neutral-900 dark:text-white mb-2\">\r\n                        {mode === \"signup\" ? \"Create Account\" : \"Welcome Back\"}\r\n                    </CardTitle>\r\n                    <CardDescription className=\"text-neutral-500 dark:text-neutral-400\">\r\n                        {mode === \"signup\" ? \"Join Gakuen to start learning\" : \"Sign in to continue your journey\"}\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4 pt-4\">\r\n                    <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n                        {mode === \"signup\" && (\r\n                            <div className=\"space-y-2\">\r\n                                <label htmlFor=\"name\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                    Full Name\r\n                                </label>\r\n                                <div className=\"relative\">\r\n                                    <UserIcon className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-neutral-400 dark:text-neutral-500\" />\r\n                                    <input\r\n                                        id=\"name\"\r\n                                        type=\"text\"\r\n                                        value={name}\r\n                                        onChange={(e) => setName(e.target.value)}\r\n                                        placeholder=\"Yuki Tanaka\"\r\n                                        required\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <label htmlFor=\"email\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                Email Address\r\n                            </label>\r\n                            <div className=\"relative\">\r\n                                <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-neutral-400 dark:text-neutral-500\" />\r\n                                <input\r\n                                    id=\"email\"\r\n                                    type=\"email\"\r\n                                    value={email}\r\n                                    onChange={(e) => setEmail(e.target.value)}\r\n                                    placeholder=\"student@gakuen.edu\"\r\n                                    required\r\n                                    className=\"w-full pl-10 pr-4 py-2.5 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <label htmlFor=\"password\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                Password\r\n                            </label>\r\n                            <div className=\"relative\">\r\n                                <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-neutral-400 dark:text-neutral-500\" />\r\n                                <input\r\n                                    id=\"password\"\r\n                                    type={showPassword ? \"text\" : \"password\"}\r\n                                    value={password}\r\n                                    onChange={(e) => setPassword(e.target.value)}\r\n                                    placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\r\n                                    required\r\n                                    minLength={mode === \"signup\" ? 8 : 6}\r\n                                    className=\"w-full pl-10 pr-11 py-2.5 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                />\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setShowPassword(!showPassword)}\r\n                                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 dark:text-neutral-500 hover:text-neutral-600 dark:hover:text-neutral-300 transition-colors\"\r\n                                >\r\n                                    {showPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\r\n                                </button>\r\n                            </div>\r\n                            {mode === \"signup\" && password.length > 0 && (\r\n                                <div className=\"space-y-1.5\">\r\n                                    <div className=\"flex items-center gap-2 text-xs\">\r\n                                        {password.length >= 8 ? (\r\n                                            <Check className=\"w-3.5 h-3.5 text-green-500\" />\r\n                                        ) : (\r\n                                            <X className=\"w-3.5 h-3.5 text-neutral-400\" />\r\n                                        )}\r\n                                        <span className={password.length >= 8 ? \"text-green-600 dark:text-green-400\" : \"text-neutral-500\"}>8+ characters</span>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2 text-xs\">\r\n                                        {/[A-Z]/.test(password) ? (\r\n                                            <Check className=\"w-3.5 h-3.5 text-green-500\" />\r\n                                        ) : (\r\n                                            <X className=\"w-3.5 h-3.5 text-neutral-400\" />\r\n                                        )}\r\n                                        <span className={/[A-Z]/.test(password) ? \"text-green-600 dark:text-green-400\" : \"text-neutral-500\"}>1 uppercase letter</span>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2 text-xs\">\r\n                                        {/[0-9]/.test(password) ? (\r\n                                            <Check className=\"w-3.5 h-3.5 text-green-500\" />\r\n                                        ) : (\r\n                                            <X className=\"w-3.5 h-3.5 text-neutral-400\" />\r\n                                        )}\r\n                                        <span className={/[0-9]/.test(password) ? \"text-green-600 dark:text-green-400\" : \"text-neutral-500\"}>1 number</span>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {mode === \"signup\" && (\r\n                            <div className=\"space-y-2\">\r\n                                <label htmlFor=\"confirmPassword\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                    Confirm Password\r\n                                </label>\r\n                                <div className=\"relative\">\r\n                                    <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-neutral-400 dark:text-neutral-500\" />\r\n                                    <input\r\n                                        id=\"confirmPassword\"\r\n                                        type={showConfirmPassword ? \"text\" : \"password\"}\r\n                                        value={confirmPassword}\r\n                                        onChange={(e) => setConfirmPassword(e.target.value)}\r\n                                        placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\r\n                                        required\r\n                                        minLength={8}\r\n                                        className=\"w-full pl-10 pr-11 py-2.5 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                    />\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => setShowConfirmPassword(!showConfirmPassword)}\r\n                                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 dark:text-neutral-500 hover:text-neutral-600 dark:hover:text-neutral-300 transition-colors\"\r\n                                    >\r\n                                        {showConfirmPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* TOS Checkbox - Only for signup */}\r\n                        {mode === \"signup\" && (\r\n                            <div className=\"space-y-2 pt-2\">\r\n                                <div className=\"flex items-start gap-3\">\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => {\r\n                                            if (!tosAccepted) {\r\n                                                setShowTosModal(true);\r\n                                            } else {\r\n                                                setTosAccepted(false);\r\n                                            }\r\n                                        }}\r\n                                        className={`mt-0.5 flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${tosAccepted\r\n                                            ? 'bg-blue-600 border-blue-600 dark:bg-white dark:border-white'\r\n                                            : 'border-neutral-300 dark:border-white/30 hover:border-blue-500'\r\n                                            }`}\r\n                                    >\r\n                                        {tosAccepted && <Check className=\"w-3 h-3 text-white dark:text-black\" />}\r\n                                    </button>\r\n                                    <label className=\"text-sm text-neutral-600 dark:text-neutral-400 leading-relaxed\">\r\n                                        I agree to the{' '}\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => setShowTosModal(true)}\r\n                                            className=\"text-blue-600 dark:text-blue-400 hover:underline font-medium\"\r\n                                        >\r\n                                            Terms of Service\r\n                                        </button>{' '}\r\n                                        and{' '}\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => setShowTosModal(true)}\r\n                                            className=\"text-blue-600 dark:text-blue-400 hover:underline font-medium\"\r\n                                        >\r\n                                            Privacy Policy\r\n                                        </button>\r\n                                    </label>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {(error || authError) && (\r\n                            <div className=\"flex items-center gap-2 p-3 bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/20 rounded-lg\">\r\n                                <AlertCircle className=\"h-4 w-4 text-red-500 dark:text-red-400 flex-shrink-0\" />\r\n                                <p className=\"text-sm text-red-600 dark:text-red-400\">{error || authError}</p>\r\n                            </div>\r\n                        )}\r\n\r\n                        <Button\r\n                            type=\"submit\"\r\n                            disabled={isLoading || (mode === \"signup\" && !tosAccepted)}\r\n                            className={`w-full h-11 font-medium transition-all ${(mode === \"signup\" && !tosAccepted)\r\n                                ? 'bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed'\r\n                                : 'bg-blue-600 text-white hover:bg-blue-700 dark:bg-white dark:text-black dark:hover:bg-neutral-200'\r\n                                }`}\r\n                        >\r\n                            {isLoading ? (\r\n                                <>\r\n                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                    {mode === \"signup\" ? \"Creating account...\" : \"Signing in...\"}\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    {mode === \"signup\" && !tosAccepted && <Shield className=\"mr-2 h-4 w-4\" />}\r\n                                    {mode === \"signup\" ? (tosAccepted ? \"Create Account\" : \"Accept Terms to Continue\") : \"Sign In\"}\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </form>\r\n\r\n                    <div className=\"relative\">\r\n                        <div className=\"absolute inset-0 flex items-center\">\r\n                            <span className=\"w-full border-t border-neutral-200 dark:border-white/10\" />\r\n                        </div>\r\n                        <div className=\"relative flex justify-center text-xs uppercase\">\r\n                            <span className=\"bg-white dark:bg-black/40 px-2 text-neutral-500 dark:text-neutral-600\">Or continue with</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <Button\r\n                        type=\"button\"\r\n                        variant=\"outline\"\r\n                        onClick={handleGoogleSignIn}\r\n                        disabled={isLoading}\r\n                        className=\"w-full h-11 border-neutral-200 dark:border-white/10 hover:bg-neutral-100 dark:hover:bg-white/5 text-neutral-700 dark:text-neutral-300\"\r\n                    >\r\n                        <svg className=\"mr-2 h-5 w-5\" viewBox=\"0 0 24 24\">\r\n                            <path fill=\"#4285F4\" d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\" />\r\n                            <path fill=\"#34A853\" d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\" />\r\n                            <path fill=\"#FBBC05\" d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\" />\r\n                            <path fill=\"#EA4335\" d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\" />\r\n                        </svg>\r\n                        Sign in with Google\r\n                    </Button>\r\n\r\n                    <div className=\"text-center text-sm\">\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => setMode(mode === \"login\" ? \"signup\" : \"login\")}\r\n                            className=\"text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors\"\r\n                        >\r\n                            {mode === \"login\" ? \"Don't have an account? \" : \"Already have an account? \"}\r\n                            <span className=\"text-blue-600 dark:text-white font-medium\">\r\n                                {mode === \"login\" ? \"Sign up\" : \"Sign in\"}\r\n                            </span>\r\n                        </button>\r\n                    </div>\r\n\r\n                    <p className=\"text-xs text-center text-neutral-400 dark:text-neutral-600\">\r\n                        Demo: student@gakuen.edu / any password (6+ chars)\r\n                    </p>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* TOS Modal */}\r\n            {showTosModal && (\r\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm\">\r\n                    <div className=\"w-full max-w-2xl max-h-[80vh] bg-white dark:bg-neutral-900 rounded-xl shadow-2xl border border-neutral-200 dark:border-white/10 flex flex-col\">\r\n                        {/* Header */}\r\n                        <div className=\"flex items-center gap-3 p-6 border-b border-neutral-200 dark:border-white/10\">\r\n                            <div className=\"w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-500/20 flex items-center justify-center\">\r\n                                <FileText className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\r\n                            </div>\r\n                            <div>\r\n                                <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">Terms of Service & Privacy Policy</h2>\r\n                                <p className=\"text-sm text-neutral-500 dark:text-neutral-400\">Please read carefully before proceeding</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Content */}\r\n                        <div className=\"flex-1 overflow-y-auto p-6 space-y-6 text-sm text-neutral-700 dark:text-neutral-300\">\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">1. Acceptance of Terms</h3>\r\n                                <p>By accessing or using Gakuen (&quot;the Service&quot;), you agree to be bound by these Terms of Service. If you do not agree to these terms, you may not access or use the Service. These terms constitute a legally binding agreement between you and Gakuen.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">2. Description of Service</h3>\r\n                                <p>Gakuen provides an AI-powered educational platform including but not limited to: AI tutoring services, course materials, progress tracking, and personalized learning experiences. The Service is provided &quot;as is&quot; and we reserve the right to modify, suspend, or discontinue any part of the Service at any time.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">3. User Accounts</h3>\r\n                                <p>You are responsible for maintaining the confidentiality of your account credentials and for all activities that occur under your account. You must provide accurate, current, and complete information during registration. You may not share your account with others or allow unauthorized access.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">4. Privacy & Data Collection</h3>\r\n                                <p>We collect and process personal data as described in our Privacy Policy. By using the Service, you consent to: (a) Collection of usage data, learning progress, and interaction patterns; (b) Processing of data by AI systems for personalization; (c) Storage of data on secure cloud servers; (d) Use of anonymized data for service improvement.</p>\r\n                            </section>\r\n\r\n                            <section className=\"p-4 bg-amber-50 dark:bg-amber-500/10 rounded-lg border border-amber-200 dark:border-amber-500/20\">\r\n                                <h3 className=\"font-bold text-amber-800 dark:text-amber-300 mb-2\">âš ï¸ AI-Generated Content Notice</h3>\r\n                                <p className=\"text-amber-700 dark:text-amber-400\">ALL CONTENT ON GAKUEN IS GENERATED BY ARTIFICIAL INTELLIGENCE. AI-generated content is not protected by copyright law. If you believe any content resembles your copyrighted work, please contact us immediately and we will review and remove it.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">6. Intellectual Property</h3>\r\n                                <p>AI-generated content provided through this Service is not claimed as copyrighted material. You may use AI-generated educational content for personal learning purposes. However, the platform design, branding, and non-AI elements remain our property.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">7. Payment & Refunds</h3>\r\n                                <p>Paid features are billed in advance on a subscription basis. Refunds are provided in accordance with applicable law. We reserve the right to change pricing with 30 days notice. Continued use after price changes constitutes acceptance.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">8. Limitation of Liability</h3>\r\n                                <p>TO THE MAXIMUM EXTENT PERMITTED BY LAW, GAKUEN SHALL NOT BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, INCLUDING BUT NOT LIMITED TO LOSS OF PROFITS, DATA, OR GOODWILL. OUR TOTAL LIABILITY SHALL NOT EXCEED THE AMOUNT PAID BY YOU IN THE PAST 12 MONTHS.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">9. Indemnification</h3>\r\n                                <p>You agree to indemnify and hold harmless Gakuen and its officers, directors, employees, and agents from any claims, damages, losses, or expenses arising from your use of the Service or violation of these Terms.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">10. Governing Law</h3>\r\n                                <p>These Terms shall be governed by and construed in accordance with the laws of the jurisdiction in which Gakuen operates, without regard to conflict of law principles. Any disputes shall be resolved through binding arbitration.</p>\r\n                            </section>\r\n\r\n                            <section>\r\n                                <h3 className=\"font-bold text-neutral-900 dark:text-white mb-2\">11. Changes to Terms</h3>\r\n                                <p>We reserve the right to modify these Terms at any time. We will notify users of material changes via email or through the Service. Continued use after changes constitute acceptance of the new Terms.</p>\r\n                            </section>\r\n\r\n                            <section className=\"bg-neutral-100 dark:bg-white/5 p-4 rounded-lg border border-neutral-200 dark:border-white/10\">\r\n                                <p className=\"text-xs text-neutral-500 dark:text-neutral-400\">Last updated: January 2025. By clicking &quot;I Accept&quot; below, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service and Privacy Policy.</p>\r\n                            </section>\r\n                        </div>\r\n\r\n                        {/* Footer */}\r\n                        <div className=\"flex items-center gap-3 p-6 border-t border-neutral-200 dark:border-white/10\">\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                onClick={() => setShowTosModal(false)}\r\n                                className=\"flex-1 h-11 border-neutral-200 dark:border-white/10\"\r\n                            >\r\n                                Cancel\r\n                            </Button>\r\n                            <Button\r\n                                onClick={() => {\r\n                                    setTosAccepted(true);\r\n                                    setShowTosModal(false);\r\n                                }}\r\n                                className=\"flex-1 h-11 bg-blue-600 hover:bg-blue-700 dark:bg-white dark:hover:bg-neutral-200 text-white dark:text-black font-medium\"\r\n                            >\r\n                                <Check className=\"mr-2 h-4 w-4\" />\r\n                                I Accept\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function LoginPage() {\r\n    return (\r\n        <Suspense fallback={\r\n            <div className=\"flex min-h-screen items-center justify-center p-4 bg-neutral-50 dark:bg-neutral-950\">\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                    <Loader2 className=\"h-8 w-8 animate-spin text-blue-600 dark:text-white\" />\r\n                    <p className=\"text-neutral-600 dark:text-neutral-400\">\r\n                        Loading...\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        }>\r\n            <LoginPageContent />\r\n        </Suspense>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(checkout)\\checkout\\[courseId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cvvValidation' is assigned a value but never used.","line":71,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5055,5058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5055,5058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6708,6711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6708,6711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useMemo, useRef } from \"react\";\r\nimport { useParams, useRouter } from \"next/navigation\";\r\nimport { ArrowLeft, Check, Lock, CreditCard as CreditCardIcon, Tag, Loader2, CheckCircle, Clock, Users, Star, Shield } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport Link from \"next/link\";\r\nimport Image from \"next/image\";\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { CardBrandIcon } from \"@/components/payment/CardBrandIcon\";\r\nimport {\r\n    detectCardBrand,\r\n    validateCardNumber,\r\n    validateExpiry,\r\n    validateCVV,\r\n    formatCardNumber,\r\n    formatExpiry,\r\n} from \"@/lib/payment/card-validator\";\r\n\r\ninterface Course {\r\n    id: string;\r\n    title: string;\r\n    description: string;\r\n    instructor: string;\r\n    thumbnail: string;\r\n    duration: string;\r\n    enrolledCount: number;\r\n    rating: number;\r\n    price: number;\r\n    originalPrice?: number;\r\n    lessonsCount: number;\r\n}\r\n\r\ntype CheckoutStep = 'payment' | 'success' | 'review' | 'coupon';\r\n\r\nexport default function CourseCheckoutPage() {\r\n    const params = useParams();\r\n    const router = useRouter();\r\n    const { refreshUser } = useAuth();\r\n    const courseId = params.courseId as string;\r\n\r\n    const [course, setCourse] = useState<Course | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [step, setStep] = useState<CheckoutStep>('payment');\r\n\r\n    // Coupon\r\n    const [couponCode, setCouponCode] = useState(\"\");\r\n    const [couponApplied, setCouponApplied] = useState<{ code: string; discount: number } | null>(null);\r\n    const [couponError, setCouponError] = useState(\"\");\r\n    const [couponLoading, setCouponLoading] = useState(false);\r\n\r\n    // Payment\r\n    const [cardNumber, setCardNumber] = useState(\"\");\r\n    const [expiry, setExpiry] = useState(\"\");\r\n    const [cvv, setCvv] = useState(\"\");\r\n    const [name, setName] = useState(\"\");\r\n    const [paymentError, setPaymentError] = useState(\"\");\r\n    const [processing, setProcessing] = useState(false);\r\n\r\n    // CRITICAL: Ref-based lock to prevent double payment even if disabled state is bypassed\r\n    const paymentInFlightRef = useRef(false);\r\n\r\n    // Card validation - MUST be before any early returns\r\n    const cardBrand = useMemo(() => detectCardBrand(cardNumber), [cardNumber]);\r\n    const cardValidation = useMemo(() => validateCardNumber(cardNumber), [cardNumber]);\r\n    const expiryValidation = useMemo(() => validateExpiry(expiry), [expiry]);\r\n    const cvvValidation = useMemo(() => validateCVV(cvv, cardBrand), [cvv, cardBrand]);\r\n\r\n    useEffect(() => {\r\n        const fetchCourse = async () => {\r\n            try {\r\n                const res = await fetch(`/api/courses/${courseId}`);\r\n                if (res.ok) {\r\n                    const data = await res.json();\r\n                    setCourse(data);\r\n                }\r\n            } catch (error) {\r\n                console.error('Failed to fetch course:', error);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        if (courseId) {\r\n            fetchCourse();\r\n        }\r\n    }, [courseId]);\r\n\r\n    // Handler functions\r\n    const handleCardChange = (value: string) => {\r\n        setCardNumber(formatCardNumber(value, cardBrand));\r\n    };\r\n\r\n    const handleExpiryChange = (value: string) => {\r\n        setExpiry(formatExpiry(value));\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950 flex items-center justify-center\">\r\n                <Loader2 className=\"w-8 h-8 animate-spin text-blue-600\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!course) {\r\n        return (\r\n            <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950 flex flex-col items-center justify-center\">\r\n                <h1 className=\"text-2xl font-bold mb-4\">Course not found</h1>\r\n                <Link href=\"/browse\"><Button>Browse Courses</Button></Link>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const basePrice = course.price;\r\n    const discountAmount = couponApplied ? (basePrice * couponApplied.discount / 100) : 0;\r\n    const finalPrice = basePrice - discountAmount;\r\n\r\n    const applyCoupon = async () => {\r\n        if (!couponCode.trim()) return;\r\n        setCouponLoading(true);\r\n        setCouponError(\"\");\r\n\r\n        try {\r\n            const res = await fetch('/api/coupons/validate', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ code: couponCode, type: 'course' }),\r\n            });\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.error || 'Invalid coupon');\r\n            setCouponApplied({ code: couponCode, discount: data.discountPercent });\r\n        } catch (err: any) {\r\n            setCouponError(err.message);\r\n        } finally {\r\n            setCouponLoading(false);\r\n        }\r\n    };\r\n\r\n    const handlePayment = async () => {\r\n        setPaymentError(\"\");\r\n\r\n        if (!cardValidation.isValid) {\r\n            setPaymentError(cardValidation.error || \"Please enter a valid card number\");\r\n            return;\r\n        }\r\n        if (!expiryValidation.isValid) {\r\n            setPaymentError(expiryValidation.error || \"Please enter a valid expiry date\");\r\n            return;\r\n        }\r\n        if (cvv.length < 3) {\r\n            setPaymentError(\"Please enter a valid CVV\");\r\n            return;\r\n        }\r\n\r\n        // CRITICAL: Double-click prevention - check ref BEFORE processing state\r\n        if (paymentInFlightRef.current) {\r\n            console.warn('âš ï¸ Payment already in flight, ignoring duplicate click');\r\n            return;\r\n        }\r\n        paymentInFlightRef.current = true;\r\n        setProcessing(true);\r\n\r\n        try {\r\n            const res = await fetch('/api/payments/process', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    courseId: course.id,\r\n                    amount: finalPrice,\r\n                    couponCode: couponApplied?.code,\r\n                }),\r\n            });\r\n\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.error || 'Payment failed');\r\n\r\n            // CRITICAL: Refresh user session so enrolled courses update\r\n            await refreshUser();\r\n\r\n            setStep('success');\r\n        } catch (err: any) {\r\n            setPaymentError(err.message);\r\n        } finally {\r\n            paymentInFlightRef.current = false;\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const steps = [\r\n        { id: 'payment', label: 'Payment' },\r\n        { id: 'success', label: 'Complete' },\r\n    ];\r\n\r\n    const currentStepIndex = steps.findIndex(s => s.id === step);\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950\">\r\n            {/* Header */}\r\n            <header className=\"bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800\">\r\n                <div className=\"max-w-4xl mx-auto px-6 py-4 flex items-center justify-between\">\r\n                    <Link href=\"/browse\" className=\"flex items-center gap-2 text-neutral-600 hover:text-neutral-900 dark:text-neutral-400 dark:hover:text-white\">\r\n                        <ArrowLeft size={20} />\r\n                        <span>Back</span>\r\n                    </Link>\r\n                    <h1 className=\"text-lg font-semibold\">Checkout</h1>\r\n                    <div className=\"w-20\" />\r\n                </div>\r\n            </header>\r\n\r\n            {/* Progress Steps */}\r\n            <div className=\"bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800\">\r\n                <div className=\"max-w-4xl mx-auto px-6 py-4\">\r\n                    <div className=\"flex items-center justify-center gap-2\">\r\n                        {steps.map((s, i) => (\r\n                            <div key={s.id} className=\"flex items-center\">\r\n                                <div className={cn(\r\n                                    \"w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium\",\r\n                                    i < currentStepIndex && \"bg-green-500 text-white\",\r\n                                    i === currentStepIndex && \"bg-blue-600 text-white\",\r\n                                    i > currentStepIndex && \"bg-neutral-200 dark:bg-neutral-800 text-neutral-500\"\r\n                                )}>\r\n                                    {i < currentStepIndex ? <Check size={16} /> : i + 1}\r\n                                </div>\r\n                                <span className={cn(\r\n                                    \"ml-2 text-sm hidden sm:block\",\r\n                                    i === currentStepIndex ? \"text-neutral-900 dark:text-white font-medium\" : \"text-neutral-500\"\r\n                                )}>\r\n                                    {s.label}\r\n                                </span>\r\n                                {i < steps.length - 1 && (\r\n                                    <div className={cn(\r\n                                        \"w-8 md:w-16 h-[2px] mx-2\",\r\n                                        i < currentStepIndex ? \"bg-green-500\" : \"bg-neutral-200 dark:bg-neutral-800\"\r\n                                    )} />\r\n                                )}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content */}\r\n            <main className=\"max-w-4xl mx-auto px-6 py-8\">\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n                    {/* Left: Step Content */}\r\n                    <div className=\"lg:col-span-2\">\r\n                        <AnimatePresence mode=\"wait\">\r\n                            {/* Step 1: Review */}\r\n                            {step === 'review' && (\r\n                                <motion.div\r\n                                    key=\"review\"\r\n                                    initial={{ opacity: 0, x: -20 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: 20 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 overflow-hidden\"\r\n                                >\r\n                                    {/* Course Image */}\r\n                                    <div className=\"relative h-48\">\r\n                                        <Image src={course.thumbnail} alt={course.title} fill className=\"object-cover\" />\r\n                                        <div className=\"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent\" />\r\n                                    </div>\r\n\r\n                                    <div className=\"p-6\">\r\n                                        <h2 className=\"text-xl font-bold mb-2\">{course.title}</h2>\r\n                                        <p className=\"text-neutral-500 text-sm mb-4\">by {course.instructor}</p>\r\n\r\n                                        <div className=\"flex flex-wrap gap-4 mb-6 text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                            <span className=\"flex items-center gap-1\"><Clock size={16} /> {course.duration}</span>\r\n                                            <span className=\"flex items-center gap-1\"><Users size={16} /> {course.enrolledCount} enrolled</span>\r\n                                            <span className=\"flex items-center gap-1 text-amber-500\"><Star size={16} fill=\"currentColor\" /> {course.rating}</span>\r\n                                        </div>\r\n\r\n                                        <div className=\"space-y-2 mb-6\">\r\n                                            <div className=\"flex items-center gap-2\"><CheckCircle size={16} className=\"text-green-500\" /> Lifetime access</div>\r\n                                            <div className=\"flex items-center gap-2\"><CheckCircle size={16} className=\"text-green-500\" /> {course.lessonsCount} lessons</div>\r\n                                            <div className=\"flex items-center gap-2\"><CheckCircle size={16} className=\"text-green-500\" /> AI Assistant (Flash)</div>\r\n                                        </div>\r\n\r\n                                        <Button onClick={() => setStep('coupon')} className=\"w-full h-12\">\r\n                                            Continue\r\n                                        </Button>\r\n                                    </div>\r\n                                </motion.div>\r\n                            )}\r\n\r\n                            {/* Step 2: Coupon */}\r\n                            {step === 'coupon' && (\r\n                                <motion.div\r\n                                    key=\"coupon\"\r\n                                    initial={{ opacity: 0, x: -20 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: 20 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6\"\r\n                                >\r\n                                    <h2 className=\"text-xl font-semibold mb-6\">Have a Coupon?</h2>\r\n\r\n                                    <div className=\"flex gap-3 mb-4\">\r\n                                        <div className=\"relative flex-1\">\r\n                                            <Tag className=\"absolute left-3 top-3 text-neutral-400\" size={18} />\r\n                                            <Input\r\n                                                placeholder=\"Enter coupon code\"\r\n                                                className=\"pl-10 uppercase\"\r\n                                                value={couponCode}\r\n                                                onChange={(e) => setCouponCode(e.target.value.toUpperCase())}\r\n                                                disabled={!!couponApplied}\r\n                                            />\r\n                                        </div>\r\n                                        <Button variant=\"outline\" onClick={applyCoupon} disabled={couponLoading || !!couponApplied}>\r\n                                            {couponLoading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : 'Apply'}\r\n                                        </Button>\r\n                                    </div>\r\n\r\n                                    {couponError && <p className=\"text-sm text-red-500 mb-4\">{couponError}</p>}\r\n                                    {couponApplied && (\r\n                                        <div className=\"p-3 bg-green-50 dark:bg-green-900/20 text-green-700 rounded-xl flex items-center gap-2 mb-4\">\r\n                                            <CheckCircle size={18} />\r\n                                            <span className=\"text-sm font-medium\">{couponApplied.discount}% discount applied!</span>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <div className=\"flex gap-3\">\r\n                                        <Button variant=\"outline\" onClick={() => setStep('review')} className=\"flex-1\">Back</Button>\r\n                                        <Button onClick={() => setStep('payment')} className=\"flex-1\">Continue</Button>\r\n                                    </div>\r\n                                </motion.div>\r\n                            )}\r\n\r\n                            {/* Step 3: Payment */}\r\n                            {step === 'payment' && (\r\n                                <motion.div\r\n                                    key=\"payment\"\r\n                                    initial={{ opacity: 0, x: -20 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: 20 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6\"\r\n                                >\r\n                                    <h2 className=\"text-xl font-semibold mb-6\">Payment Details</h2>\r\n\r\n                                    {paymentError && (\r\n                                        <div className=\"p-3 mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 rounded-xl text-sm\">{paymentError}</div>\r\n                                    )}\r\n\r\n                                    <div className=\"space-y-4 mb-6\">\r\n                                        <div>\r\n                                            <Label>Cardholder Name</Label>\r\n                                            <Input placeholder=\"John Doe\" value={name} onChange={(e) => setName(e.target.value)} />\r\n                                        </div>\r\n                                        <div>\r\n                                            <Label>Card Number</Label>\r\n                                            <div className=\"relative\">\r\n                                                <CreditCardIcon className=\"absolute left-3 top-3 text-neutral-400\" size={18} />\r\n                                                <Input\r\n                                                    className={cn(\r\n                                                        \"pl-10 font-mono\",\r\n                                                        cardValidation.isValid && \"border-green-500\",\r\n                                                        cardValidation.error && \"border-red-500\"\r\n                                                    )}\r\n                                                    placeholder=\"4242 4242 4242 4242\"\r\n                                                    value={cardNumber}\r\n                                                    onChange={(e) => handleCardChange(e.target.value)}\r\n                                                />\r\n                                                <CardBrandIcon brand={cardBrand?.brand} className=\"absolute right-3 top-2.5 w-6 h-6\" />\r\n                                            </div>\r\n                                        </div>\r\n                                        <div className=\"grid grid-cols-2 gap-4\">\r\n                                            <div>\r\n                                                <Label>Expiry</Label>\r\n                                                <Input\r\n                                                    className={cn(\r\n                                                        \"font-mono\",\r\n                                                        expiryValidation.isValid && \"border-green-500\",\r\n                                                        expiryValidation.error && \"border-red-500\"\r\n                                                    )}\r\n                                                    placeholder=\"MM/YY\"\r\n                                                    value={expiry}\r\n                                                    onChange={(e) => handleExpiryChange(e.target.value)}\r\n                                                />\r\n                                            </div>\r\n                                            <div>\r\n                                                <Label>CVV</Label>\r\n                                                <Input className=\"font-mono\" type=\"password\" placeholder=\"123\" maxLength={4} value={cvv} onChange={(e) => setCvv(e.target.value.replace(/\\D/g, ''))} />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"flex gap-3\">\r\n                                        <Button variant=\"outline\" onClick={() => setStep('coupon')} className=\"flex-1\" disabled={processing}>Back</Button>\r\n                                        <Button onClick={handlePayment} className=\"flex-1 bg-gradient-to-r from-green-600 to-emerald-600\" disabled={processing}>\r\n                                            {processing ? <Loader2 className=\"w-4 h-4 animate-spin mr-2\" /> : <Lock className=\"w-4 h-4 mr-2\" />}\r\n                                            Pay ${finalPrice.toFixed(2)}\r\n                                        </Button>\r\n                                    </div>\r\n                                </motion.div>\r\n                            )}\r\n\r\n                            {/* Step 4: Success */}\r\n                            {step === 'success' && (\r\n                                <motion.div\r\n                                    key=\"success\"\r\n                                    initial={{ opacity: 0, scale: 0.95 }}\r\n                                    animate={{ opacity: 1, scale: 1 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-8 text-center\"\r\n                                >\r\n                                    <motion.div\r\n                                        initial={{ scale: 0 }}\r\n                                        animate={{ scale: 1 }}\r\n                                        transition={{ delay: 0.2, type: \"spring\" }}\r\n                                        className=\"w-20 h-20 mx-auto bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-6\"\r\n                                    >\r\n                                        <CheckCircle className=\"w-10 h-10 text-green-600\" />\r\n                                    </motion.div>\r\n                                    <h2 className=\"text-2xl font-bold mb-2\">You're Enrolled!</h2>\r\n                                    <p className=\"text-neutral-500 mb-8\">Start learning {course.title} now</p>\r\n                                    <Button onClick={() => router.push(`/class/${course.id}`)} className=\"bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8\">\r\n                                        Start Learning\r\n                                    </Button>\r\n                                </motion.div>\r\n                            )}\r\n                        </AnimatePresence>\r\n                    </div>\r\n\r\n                    {/* Right: Order Summary */}\r\n                    <div>\r\n                        <div className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6 sticky top-24\">\r\n                            <h3 className=\"font-semibold mb-4\">Order Summary</h3>\r\n\r\n                            <div className=\"flex items-center gap-3 mb-4 pb-4 border-b border-neutral-100 dark:border-neutral-800\">\r\n                                <div className=\"relative w-16 h-12 rounded-lg overflow-hidden\">\r\n                                    <Image src={course.thumbnail} alt={course.title} fill className=\"object-cover\" />\r\n                                </div>\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                    <p className=\"font-medium text-sm truncate\">{course.title}</p>\r\n                                    <p className=\"text-xs text-neutral-500\">{course.instructor}</p>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-2 text-sm\">\r\n                                <div className=\"flex justify-between\">\r\n                                    <span className=\"text-neutral-500\">Price</span>\r\n                                    <span>${course.price.toFixed(2)}</span>\r\n                                </div>\r\n                                {couponApplied && (\r\n                                    <div className=\"flex justify-between text-green-600\">\r\n                                        <span>Discount ({couponApplied.discount}%)</span>\r\n                                        <span>-${discountAmount.toFixed(2)}</span>\r\n                                    </div>\r\n                                )}\r\n                                <div className=\"pt-2 border-t border-neutral-100 dark:border-neutral-800 flex justify-between font-semibold text-lg\">\r\n                                    <span>Total</span>\r\n                                    <span className=\"text-green-600\">${finalPrice.toFixed(2)}</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"mt-4 pt-4 border-t border-neutral-100 dark:border-neutral-800 flex items-center gap-2 text-xs text-neutral-400\">\r\n                                <Shield size={14} />\r\n                                <span>30-day money-back guarantee</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(checkout)\\checkout\\subscribe\\[tier]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3298,3301],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3298,3301],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4616,4619],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4616,4619],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\r\nimport { ArrowLeft, Check, Lock, CreditCard, Tag, Loader2, CheckCircle, Sparkles } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { SUBSCRIPTION_TIERS, SubscriptionTier } from \"@/lib/constants/subscription\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport Link from \"next/link\";\r\n\r\ntype CheckoutStep = 'review' | 'coupon' | 'payment' | 'success';\r\n\r\nexport default function SubscribeCheckoutPage() {\r\n    const params = useParams();\r\n    const searchParams = useSearchParams();\r\n    const router = useRouter();\r\n\r\n    const tierId = params.tier as SubscriptionTier;\r\n    const billingCycle = (searchParams?.get('billing') || 'monthly') as 'monthly' | 'yearly';\r\n\r\n    const tier = SUBSCRIPTION_TIERS[tierId];\r\n\r\n    const [step, setStep] = useState<CheckoutStep>('review');\r\n    const [couponCode, setCouponCode] = useState(\"\");\r\n    const [couponApplied, setCouponApplied] = useState<{ code: string; discount: number } | null>(null);\r\n    const [couponError, setCouponError] = useState(\"\");\r\n    const [couponLoading, setCouponLoading] = useState(false);\r\n\r\n    // Payment form\r\n    const [cardNumber, setCardNumber] = useState(\"\");\r\n    const [expiry, setExpiry] = useState(\"\");\r\n    const [cvv, setCvv] = useState(\"\");\r\n    const [name, setName] = useState(\"\");\r\n    const [paymentError, setPaymentError] = useState(\"\");\r\n    const [processing, setProcessing] = useState(false);\r\n\r\n    if (!tier) {\r\n        return (\r\n            <div className=\"min-h-screen flex items-center justify-center\">\r\n                <p>Invalid subscription tier</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const basePrice = billingCycle === 'yearly' ? tier.priceYearly : tier.priceMonthly;\r\n    const discountAmount = couponApplied ? (basePrice * couponApplied.discount / 100) : 0;\r\n    const finalPrice = basePrice - discountAmount;\r\n\r\n    const formatCardNumber = (value: string) => {\r\n        const digits = value.replace(/\\D/g, '').slice(0, 16);\r\n        const groups = digits.match(/.{1,4}/g) || [];\r\n        return groups.join(' ');\r\n    };\r\n\r\n    const formatExpiry = (value: string) => {\r\n        const digits = value.replace(/\\D/g, '').slice(0, 4);\r\n        if (digits.length >= 2) {\r\n            return digits.slice(0, 2) + '/' + digits.slice(2);\r\n        }\r\n        return digits;\r\n    };\r\n\r\n    const applyCoupon = async () => {\r\n        if (!couponCode.trim()) return;\r\n\r\n        setCouponLoading(true);\r\n        setCouponError(\"\");\r\n\r\n        try {\r\n            const res = await fetch('/api/coupons/validate', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ code: couponCode, type: 'subscription' }),\r\n            });\r\n\r\n            const data = await res.json();\r\n\r\n            if (!res.ok) {\r\n                throw new Error(data.error || 'Invalid coupon');\r\n            }\r\n\r\n            setCouponApplied({ code: couponCode, discount: data.discountPercent });\r\n        } catch (err: any) {\r\n            setCouponError(err.message);\r\n        } finally {\r\n            setCouponLoading(false);\r\n        }\r\n    };\r\n\r\n    const handlePayment = async () => {\r\n        setPaymentError(\"\");\r\n\r\n        // Basic validation\r\n        if (cardNumber.replace(/\\s/g, '').length !== 16) {\r\n            setPaymentError(\"Please enter a valid card number\");\r\n            return;\r\n        }\r\n        if (expiry.length !== 5) {\r\n            setPaymentError(\"Please enter a valid expiry date\");\r\n            return;\r\n        }\r\n        if (cvv.length < 3) {\r\n            setPaymentError(\"Please enter a valid CVV\");\r\n            return;\r\n        }\r\n\r\n        setProcessing(true);\r\n\r\n        try {\r\n            const res = await fetch('/api/subscriptions/create', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    tier: tierId,\r\n                    billingCycle,\r\n                    couponCode: couponApplied?.code,\r\n                    amount: finalPrice,\r\n                }),\r\n            });\r\n\r\n            const data = await res.json();\r\n\r\n            if (!res.ok) {\r\n                throw new Error(data.error || 'Payment failed');\r\n            }\r\n\r\n            setStep('success');\r\n        } catch (err: any) {\r\n            setPaymentError(err.message);\r\n        } finally {\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const steps = [\r\n        { id: 'review', label: 'Review' },\r\n        { id: 'coupon', label: 'Coupon' },\r\n        { id: 'payment', label: 'Payment' },\r\n        { id: 'success', label: 'Complete' },\r\n    ];\r\n\r\n    const currentStepIndex = steps.findIndex(s => s.id === step);\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950\">\r\n            {/* Header */}\r\n            <header className=\"bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800\">\r\n                <div className=\"max-w-4xl mx-auto px-6 py-4 flex items-center justify-between\">\r\n                    <Link href=\"/pricing\" className=\"flex items-center gap-2 text-neutral-600 hover:text-neutral-900 dark:text-neutral-400 dark:hover:text-white\">\r\n                        <ArrowLeft size={20} />\r\n                        <span>Back to Pricing</span>\r\n                    </Link>\r\n                    <h1 className=\"text-lg font-semibold\">Checkout</h1>\r\n                    <div className=\"w-20\" />\r\n                </div>\r\n            </header>\r\n\r\n            {/* Progress Steps */}\r\n            <div className=\"bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800\">\r\n                <div className=\"max-w-4xl mx-auto px-6 py-4\">\r\n                    <div className=\"flex items-center justify-center gap-2\">\r\n                        {steps.map((s, i) => (\r\n                            <div key={s.id} className=\"flex items-center\">\r\n                                <div className={cn(\r\n                                    \"w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all\",\r\n                                    i < currentStepIndex && \"bg-green-500 text-white\",\r\n                                    i === currentStepIndex && \"bg-blue-600 text-white\",\r\n                                    i > currentStepIndex && \"bg-neutral-200 dark:bg-neutral-800 text-neutral-500\"\r\n                                )}>\r\n                                    {i < currentStepIndex ? <Check size={16} /> : i + 1}\r\n                                </div>\r\n                                <span className={cn(\r\n                                    \"ml-2 text-sm hidden sm:block\",\r\n                                    i === currentStepIndex ? \"text-neutral-900 dark:text-white font-medium\" : \"text-neutral-500\"\r\n                                )}>\r\n                                    {s.label}\r\n                                </span>\r\n                                {i < steps.length - 1 && (\r\n                                    <div className={cn(\r\n                                        \"w-8 md:w-16 h-[2px] mx-2\",\r\n                                        i < currentStepIndex ? \"bg-green-500\" : \"bg-neutral-200 dark:bg-neutral-800\"\r\n                                    )} />\r\n                                )}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content */}\r\n            <main className=\"max-w-4xl mx-auto px-6 py-8\">\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n                    {/* Left: Step Content */}\r\n                    <div className=\"lg:col-span-2\">\r\n                        <AnimatePresence mode=\"wait\">\r\n                            {/* Step 1: Review */}\r\n                            {step === 'review' && (\r\n                                <motion.div\r\n                                    key=\"review\"\r\n                                    initial={{ opacity: 0, x: -20 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: 20 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6\"\r\n                                >\r\n                                    <h2 className=\"text-xl font-semibold mb-6\">Review Your Plan</h2>\r\n\r\n                                    <div className=\"flex items-start gap-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl mb-6\">\r\n                                        <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center\">\r\n                                            <Sparkles className=\"w-6 h-6 text-white\" />\r\n                                        </div>\r\n                                        <div>\r\n                                            <h3 className=\"font-semibold text-lg\">{tier.name} Plan</h3>\r\n                                            <p className=\"text-sm text-neutral-500\">{tier.description}</p>\r\n                                            <p className=\"text-sm text-neutral-500 mt-1\">\r\n                                                Billed {billingCycle}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"space-y-3 mb-6\">\r\n                                        <h4 className=\"font-medium text-sm text-neutral-500 uppercase tracking-wider\">Features Included</h4>\r\n                                        {tier.features.map((feature, i) => (\r\n                                            <div key={i} className=\"flex items-center gap-3\">\r\n                                                <Check className=\"w-5 h-5 text-green-500\" />\r\n                                                <span className=\"text-sm text-neutral-600 dark:text-neutral-400\">{feature}</span>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n\r\n                                    <Button\r\n                                        onClick={() => setStep('coupon')}\r\n                                        className=\"w-full h-12 bg-neutral-900 dark:bg-white text-white dark:text-neutral-900\"\r\n                                    >\r\n                                        Continue\r\n                                    </Button>\r\n                                </motion.div>\r\n                            )}\r\n\r\n                            {/* Step 2: Coupon */}\r\n                            {step === 'coupon' && (\r\n                                <motion.div\r\n                                    key=\"coupon\"\r\n                                    initial={{ opacity: 0, x: -20 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: 20 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6\"\r\n                                >\r\n                                    <h2 className=\"text-xl font-semibold mb-6\">Have a Coupon?</h2>\r\n\r\n                                    <div className=\"space-y-4 mb-6\">\r\n                                        <div className=\"flex gap-3\">\r\n                                            <div className=\"relative flex-1\">\r\n                                                <Tag className=\"absolute left-3 top-3 text-neutral-400\" size={18} />\r\n                                                <Input\r\n                                                    placeholder=\"Enter coupon code\"\r\n                                                    className=\"pl-10 uppercase\"\r\n                                                    value={couponCode}\r\n                                                    onChange={(e) => setCouponCode(e.target.value.toUpperCase())}\r\n                                                    disabled={!!couponApplied}\r\n                                                />\r\n                                            </div>\r\n                                            <Button\r\n                                                type=\"button\"\r\n                                                variant=\"outline\"\r\n                                                onClick={applyCoupon}\r\n                                                disabled={couponLoading || !!couponApplied}\r\n                                            >\r\n                                                {couponLoading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : 'Apply'}\r\n                                            </Button>\r\n                                        </div>\r\n\r\n                                        {couponError && (\r\n                                            <p className=\"text-sm text-red-500\">{couponError}</p>\r\n                                        )}\r\n\r\n                                        {couponApplied && (\r\n                                            <div className=\"p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 rounded-xl flex items-center gap-2\">\r\n                                                <CheckCircle size={18} />\r\n                                                <span className=\"text-sm font-medium\">\r\n                                                    {couponApplied.discount}% discount applied!\r\n                                                </span>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    <div className=\"flex gap-3\">\r\n                                        <Button\r\n                                            variant=\"outline\"\r\n                                            onClick={() => setStep('review')}\r\n                                            className=\"flex-1\"\r\n                                        >\r\n                                            Back\r\n                                        </Button>\r\n                                        <Button\r\n                                            onClick={() => setStep('payment')}\r\n                                            className=\"flex-1 bg-neutral-900 dark:bg-white text-white dark:text-neutral-900\"\r\n                                        >\r\n                                            Continue to Payment\r\n                                        </Button>\r\n                                    </div>\r\n                                </motion.div>\r\n                            )}\r\n\r\n                            {/* Step 3: Payment */}\r\n                            {step === 'payment' && (\r\n                                <motion.div\r\n                                    key=\"payment\"\r\n                                    initial={{ opacity: 0, x: -20 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: 20 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6\"\r\n                                >\r\n                                    <h2 className=\"text-xl font-semibold mb-6\">Payment Details</h2>\r\n\r\n                                    {paymentError && (\r\n                                        <div className=\"p-3 mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl text-sm\">\r\n                                            {paymentError}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <div className=\"space-y-4 mb-6\">\r\n                                        <div className=\"space-y-2\">\r\n                                            <Label>Cardholder Name</Label>\r\n                                            <Input\r\n                                                placeholder=\"John Doe\"\r\n                                                value={name}\r\n                                                onChange={(e) => setName(e.target.value)}\r\n                                            />\r\n                                        </div>\r\n\r\n                                        <div className=\"space-y-2\">\r\n                                            <Label>Card Number</Label>\r\n                                            <div className=\"relative\">\r\n                                                <CreditCard className=\"absolute left-3 top-3 text-neutral-400\" size={18} />\r\n                                                <Input\r\n                                                    placeholder=\"4242 4242 4242 4242\"\r\n                                                    className=\"pl-10 font-mono\"\r\n                                                    value={cardNumber}\r\n                                                    onChange={(e) => setCardNumber(formatCardNumber(e.target.value))}\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"grid grid-cols-2 gap-4\">\r\n                                            <div className=\"space-y-2\">\r\n                                                <Label>Expiry</Label>\r\n                                                <Input\r\n                                                    placeholder=\"MM/YY\"\r\n                                                    className=\"font-mono\"\r\n                                                    value={expiry}\r\n                                                    onChange={(e) => setExpiry(formatExpiry(e.target.value))}\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"space-y-2\">\r\n                                                <Label>CVV</Label>\r\n                                                <Input\r\n                                                    placeholder=\"123\"\r\n                                                    className=\"font-mono\"\r\n                                                    type=\"password\"\r\n                                                    maxLength={4}\r\n                                                    value={cvv}\r\n                                                    onChange={(e) => setCvv(e.target.value.replace(/\\D/g, ''))}\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"flex gap-3\">\r\n                                        <Button\r\n                                            variant=\"outline\"\r\n                                            onClick={() => setStep('coupon')}\r\n                                            className=\"flex-1\"\r\n                                            disabled={processing}\r\n                                        >\r\n                                            Back\r\n                                        </Button>\r\n                                        <Button\r\n                                            onClick={handlePayment}\r\n                                            className=\"flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white\"\r\n                                            disabled={processing}\r\n                                        >\r\n                                            {processing ? (\r\n                                                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\r\n                                            ) : (\r\n                                                <Lock className=\"w-4 h-4 mr-2\" />\r\n                                            )}\r\n                                            Pay ${finalPrice.toFixed(2)}\r\n                                        </Button>\r\n                                    </div>\r\n\r\n                                    <p className=\"text-xs text-center text-neutral-400 mt-4 flex items-center justify-center gap-1\">\r\n                                        <Lock size={12} />\r\n                                        Secure payment simulation (no real charge)\r\n                                    </p>\r\n                                </motion.div>\r\n                            )}\r\n\r\n                            {/* Step 4: Success */}\r\n                            {step === 'success' && (\r\n                                <motion.div\r\n                                    key=\"success\"\r\n                                    initial={{ opacity: 0, scale: 0.95 }}\r\n                                    animate={{ opacity: 1, scale: 1 }}\r\n                                    className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-8 text-center\"\r\n                                >\r\n                                    <motion.div\r\n                                        initial={{ scale: 0 }}\r\n                                        animate={{ scale: 1 }}\r\n                                        transition={{ delay: 0.2, type: \"spring\" }}\r\n                                        className=\"w-20 h-20 mx-auto bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-6\"\r\n                                    >\r\n                                        <CheckCircle className=\"w-10 h-10 text-green-600\" />\r\n                                    </motion.div>\r\n\r\n                                    <h2 className=\"text-2xl font-bold mb-2\">Welcome to {tier.name}!</h2>\r\n                                    <p className=\"text-neutral-600 dark:text-neutral-400 mb-8\">\r\n                                        Your subscription is now active. Start learning today!\r\n                                    </p>\r\n\r\n                                    <Button\r\n                                        onClick={() => router.push('/user')}\r\n                                        className=\"bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8\"\r\n                                    >\r\n                                        Start Learning\r\n                                    </Button>\r\n                                </motion.div>\r\n                            )}\r\n                        </AnimatePresence>\r\n                    </div>\r\n\r\n                    {/* Right: Order Summary */}\r\n                    <div className=\"lg:col-span-1\">\r\n                        <div className=\"bg-white dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 p-6 sticky top-24\">\r\n                            <h3 className=\"font-semibold mb-4\">Order Summary</h3>\r\n\r\n                            <div className=\"space-y-3 text-sm\">\r\n                                <div className=\"flex justify-between\">\r\n                                    <span className=\"text-neutral-500\">{tier.name} ({billingCycle})</span>\r\n                                    <span>${basePrice.toFixed(2)}</span>\r\n                                </div>\r\n\r\n                                {couponApplied && (\r\n                                    <div className=\"flex justify-between text-green-600\">\r\n                                        <span>Discount ({couponApplied.discount}%)</span>\r\n                                        <span>-${discountAmount.toFixed(2)}</span>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"border-t border-neutral-100 dark:border-neutral-800 pt-3 flex justify-between font-semibold text-lg\">\r\n                                    <span>Total</span>\r\n                                    <span className=\"text-green-600\">${finalPrice.toFixed(2)}</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"mt-6 pt-4 border-t border-neutral-100 dark:border-neutral-800\">\r\n                                <p className=\"text-xs text-neutral-400\">\r\n                                    {billingCycle === 'yearly'\r\n                                        ? `Billed annually. Renews at $${tier.priceYearly}/year.`\r\n                                        : `Billed monthly. Renews at $${tier.priceMonthly}/month.`\r\n                                    }\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\browse\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'spring' is assigned a value but never used.","line":13,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3031,3034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3031,3034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Course } from \"@/lib/types\";\r\nimport { CourseCard } from \"@/components/course/CourseCard\";\r\nimport { Search, Compass, Sparkles } from \"lucide-react\";\r\nimport { AICourseSelector } from \"@/components/ai/AICourseSelector\";\r\nimport { RecommendedCourses } from \"@/components/course/RecommendedCourses\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\n\r\n// Apple-style spring animation\r\nconst spring = {\r\n    type: \"spring\",\r\n    stiffness: 300,\r\n    damping: 30,\r\n};\r\n\r\n// Container stagger variants\r\nconst containerVariants = {\r\n    hidden: { opacity: 0 },\r\n    visible: {\r\n        opacity: 1,\r\n        transition: {\r\n            staggerChildren: 0.08,\r\n            delayChildren: 0.1,\r\n        },\r\n    },\r\n};\r\n\r\n// Item variants\r\nconst itemVariants = {\r\n    hidden: { opacity: 0, y: 20, scale: 0.95 },\r\n    visible: {\r\n        opacity: 1,\r\n        y: 0,\r\n        scale: 1,\r\n        transition: { type: \"spring\", stiffness: 300, damping: 30 },\r\n    },\r\n    exit: { opacity: 0, y: -10, scale: 0.95, transition: { duration: 0.2 } },\r\n} as const;\r\n\r\nexport default function BrowsePage() {\r\n    const [courses, setCourses] = useState<Course[]>([]);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [searchQuery, setSearchQuery] = useState(\"\");\r\n    const [selectedCategory, setSelectedCategory] = useState(\"All\");\r\n    const [searchResults, setSearchResults] = useState<Course[] | null>(null);\r\n    const { t } = useTranslation();\r\n\r\n    useEffect(() => {\r\n        fetch('/api/courses', { cache: 'no-store' })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                // DEFENSIVE: Ensure data is an array\r\n                setCourses(Array.isArray(data) ? data : []);\r\n                setIsLoading(false);\r\n            })\r\n            .catch(err => {\r\n                console.error(\"Failed to load courses\", err);\r\n                setCourses([]);\r\n                setIsLoading(false);\r\n            });\r\n    }, []);\r\n\r\n    // Semantic Search with debounce\r\n    useEffect(() => {\r\n        const performSearch = async () => {\r\n            if (!searchQuery.trim()) {\r\n                setSearchResults(null);\r\n                return;\r\n            }\r\n\r\n            setIsLoading(true);\r\n            try {\r\n                const res = await fetch('/api/courses/search', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ query: searchQuery, allCourses: courses }),\r\n                });\r\n                const results = await res.json();\r\n\r\n                // DEFENSIVE: Ensure results is an array\r\n                if (!Array.isArray(results)) {\r\n                    console.warn('Search API returned non-array:', results);\r\n                    setSearchResults(null);\r\n                    return;\r\n                }\r\n\r\n                const mergedResults = results.map((r: any) => {\r\n                    const original = courses.find(c => c.id === r.id);\r\n                    return original ? { ...original, ...r } : r;\r\n                });\r\n\r\n                setSearchResults(mergedResults);\r\n            } catch (error) {\r\n                console.error(\"Search failed\", error);\r\n                setSearchResults(null);\r\n            } finally {\r\n                setIsLoading(false);\r\n            }\r\n        };\r\n\r\n        const timeoutId = setTimeout(() => {\r\n            performSearch();\r\n        }, 600);\r\n\r\n        return () => clearTimeout(timeoutId);\r\n    }, [searchQuery, courses]);\r\n\r\n    const categories = [\"All\", ...Array.from(new Set(courses.map(c => c.category)))];\r\n    const sourceList = searchResults || courses;\r\n    const filteredCourses = sourceList.filter(course => {\r\n        return selectedCategory === \"All\" || course.category === selectedCategory;\r\n    });\r\n\r\n    return (\r\n        <motion.div\r\n            initial=\"hidden\"\r\n            animate=\"visible\"\r\n            variants={containerVariants}\r\n            className=\"space-y-8 min-h-screen\"\r\n        >\r\n            {/* Header Section */}\r\n            <motion.div\r\n                variants={itemVariants}\r\n                className=\"flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-neutral-200 dark:border-white/5 pb-8\"\r\n            >\r\n                <div>\r\n                    <motion.div\r\n                        className=\"flex items-center gap-3 mb-3\"\r\n                        initial={{ opacity: 0, x: -20 }}\r\n                        animate={{ opacity: 1, x: 0 }}\r\n                        transition={{ type: \"spring\" as const, stiffness: 300, damping: 30, delay: 0.1 }}\r\n                    >\r\n                        <motion.div\r\n                            className=\"p-2 bg-indigo-500/20 rounded-xl backdrop-blur-md border border-indigo-500/30\"\r\n                            whileHover={{ rotate: [0, -10, 10, 0], scale: 1.1 }}\r\n                            transition={{ duration: 0.5 }}\r\n                        >\r\n                            <Compass className=\"w-5 h-5 text-indigo-600 dark:text-indigo-400\" />\r\n                        </motion.div>\r\n                        <span className=\"text-sm font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest\">{t.browsePage.explore}</span>\r\n                    </motion.div>\r\n                    <motion.h1\r\n                        className=\"text-4xl font-bold text-neutral-900 dark:text-white mb-2 tracking-tight\"\r\n                        initial={{ opacity: 0, y: 20 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        transition={{ type: \"spring\" as const, stiffness: 300, damping: 30, delay: 0.2 }}\r\n                    >\r\n                        {t.browsePage.title}\r\n                    </motion.h1>\r\n                    <motion.p\r\n                        className=\"text-neutral-600 dark:text-zinc-400 max-w-xl text-lg\"\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        transition={{ delay: 0.4 }}\r\n                    >\r\n                        {t.browsePage.description}\r\n                    </motion.p>\r\n                </div>\r\n\r\n                {/* Search Bar */}\r\n                <motion.div\r\n                    className=\"relative w-full md:w-96\"\r\n                    initial={{ opacity: 0, scale: 0.95 }}\r\n                    animate={{ opacity: 1, scale: 1 }}\r\n                    transition={{ type: \"spring\" as const, stiffness: 300, damping: 30, delay: 0.3 }}\r\n                >\r\n                    <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 dark:text-zinc-500 w-5 h-5\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder={t.browsePage.searchPlaceholder}\r\n                        value={searchQuery}\r\n                        onChange={(e) => setSearchQuery(e.target.value)}\r\n                        className=\"w-full bg-white dark:bg-zinc-900/50 border border-neutral-200 dark:border-white/10 rounded-full py-3.5 pl-12 pr-4 text-sm text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-zinc-600 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-transparent transition-all hover:bg-neutral-50 dark:hover:bg-zinc-900 shadow-lg dark:shadow-xl\"\r\n                    />\r\n                    {searchQuery && (\r\n                        <motion.div\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            className=\"absolute right-4 top-1/2 -translate-y-1/2\"\r\n                        >\r\n                            <Sparkles className=\"w-4 h-4 text-indigo-400 animate-pulse\" />\r\n                        </motion.div>\r\n                    )}\r\n                </motion.div>\r\n            </motion.div>\r\n\r\n            {/* AI Advisor Section */}\r\n            <motion.div variants={itemVariants}>\r\n                <AICourseSelector courses={courses} />\r\n            </motion.div>\r\n\r\n            {/* Category Filters */}\r\n            <motion.div\r\n                variants={itemVariants}\r\n                className=\"flex flex-wrap items-center gap-2 pb-4\"\r\n            >\r\n                <span className=\"text-xs font-semibold text-neutral-500 dark:text-zinc-500 uppercase tracking-wider mr-2\">{t.browsePage.filters}:</span>\r\n                {categories.map((category, index) => (\r\n                    <motion.button\r\n                        key={category}\r\n                        onClick={() => setSelectedCategory(category)}\r\n                        initial={{ opacity: 0, scale: 0.8 }}\r\n                        animate={{ opacity: 1, scale: 1 }}\r\n                        transition={{ type: \"spring\", stiffness: 300, damping: 30, delay: 0.1 + index * 0.05 }}\r\n                        whileHover={{ scale: 1.05 }}\r\n                        whileTap={{ scale: 0.95 }}\r\n                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all duration-300 border ${selectedCategory === category\r\n                            ? \"bg-neutral-900 dark:bg-white text-white dark:text-black border-neutral-900 dark:border-white shadow-lg\"\r\n                            : \"bg-white dark:bg-zinc-900/40 text-neutral-600 dark:text-zinc-400 border-neutral-200 dark:border-white/5 hover:border-neutral-400 dark:hover:border-white/20 hover:text-neutral-900 dark:hover:text-white\"\r\n                            }`}\r\n                    >\r\n                        {category}\r\n                    </motion.button>\r\n                ))}\r\n            </motion.div>\r\n\r\n            {/* AI Recommendations Section */}\r\n            <RecommendedCourses limit={4} className=\"mb-8\" />\r\n\r\n            {/* Content Grid */}\r\n            <div className=\"pb-20\">\r\n                <AnimatePresence mode=\"wait\">\r\n                    {isLoading ? (\r\n                        <motion.div\r\n                            key=\"loading\"\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            exit={{ opacity: 0 }}\r\n                            className=\"flex flex-col items-center justify-center py-20 gap-4\"\r\n                        >\r\n                            <motion.div\r\n                                className=\"w-10 h-10 border-2 border-indigo-500 border-t-transparent rounded-full\"\r\n                                animate={{ rotate: 360 }}\r\n                                transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\r\n                            />\r\n                            <p className=\"text-neutral-500 dark:text-zinc-500 text-sm\">{t.browsePage.findingCourses}</p>\r\n                        </motion.div>\r\n                    ) : filteredCourses.length > 0 ? (\r\n                        <motion.div\r\n                            key=\"grid\"\r\n                            className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\"\r\n                            variants={containerVariants}\r\n                            initial=\"hidden\"\r\n                            animate=\"visible\"\r\n                        >\r\n                            {filteredCourses.map((course, idx) => (\r\n                                <motion.div\r\n                                    key={course.id}\r\n                                    variants={itemVariants}\r\n                                    layout\r\n                                    whileHover={{ y: -6 }}\r\n                                    transition={{ type: \"spring\" as const, stiffness: 300, damping: 30 }}\r\n                                >\r\n                                    <CourseCard course={course} index={idx} />\r\n                                </motion.div>\r\n                            ))}\r\n                        </motion.div>\r\n                    ) : (\r\n                        <motion.div\r\n                            key=\"empty\"\r\n                            initial={{ opacity: 0, y: 20 }}\r\n                            animate={{ opacity: 1, y: 0 }}\r\n                            exit={{ opacity: 0, y: -20 }}\r\n                            className=\"flex flex-col items-center justify-center py-24 text-center border border-dashed border-neutral-200 dark:border-white/5 rounded-3xl bg-neutral-50 dark:bg-white/[0.02]\"\r\n                        >\r\n                            <motion.div\r\n                                className=\"w-16 h-16 rounded-full bg-neutral-100 dark:bg-zinc-900/50 flex items-center justify-center mb-4 border border-neutral-200 dark:border-white/5\"\r\n                                animate={{ scale: [1, 1.05, 1] }}\r\n                                transition={{ duration: 2, repeat: Infinity }}\r\n                            >\r\n                                <Search className=\"w-6 h-6 text-neutral-400 dark:text-zinc-600\" />\r\n                            </motion.div>\r\n                            <h3 className=\"text-lg font-medium text-neutral-900 dark:text-white mb-1\">{t.browsePage.noResults}</h3>\r\n                            <p className=\"text-neutral-500 dark:text-zinc-500 text-sm\">\r\n                                We couldn't find anything matching \"{searchQuery}\" in {selectedCategory}.\r\n                            </p>\r\n                            <motion.button\r\n                                onClick={() => { setSearchQuery(\"\"); setSelectedCategory(\"All\"); }}\r\n                                whileHover={{ scale: 1.05 }}\r\n                                whileTap={{ scale: 0.95 }}\r\n                                className=\"mt-4 text-indigo-400 hover:text-indigo-300 text-sm font-medium\"\r\n                            >\r\n                                {t.browsePage.clearFilters}\r\n                            </motion.button>\r\n                        </motion.div>\r\n                    )}\r\n                </AnimatePresence>\r\n            </div>\r\n        </motion.div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\class\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":10,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ImageIcon' is defined but never used.","line":10,"column":70,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":79},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'refreshUser'. Either include it or remove the dependency array.","line":40,"column":8,"nodeType":"ArrayExpression","endLine":40,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [user, courseId, refreshUser]","fix":{"range":[1790,1806],"text":"[user, courseId, refreshUser]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\r\nimport { Lesson } from \"@/lib/types\";\r\nimport { MaterialViewer } from \"@/components/course/MaterialViewer\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { CheckCircle, FileText, ChevronLeft, ChevronDown, ChevronUp, ImageIcon, List } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useCourse } from \"@/lib/hooks/useCourse\";\r\nimport { CourseChatBot } from \"@/components/ai/CourseChatBot\";\r\nimport { SkeletonCourseContent, SkeletonLessonList } from \"@/components/ui/Skeleton\";\r\n\r\nexport default function ClassPage() {\r\n    const params = useParams();\r\n    const router = useRouter();\r\n    const searchParams = useSearchParams();\r\n\r\n    const courseId = params.id as string;\r\n\r\n    const { course, isLoading } = useCourse(courseId);\r\n    const [completedLessons, setCompletedLessons] = useState<string[]>([]);\r\n    const [isChatSidebarOpen, setIsChatSidebarOpen] = useState(false);\r\n    const [isLessonListOpen, setIsLessonListOpen] = useState(false);\r\n    const { user, refreshUser } = useAuth();\r\n\r\n    useEffect(() => {\r\n        if (user && courseId) {\r\n            import(\"@/lib/storage/enrollment\").then(({ enrollmentManager }) => {\r\n                if (!enrollmentManager.isEnrolled(courseId)) {\r\n                    enrollmentManager.enrollInCourse(user.id, courseId)\r\n                        .then(() => refreshUser())\r\n                        .catch(err => console.error(\"Auto-enroll failed:\", err));\r\n                }\r\n            });\r\n        }\r\n    }, [user, courseId]);\r\n\r\n    useEffect(() => {\r\n        const progress = hybridStorage.progress.get();\r\n        setCompletedLessons(progress.completedLessons);\r\n    }, []);\r\n\r\n    const activeLessonId = searchParams.get(\"lesson\");\r\n    const activeLesson = course?.lessons.find((l: Lesson) => l.id === activeLessonId) || course?.lessons[0];\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex flex-col lg:flex-row h-full overflow-hidden\">\r\n                <div className=\"hidden lg:block w-80 flex-shrink-0\">\r\n                    <SkeletonLessonList />\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                    <SkeletonCourseContent />\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!course) {\r\n        return <div className=\"text-white\">Course not found</div>;\r\n    }\r\n\r\n    const handleSelectLesson = (lessonId: string) => {\r\n        router.push(`/class/${courseId}?lesson=${lessonId}`);\r\n        setIsLessonListOpen(false);\r\n    };\r\n\r\n    const handleComplete = () => {\r\n        if (activeLesson && user) {\r\n            const allLessonIds = course.lessons.map((l: Lesson) => l.id);\r\n            const currentCompleted = new Set(completedLessons);\r\n            currentCompleted.add(activeLesson.id);\r\n\r\n            const completedCount = allLessonIds.filter((id: string) => currentCompleted.has(id)).length;\r\n            const progressPercent = Math.round((completedCount / allLessonIds.length) * 100);\r\n\r\n            hybridStorage.progress.completeLesson(\r\n                user.id,\r\n                activeLesson.id,\r\n                courseId,\r\n                course.lessons.length,\r\n                progressPercent\r\n            );\r\n\r\n            const progress = hybridStorage.progress.get();\r\n            setCompletedLessons([...progress.completedLessons]);\r\n        }\r\n    };\r\n\r\n    const isCompleted = (lessonId: string) => completedLessons.includes(lessonId);\r\n    const currentLessonIndex = course.lessons.findIndex((l: Lesson) => l.id === activeLesson?.id);\r\n\r\n    return (\r\n        <div className=\"flex flex-col lg:flex-row h-full overflow-hidden relative\">\r\n            {/* Mobile: Collapsible lesson header - STICKY */}\r\n            <div className=\"lg:hidden sticky top-0 z-30 bg-zinc-950\">\r\n                <button\r\n                    onClick={() => setIsLessonListOpen(!isLessonListOpen)}\r\n                    className=\"w-full flex items-center justify-between p-3 bg-zinc-900/80 border-b border-white/10\"\r\n                >\r\n                    <div className=\"flex items-center gap-3 min-w-0\">\r\n                        <div className=\"p-2 bg-white/10 rounded-lg flex-shrink-0\">\r\n                            <List className=\"w-4 h-4 text-white\" />\r\n                        </div>\r\n                        <div className=\"min-w-0\">\r\n                            <p className=\"text-[10px] text-neutral-500\">Lesson {currentLessonIndex + 1}/{course.lessons.length}</p>\r\n                            <p className=\"text-sm font-medium text-white truncate\">{activeLesson?.title}</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 flex-shrink-0\">\r\n                        <span className=\"text-xs text-neutral-500\">{hybridStorage.progress.getCourseProgress(courseId)}%</span>\r\n                        {isLessonListOpen ? (\r\n                            <ChevronUp className=\"w-5 h-5 text-neutral-400\" />\r\n                        ) : (\r\n                            <ChevronDown className=\"w-5 h-5 text-neutral-400\" />\r\n                        )}\r\n                    </div>\r\n                </button>\r\n\r\n                {/* Collapsible lesson list */}\r\n                {isLessonListOpen && (\r\n                    <div className=\"bg-zinc-950 border-b border-white/10 max-h-[50vh] overflow-y-auto\">\r\n                        <div className=\"p-2 space-y-1\">\r\n                            {course.lessons.map((lesson, index) => {\r\n                                const completed = isCompleted(lesson.id);\r\n                                const isActive = activeLesson?.id === lesson.id;\r\n\r\n                                return (\r\n                                    <button\r\n                                        key={lesson.id}\r\n                                        onClick={() => handleSelectLesson(lesson.id)}\r\n                                        className={cn(\r\n                                            \"w-full flex items-center p-3 rounded-lg text-sm transition-all text-left\",\r\n                                            isActive ? \"bg-white/10 text-white\" : \"text-neutral-400 hover:bg-white/5\"\r\n                                        )}\r\n                                    >\r\n                                        {completed ? (\r\n                                            <CheckCircle className=\"w-4 h-4 mr-3 text-green-500 flex-shrink-0\" />\r\n                                        ) : (\r\n                                            <span className=\"w-4 h-4 mr-3 flex items-center justify-center text-neutral-500 flex-shrink-0 text-xs\">\r\n                                                {index + 1}\r\n                                            </span>\r\n                                        )}\r\n                                        <span className=\"truncate\">{lesson.title}</span>\r\n                                    </button>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Desktop: Fixed Sidebar */}\r\n            <div className=\"hidden lg:flex w-80 flex-shrink-0 flex-col bg-black/20 backdrop-blur-sm rounded-xl border border-white/5 h-full overflow-hidden\">\r\n                <div className=\"p-4 border-b border-white/5 bg-white/5 flex-shrink-0\">\r\n                    <Link href=\"/user\" className=\"text-xs text-neutral-400 hover:text-white flex items-center mb-2 transition-colors\">\r\n                        <ChevronLeft className=\"w-3 h-3 mr-1\" /> Back to Dashboard\r\n                    </Link>\r\n                    <h2 className=\"font-bold text-white line-clamp-1\">{course.title}</h2>\r\n                    <div className=\"mt-2 text-xs text-neutral-500 flex justify-between\">\r\n                        <span>Progress</span>\r\n                        <span>{hybridStorage.progress.getCourseProgress(courseId)}%</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <ScrollArea className=\"flex-1 overflow-y-auto\">\r\n                    <div className=\"p-4 space-y-2\">\r\n                        {course.lessons.map((lesson, index) => {\r\n                            const completed = isCompleted(lesson.id);\r\n                            const isActive = activeLesson?.id === lesson.id;\r\n\r\n                            return (\r\n                                <button\r\n                                    key={lesson.id}\r\n                                    onClick={() => handleSelectLesson(lesson.id)}\r\n                                    className={cn(\r\n                                        \"w-full flex items-center p-3 rounded-lg text-sm transition-all text-left\",\r\n                                        isActive ? \"bg-white/10 text-white\" : \"text-neutral-400 hover:bg-white/5\"\r\n                                    )}\r\n                                >\r\n                                    {completed ? (\r\n                                        <CheckCircle className=\"w-4 h-4 mr-2 text-green-500 flex-shrink-0\" />\r\n                                    ) : (\r\n                                        <span className=\"w-4 h-4 mr-2 flex items-center justify-center text-neutral-500 text-xs\">\r\n                                            {index + 1}\r\n                                        </span>\r\n                                    )}\r\n                                    <span className=\"line-clamp-1\">{lesson.title}</span>\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </ScrollArea>\r\n            </div>\r\n\r\n            {/* Content Area - SCROLLABLE on mobile */}\r\n            <div className={cn(\r\n                \"flex-1 min-w-0 overflow-y-auto bg-zinc-950/50 transition-all duration-300\",\r\n                isChatSidebarOpen ? \"lg:mr-[400px]\" : \"mr-0\"\r\n            )}>\r\n                {activeLesson ? (\r\n                    <MaterialViewer\r\n                        lesson={activeLesson}\r\n                        isCompleted={isCompleted(activeLesson.id)}\r\n                        onComplete={handleComplete}\r\n                    />\r\n                ) : (\r\n                    <div className=\"h-full flex items-center justify-center text-neutral-500\">\r\n                        Select a lesson to start\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* AI Chatbot */}\r\n            <CourseChatBot\r\n                course={course}\r\n                onToggleSidebar={setIsChatSidebarOpen}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\my-classes\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":172,"column":45,"nodeType":"JSXOpeningElement","endLine":176,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { Course } from \"@/lib/types\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { BookOpen, Clock, PlayCircle, CheckCircle2, TrendingUp } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\n\r\nexport default function MyClassesPage() {\r\n    const { user } = useAuth();\r\n    const [courses, setCourses] = useState<Course[]>([]);\r\n    const [courseProgress, setCourseProgress] = useState<Record<string, number>>({});\r\n    const [filter, setFilter] = useState<\"all\" | \"inProgress\" | \"completed\">(\"all\");\r\n    const [isTransitioning, setIsTransitioning] = useState(false);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const { t } = useTranslation();\r\n\r\n    // Fetch courses from API\r\n    useEffect(() => {\r\n        fetch('/api/courses', { cache: 'no-store' })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                setCourses(Array.isArray(data) ? data : []);\r\n                setIsLoading(false);\r\n            })\r\n            .catch(() => setIsLoading(false));\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (user) {\r\n            const progress = hybridStorage.progress.get();\r\n            setCourseProgress(progress.courseProgress || {});\r\n        }\r\n    }, [user]);\r\n\r\n    const handleFilterChange = (newFilter: typeof filter) => {\r\n        if (newFilter === filter) return;\r\n\r\n        setIsTransitioning(true);\r\n        setTimeout(() => {\r\n            setFilter(newFilter);\r\n            setTimeout(() => setIsTransitioning(false), 50);\r\n        }, 200);\r\n    };\r\n\r\n    if (!user || isLoading) {\r\n        return <div className=\"text-neutral-400\">{t.loading}</div>;\r\n    }\r\n\r\n    const enrolledCourses = courses.filter(c =>\r\n        user.enrolledCourses?.includes(c.id)\r\n    );\r\n\r\n    const filteredCourses = enrolledCourses.filter(course => {\r\n        const progress = courseProgress[course.id] || 0;\r\n        if (filter === \"inProgress\") return progress > 0 && progress < 100;\r\n        if (filter === \"completed\") return progress === 100;\r\n        return true;\r\n    });\r\n\r\n    const stats = {\r\n        total: enrolledCourses.length,\r\n        inProgress: enrolledCourses.filter(c => {\r\n            const p = courseProgress[c.id] || 0;\r\n            return p > 0 && p < 100;\r\n        }).length,\r\n        completed: enrolledCourses.filter(c => courseProgress[c.id] === 100).length,\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"animate-in fade-in slide-in-from-top-4 duration-500\">\r\n                <h1 className=\"text-3xl font-bold text-white\">{t.myClasses.title}</h1>\r\n                <p className=\"text-neutral-400 mt-1\">\r\n                    {enrolledCourses.length} {enrolledCourses.length === 1 ? t.course.enrolled : t.myClasses.totalCourses.toLowerCase()}\r\n                </p>\r\n            </div>\r\n\r\n            {/* Stats Overview */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                <Card className=\"p-4 bg-white/5 border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-100\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center\">\r\n                            <BookOpen className=\"w-5 h-5 text-blue-400\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-sm text-neutral-400\">{t.myClasses.totalCourses}</p>\r\n                            <p className=\"text-2xl font-bold text-white\">{stats.total}</p>\r\n                        </div>\r\n                    </div>\r\n                </Card>\r\n\r\n                <Card className=\"p-4 bg-white/5 border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-200\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center\">\r\n                            <TrendingUp className=\"w-5 h-5 text-yellow-400\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-sm text-neutral-400\">{t.myClasses.inProgress}</p>\r\n                            <p className=\"text-2xl font-bold text-white\">{stats.inProgress}</p>\r\n                        </div>\r\n                    </div>\r\n                </Card>\r\n\r\n                <Card className=\"p-4 bg-white/5 border-white/10 animate-in fade-in slide-in-from-bottom-2 duration-500 delay-300\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center\">\r\n                            <CheckCircle2 className=\"w-5 h-5 text-green-400\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-sm text-neutral-400\">{t.myClasses.completed}</p>\r\n                            <p className=\"text-2xl font-bold text-white\">{stats.completed}</p>\r\n                        </div>\r\n                    </div>\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Filter Tabs */}\r\n            <div className=\"flex gap-2 border-b border-white/10 pb-4\">\r\n                <button\r\n                    onClick={() => handleFilterChange(\"all\")}\r\n                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 ${filter === \"all\"\r\n                        ? \"bg-white/10 text-white scale-105\"\r\n                        : \"text-neutral-400 hover:text-white hover:bg-white/5\"\r\n                        }`}\r\n                >\r\n                    {t.myClasses.all}\r\n                </button>\r\n                <button\r\n                    onClick={() => handleFilterChange(\"inProgress\")}\r\n                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 ${filter === \"inProgress\"\r\n                        ? \"bg-white/10 text-white scale-105\"\r\n                        : \"text-neutral-400 hover:text-white hover:bg-white/5\"\r\n                        }`}\r\n                >\r\n                    {t.myClasses.inProgress}\r\n                </button>\r\n                <button\r\n                    onClick={() => handleFilterChange(\"completed\")}\r\n                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 ${filter === \"completed\"\r\n                        ? \"bg-white/10 text-white scale-105\"\r\n                        : \"text-neutral-400 hover:text-white hover:bg-white/5\"\r\n                        }`}\r\n                >\r\n                    {t.myClasses.completed}\r\n                </button>\r\n            </div>\r\n\r\n            {/* Course List */}\r\n            <div className={`transition-all duration-300 ${isTransitioning ? 'opacity-0 translate-y-2' : 'opacity-100 translate-y-0'}`}>\r\n                {filteredCourses.length > 0 ? (\r\n                    <div className=\"space-y-4\">\r\n                        {filteredCourses.map((course, index) => {\r\n                            const progress = courseProgress[course.id] || 0;\r\n                            const isCompleted = progress === 100;\r\n\r\n                            return (\r\n                                <Card\r\n                                    key={course.id}\r\n                                    className=\"p-6 bg-white/5 border-white/10 hover:bg-white/10 transition-all duration-300 hover:scale-[1.01] hover:shadow-lg\"\r\n                                    style={{\r\n                                        animation: `fadeInUp 0.5s ease-out ${index * 0.1}s both`\r\n                                    }}\r\n                                >\r\n                                    <div className=\"flex flex-col md:flex-row gap-4\">\r\n                                        <div className=\"relative w-full md:w-48 h-32 rounded-lg overflow-hidden flex-shrink-0\">\r\n                                            <img\r\n                                                src={course.thumbnail}\r\n                                                alt={course.title}\r\n                                                className=\"absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110\"\r\n                                            />\r\n                                            <div className=\"absolute top-2 left-2\">\r\n                                                <span className=\"text-xs font-semibold uppercase tracking-wider text-white bg-blue-600/90 px-2 py-1 rounded\">\r\n                                                    {course.level}\r\n                                                </span>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"flex-1 space-y-3\">\r\n                                            <div>\r\n                                                <h3 className=\"text-xl font-semibold text-white mb-1\">{course.title}</h3>\r\n                                                <p className=\"text-sm text-neutral-400\">{course.category} â€¢ {course.instructor || 'Unknown'}</p>\r\n                                            </div>\r\n\r\n                                            <div className=\"flex items-center gap-4 text-sm text-neutral-400\">\r\n                                                <span className=\"flex items-center gap-1\">\r\n                                                    <BookOpen className=\"w-4 h-4\" />\r\n                                                    {course.lessons.length} lessons\r\n                                                </span>\r\n                                                <span className=\"flex items-center gap-1\">\r\n                                                    <Clock className=\"w-4 h-4\" />\r\n                                                    {course.duration}\r\n                                                </span>\r\n                                            </div>\r\n\r\n                                            <div className=\"space-y-2\">\r\n                                                <div className=\"flex items-center justify-between text-sm\">\r\n                                                    <span className=\"text-neutral-400\">{t.course.progress}</span>\r\n                                                    <span className=\"text-white font-medium\">{progress}%</span>\r\n                                                </div>\r\n                                                <Progress value={progress} className=\"h-2 bg-white/10\" />\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"flex md:flex-col gap-2 md:justify-center\">\r\n                                            <Link href={`/class/${course.id}`} className=\"flex-1 md:flex-initial\">\r\n                                                <Button className=\"w-full bg-white text-black hover:bg-neutral-200 transition-all duration-300 hover:scale-105\">\r\n                                                    <PlayCircle className=\"w-4 h-4 mr-2\" />\r\n                                                    {isCompleted ? \"Review\" : progress > 0 ? \"Continue\" : \"Start\"}\r\n                                                </Button>\r\n                                            </Link>\r\n                                        </div>\r\n                                    </div>\r\n                                </Card>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"py-16 text-center animate-in fade-in duration-500\">\r\n                        <BookOpen className=\"w-16 h-16 text-neutral-600 mx-auto mb-4\" />\r\n                        <p className=\"text-neutral-400 mb-2\">\r\n                            {filter === \"all\"\r\n                                ? \"No enrolled courses yet\"\r\n                                : filter === \"inProgress\"\r\n                                    ? \"No courses in progress\"\r\n                                    : \"No completed courses yet\"}\r\n                        </p>\r\n                        {filter === \"all\" && (\r\n                            <p className=\"text-sm text-neutral-500\">\r\n                                Go to Dashboard to browse and enroll in courses!\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <style jsx>{`\r\n        @keyframes fadeInUp {\r\n          from {\r\n            opacity: 0;\r\n            transform: translateY(20px);\r\n          }\r\n          to {\r\n            opacity: 1;\r\n            transform: translateY(0);\r\n          }\r\n        }\r\n      `}</style>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3134,3137],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3134,3137],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":108,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":108,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":181,"column":41,"nodeType":"JSXOpeningElement","endLine":185,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { syncManager } from \"@/lib/storage/sync-manager\";\r\nimport { ChevronRight, Trash2, Camera, Copy, Check } from \"lucide-react\";\r\nimport { useState, useEffect } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useSearchParams, useRouter } from \"next/navigation\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\nimport { SimpleModal } from \"@/components/ui/SimpleModal\";\r\n\r\nexport default function SettingsPage() {\r\n    const { user, refreshUser } = useAuth();\r\n    const [name, setName] = useState(\"\");\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [tempName, setTempName] = useState(\"\");\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const { t } = useTranslation();\r\n\r\n    // Google Drive Token Handling\r\n    const searchParams = useSearchParams();\r\n    const router = useRouter();\r\n    const [driveToken, setDriveToken] = useState<string | null>(null);\r\n    const [copied, setCopied] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const token = searchParams.get('token');\r\n        const status = searchParams.get('google_drive');\r\n        if (status === 'success' && token) {\r\n            setDriveToken(token);\r\n        }\r\n    }, [searchParams]);\r\n\r\n    const copyToClipboard = () => {\r\n        if (driveToken) {\r\n            navigator.clipboard.writeText(driveToken);\r\n            setCopied(true);\r\n            setTimeout(() => setCopied(false), 2000);\r\n        }\r\n    };\r\n\r\n    const closeDriveModal = () => {\r\n        setDriveToken(null);\r\n        router.replace('/settings');\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (user) {\r\n            setName(user.name || \"\");\r\n        }\r\n    }, [user]);\r\n\r\n    const handleAvatarUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file || !user) return;\r\n\r\n        setIsUploading(true);\r\n        try {\r\n            // Upload using new API\r\n            const formData = new FormData();\r\n            formData.append('file', file);\r\n            formData.append('type', 'avatar');\r\n            formData.append('id', user.id);\r\n\r\n\r\n\r\n            const res = await authenticatedFetch('/api/upload', {\r\n                method: 'POST',\r\n                body: formData,\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const errorData = await res.json();\r\n                throw new Error(errorData.error || 'Upload failed');\r\n            }\r\n            const { url } = await res.json();\r\n\r\n            // Update Profile in both local and Firebase\r\n            await hybridStorage.profile.update(user.id, { avatar: url });\r\n\r\n            // Force immediate sync to Firestore (don't wait for debounce)\r\n            // This ensures avatar persists even if user hard refreshes immediately\r\n            await syncManager.syncNow();\r\n\r\n            // Refresh Context to show new avatar instantly\r\n            await refreshUser();\r\n        } catch (error: any) {\r\n            console.error(\"Failed to upload avatar\", error);\r\n            // No rollback needed - avatar state wasn't updated until after success\r\n            // The user's avatar remains unchanged as expected\r\n            alert(error.message || \"Failed to upload avatar\");\r\n        } finally {\r\n            setIsUploading(false);\r\n        }\r\n    };\r\n\r\n    const handleSaveName = async () => {\r\n        if (!user || !tempName.trim()) return;\r\n\r\n        try {\r\n            await hybridStorage.profile.update(user.id, { name: tempName });\r\n            await syncManager.syncNow(); // Force immediate sync\r\n            setName(tempName);\r\n            setIsEditing(false);\r\n        } catch (error) {\r\n            console.error(\"Failed to update name\");\r\n        }\r\n    };\r\n\r\n    const handleDeleteAccount = () => {\r\n        if (confirm(\"Delete your account? This cannot be undone.\")) {\r\n            alert(\"Account deletion would be processed here.\");\r\n        }\r\n    };\r\n\r\n    if (!user) {\r\n        return (\r\n            <div className=\"flex justify-center items-center h-[50vh] text-neutral-400\">\r\n                {t.loading}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex justify-center\">\r\n            {/* Google Drive Token Modal */}\r\n            <SimpleModal\r\n                isOpen={!!driveToken}\r\n                onClose={closeDriveModal}\r\n                title=\"Google Drive Authorization Successful!\"\r\n                onConfirm={closeDriveModal}\r\n                confirmText=\"Close\"\r\n                cancelText=\"Done\"\r\n                icon={<Check size={20} />}\r\n                isDestructive={false}\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">\r\n                        Copy this <strong>Refresh Token</strong> and add it to your <code>.env</code> file (locally) and Vercel Environment Variables (production) as <code>GOOGLE_REFRESH_TOKEN</code>.\r\n                    </p>\r\n                    <div className=\"relative\">\r\n                        <pre className=\"bg-neutral-100 dark:bg-black/30 p-4 rounded-lg text-xs font-mono text-neutral-800 dark:text-neutral-300 break-all whitespace-pre-wrap border border-neutral-200 dark:border-white/10 max-h-32 overflow-y-auto\">\r\n                            {driveToken}\r\n                        </pre>\r\n                        <button\r\n                            onClick={copyToClipboard}\r\n                            className=\"absolute top-2 right-2 p-2 bg-white dark:bg-neutral-800 rounded-md shadow-sm border border-neutral-200 dark:border-white/10 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors\"\r\n                        >\r\n                            {copied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Copy className=\"w-4 h-4 text-neutral-500\" />}\r\n                        </button>\r\n                    </div>\r\n                    <div className=\"p-3 bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-200 dark:border-yellow-900/30 rounded-lg\">\r\n                        <p className=\"text-xs text-yellow-800 dark:text-yellow-500 font-medium\">\r\n                            âš ï¸ Keep this token secret! It gives access to your Google Drive.\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </SimpleModal>\r\n\r\n            <div className=\"w-full max-w-2xl space-y-8\">\r\n                {/* Header */}\r\n                <div>\r\n                    <h1 className=\"text-3xl font-bold text-neutral-900 dark:text-white\">{t.settingsPage.title}</h1>\r\n                    <p className=\"text-neutral-500 dark:text-neutral-400 mt-1\">{t.settingsPage.description}</p>\r\n                </div>\r\n\r\n                {/* Profile Section */}\r\n                <div className=\"space-y-2\">\r\n                    <h2 className=\"text-xs font-semibold uppercase tracking-wider text-neutral-500 px-4\">\r\n                        {t.settingsPage.profile}\r\n                    </h2>\r\n                    <div className=\"bg-white dark:bg-white/5 rounded-xl border border-neutral-200 dark:border-white/10 overflow-hidden shadow-sm dark:shadow-none\">\r\n                        {/* Avatar */}\r\n                        <div className=\"p-4 border-b border-neutral-100 dark:border-white/5 flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className=\"relative group\">\r\n                                    {user.avatar ? (\r\n                                        <img\r\n                                            src={user.avatar}\r\n                                            alt={user.name}\r\n                                            className=\"h-16 w-16 rounded-full object-cover border-2 border-white/10 group-hover:border-blue-500 transition-colors\"\r\n                                        />\r\n                                    ) : (\r\n                                        <div className=\"h-16 w-16 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center text-xl font-bold text-neutral-600 dark:text-white border-2 border-neutral-300 dark:border-white/10 group-hover:border-blue-500 transition-colors\">\r\n                                            {user.name?.[0]?.toUpperCase() || \"U\"}\r\n                                        </div>\r\n                                    )}\r\n                                    <label className=\"absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity\">\r\n                                        <Camera className=\"w-5 h-5 text-white\" />\r\n                                        <input\r\n                                            type=\"file\"\r\n                                            className=\"hidden\"\r\n                                            accept=\"image/*\"\r\n                                            onChange={handleAvatarUpload}\r\n                                            disabled={isUploading}\r\n                                        />\r\n                                    </label>\r\n                                    {isUploading && (\r\n                                        <div className=\"absolute inset-0 flex items-center justify-center bg-black/70 rounded-full\">\r\n                                            <div className=\"w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin\"></div>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <div>\r\n                                    <div className=\"text-sm font-medium text-neutral-900 dark:text-white\">{t.settingsPage.profilePicture}</div>\r\n                                    <div className=\"text-xs text-neutral-400 mt-1\">{t.settingsPage.uploadAvatar}</div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Name */}\r\n                        {isEditing ? (\r\n                            <div className=\"p-4 border-b border-neutral-100 dark:border-white/5\">\r\n                                <label className=\"text-sm text-neutral-500 dark:text-neutral-400\">{t.settingsPage.name}</label>\r\n                                <div className=\"flex gap-2 mt-2\">\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={tempName}\r\n                                        onChange={(e) => setTempName(e.target.value)}\r\n                                        autoFocus\r\n                                        className=\"flex-1 px-3 py-2 bg-neutral-50 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    />\r\n                                    <button\r\n                                        onClick={() => setIsEditing(false)}\r\n                                        className=\"px-4 py-2 text-sm text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white\"\r\n                                    >\r\n                                        {t.cancel}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={handleSaveName}\r\n                                        className=\"px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n                                    >\r\n                                        {t.save}\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            <button\r\n                                onClick={() => {\r\n                                    setTempName(name);\r\n                                    setIsEditing(true);\r\n                                }}\r\n                                className=\"w-full p-4 flex items-center justify-between hover:bg-neutral-50 dark:hover:bg-white/5 transition-colors border-b border-neutral-100 dark:border-white/5\"\r\n                            >\r\n                                <div className=\"text-left\">\r\n                                    <div className=\"text-sm text-neutral-500 dark:text-neutral-400\">{t.settingsPage.name}</div>\r\n                                    <div className=\"text-neutral-900 dark:text-white mt-0.5\">{name || \"Not set\"}</div>\r\n                                </div>\r\n                                <ChevronRight className=\"w-5 h-5 text-neutral-500\" />\r\n                            </button>\r\n                        )}\r\n\r\n                        {/* Email */}\r\n                        <div className=\"p-4 flex items-center justify-between border-b border-neutral-100 dark:border-white/5\">\r\n                            <div>\r\n                                <div className=\"text-sm text-neutral-500 dark:text-neutral-400\">{t.settingsPage.email}</div>\r\n                                <div className=\"text-neutral-900 dark:text-white mt-0.5\">{user.email}</div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Profile Details Link */}\r\n                        <Link href=\"/settings/profile\">\r\n                            <button className=\"w-full p-4 flex items-center justify-between hover:bg-neutral-50 dark:hover:bg-white/5 transition-colors\">\r\n                                <div className=\"text-left\">\r\n                                    <div className=\"text-neutral-900 dark:text-white\">Profile Details</div>\r\n                                    <div className=\"text-sm text-neutral-400 mt-0.5\">\r\n                                        Phone, bio, and more\r\n                                    </div>\r\n                                </div>\r\n                                <ChevronRight className=\"w-5 h-5 text-neutral-500\" />\r\n                            </button>\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Security Section */}\r\n                <div className=\"space-y-2\">\r\n                    <h2 className=\"text-xs font-semibold uppercase tracking-wider text-neutral-500 px-4\">\r\n                        {t.settingsPage.security}\r\n                    </h2>\r\n                    <div className=\"bg-white dark:bg-white/5 rounded-xl border border-neutral-200 dark:border-white/10 overflow-hidden shadow-sm dark:shadow-none\">\r\n                        <Link href=\"/settings/security\">\r\n                            <button className=\"w-full p-4 flex items-center justify-between hover:bg-neutral-50 dark:hover:bg-white/5 transition-colors\">\r\n                                <div className=\"text-left\">\r\n                                    <div className=\"text-neutral-900 dark:text-white\">{t.settingsPage.passwordEmail}</div>\r\n                                    <div className=\"text-sm text-neutral-400 mt-0.5\">\r\n                                        {t.settingsPage.changePassword}\r\n                                    </div>\r\n                                </div>\r\n                                <ChevronRight className=\"w-5 h-5 text-neutral-500\" />\r\n                            </button>\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Notifications Section */}\r\n                <div className=\"space-y-2\">\r\n                    <h2 className=\"text-xs font-semibold uppercase tracking-wider text-neutral-500 px-4\">\r\n                        {t.settingsPage.notifications}\r\n                    </h2>\r\n                    <div className=\"bg-white dark:bg-white/5 rounded-xl border border-neutral-200 dark:border-white/10 overflow-hidden divide-y divide-neutral-100 dark:divide-white/5 shadow-sm dark:shadow-none\">\r\n                        <div className=\"p-4 flex items-center justify-between\">\r\n                            <div>\r\n                                <div className=\"text-neutral-900 dark:text-white\">{t.settingsPage.emailNotifications}</div>\r\n                                <div className=\"text-sm text-neutral-400 mt-0.5\">\r\n                                    {t.settingsPage.courseUpdates}\r\n                                </div>\r\n                            </div>\r\n                            <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                                <input type=\"checkbox\" defaultChecked className=\"sr-only peer\" />\r\n                                <div className=\"w-11 h-6 bg-neutral-200 dark:bg-white/20 rounded-full peer peer-focus:outline-none peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600\"></div>\r\n                            </label>\r\n                        </div>\r\n\r\n                        <div className=\"p-4 flex items-center justify-between\">\r\n                            <div>\r\n                                <div className=\"text-neutral-900 dark:text-white\">{t.settingsPage.courseReminders}</div>\r\n                                <div className=\"text-sm text-neutral-400 mt-0.5\">{t.settingsPage.dailyReminders}</div>\r\n                            </div>\r\n                            <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                                <input type=\"checkbox\" defaultChecked className=\"sr-only peer\" />\r\n                                <div className=\"w-11 h-6 bg-neutral-200 dark:bg-white/20 rounded-full peer peer-focus:outline-none peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600\"></div>\r\n                            </label>\r\n                        </div>\r\n\r\n                        <div className=\"p-4 flex items-center justify-between\">\r\n                            <div>\r\n                                <div className=\"text-neutral-900 dark:text-white\">{t.settingsPage.achievements}</div>\r\n                                <div className=\"text-sm text-neutral-400 mt-0.5\">{t.settingsPage.badgesMilestones}</div>\r\n                            </div>\r\n                            <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                                <input type=\"checkbox\" defaultChecked className=\"sr-only peer\" />\r\n                                <div className=\"w-11 h-6 bg-neutral-200 dark:bg-white/20 rounded-full peer peer-focus:outline-none peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600\"></div>\r\n                            </label>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Danger Zone */}\r\n                <div className=\"space-y-2\">\r\n                    <h2 className=\"text-xs font-semibold uppercase tracking-wider text-red-400 px-4\">\r\n                        {t.settingsPage.dangerZone}\r\n                    </h2>\r\n                    <div className=\"bg-red-500/10 rounded-xl border border-red-500/20 overflow-hidden\">\r\n                        <button\r\n                            onClick={handleDeleteAccount}\r\n                            className=\"w-full p-4 flex items-center justify-between hover:bg-red-500/20 transition-colors\"\r\n                        >\r\n                            <div className=\"text-left\">\r\n                                <div className=\"text-red-400 font-medium flex items-center gap-2\">\r\n                                    <Trash2 className=\"w-4 h-4\" />\r\n                                    {t.settingsPage.deleteAccount}\r\n                                </div>\r\n                                <div className=\"text-sm text-red-300/70 mt-0.5\">\r\n                                    {t.settingsPage.deleteWarning}\r\n                                </div>\r\n                            </div>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\settings\\profile\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3061,3064],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3061,3064],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":176,"column":41,"nodeType":"JSXOpeningElement","endLine":176,"endColumn":117}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { syncManager } from \"@/lib/storage/sync-manager\";\r\nimport { ChevronLeft, Camera, Loader2 } from \"lucide-react\";\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { PhoneInput } from \"@/components/ui/phone-input\";\r\n\r\nexport default function ProfileDetailsPage() {\r\n    const { user, refreshUser } = useAuth();\r\n    const [username, setUsername] = useState(\"\");\r\n    const [phone, setPhone] = useState(\"\");\r\n    const [bio, setBio] = useState(\"\");\r\n    const [firstName, setFirstName] = useState(\"\");\r\n    const [lastName, setLastName] = useState(\"\");\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [saveMessage, setSaveMessage] = useState<string | null>(null);\r\n    const [errors, setErrors] = useState<{ username?: string; firstName?: string; lastName?: string; phone?: string }>({});\r\n\r\n    // Avatar upload state\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        if (user) {\r\n            setUsername(user.username || \"\");\r\n            setPhone(user.phone || \"\");\r\n            setBio(user.bio || \"\");\r\n            setFirstName(user.firstName || \"\");\r\n            setLastName(user.lastName || \"\");\r\n            setAvatarUrl(user.avatar || null);\r\n        }\r\n    }, [user]);\r\n\r\n    const handleAvatarUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file || !user) return;\r\n\r\n        // Store previous avatar for rollback on failure\r\n        const previousAvatar = avatarUrl;\r\n\r\n        setIsUploading(true);\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('file', file);\r\n            formData.append('type', 'avatar');\r\n            formData.append('id', user.id);\r\n\r\n\r\n\r\n            const res = await authenticatedFetch('/api/upload', {\r\n                method: 'POST',\r\n                body: formData,\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const errorData = await res.json();\r\n                throw new Error(errorData.error || 'Upload failed');\r\n            }\r\n\r\n            const data = await res.json();\r\n\r\n            // Update UI immediately (optimistic)\r\n            setAvatarUrl(data.url);\r\n\r\n            // Update user profile in storage/DB\r\n            await hybridStorage.profile.update(user.id, { avatar: data.url });\r\n\r\n            // Force immediate sync to Firestore (don't wait for 30s debounce)\r\n            await syncManager.syncNow();\r\n\r\n            // Refresh user in context so sidebar updates instantly\r\n            await refreshUser();\r\n\r\n            setSaveMessage(\"Avatar updated successfully!\");\r\n            setTimeout(() => setSaveMessage(null), 3000);\r\n        } catch (error: any) {\r\n            console.error(error);\r\n            // Rollback to previous avatar on failure\r\n            setAvatarUrl(previousAvatar);\r\n            setSaveMessage(error.message || \"Failed to upload avatar\");\r\n        } finally {\r\n            setIsUploading(false);\r\n        }\r\n    };\r\n\r\n    const validateForm = (): boolean => {\r\n        // ... existing validation\r\n        const newErrors: typeof errors = {};\r\n\r\n        // Validate first name - letters, spaces, hyphens only\r\n        if (firstName && !/^[a-zA-Z\\s-]+$/.test(firstName)) {\r\n            newErrors.firstName = \"Only letters, spaces, and hyphens allowed\";\r\n        }\r\n\r\n        // Validate last name\r\n        if (lastName && !/^[a-zA-Z\\s-]+$/.test(lastName)) {\r\n            newErrors.lastName = \"Only letters, spaces, and hyphens allowed\";\r\n        }\r\n\r\n        // Validate phone - must be 8-20 digits (allowing spaces, hyphens, parentheses)\r\n        if (phone && !/^[\\d\\s\\-()]{8,20}$/.test(phone)) {\r\n            newErrors.phone = \"Invalid phone number (8-20 digits required)\";\r\n        }\r\n\r\n        setErrors(newErrors);\r\n        return Object.keys(newErrors).length === 0;\r\n    };\r\n\r\n    const handleSave = async (e: React.FormEvent) => {\r\n        // ... existing handleSave\r\n        e.preventDefault();\r\n        if (!user) return;\r\n\r\n        if (!validateForm()) {\r\n            setSaveMessage(\"Please fix the errors above\");\r\n            setTimeout(() => setSaveMessage(null), 3000);\r\n            return;\r\n        }\r\n\r\n        setIsSaving(true);\r\n        setSaveMessage(null);\r\n\r\n        try {\r\n            await hybridStorage.profile.update(user.id, {\r\n                username,\r\n                phone,\r\n                bio,\r\n                firstName,\r\n                lastName,\r\n            });\r\n\r\n            // Refresh user in context so sidebar updates instantly\r\n            await refreshUser();\r\n\r\n            setSaveMessage(\"Profile updated successfully!\");\r\n            setTimeout(() => setSaveMessage(null), 3000);\r\n        } catch (error) {\r\n            console.error(\"Failed to update profile:\", error);\r\n            setSaveMessage(\"Failed to update profile\");\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    if (!user) {\r\n        return <div className=\"flex justify-center items-center h-[50vh] text-neutral-400\">Loading...</div>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex justify-center\">\r\n            <div className=\"w-full max-w-2xl space-y-6\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center gap-4\">\r\n                    <a href=\"/settings\" className=\"text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300\">\r\n                        <ChevronLeft className=\"w-6 h-6\" />\r\n                    </a>\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold text-neutral-900 dark:text-white\">Profile Details</h1>\r\n                        <p className=\"text-neutral-500 dark:text-neutral-400 mt-1\">Manage your personal information</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <form onSubmit={handleSave} className=\"space-y-4\">\r\n                    <div className=\"bg-white dark:bg-white/5 rounded-xl border border-neutral-200 dark:border-white/10 overflow-hidden divide-y divide-neutral-100 dark:divide-white/5\">\r\n\r\n                        {/* Avatar Section */}\r\n                        <div className=\"p-6 flex flex-col items-center border-b border-neutral-100 dark:border-white/5 bg-neutral-50/50 dark:bg-white/5\">\r\n                            <div className=\"relative group cursor-pointer\" onClick={() => fileInputRef.current?.click()}>\r\n                                <div className=\"w-24 h-24 rounded-full overflow-hidden ring-4 ring-white dark:ring-neutral-900 shadow-lg\">\r\n                                    {avatarUrl ? (\r\n                                        <img src={avatarUrl} alt=\"Profile\" className=\"w-full h-full object-cover\" />\r\n                                    ) : (\r\n                                        <div className=\"w-full h-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-3xl font-bold text-white\">\r\n                                            {firstName?.[0] || user.name?.[0] || \"U\"}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                    {isUploading ? (\r\n                                        <Loader2 className=\"w-8 h-8 text-white animate-spin\" />\r\n                                    ) : (\r\n                                        <Camera className=\"w-8 h-8 text-white\" />\r\n                                    )}\r\n                                </div>\r\n                                <input\r\n                                    type=\"file\"\r\n                                    ref={fileInputRef}\r\n                                    className=\"hidden\"\r\n                                    accept=\"image/*\"\r\n                                    onChange={handleAvatarUpload}\r\n                                    disabled={isUploading}\r\n                                />\r\n                            </div>\r\n                            <p className=\"mt-3 text-sm text-neutral-500 dark:text-neutral-400\">\r\n                                Click to upload new avatar\r\n                            </p>\r\n                        </div>\r\n                        {/* Name - grouped */}\r\n                        <div className=\"p-4\">\r\n                            <label className=\"text-sm text-neutral-500 dark:text-neutral-400 block mb-2\">Name</label>\r\n                            <div className=\"grid grid-cols-2 gap-3\">\r\n                                <div>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={firstName}\r\n                                        onChange={(e) => {\r\n                                            setFirstName(e.target.value);\r\n                                            if (errors.firstName) setErrors({ ...errors, firstName: undefined });\r\n                                        }}\r\n                                        placeholder=\"First name\"\r\n                                        className={`w-full px-3 py-2 bg-neutral-50 dark:bg-white/5 border ${errors.firstName ? 'border-red-500' : 'border-neutral-200 dark:border-white/10'} rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500`}\r\n                                    />\r\n                                    {errors.firstName && (\r\n                                        <p className=\"text-xs text-red-500 mt-1\">{errors.firstName}</p>\r\n                                    )}\r\n                                </div>\r\n                                <div>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={lastName}\r\n                                        onChange={(e) => {\r\n                                            setLastName(e.target.value);\r\n                                            if (errors.lastName) setErrors({ ...errors, lastName: undefined });\r\n                                        }}\r\n                                        placeholder=\"Last name\"\r\n                                        className={`w-full px-3 py-2 bg-neutral-50 dark:bg-white/5 border ${errors.lastName ? 'border-red-500' : 'border-neutral-200 dark:border-white/10'} rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500`}\r\n                                    />\r\n                                    {errors.lastName && (\r\n                                        <p className=\"text-xs text-red-500 mt-1\">{errors.lastName}</p>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Username */}\r\n                        <div className=\"p-4\">\r\n                            <label className=\"text-sm text-neutral-500 dark:text-neutral-400 block mb-2\">Username</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={username}\r\n                                onChange={(e) => {\r\n                                    setUsername(e.target.value.toLowerCase());\r\n                                    if (errors.username) setErrors({ ...errors, username: undefined });\r\n                                }}\r\n                                placeholder=\"johndoe123\"\r\n                                className={`w-full px-3 py-2 bg-neutral-50 dark:bg-white/5 border ${errors.username ? 'border-red-500' : 'border-neutral-200 dark:border-white/10'} rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500`}\r\n                            />\r\n                            {errors.username && (\r\n                                <p className=\"text-xs text-red-500 mt-1\">{errors.username}</p>\r\n                            )}\r\n                            <p className=\"text-xs text-neutral-500 dark:text-neutral-400 mt-1\">Used for your profile URL</p>\r\n                        </div>\r\n                        <div className=\"p-4\">\r\n                            <label className=\"text-sm text-neutral-500 dark:text-neutral-400\">Phone</label>\r\n                            <div className=\"mt-2\">\r\n                                <PhoneInput\r\n                                    value={phone}\r\n                                    onChange={(val) => {\r\n                                        setPhone(val);\r\n                                        if (errors.phone) setErrors({ ...errors, phone: undefined });\r\n                                    }}\r\n                                    placeholder=\"123 456 7890\"\r\n                                />\r\n                                {errors.phone && (\r\n                                    <p className=\"text-xs text-red-500 mt-1\">{errors.phone}</p>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"p-4\">\r\n                            <label className=\"text-sm text-neutral-500 dark:text-neutral-400\">Bio</label>\r\n                            <textarea\r\n                                value={bio}\r\n                                onChange={(e) => setBio(e.target.value)}\r\n                                rows={4}\r\n                                placeholder=\"Tell us about yourself...\"\r\n                                className=\"w-full mt-2 px-0 py-1 bg-transparent border-none text-neutral-900 dark:text-white placeholder:text-neutral-400 focus:outline-none resize-none\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {saveMessage && (\r\n                        <div className={`p-3 rounded-lg text-sm ${saveMessage.includes(\"success\") ? \"bg-green-500/20 text-green-600 dark:text-green-400\" : \"bg-red-500/20 text-red-600 dark:text-red-400\"}`}>\r\n                            {saveMessage}\r\n                        </div>\r\n                    )}\r\n\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={isSaving}\r\n                        className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-600/50 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                        {isSaving ? \"Saving...\" : \"Save Changes\"}\r\n                    </button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\settings\\security\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2404,2407],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2404,2407],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3727,3730],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3727,3730],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { firebaseAuth } from \"@/lib/firebase/auth\";\r\nimport { ChevronLeft, AlertCircle, CheckCircle } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { updatePassword, updateEmail, EmailAuthProvider, reauthenticateWithCredential } from \"firebase/auth\";\r\n\r\ntype Section = \"menu\" | \"password\" | \"email\";\r\n\r\nexport default function SecurityPage() {\r\n    const { user } = useAuth();\r\n    const router = useRouter();\r\n    const [section, setSection] = useState<Section>(\"menu\");\r\n\r\n    // Password state\r\n    const [currentPassword, setCurrentPassword] = useState(\"\");\r\n    const [newPassword, setNewPassword] = useState(\"\");\r\n    const [confirmPassword, setConfirmPassword] = useState(\"\");\r\n    const [passwordMessage, setPasswordMessage] = useState<{ type: \"success\" | \"error\", text: string } | null>(null);\r\n    const [isChangingPassword, setIsChangingPassword] = useState(false);\r\n\r\n    // Email state\r\n    const [newEmail, setNewEmail] = useState(\"\");\r\n    const [emailPassword, setEmailPassword] = useState(\"\");\r\n    const [emailMessage, setEmailMessage] = useState<{ type: \"success\" | \"error\", text: string } | null>(null);\r\n    const [isChangingEmail, setIsChangingEmail] = useState(false);\r\n\r\n    const handleChangePassword = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setPasswordMessage(null);\r\n\r\n        if (newPassword !== confirmPassword) {\r\n            setPasswordMessage({ type: \"error\", text: \"Passwords don't match\" });\r\n            return;\r\n        }\r\n\r\n        if (newPassword.length < 6) {\r\n            setPasswordMessage({ type: \"error\", text: \"Password must be at least 6 characters\" });\r\n            return;\r\n        }\r\n\r\n        setIsChangingPassword(true);\r\n\r\n        try {\r\n            const firebaseUser = firebaseAuth.getCurrentUser();\r\n            if (!firebaseUser || !user?.email) throw new Error(\"Not authenticated\");\r\n\r\n            const credential = EmailAuthProvider.credential(user.email, currentPassword);\r\n            await reauthenticateWithCredential(firebaseUser, credential);\r\n            await updatePassword(firebaseUser, newPassword);\r\n\r\n            setPasswordMessage({ type: \"success\", text: \"Password updated!\" });\r\n            setTimeout(() => setSection(\"menu\"), 1500);\r\n        } catch (error: any) {\r\n            if (error.code === \"auth/wrong-password\") {\r\n                setPasswordMessage({ type: \"error\", text: \"Current password is incorrect\" });\r\n            } else {\r\n                setPasswordMessage({ type: \"error\", text: error.message || \"Failed to update password\" });\r\n            }\r\n        } finally {\r\n            setIsChangingPassword(false);\r\n        }\r\n    };\r\n\r\n    const handleChangeEmail = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setEmailMessage(null);\r\n\r\n        if (!newEmail.includes(\"@\")) {\r\n            setEmailMessage({ type: \"error\", text: \"Invalid email address\" });\r\n            return;\r\n        }\r\n\r\n        setIsChangingEmail(true);\r\n\r\n        try {\r\n            const firebaseUser = firebaseAuth.getCurrentUser();\r\n            if (!firebaseUser || !user?.email) throw new Error(\"Not authenticated\");\r\n\r\n            const credential = EmailAuthProvider.credential(user.email, emailPassword);\r\n            await reauthenticateWithCredential(firebaseUser, credential);\r\n            await updateEmail(firebaseUser, newEmail);\r\n\r\n            setEmailMessage({ type: \"success\", text: \"Email updated!\" });\r\n            setTimeout(() => {\r\n                setSection(\"menu\");\r\n                router.refresh();\r\n            }, 1500);\r\n        } catch (error: any) {\r\n            if (error.code === \"auth/wrong-password\") {\r\n                setEmailMessage({ type: \"error\", text: \"Password is incorrect\" });\r\n            } else if (error.code === \"auth/email-already-in-use\") {\r\n                setEmailMessage({ type: \"error\", text: \"Email already in use\" });\r\n            } else {\r\n                setEmailMessage({ type: \"error\", text: error.message || \"Failed to update email\" });\r\n            }\r\n        } finally {\r\n            setIsChangingEmail(false);\r\n        }\r\n    };\r\n\r\n    if (!user) {\r\n        return <div className=\"flex justify-center items-center h-[50vh] text-neutral-400\">Loading...</div>;\r\n    }\r\n\r\n    const renderMenu = () => (\r\n        <div className=\"space-y-2\">\r\n            <div className=\"bg-white/5 rounded-xl border border-white/10 overflow-hidden divide-y divide-white/5\">\r\n                <button\r\n                    onClick={() => setSection(\"password\")}\r\n                    className=\"w-full p-4 flex items-center justify-between hover:bg-white/5 transition-colors\"\r\n                >\r\n                    <div className=\"text-left\">\r\n                        <div className=\"text-white\">Password</div>\r\n                        <div className=\"text-sm text-neutral-400 mt-0.5\">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>\r\n                    </div>\r\n                    <ChevronLeft className=\"w-5 h-5 text-neutral-500 rotate-180\" />\r\n                </button>\r\n\r\n                <button\r\n                    onClick={() => setSection(\"email\")}\r\n                    className=\"w-full p-4 flex items-center justify-between hover:bg-white/5 transition-colors\"\r\n                >\r\n                    <div className=\"text-left\">\r\n                        <div className=\"text-white\">Email</div>\r\n                        <div className=\"text-sm text-neutral-400 mt-0.5\">{user.email}</div>\r\n                    </div>\r\n                    <ChevronLeft className=\"w-5 h-5 text-neutral-500 rotate-180\" />\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderPasswordForm = () => (\r\n        <form onSubmit={handleChangePassword} className=\"space-y-4\">\r\n            <div className=\"bg-white/5 rounded-xl border border-white/10 overflow-hidden divide-y divide-white/5\">\r\n                <div className=\"p-4\">\r\n                    <label className=\"text-sm text-neutral-400\">Current Password</label>\r\n                    <input\r\n                        type=\"password\"\r\n                        value={currentPassword}\r\n                        onChange={(e) => setCurrentPassword(e.target.value)}\r\n                        required\r\n                        className=\"w-full mt-2 px-0 py-1 bg-transparent border-none text-white focus:outline-none\"\r\n                    />\r\n                </div>\r\n                <div className=\"p-4\">\r\n                    <label className=\"text-sm text-neutral-400\">New Password</label>\r\n                    <input\r\n                        type=\"password\"\r\n                        value={newPassword}\r\n                        onChange={(e) => setNewPassword(e.target.value)}\r\n                        required\r\n                        minLength={6}\r\n                        className=\"w-full mt-2 px-0 py-1 bg-transparent border-none text-white focus:outline-none\"\r\n                    />\r\n                </div>\r\n                <div className=\"p-4\">\r\n                    <label className=\"text-sm text-neutral-400\">Verify Password</label>\r\n                    <input\r\n                        type=\"password\"\r\n                        value={confirmPassword}\r\n                        onChange={(e) => setConfirmPassword(e.target.value)}\r\n                        required\r\n                        minLength={6}\r\n                        className=\"w-full mt-2 px-0 py-1 bg-transparent border-none text-white focus:outline-none\"\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {passwordMessage && (\r\n                <div className={`flex items-center gap-2 p-3 rounded-lg ${passwordMessage.type === \"success\" ? \"bg-green-500/20 text-green-400\" : \"bg-red-500/20 text-red-400\"}`}>\r\n                    {passwordMessage.type === \"success\" ? <CheckCircle className=\"w-4 h-4\" /> : <AlertCircle className=\"w-4 h-4\" />}\r\n                    <span className=\"text-sm\">{passwordMessage.text}</span>\r\n                </div>\r\n            )}\r\n\r\n            <button\r\n                type=\"submit\"\r\n                disabled={isChangingPassword}\r\n                className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-600/50 text-white rounded-lg font-medium transition-colors\"\r\n            >\r\n                {isChangingPassword ? \"Updating...\" : \"Change Password\"}\r\n            </button>\r\n        </form>\r\n    );\r\n\r\n    const renderEmailForm = () => (\r\n        <form onSubmit={handleChangeEmail} className=\"space-y-4\">\r\n            <div className=\"bg-white/5 rounded-xl border border-white/10 overflow-hidden divide-y divide-white/5\">\r\n                <div className=\"p-4\">\r\n                    <label className=\"text-sm text-neutral-400\">New Email</label>\r\n                    <input\r\n                        type=\"email\"\r\n                        value={newEmail}\r\n                        onChange={(e) => setNewEmail(e.target.value)}\r\n                        required\r\n                        placeholder={user.email}\r\n                        className=\"w-full mt-2 px-0 py-1 bg-transparent border-none text-white placeholder:text-neutral-600 focus:outline-none\"\r\n                    />\r\n                </div>\r\n                <div className=\"p-4\">\r\n                    <label className=\"text-sm text-neutral-400\">Password</label>\r\n                    <input\r\n                        type=\"password\"\r\n                        value={emailPassword}\r\n                        onChange={(e) => setEmailPassword(e.target.value)}\r\n                        required\r\n                        className=\"w-full mt-2 px-0 py-1 bg-transparent border-none text-white focus:outline-none\"\r\n                    />\r\n                    <p className=\"text-xs text-neutral-500 mt-2\">Enter your password to confirm</p>\r\n                </div>\r\n            </div>\r\n\r\n            {emailMessage && (\r\n                <div className={`flex items-center gap-2 p-3 rounded-lg ${emailMessage.type === \"success\" ? \"bg-green-500/20 text-green-400\" : \"bg-red-500/20 text-red-400\"}`}>\r\n                    {emailMessage.type === \"success\" ? <CheckCircle className=\"w-4 h-4\" /> : <AlertCircle className=\"w-4 h-4\" />}\r\n                    <span className=\"text-sm\">{emailMessage.text}</span>\r\n                </div>\r\n            )}\r\n\r\n            <button\r\n                type=\"submit\"\r\n                disabled={isChangingEmail}\r\n                className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-600/50 text-white rounded-lg font-medium transition-colors\"\r\n            >\r\n                {isChangingEmail ? \"Updating...\" : \"Change Email\"}\r\n            </button>\r\n        </form>\r\n    );\r\n\r\n    return (\r\n        <div className=\"flex justify-center\">\r\n            <div className=\"w-full max-w-2xl space-y-6\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    {section !== \"menu\" && (\r\n                        <button onClick={() => setSection(\"menu\")} className=\"text-blue-400 hover:text-blue-300\">\r\n                            <ChevronLeft className=\"w-6 h-6\" />\r\n                        </button>\r\n                    )}\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold text-white\">\r\n                            {section === \"menu\" ? \"Security\" : section === \"password\" ? \"Change Password\" : \"Change Email\"}\r\n                        </h1>\r\n                        <p className=\"text-neutral-400 mt-1\">\r\n                            {section === \"menu\" ? \"Manage your account security\" : \"Keep your account secure\"}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n\r\n                {section === \"menu\" && renderMenu()}\r\n                {section === \"password\" && renderPasswordForm()}\r\n                {section === \"email\" && renderEmailForm()}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\(dashboard)\\user\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'spring' is assigned a value but never used.","line":14,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3617,3620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3617,3620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5734,5737],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5734,5737],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6782,6785],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6782,6785],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { CourseCard } from \"@/components/course/CourseCard\";\r\nimport { SubscriptionWidget } from \"@/components/subscription/SubscriptionWidget\";\r\nimport { BookOpen, TrendingUp, Award, Flame, Sparkles } from \"lucide-react\";\r\nimport { useEffect, useState, useMemo } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\n\r\n// Apple-style spring animation config\r\nconst spring = {\r\n    type: \"spring\",\r\n    stiffness: 300,\r\n    damping: 30,\r\n};\r\n\r\n// Stagger container variants\r\nconst containerVariants = {\r\n    hidden: { opacity: 0 },\r\n    visible: {\r\n        opacity: 1,\r\n        transition: {\r\n            staggerChildren: 0.1,\r\n            delayChildren: 0.1,\r\n        },\r\n    },\r\n};\r\n\r\n// Item fade up variants\r\nconst itemVariants = {\r\n    hidden: { opacity: 0, y: 20 },\r\n    visible: {\r\n        opacity: 1,\r\n        y: 0,\r\n        transition: { type: \"spring\" as const, stiffness: 300, damping: 30 },\r\n    },\r\n} as const;\r\n\r\n// Stats card with number animation\r\nfunction StatCard({ icon: Icon, value, label, color, delay = 0 }: {\r\n    icon: typeof BookOpen;\r\n    value: number | string;\r\n    label: string;\r\n    color: string;\r\n    delay?: number;\r\n}) {\r\n    const colorClasses = {\r\n        blue: { bg: \"bg-blue-500/10 dark:bg-blue-500/10\", text: \"text-blue-600 dark:text-blue-400\", border: \"hover:border-blue-500/30\" },\r\n        indigo: { bg: \"bg-indigo-500/10 dark:bg-indigo-500/10\", text: \"text-indigo-600 dark:text-indigo-400\", border: \"hover:border-indigo-500/30\" },\r\n        green: { bg: \"bg-green-500/10 dark:bg-green-500/10\", text: \"text-green-600 dark:text-green-400\", border: \"hover:border-green-500/30\" },\r\n        orange: { bg: \"bg-orange-500/10 dark:bg-orange-500/10\", text: \"text-orange-600 dark:text-orange-400\", border: \"hover:border-orange-500/30\" },\r\n    }[color] || { bg: \"bg-blue-500/10 dark:bg-blue-500/10\", text: \"text-blue-600 dark:text-blue-400\", border: \"hover:border-blue-500/30\" };\r\n\r\n    return (\r\n        <motion.div\r\n            variants={itemVariants}\r\n            whileHover={{ scale: 1.02, y: -2 }}\r\n            whileTap={{ scale: 0.98 }}\r\n            className={`bg-white/80 dark:bg-black/20 backdrop-blur-sm p-5 rounded-2xl border border-neutral-200 dark:border-white/5 ${colorClasses.border} transition-colors cursor-default shadow-sm dark:shadow-none`}\r\n        >\r\n            <div className=\"flex items-center justify-between mb-3\">\r\n                <motion.div\r\n                    className={`p-2.5 ${colorClasses.bg} rounded-xl`}\r\n                    whileHover={{ rotate: [0, -10, 10, 0] }}\r\n                    transition={{ duration: 0.5 }}\r\n                >\r\n                    <Icon className={`w-5 h-5 ${colorClasses.text}`} />\r\n                </motion.div>\r\n            </div>\r\n            <motion.div\r\n                className=\"text-3xl font-bold text-neutral-900 dark:text-white mb-1\"\r\n                initial={{ opacity: 0, scale: 0.5 }}\r\n                animate={{ opacity: 1, scale: 1 }}\r\n                transition={{ type: \"spring\" as const, stiffness: 300, damping: 30, delay: delay + 0.3 }}\r\n            >\r\n                {value}\r\n            </motion.div>\r\n            <div className=\"text-sm text-neutral-500 dark:text-neutral-400\">{label}</div>\r\n        </motion.div>\r\n    );\r\n}\r\n\r\nexport default function UserDashboard() {\r\n    const { user, isLoading: isUserLoading } = useAuth();\r\n    const [allCourses, setAllCourses] = useState<any[]>([]);\r\n    const [isLoadingCourses, setIsLoadingCourses] = useState(true);\r\n    const [localUser, setLocalUser] = useState(user);\r\n    const [mounted, setMounted] = useState(false);\r\n    const { t } = useTranslation();\r\n\r\n    // Prevent hydration mismatch by deferring render\r\n    useEffect(() => {\r\n        setMounted(true);\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (user) setLocalUser(user);\r\n    }, [user]);\r\n\r\n    useEffect(() => {\r\n        if (!user && !isUserLoading) {\r\n            const cachedUser = hybridStorage.auth.getSession();\r\n            if (cachedUser) setLocalUser(cachedUser);\r\n        }\r\n    }, [user, isUserLoading]);\r\n\r\n    useEffect(() => {\r\n        fetch('/api/courses', { cache: 'no-store' })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                // DEFENSIVE: Ensure data is an array before setting state\r\n                if (Array.isArray(data)) {\r\n                    setAllCourses(data);\r\n                } else {\r\n                    console.error('Courses API returned non-array:', data);\r\n                    setAllCourses([]); // Use empty array to prevent crash\r\n                }\r\n                setIsLoadingCourses(false);\r\n            })\r\n            .catch(err => {\r\n                console.error('Failed to load courses:', err);\r\n                setAllCourses([]); // Ensure state is always an array\r\n                setIsLoadingCourses(false);\r\n            });\r\n    }, []);\r\n\r\n    const currentUser = localUser || user;\r\n\r\n    const stats = useMemo(() => {\r\n        if (!currentUser) {\r\n            return { coursesEnrolled: 0, lessonsCompleted: 0, hoursLearned: 0, currentStreak: 7 };\r\n        }\r\n        const progress = hybridStorage.progress.get();\r\n        return {\r\n            coursesEnrolled: currentUser.enrolledCourses?.length || 0,\r\n            lessonsCompleted: progress?.completedLessons?.length || 0,\r\n            hoursLearned: progress?.totalHours || 0,\r\n            currentStreak: progress?.currentStreak || 7,\r\n        };\r\n    }, [currentUser]);\r\n\r\n    const [recommendedCourses, setRecommendedCourses] = useState<any[]>([]);\r\n\r\n    const enrolledCourses = useMemo(() => {\r\n        if (!currentUser?.enrolledCourses?.length) return [];\r\n        return allCourses.filter(c => currentUser.enrolledCourses?.includes(c.id));\r\n    }, [currentUser, allCourses]);\r\n\r\n    useEffect(() => {\r\n        async function fetchRecommendations() {\r\n            if (enrolledCourses.length > 0 && allCourses.length > 0) {\r\n                const lastCourseId = enrolledCourses[enrolledCourses.length - 1].id;\r\n                try {\r\n                    const res = await fetch('/api/courses/related', {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify({ courseId: lastCourseId, allCourses }),\r\n                    });\r\n                    const data = await res.json();\r\n                    // DEFENSIVE: Ensure data is an array before calling .filter()\r\n                    if (Array.isArray(data)) {\r\n                        const newRecommendations = data.filter((c: any) => !currentUser?.enrolledCourses?.includes(c.id));\r\n                        setRecommendedCourses(newRecommendations);\r\n                    } else {\r\n                        // API returned error object or non-array, use fallback\r\n                        console.warn('ML recommendations API returned non-array:', data);\r\n                        setRecommendedCourses(allCourses.filter(c => !currentUser?.enrolledCourses?.includes(c.id)).slice(0, 3));\r\n                    }\r\n                } catch (error) {\r\n                    console.error(\"Failed to fetch ML recommendations\", error);\r\n                    setRecommendedCourses(allCourses.filter(c => !currentUser?.enrolledCourses?.includes(c.id)).slice(0, 3));\r\n                }\r\n            } else if (allCourses.length > 0) {\r\n                setRecommendedCourses(allCourses.slice(0, 3));\r\n            }\r\n        }\r\n        if (allCourses.length > 0) fetchRecommendations();\r\n    }, [enrolledCourses, allCourses, currentUser]);\r\n\r\n    // Show consistent loading state on server and client until mounted\r\n    if (!mounted || (isUserLoading && !currentUser)) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-[50vh]\">\r\n                <div className=\"w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const firstName = currentUser?.name?.split(\" \")[0] || \"Student\";\r\n\r\n    return (\r\n        <motion.div\r\n            initial=\"hidden\"\r\n            animate=\"visible\"\r\n            variants={containerVariants}\r\n            className=\"space-y-10\"\r\n        >\r\n            {/* Welcome Header */}\r\n            <motion.div variants={itemVariants}>\r\n                <motion.h1\r\n                    className=\"text-4xl font-bold text-neutral-900 dark:text-white tracking-tight\"\r\n                    initial={{ opacity: 0, x: -20 }}\r\n                    animate={{ opacity: 1, x: 0 }}\r\n                    transition={{ type: \"spring\" as const, stiffness: 300, damping: 30, delay: 0.1 }}\r\n                >\r\n                    {t.userDash.welcomeBack}, {firstName}!\r\n                </motion.h1>\r\n                <motion.p\r\n                    className=\"text-neutral-600 dark:text-neutral-400 mt-2 text-lg\"\r\n                    initial={{ opacity: 0 }}\r\n                    animate={{ opacity: 1 }}\r\n                    transition={{ delay: 0.3 }}\r\n                >\r\n                    {t.userDash.continueJourney}\r\n                </motion.p>\r\n            </motion.div>\r\n\r\n            {/* Stats Grid */}\r\n            <motion.div\r\n                variants={containerVariants}\r\n                className=\"grid grid-cols-2 md:grid-cols-4 gap-4\"\r\n            >\r\n                <StatCard icon={BookOpen} value={stats.coursesEnrolled} label={t.userDash.coursesEnrolled} color=\"blue\" delay={0} />\r\n                <StatCard icon={TrendingUp} value={`${stats.hoursLearned}h`} label={t.userDash.hoursLearned} color=\"indigo\" delay={0.1} />\r\n                <StatCard icon={Award} value={stats.lessonsCompleted} label={t.userDash.lessonsCompleted} color=\"green\" delay={0.2} />\r\n                <StatCard icon={Flame} value={stats.currentStreak} label={t.userDash.dayStreak} color=\"orange\" delay={0.3} />\r\n            </motion.div>\r\n\r\n            {/* Subscription Widget - seamless for free users */}\r\n            <motion.div variants={itemVariants}>\r\n                <SubscriptionWidget />\r\n            </motion.div>\r\n\r\n            {/* Continue Learning Section */}\r\n            {enrolledCourses.length > 0 && (\r\n                <motion.div variants={itemVariants}>\r\n                    <motion.h2\r\n                        className=\"text-2xl font-semibold text-neutral-900 dark:text-white mb-6\"\r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        whileInView={{ opacity: 1, y: 0 }}\r\n                        viewport={{ once: true }}\r\n                    >\r\n                        {t.userDash.continueLearning}\r\n                    </motion.h2>\r\n                    <motion.div\r\n                        className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\"\r\n                        variants={containerVariants}\r\n                        initial=\"hidden\"\r\n                        whileInView=\"visible\"\r\n                        viewport={{ once: true }}\r\n                    >\r\n                        {enrolledCourses.map((course, index) => (\r\n                            <motion.div\r\n                                key={course.id}\r\n                                variants={itemVariants}\r\n                                whileHover={{ y: -4 }}\r\n                                transition={{ type: \"spring\" as const, stiffness: 300, damping: 30 }}\r\n                            >\r\n                                <CourseCard course={course} index={index} />\r\n                            </motion.div>\r\n                        ))}\r\n                    </motion.div>\r\n                </motion.div>\r\n            )}\r\n\r\n            {/* Recommended Courses (ML Powered) */}\r\n            <motion.div variants={itemVariants}>\r\n                <motion.div\r\n                    className=\"flex items-center justify-between mb-6\"\r\n                    initial={{ opacity: 0 }}\r\n                    whileInView={{ opacity: 1 }}\r\n                    viewport={{ once: true }}\r\n                >\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <h2 className=\"text-2xl font-semibold text-neutral-900 dark:text-white\">{t.userDash.recommendedForYou}</h2>\r\n                        <motion.span\r\n                            className=\"text-xs bg-gradient-to-r from-indigo-500/20 to-indigo-500/20 text-indigo-600 dark:text-indigo-300 px-3 py-1 rounded-full border border-indigo-500/20 flex items-center gap-1.5\"\r\n                            animate={{ scale: [1, 1.02, 1] }}\r\n                            transition={{ duration: 2, repeat: Infinity }}\r\n                        >\r\n                            <Sparkles className=\"w-3 h-3\" />\r\n                            {t.userDash.aiPowered}\r\n                        </motion.span>\r\n                    </div>\r\n                    <Link\r\n                        href=\"/browse\"\r\n                        className=\"text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors font-medium\"\r\n                    >\r\n                        {t.userDash.browseAll} â†’\r\n                    </Link>\r\n                </motion.div>\r\n\r\n                {isLoadingCourses ? (\r\n                    <motion.div\r\n                        className=\"flex items-center gap-3 text-neutral-400\"\r\n                        animate={{ opacity: [0.5, 1, 0.5] }}\r\n                        transition={{ duration: 1.5, repeat: Infinity }}\r\n                    >\r\n                        <div className=\"w-5 h-5 border-2 border-neutral-500 border-t-transparent rounded-full animate-spin\" />\r\n                        {t.loading}\r\n                    </motion.div>\r\n                ) : recommendedCourses.length > 0 ? (\r\n                    <motion.div\r\n                        className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\"\r\n                        variants={containerVariants}\r\n                        initial=\"hidden\"\r\n                        whileInView=\"visible\"\r\n                        viewport={{ once: true }}\r\n                    >\r\n                        {recommendedCourses.slice(0, 3).map((course, index) => (\r\n                            <motion.div\r\n                                key={course.id}\r\n                                variants={itemVariants}\r\n                                whileHover={{ y: -4 }}\r\n                                transition={{ type: \"spring\" as const, stiffness: 300, damping: 30 }}\r\n                            >\r\n                                <CourseCard course={course} index={index} />\r\n                            </motion.div>\r\n                        ))}\r\n                    </motion.div>\r\n                ) : (\r\n                    <motion.div\r\n                        className=\"text-neutral-500 dark:text-neutral-400 py-8 text-center bg-neutral-50 dark:bg-white/5 rounded-2xl border border-neutral-200 dark:border-white/5\"\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                    >\r\n                        {t.userDash.noRecommendations}\r\n                    </motion.div>\r\n                )}\r\n            </motion.div>\r\n        </motion.div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\analytics\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\authorize-drive\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[635,638],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[635,638],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Admin-only endpoint to initiate Google Drive authorization\r\n// Only admins can authorize Drive storage for the application\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAdmin } from '@/lib/api/auth-guard';\r\nimport { getAuthUrl } from '@/lib/storage/google-drive';\r\n\r\nexport async function GET(request: NextRequest) {\r\n    // ðŸ”’ SECURITY: Only admins can authorize Drive integration\r\n    const auth = await requireAdmin(request);\r\n    if ('response' in auth) return auth.response;\r\n\r\n    try {\r\n        const authUrl = getAuthUrl();\r\n        return NextResponse.redirect(authUrl);\r\n    } catch (error: any) {\r\n        console.error('Google auth error:', error);\r\n        return NextResponse.json(\r\n            { error: 'Failed to generate auth URL' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\dashboard\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1163,1166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1163,1166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2227,2230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2227,2230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAdmin, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n/**\r\n * GET /api/admin/dashboard\r\n * Get dashboard statistics with real revenue data\r\n */\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        // ðŸ”’ SECURITY: Require admin role\r\n        const authResult = await requireAdmin(request);\r\n        if (!authResult.authenticated) {\r\n            return authResult.response;\r\n        }\r\n\r\n        const admin = initAdmin();\r\n        if (!admin) {\r\n            return NextResponse.json({ error: 'Firebase Admin not initialized' }, { status: 500 });\r\n        }\r\n\r\n        const db = admin.firestore();\r\n\r\n        const stats = {\r\n            totalUsers: 0,\r\n            activeCourses: 0,\r\n            totalRevenue: 0,\r\n            avgCompletion: 0,\r\n            // New subscription stats\r\n            subscriptions: {\r\n                free: 0,\r\n                basic: 0,\r\n                mid: 0,\r\n                pro: 0,\r\n            },\r\n            recentPayments: [] as any[],\r\n            monthlyRevenue: 0,\r\n        };\r\n\r\n        try {\r\n            // Get total users count and subscription breakdown\r\n            const usersSnapshot = await db.collection('users').get();\r\n            stats.totalUsers = usersSnapshot.size;\r\n\r\n            usersSnapshot.forEach(doc => {\r\n                const data = doc.data();\r\n                const tier = data.subscription?.tier || 'free';\r\n                if (stats.subscriptions[tier as keyof typeof stats.subscriptions] !== undefined) {\r\n                    stats.subscriptions[tier as keyof typeof stats.subscriptions]++;\r\n                }\r\n            });\r\n\r\n            // Get real revenue from payments collection\r\n            const paymentsSnapshot = await db.collection('payments')\r\n                .where('status', '==', 'completed')\r\n                .get();\r\n\r\n            let totalRevenue = 0;\r\n            let monthlyRevenue = 0;\r\n            const now = new Date();\r\n            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);\r\n            const recentPayments: any[] = [];\r\n\r\n            paymentsSnapshot.forEach(doc => {\r\n                const data = doc.data();\r\n                const amount = data.amount || 0;\r\n                totalRevenue += amount;\r\n\r\n                // Check if payment is from this month\r\n                const createdAt = data.createdAt?.toDate?.() || new Date(data.createdAt);\r\n                if (createdAt >= thisMonth) {\r\n                    monthlyRevenue += amount;\r\n                }\r\n\r\n                // Collect recent payments (last 5)\r\n                if (recentPayments.length < 5) {\r\n                    recentPayments.push({\r\n                        id: doc.id,\r\n                        amount,\r\n                        type: data.type || 'course',\r\n                        tier: data.tier,\r\n                        createdAt: createdAt.toISOString(),\r\n                    });\r\n                }\r\n            });\r\n\r\n            stats.totalRevenue = Math.round(totalRevenue * 100) / 100;\r\n            stats.monthlyRevenue = Math.round(monthlyRevenue * 100) / 100;\r\n            stats.recentPayments = recentPayments;\r\n\r\n            // Get enrollments for completion calculation\r\n            const enrollmentsSnapshot = await db.collection('enrollments').get();\r\n            let totalProgress = 0;\r\n            enrollmentsSnapshot.forEach(doc => {\r\n                const data = doc.data();\r\n                if (data.progress) {\r\n                    totalProgress += data.progress;\r\n                }\r\n            });\r\n\r\n            if (enrollmentsSnapshot.size > 0) {\r\n                stats.avgCompletion = Math.round(totalProgress / enrollmentsSnapshot.size);\r\n            }\r\n        } catch (e) {\r\n            console.log('Error fetching from Firebase:', e);\r\n        }\r\n\r\n        // Get active courses count\r\n        try {\r\n            const coursesResponse = await fetch(\r\n                new URL('/api/courses', request.url).toString(),\r\n                { headers: request.headers }\r\n            );\r\n            if (coursesResponse.ok) {\r\n                const coursesData = await coursesResponse.json();\r\n                stats.activeCourses = Array.isArray(coursesData) ? coursesData.length : 0;\r\n            }\r\n        } catch (e) {\r\n            console.log('Failed to fetch courses count:', e);\r\n        }\r\n\r\n        return NextResponse.json(stats);\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to fetch dashboard stats');\r\n    }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\features\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\notifications\\send\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\revenue\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\users\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\admin\\users\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\ai\\chat\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AI_MODELS' is defined but never used.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { GoogleGenerativeAI } from '@google/generative-ai';\r\nimport { indexCourse, retrieveContext } from '@/lib/ml/server';\r\nimport { requireAuth, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { checkRateLimit, getClientIP, RateLimits } from '@/lib/api/rate-limit';\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { AI_MODELS, SUBSCRIPTION_TIERS, SubscriptionTier, checkAILimit } from '@/lib/constants/subscription';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\nimport { isAIEnabled, shouldBypassRateLimits, shouldUnlockAI } from '@/lib/admin/feature-flags';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nconst apiKey = process.env.GEMINI_API_KEY || '';\r\nconst genAI = new GoogleGenerativeAI(apiKey);\r\n\r\n// Model mapping for tiers\r\nconst TIER_MODELS = {\r\n    free: 'gemini-3-flash-preview',\r\n    basic: 'gemini-3-flash-preview',\r\n    mid: 'gemini-3-pro-preview', // Pro on request\r\n    pro: 'gemini-3-pro-preview', // Pro on request\r\n} as const;\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        // ðŸ”§ Feature flag check\r\n        if (!(await isAIEnabled())) {\r\n            return NextResponse.json(\r\n                { error: 'AI features are temporarily disabled for maintenance.' },\r\n                { status: 503 }\r\n            );\r\n        }\r\n\r\n        // ðŸ”§ Check if rate limits should be bypassed\r\n        const bypassRateLimits = await shouldBypassRateLimits();\r\n\r\n        // ðŸ”’ SECURITY: Rate limiting (unless bypassed)\r\n        if (!bypassRateLimits) {\r\n            const clientIP = getClientIP(request);\r\n            const rateLimit = checkRateLimit(`ai-chat:${clientIP}`, RateLimits.AI);\r\n            if (!rateLimit.allowed) {\r\n                return NextResponse.json(\r\n                    { error: 'Too many requests. Please wait before trying again.' },\r\n                    {\r\n                        status: 429,\r\n                        headers: {\r\n                            'Retry-After': String(Math.ceil((rateLimit.resetTime - Date.now()) / 1000)),\r\n                            'X-RateLimit-Remaining': '0',\r\n                        }\r\n                    }\r\n                );\r\n            }\r\n        }\r\n\r\n        // ðŸ”’ SECURITY: Require authentication\r\n        const authResult = await requireAuth(request);\r\n        if (!authResult.authenticated) {\r\n            return authResult.response;\r\n        }\r\n\r\n        const { messages, course, mode } = await request.json();\r\n\r\n        // ðŸ”’ SECURITY: Validate input\r\n        if (!messages || !Array.isArray(messages) || messages.length === 0) {\r\n            return NextResponse.json({ error: 'Messages required' }, { status: 400 });\r\n        }\r\n        if (!course || !course.id || !course.title) {\r\n            return NextResponse.json({ error: 'Course data required' }, { status: 400 });\r\n        }\r\n\r\n        const userMessage = messages[messages.length - 1].content;\r\n        if (typeof userMessage !== 'string' || userMessage.length > 5000) {\r\n            return NextResponse.json({ error: 'Message too long (max 5000 chars)' }, { status: 400 });\r\n        }\r\n\r\n        // Get user's subscription tier and AI usage\r\n        const admin = initAdmin();\r\n        let userTier: SubscriptionTier = 'free';\r\n        let aiUsage = { proRequestsToday: 0, flashRequestsToday: 0, lastResetDate: '' };\r\n        let userRef: FirebaseFirestore.DocumentReference | null = null;\r\n\r\n        if (admin) {\r\n            const db = admin.firestore();\r\n            userRef = db.collection('users').doc(authResult.user.id);\r\n            const userDoc = await userRef.get();\r\n\r\n            if (userDoc.exists) {\r\n                const userData = userDoc.data();\r\n                userTier = userData?.subscription?.tier || 'free';\r\n                aiUsage = userData?.subscription?.aiUsage || aiUsage;\r\n\r\n                // Check if daily limits need to reset\r\n                const today = new Date().toISOString().split('T')[0];\r\n                if (aiUsage.lastResetDate !== today) {\r\n                    aiUsage = {\r\n                        proRequestsToday: 0,\r\n                        flashRequestsToday: 0,\r\n                        lastResetDate: today,\r\n                    };\r\n                }\r\n            }\r\n        }\r\n\r\n        // Determine model based on tier and mode\r\n        // Check if AI should be unlocked for all (promo/testing)\r\n        const unlockAI = await shouldUnlockAI(authResult.user.id);\r\n        const effectiveTier = unlockAI ? 'pro' : userTier;\r\n        let modelToUse = TIER_MODELS[effectiveTier];\r\n        let usingProModel = false;\r\n\r\n        // Check if user wants Pro model and has access\r\n        if (mode === 'deep' && (userTier === 'mid' || userTier === 'pro')) {\r\n            const proLimit = checkAILimit(userTier, aiUsage, 'pro');\r\n            if (proLimit.allowed) {\r\n                modelToUse = 'gemini-3-pro-preview'; // Use best available\r\n                usingProModel = true;\r\n            } else {\r\n                return NextResponse.json({\r\n                    error: `Daily Pro AI limit reached (${SUBSCRIPTION_TIERS[userTier].aiLimits.proRequestsPerDay}/day). Try again tomorrow or use standard mode.`,\r\n                    remaining: proLimit.remaining,\r\n                }, { status: 429 });\r\n            }\r\n        }\r\n\r\n        // Check Flash limits for non-pro tiers\r\n        if (!usingProModel && userTier !== 'mid' && userTier !== 'pro') {\r\n            const flashLimit = checkAILimit(userTier, aiUsage, 'flash');\r\n            if (!flashLimit.allowed) {\r\n                return NextResponse.json({\r\n                    error: `Daily AI limit reached (${SUBSCRIPTION_TIERS[userTier].aiLimits.flashRequestsPerDay}/day). Upgrade your plan for more requests.`,\r\n                    remaining: flashLimit.remaining,\r\n                    upgradeUrl: '/pricing',\r\n                }, { status: 429 });\r\n            }\r\n        }\r\n\r\n        console.log(`ðŸ¤– User ${authResult.user.email} (${userTier}) using ${modelToUse}`);\r\n\r\n        // 1. Index course for RAG\r\n        await indexCourse(course);\r\n\r\n        // 2. Retrieve context\r\n        const context = await retrieveContext(userMessage, course.id, 3);\r\n\r\n        // 3. Make AI call\r\n        const response = await callAI(userMessage, course, context, modelToUse, usingProModel);\r\n\r\n        // 4. Update usage tracking\r\n        if (admin && userRef) {\r\n            try {\r\n                const usageUpdate = usingProModel\r\n                    ? { 'subscription.aiUsage.proRequestsToday': FieldValue.increment(1) }\r\n                    : { 'subscription.aiUsage.flashRequestsToday': FieldValue.increment(1) };\r\n\r\n                await userRef.update({\r\n                    ...usageUpdate,\r\n                    'subscription.aiUsage.lastResetDate': new Date().toISOString().split('T')[0],\r\n                });\r\n            } catch (e) {\r\n                console.log('Failed to update AI usage:', e);\r\n            }\r\n        }\r\n\r\n        return response;\r\n\r\n    } catch (error: unknown) {\r\n        return safeErrorResponse(error, 'Chat service unavailable');\r\n    }\r\n}\r\n\r\nasync function callAI(\r\n    userMessage: string,\r\n    course: { id: string; title: string; lessons?: unknown[] },\r\n    context: string,\r\n    modelName: string,\r\n    isDeepMode: boolean\r\n) {\r\n    const systemPrompt = isDeepMode\r\n        ? `You are an expert teacher for \"${course.title}\".\r\n\r\nRESPONSE PATTERN (CHAIN FORMAT):\r\n1. Answer the core question in 2-3 short paragraphs MAX.\r\n2. ALWAYS end with ONE specific follow-up offer.\r\n\r\nFOLLOW-UP FORMAT:\r\nEnd with: \"Would you like to explore [specific related topic]?\"\r\n\r\nSTRICT RULES:\r\n- No introductions, no summaries.\r\n- Under 100 words before the follow-up.\r\n- One idea per paragraph.\r\n- Separate paragraphs with blank lines.\r\n\r\nCONTEXT: ${context}`\r\n        : `You are a course tutor for \"${course.title}\".\r\n\r\nRESPONSE PATTERN:\r\n1. Give a SHORT answer (2-3 sentences max).\r\n2. ALWAYS end with a follow-up offer related to the topic.\r\n\r\nFOLLOW-UP EXAMPLES:\r\n- \"Would you like to see an example?\"\r\n- \"Want me to explain how this works in practice?\"\r\n- \"Should I break down the steps?\"\r\n\r\nFORMATTING:\r\n- Separate paragraphs with blank lines.\r\n\r\nCONTEXT: ${context}`;\r\n\r\n    const model = genAI.getGenerativeModel({\r\n        model: modelName,\r\n        systemInstruction: systemPrompt,\r\n    });\r\n\r\n    const result = await model.generateContent(userMessage);\r\n    const text = result.response.text();\r\n\r\n    return NextResponse.json({\r\n        role: 'assistant',\r\n        content: text,\r\n        modelUsed: modelName,\r\n        tier: isDeepMode ? 'pro' : 'flash',\r\n    });\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\ai\\generate-image\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\ai\\improve\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\ai\\recommend\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1274,1277],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1274,1277],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { recommendCourses } from '@/lib/ai/gemini';\r\nimport { requireAuth, safeErrorResponse } from '@/lib/api/auth-guard';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        // ðŸ”’ SECURITY: Require authentication to prevent API cost abuse\r\n        const authResult = await requireAuth(request);\r\n        if (!authResult.authenticated) {\r\n            return authResult.response;\r\n        }\r\n\r\n        const { query, courses } = await request.json();\r\n\r\n        // ðŸ”’ SECURITY: Validate input\r\n        if (!query || typeof query !== 'string') {\r\n            return NextResponse.json({ error: 'Query is required' }, { status: 400 });\r\n        }\r\n        if (!courses || !Array.isArray(courses)) {\r\n            return NextResponse.json({ error: 'Courses array required' }, { status: 400 });\r\n        }\r\n\r\n        // ðŸ”’ SECURITY: Limit query length\r\n        if (query.length > 1000) {\r\n            return NextResponse.json({ error: 'Query too long (max 1000 chars)' }, { status: 400 });\r\n        }\r\n\r\n        // Limit course data to save tokens (send only id, title, description, category)\r\n        const simplifiedCourses = courses.slice(0, 50).map((c: any) => ({\r\n            id: c.id,\r\n            title: c.title?.slice(0, 200),\r\n            description: c.description?.slice(0, 500),\r\n            category: c.category?.slice(0, 50),\r\n            level: c.level\r\n        }));\r\n\r\n        console.log(`ðŸ¤– AI recommend for user ${authResult.user.email}: \"${query.slice(0, 50)}...\"`);\r\n\r\n        const jsonString = await recommendCourses(query, JSON.stringify(simplifiedCourses));\r\n        const recommendation = JSON.parse(jsonString);\r\n\r\n        return NextResponse.json(recommendation);\r\n    } catch (error: unknown) {\r\n        return safeErrorResponse(error, 'Recommendation service unavailable');\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\analytics\\track\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'functional' is assigned a value but never used.","line":14,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { saveAnalyticsRecord } from \"@/lib/analytics/firestore-analytics\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * POST /api/analytics/track\r\n * Track analytics events (page views, events)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const body = await request.json();\r\n        const { type, timestamp, functional } = body;\r\n\r\n        // For non-functional tracking, we don't store user data\r\n        // Just the aggregated event\r\n\r\n        switch (type) {\r\n            case \"page_view\":\r\n                await saveAnalyticsRecord({\r\n                    type: \"page_view\",\r\n                    pagePath: body.pagePath,\r\n                    referrer: body.referrer,\r\n                    timestamp: timestamp || Date.now(),\r\n                });\r\n                break;\r\n\r\n            case \"event\":\r\n                await saveAnalyticsRecord({\r\n                    type: \"event\",\r\n                    eventName: body.eventName,\r\n                    eventData: body.eventData,\r\n                    timestamp: timestamp || Date.now(),\r\n                });\r\n                break;\r\n\r\n            default:\r\n                return NextResponse.json(\r\n                    { error: \"Invalid event type\" },\r\n                    { status: 400 }\r\n                );\r\n        }\r\n\r\n        return NextResponse.json({ success: true });\r\n    } catch (error) {\r\n        console.error(\"Analytics track error:\", error);\r\n        return NextResponse.json(\r\n            { error: \"Failed to track event\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\auth\\callback\\google\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1525,1528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1525,1528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Google OAuth callback handler\r\n// Exchanges auth code for refresh token and stores it\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { handleCallback } from '@/lib/storage/google-drive';\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const code = searchParams.get('code');\r\n    const error = searchParams.get('error');\r\n\r\n    if (error) {\r\n        return NextResponse.redirect(\r\n            new URL(`/settings?error=${encodeURIComponent(error)}`, request.url)\r\n        );\r\n    }\r\n\r\n    if (!code) {\r\n        return NextResponse.redirect(\r\n            new URL('/settings?error=missing_code', request.url)\r\n        );\r\n    }\r\n\r\n    try {\r\n        const { refreshToken } = await handleCallback(code);\r\n\r\n        // IMPORTANT: In production, you should store this refresh token securely\r\n        // For now, we'll show it to the admin to add to environment variables\r\n        console.log('='.repeat(60));\r\n        console.log('GOOGLE DRIVE AUTHORIZATION SUCCESSFUL!');\r\n        console.log('Add this to your .env and Vercel environment variables:');\r\n        console.log(`GOOGLE_REFRESH_TOKEN=\"${refreshToken}\"`);\r\n        console.log('='.repeat(60));\r\n\r\n        // Redirect to success page with instructions\r\n        return NextResponse.redirect(\r\n            new URL(\r\n                `/settings?google_drive=success&token=${encodeURIComponent(refreshToken)}`,\r\n                request.url\r\n            )\r\n        );\r\n    } catch (err: any) {\r\n        console.error('OAuth callback error:', err);\r\n        return NextResponse.redirect(\r\n            new URL(`/settings?error=${encodeURIComponent(err.message || 'auth_failed')}`, request.url)\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\auth\\clear-token\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\auth\\set-token\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2828,2831],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2828,2831],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyIdToken } from '@/lib/auth/validateToken';\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { checkRateLimit, getClientIP, RateLimits } from '@/lib/api/rate-limit';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n/**\r\n * API endpoint to set httpOnly cookie with Firebase Session Cookie\r\n * Called after successful login on client side\r\n * \r\n * SECURITY:\r\n * - Rate limited to 5 attempts per minute per IP\r\n * - httpOnly cookie prevents XSS token theft\r\n * - sameSite=strict prevents CSRF attacks\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    // Rate limiting - prevent brute force attacks\r\n    const clientIP = getClientIP(request);\r\n    const rateLimitKey = `login:${clientIP}`;\r\n    const rateCheck = checkRateLimit(rateLimitKey, RateLimits.AUTH);\r\n\r\n    if (!rateCheck.allowed) {\r\n        console.warn(`âš ï¸ Login rate limit exceeded for IP: ${clientIP}`);\r\n        return NextResponse.json(\r\n            { error: 'Too many login attempts. Please try again later.' },\r\n            {\r\n                status: 429,\r\n                headers: {\r\n                    'Retry-After': Math.ceil((rateCheck.resetTime - Date.now()) / 1000).toString(),\r\n                    'X-RateLimit-Remaining': '0',\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    try {\r\n        const { idToken } = await request.json();\r\n\r\n        if (!idToken) {\r\n            return NextResponse.json(\r\n                { error: 'ID token required' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // 1. Validate the ID token server-side (ensure it's fresh via verifyIdToken)\r\n        const user = await verifyIdToken(idToken);\r\n\r\n        // 2. Create a Session Cookie\r\n        const expiresIn = 60 * 60 * 24 * 5 * 1000; // 5 days\r\n        const admin = initAdmin();\r\n\r\n        const sessionCookie = await admin.auth().createSessionCookie(idToken, { expiresIn });\r\n\r\n        // Create response with httpOnly cookie\r\n        const response = NextResponse.json({\r\n            success: true,\r\n            user: {\r\n                uid: user.uid,\r\n                email: user.email,\r\n                role: user.role,\r\n            },\r\n        });\r\n\r\n        // Set httpOnly cookie with security hardening\r\n        response.cookies.set({\r\n            name: 'firebase-token',\r\n            value: sessionCookie,\r\n            httpOnly: true,  // Prevents XSS access to token\r\n            secure: process.env.NODE_ENV === 'production', // HTTPS only in prod\r\n            sameSite: 'strict',  // CSRF protection (stricter than 'lax')\r\n            path: '/',\r\n            maxAge: 60 * 60 * 24 * 5, // 5 days\r\n        });\r\n\r\n        console.log(`âœ… Token cookie set for user: ${user.email}`);\r\n\r\n        return response;\r\n    } catch (error: any) {\r\n        console.error('âŒ Set token error:', error);\r\n        // SECURITY: Generic error message - don't reveal details to attackers\r\n        return NextResponse.json(\r\n            { error: 'Authentication failed' },\r\n            { status: 401 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\coupons\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2246,2249],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2246,2249],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAdmin, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { getCouponById, updateCoupon, deleteCoupon } from '@/lib/firebase/coupon-operations';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\ninterface RouteParams {\r\n    params: Promise<{ id: string }>;\r\n}\r\n\r\n/**\r\n * GET /api/coupons/[id] - Get a specific coupon (admin only)\r\n */\r\nexport async function GET(request: NextRequest, { params }: RouteParams) {\r\n    const authResult = await requireAdmin(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const { id } = await params;\r\n        const coupon = await getCouponById(id);\r\n\r\n        if (!coupon) {\r\n            return NextResponse.json({ error: 'Coupon not found' }, { status: 404 });\r\n        }\r\n\r\n        return NextResponse.json(coupon);\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to fetch coupon');\r\n    }\r\n}\r\n\r\n/**\r\n * PUT /api/coupons/[id] - Update a coupon (admin only)\r\n */\r\nexport async function PUT(request: NextRequest, { params }: RouteParams) {\r\n    const authResult = await requireAdmin(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const { id } = await params;\r\n        const body = await request.json();\r\n\r\n        // Basic validation\r\n        if (body.code && (typeof body.code !== 'string' || body.code.length < 3)) {\r\n            return NextResponse.json({ error: 'Code must be at least 3 characters' }, { status: 400 });\r\n        }\r\n\r\n        if (body.discountPercent !== undefined &&\r\n            (typeof body.discountPercent !== 'number' || body.discountPercent < 0 || body.discountPercent > 100)) {\r\n            return NextResponse.json({ error: 'Discount percent must be between 0 and 100' }, { status: 400 });\r\n        }\r\n\r\n        if (body.maxUses !== undefined && (typeof body.maxUses !== 'number' || body.maxUses < 1)) {\r\n            return NextResponse.json({ error: 'Max uses must be at least 1' }, { status: 400 });\r\n        }\r\n\r\n        const coupon = await updateCoupon(id, body);\r\n\r\n        return NextResponse.json({ success: true, coupon });\r\n    } catch (error: any) {\r\n        if (error.message === 'Coupon not found') {\r\n            return NextResponse.json({ error: 'Coupon not found' }, { status: 404 });\r\n        }\r\n        if (error.message?.includes('already exists')) {\r\n            return NextResponse.json({ error: error.message }, { status: 409 });\r\n        }\r\n        return safeErrorResponse(error, 'Failed to update coupon');\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/coupons/[id] - Delete a coupon (admin only)\r\n */\r\nexport async function DELETE(request: NextRequest, { params }: RouteParams) {\r\n    const authResult = await requireAdmin(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const { id } = await params;\r\n        await deleteCoupon(id);\r\n\r\n        return NextResponse.json({ success: true, message: 'Coupon deleted' });\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to delete coupon');\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\coupons\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'requireAuth' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2968,2971],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2968,2971],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAuth, requireAdmin, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { getCoupons, createCoupon, seedDefaultCoupons } from '@/lib/firebase/coupon-operations';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n/**\r\n * GET /api/coupons - List all coupons (admin only)\r\n */\r\nexport async function GET(request: NextRequest) {\r\n    const authResult = await requireAdmin(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const activeOnly = searchParams.get('activeOnly') === 'true';\r\n        const limit = searchParams.get('limit') ? parseInt(searchParams.get('limit')!) : undefined;\r\n\r\n        const coupons = await getCoupons({ activeOnly, limit });\r\n\r\n        return NextResponse.json({\r\n            coupons,\r\n            total: coupons.length,\r\n        });\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to fetch coupons');\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/coupons - Create a new coupon (admin only)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    const authResult = await requireAdmin(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const body = await request.json();\r\n\r\n        // Validate required fields\r\n        const { code, discountPercent, validFrom, validUntil, maxUses, applicableTo, isActive } = body;\r\n\r\n        if (!code || typeof code !== 'string' || code.length < 3) {\r\n            return NextResponse.json({ error: 'Code must be at least 3 characters' }, { status: 400 });\r\n        }\r\n\r\n        if (typeof discountPercent !== 'number' || discountPercent < 0 || discountPercent > 100) {\r\n            return NextResponse.json({ error: 'Discount percent must be between 0 and 100' }, { status: 400 });\r\n        }\r\n\r\n        if (!validFrom || !validUntil) {\r\n            return NextResponse.json({ error: 'Valid from and valid until dates are required' }, { status: 400 });\r\n        }\r\n\r\n        if (typeof maxUses !== 'number' || maxUses < 1) {\r\n            return NextResponse.json({ error: 'Max uses must be at least 1' }, { status: 400 });\r\n        }\r\n\r\n        if (!['subscription', 'course', 'bundle', 'all'].includes(applicableTo)) {\r\n            return NextResponse.json({ error: 'Invalid applicableTo value' }, { status: 400 });\r\n        }\r\n\r\n        const coupon = await createCoupon({\r\n            code,\r\n            discountPercent,\r\n            discountAmount: body.discountAmount,\r\n            validFrom,\r\n            validUntil,\r\n            maxUses,\r\n            applicableTo,\r\n            applicableTiers: body.applicableTiers,\r\n            minPurchaseAmount: body.minPurchaseAmount,\r\n            isActive: isActive ?? true,\r\n        });\r\n\r\n        return NextResponse.json({ success: true, coupon }, { status: 201 });\r\n    } catch (error: any) {\r\n        if (error.message?.includes('already exists')) {\r\n            return NextResponse.json({ error: error.message }, { status: 409 });\r\n        }\r\n        return safeErrorResponse(error, 'Failed to create coupon');\r\n    }\r\n}\r\n\r\n/**\r\n * PUT /api/coupons?action=seed - Seed default coupons (admin only)\r\n */\r\nexport async function PUT(request: NextRequest) {\r\n    const authResult = await requireAdmin(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const action = searchParams.get('action');\r\n\r\n        if (action === 'seed') {\r\n            await seedDefaultCoupons();\r\n            return NextResponse.json({ success: true, message: 'Default coupons seeded' });\r\n        }\r\n\r\n        return NextResponse.json({ error: 'Unknown action' }, { status: 400 });\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to seed coupons');\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\coupons\\validate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\courses\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\courses\\related\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeErrorResponse' is defined but never used.","line":3,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":40},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[810,813],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[810,813],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1270,1273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1270,1273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { findSimilarCourses } from '@/lib/ml/server';\r\nimport { requireAuth, safeErrorResponse } from '@/lib/api/auth-guard';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(request: NextRequest) {\r\n    // ðŸ”’ SECURITY: Require authentication\r\n    const auth = await requireAuth(request);\r\n    if (!auth.authenticated) return auth.response;\r\n\r\n    try {\r\n        const { courseId, allCourses } = await request.json();\r\n\r\n        if (!courseId || !allCourses) {\r\n            return NextResponse.json({ error: 'Course ID and All Courses are required' }, { status: 400 });\r\n        }\r\n\r\n        // Limit data for processing (simulated database fetch would happen here in prod)\r\n        const simplifiedCourses = allCourses.map((c: any) => ({\r\n            id: c.id,\r\n            title: c.title,\r\n            description: c.description,\r\n            category: c.category\r\n        }));\r\n\r\n        console.log(`ðŸ§  finding similarities for course ${courseId}...`);\r\n\r\n        const relatedCourses = await findSimilarCourses(courseId, simplifiedCourses);\r\n\r\n        console.log(`âœ… found ${relatedCourses.length} matches`);\r\n\r\n        return NextResponse.json(relatedCourses);\r\n    } catch (error: any) {\r\n        console.error('ML Recommendation error:', error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\courses\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sanitizeString' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { listCourses, saveCourse } from '@/lib/server/fileOperations';\r\nimport { requireAdmin, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { sanitizeString, validateCourseId } from '@/lib/api/validators';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// GET is public - anyone can browse courses\r\nexport async function GET() {\r\n    try {\r\n        let courses = await listCourses();\r\n\r\n        // Try to add enrollment and rating data from Firebase (using Admin SDK)\r\n        try {\r\n            const { getCourseStats } = await import('@/lib/firebase/firestore-admin');\r\n            const { enrollmentCounts, courseRatings } = await getCourseStats();\r\n\r\n            // Merge data into courses\r\n            courses = courses.map(course => ({\r\n                ...course,\r\n                enrolledCount: enrollmentCounts[course.id] || 0,\r\n                rating: courseRatings[course.id]\r\n                    ? Math.round((courseRatings[course.id].sum / courseRatings[course.id].count) * 10) / 10\r\n                    : 0,\r\n            }));\r\n        } catch (e) {\r\n            console.log('Firebase enrollment/rating data not available:', e);\r\n            // Continue with file-based data\r\n        }\r\n\r\n        return NextResponse.json(courses, {\r\n            headers: {\r\n                'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',\r\n                'Pragma': 'no-cache',\r\n                'Expires': '0',\r\n            }\r\n        });\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to fetch courses');\r\n    }\r\n}\r\n\r\n// POST requires admin\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        // ðŸ”’ SECURITY: Require admin role\r\n        const authResult = await requireAdmin(request);\r\n        if (!authResult.authenticated) {\r\n            return authResult.response;\r\n        }\r\n\r\n        const courseData = await request.json();\r\n\r\n        // ðŸ”’ SECURITY: Validate and sanitize input\r\n        if (!courseData.title || typeof courseData.title !== 'string') {\r\n            return NextResponse.json({ error: 'Title is required' }, { status: 400 });\r\n        }\r\n\r\n        const title = courseData.title.slice(0, 200); // Limit title length\r\n\r\n        // Generate unique ID from title + timestamp to prevent collisions\r\n        const slug = title\r\n            .toLowerCase()\r\n            .replace(/[^a-z0-9]+/g, '-')\r\n            .replace(/(^-|-$)/g, '')\r\n            .slice(0, 50);\r\n        const id = `${slug}-${Date.now()}`;\r\n\r\n        // Create course with initial lesson\r\n        const newCourse = {\r\n            id,\r\n            title: title,\r\n            description: (courseData.description || '').slice(0, 5000),\r\n            instructor: (courseData.instructor || authResult.user.name || 'Admin').slice(0, 100),\r\n            thumbnail: courseData.thumbnail || 'https://placehold.co/800x400',\r\n            category: (courseData.category || 'Uncategorized').slice(0, 50),\r\n            level: (['beginner', 'intermediate', 'advanced'].includes(courseData.level)\r\n                ? courseData.level\r\n                : 'beginner') as 'beginner' | 'intermediate' | 'advanced',\r\n            duration: '0 hours',\r\n            lessonsCount: 1,\r\n            enrolledCount: 0,\r\n            rating: 0,\r\n            price: 0,\r\n            lessons: [\r\n                {\r\n                    id: '1',\r\n                    title: 'Introduction',\r\n                    type: 'article' as const,\r\n                    duration: '5 min',\r\n                    content: '# Welcome\\n\\nStart building your course content here.',\r\n                    order: 1,\r\n                    components: [],\r\n                },\r\n            ],\r\n            createdAt: new Date().toISOString(),\r\n            isPublished: false,\r\n            createdBy: authResult.user.id, // Track who created it\r\n        };\r\n\r\n        await saveCourse(id, newCourse);\r\n        console.log(`âœ… Admin ${authResult.user.email} created course: ${id}`);\r\n\r\n        return NextResponse.json({ course: newCourse, id });\r\n    } catch (error: unknown) {\r\n        return safeErrorResponse(error, 'Failed to create course');\r\n    }\r\n}\r\n\r\n// DELETE requires admin\r\nexport async function DELETE(request: NextRequest) {\r\n    try {\r\n        // ðŸ”’ SECURITY: Require admin role\r\n        const authResult = await requireAdmin(request);\r\n        if (!authResult.authenticated) {\r\n            return authResult.response;\r\n        }\r\n\r\n        const { searchParams } = new URL(request.url);\r\n        const id = searchParams.get('id');\r\n\r\n        if (!id) {\r\n            return NextResponse.json({ error: 'Missing course ID' }, { status: 400 });\r\n        }\r\n\r\n        // ðŸ”’ SECURITY: Validate course ID format\r\n        if (!validateCourseId(id)) {\r\n            return NextResponse.json({ error: 'Invalid course ID format' }, { status: 400 });\r\n        }\r\n\r\n        console.log(`ðŸ—‘ï¸ Admin ${authResult.user.email} deleting course: ${id}`);\r\n\r\n        // Delete from local file system\r\n        const { deleteCourse } = await import('@/lib/server/fileOperations');\r\n        const success = await deleteCourse(id);\r\n\r\n        if (!success) {\r\n            return NextResponse.json({ error: 'Course not found' }, { status: 404 });\r\n        }\r\n\r\n        return NextResponse.json({ success: true, id });\r\n    } catch (error: unknown) {\r\n        return safeErrorResponse(error, 'Failed to delete course');\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\courses\\search\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeErrorResponse' is defined but never used.","line":3,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":40},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[828,831],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[828,831],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1211,1214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1211,1214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { searchCourses } from '@/lib/ml/server';\r\nimport { requireAuth, safeErrorResponse } from '@/lib/api/auth-guard';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(request: NextRequest) {\r\n    // ðŸ”’ SECURITY: Require authentication (uses ML resources)\r\n    const auth = await requireAuth(request);\r\n    if (!auth.authenticated) return auth.response;\r\n\r\n    try {\r\n        const { query, allCourses } = await request.json();\r\n\r\n        if (!query || !allCourses) {\r\n            return NextResponse.json({ error: 'Query and Courses are required' }, { status: 400 });\r\n        }\r\n\r\n        console.log(`ðŸ” Semantic search for: \"${query}\"`);\r\n\r\n        // Simplified course objects for processing\r\n        const searchData = allCourses.map((c: any) => ({\r\n            id: c.id,\r\n            title: c.title,\r\n            description: c.description,\r\n            category: c.category,\r\n            level: c.level\r\n        }));\r\n\r\n        const results = await searchCourses(query, searchData);\r\n\r\n        console.log(`âœ… Found ${results.length} ranked results`);\r\n\r\n        return NextResponse.json(results);\r\n    } catch (error: any) {\r\n        console.error('Semantic Search error:', error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\log\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":76,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":76,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { sanitizeLogMessage } from '@/lib/api/validators';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// Terminal colors\r\nconst colors = {\r\n    reset: '\\x1b[0m',\r\n    bright: '\\x1b[1m',\r\n    dim: '\\x1b[2m',\r\n    red: '\\x1b[31m',\r\n    green: '\\x1b[32m',\r\n    yellow: '\\x1b[33m',\r\n    blue: '\\x1b[34m',\r\n    cyan: '\\x1b[36m',\r\n    gray: '\\x1b[90m',\r\n    bgRed: '\\x1b[41m',\r\n    bgYellow: '\\x1b[43m',\r\n};\r\n\r\nconst levelConfig: Record<string, { emoji: string; color: string; label: string }> = {\r\n    debug: { emoji: 'ðŸ”', color: colors.gray, label: 'DEBUG' },\r\n    info: { emoji: 'ðŸ“˜', color: colors.cyan, label: 'INFO' },\r\n    warn: { emoji: 'âš ï¸', color: colors.yellow, label: 'WARN' },\r\n    error: { emoji: 'âŒ', color: colors.red, label: 'ERROR' },\r\n};\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const payload = await request.json();\r\n\r\n        // ðŸ”’ SECURITY: Validate and sanitize all input\r\n        const level = ['debug', 'info', 'warn', 'error'].includes(payload.level)\r\n            ? payload.level\r\n            : 'info';\r\n\r\n        // ðŸ”’ SECURITY: Sanitize message to prevent log injection\r\n        const message = sanitizeLogMessage(payload.message || '');\r\n        const source = sanitizeLogMessage(payload.source || '');\r\n        const timestamp = payload.timestamp;\r\n\r\n        if (!message) {\r\n            return NextResponse.json({ error: 'Message required' }, { status: 400 });\r\n        }\r\n\r\n        const config = levelConfig[level];\r\n        const time = timestamp\r\n            ? new Date(timestamp).toLocaleTimeString()\r\n            : new Date().toLocaleTimeString();\r\n\r\n        // Get client info from headers\r\n        const userAgent = request.headers.get('user-agent') || 'Unknown';\r\n        const isChrome = userAgent.includes('Chrome');\r\n        const isFirefox = userAgent.includes('Firefox');\r\n        const browser = isChrome ? 'ðŸŒ Chrome' : isFirefox ? 'ðŸ¦Š Firefox' : 'ðŸŒ Browser';\r\n\r\n        // Format the log output\r\n        const sourceTag = source ? `${colors.dim}[${source}]${colors.reset}` : '';\r\n        const browserTag = `${colors.dim}[${browser}]${colors.reset}`;\r\n\r\n        let output = `${config.emoji} ${config.color}${colors.bright}${config.label}${colors.reset} ${colors.dim}${time}${colors.reset} ${browserTag} ${sourceTag} ${message}`;\r\n\r\n        // ðŸ”’ SECURITY: Sanitize data before logging\r\n        if (payload.data !== undefined) {\r\n            const dataStr = typeof payload.data === 'object'\r\n                ? JSON.stringify(payload.data, null, 2).slice(0, 500)\r\n                : String(payload.data).slice(0, 500);\r\n            const safeData = sanitizeLogMessage(dataStr);\r\n            output += `\\n${colors.dim}â””â”€ ${safeData}${colors.reset}`;\r\n        }\r\n\r\n        // Print to server terminal\r\n        console.log(output);\r\n\r\n        return NextResponse.json({ ok: true });\r\n    } catch (error) {\r\n        console.error(`${colors.red}âŒ Log endpoint error${colors.reset}`);\r\n        return NextResponse.json({ error: 'Failed to log' }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\notifications\\[id]\\read\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\notifications\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\payments\\process\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NextRequest' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'couponCode' is assigned a value but never used.","line":29,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":45},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2923,2926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2923,2926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { withAuthTracked, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\nimport { paymentSchema } from '@/lib/validation/schemas';\r\nimport { isSubscriptionsEnabled } from '@/lib/admin/feature-flags';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport const POST = withAuthTracked(async (request, { user }) => {\r\n    try {\r\n        // ðŸ”§ Feature flag check\r\n        if (!(await isSubscriptionsEnabled())) {\r\n            return NextResponse.json(\r\n                { error: 'Payments are temporarily disabled for maintenance.' },\r\n                { status: 503 }\r\n            );\r\n        }\r\n\r\n        // Validate and sanitize input\r\n        const body = await request.json();\r\n        const parseResult = paymentSchema.safeParse(body);\r\n\r\n        if (!parseResult.success) {\r\n            const errors = parseResult.error.issues.map((e: { message: string }) => e.message).join(', ');\r\n            return NextResponse.json({ error: `Invalid input: ${errors}` }, { status: 400 });\r\n        }\r\n\r\n        const { courseId, amount, couponCode } = parseResult.data;\r\n\r\n        const admin = initAdmin();\r\n        if (!admin) {\r\n            return NextResponse.json({ error: 'Firebase Admin not initialized' }, { status: 500 });\r\n        }\r\n\r\n        const db = admin.firestore();\r\n        const userId = user.id;\r\n\r\n        // Check if user already purchased this course\r\n        const existingPayment = await db.collection('payments')\r\n            .where('userId', '==', userId)\r\n            .where('courseId', '==', courseId)\r\n            .where('status', '==', 'completed')\r\n            .get();\r\n\r\n        if (!existingPayment.empty) {\r\n            return NextResponse.json({ error: 'You already own this course' }, { status: 400 });\r\n        }\r\n\r\n        // Simulate payment processing delay (1-2 seconds)\r\n        await new Promise(resolve => setTimeout(resolve, 1500));\r\n\r\n        // Create payment record\r\n        const paymentRef = await db.collection('payments').add({\r\n            userId,\r\n            courseId,\r\n            amount,\r\n            status: 'completed', // Always succeeds in dummy mode\r\n            paymentMethod: 'card',\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        console.log(`âœ… Payment created: ${paymentRef.id} for user ${userId}, course ${courseId}`);\r\n\r\n        // Auto-enroll user in the course and track in subscription\r\n        const userRef = db.collection('users').doc(userId);\r\n        const userDoc = await userRef.get();\r\n\r\n        if (userDoc.exists) {\r\n            const userData = userDoc.data();\r\n            const enrolledCourses = userData?.enrolledCourses || [];\r\n            const purchasedCourses = userData?.subscription?.purchasedCourses || [];\r\n\r\n            const updates: any = {};\r\n\r\n            // Add to enrolledCourses if not already enrolled\r\n            if (!enrolledCourses.includes(courseId)) {\r\n                updates.enrolledCourses = [...enrolledCourses, courseId];\r\n            }\r\n\r\n            // Also track in subscription.purchasedCourses for paid course tracking\r\n            if (!purchasedCourses.includes(courseId)) {\r\n                updates['subscription.purchasedCourses'] = [...purchasedCourses, courseId];\r\n            }\r\n\r\n            if (Object.keys(updates).length > 0) {\r\n                await userRef.update(updates);\r\n                console.log(`âœ… User ${userId} enrolled in course ${courseId} (updated enrolledCourses and subscription.purchasedCourses)`);\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            paymentId: paymentRef.id,\r\n            message: 'Payment successful! You are now enrolled in this course.',\r\n        });\r\n    } catch (error) {\r\n        console.error('âŒ Payment error:', error);\r\n        return safeErrorResponse(error, 'Payment failed');\r\n    }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\payments\\subscribe\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NextRequest' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { withAuthTracked, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\nimport { SUBSCRIPTION_TIERS, type SubscriptionTier, type UserSubscription } from '@/lib/constants/subscription';\r\nimport { logger } from '@/lib/logger';\r\nimport { validateCoupon, incrementCouponUsage } from '@/lib/firebase/coupon-operations';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\ninterface SubscribeRequest {\r\n    tier: SubscriptionTier;\r\n    billingCycle: 'monthly' | 'yearly';\r\n    couponCode?: string;\r\n    // Demo: card info not sent, just metadata\r\n    cardLast4?: string;\r\n    cardBrand?: string;\r\n}\r\n\r\nexport const POST = withAuthTracked(async (request, { user }) => {\r\n    try {\r\n        const body: SubscribeRequest = await request.json();\r\n        const { tier, billingCycle, couponCode, cardLast4, cardBrand } = body;\r\n\r\n        // Validate tier\r\n        if (!tier || !SUBSCRIPTION_TIERS[tier]) {\r\n            return NextResponse.json({ error: 'Invalid subscription tier' }, { status: 400 });\r\n        }\r\n\r\n        if (tier === 'free') {\r\n            return NextResponse.json({ error: 'Cannot subscribe to free tier' }, { status: 400 });\r\n        }\r\n\r\n        // Validate billing cycle\r\n        if (!['monthly', 'yearly'].includes(billingCycle)) {\r\n            return NextResponse.json({ error: 'Invalid billing cycle' }, { status: 400 });\r\n        }\r\n\r\n        const admin = initAdmin();\r\n        if (!admin) {\r\n            return NextResponse.json({ error: 'Firebase Admin not initialized' }, { status: 500 });\r\n        }\r\n\r\n        const db = admin.firestore();\r\n        const userId = user.id;\r\n\r\n        // Check if user already has active subscription\r\n        const userRef = db.collection('users').doc(userId);\r\n        const userDoc = await userRef.get();\r\n        const userData = userDoc.data();\r\n\r\n        if (userData?.subscription?.tier !== 'free' && userData?.subscription?.status === 'active') {\r\n            // Allow upgrade, but not if same tier\r\n            if (userData.subscription.tier === tier) {\r\n                return NextResponse.json({ error: 'You already have this subscription' }, { status: 400 });\r\n            }\r\n        }\r\n\r\n        // Calculate price\r\n        const tierConfig = SUBSCRIPTION_TIERS[tier];\r\n        let amount: number = billingCycle === 'yearly' ? tierConfig.priceYearly : tierConfig.priceMonthly;\r\n        let discountApplied = 0;\r\n        let couponValid = false;\r\n        let appliedCouponId: string | null = null;\r\n\r\n        // Apply coupon if provided (using Firestore)\r\n        if (couponCode) {\r\n            const couponResult = await validateCoupon(couponCode, 'subscription', tier, amount);\r\n            if (couponResult.valid && couponResult.coupon) {\r\n                const coupon = couponResult.coupon;\r\n                if (coupon.discountAmount) {\r\n                    discountApplied = coupon.discountAmount;\r\n                } else {\r\n                    discountApplied = amount * (coupon.discountPercent / 100);\r\n                }\r\n                amount = Math.max(0, amount - discountApplied) as number;\r\n                couponValid = true;\r\n                appliedCouponId = coupon.id;\r\n            }\r\n        }\r\n\r\n        // Simulate payment processing delay\r\n        await new Promise(resolve => setTimeout(resolve, 1500));\r\n\r\n        // Calculate subscription dates\r\n        const startDate = new Date();\r\n        const endDate = new Date();\r\n        if (billingCycle === 'yearly') {\r\n            endDate.setFullYear(endDate.getFullYear() + 1);\r\n        } else {\r\n            endDate.setMonth(endDate.getMonth() + 1);\r\n        }\r\n\r\n        // Create subscription record\r\n        const subscriptionData: UserSubscription = {\r\n            tier,\r\n            status: 'active',\r\n            startDate: startDate.toISOString(),\r\n            endDate: endDate.toISOString(),\r\n            billingCycle,\r\n            aiUsage: {\r\n                proRequestsToday: 0,\r\n                flashRequestsToday: 0,\r\n                lastResetDate: new Date().toISOString().split('T')[0],\r\n            },\r\n            purchasedCourses: userData?.subscription?.purchasedCourses || [],\r\n            purchasedBundles: userData?.subscription?.purchasedBundles || [],\r\n        };\r\n\r\n        // Create payment record\r\n        const paymentRef = await db.collection('payments').add({\r\n            userId,\r\n            type: 'subscription',\r\n            tier,\r\n            billingCycle,\r\n            amount,\r\n            originalAmount: billingCycle === 'yearly' ? tierConfig.priceYearly : tierConfig.priceMonthly,\r\n            discountApplied,\r\n            couponCode: couponValid ? couponCode?.toUpperCase() : null,\r\n            status: 'completed',\r\n            paymentMethod: 'card',\r\n            cardLast4: cardLast4 || null,\r\n            cardBrand: cardBrand || null,\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        // Update user's subscription\r\n        await userRef.update({\r\n            subscription: subscriptionData,\r\n            updatedAt: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        // Increment coupon usage if one was applied\r\n        if (appliedCouponId) {\r\n            await incrementCouponUsage(appliedCouponId);\r\n        }\r\n\r\n        logger.info(`Subscription created: ${tier} ${billingCycle}`, {\r\n            userId,\r\n            tier,\r\n            billingCycle,\r\n            amount,\r\n            paymentId: paymentRef.id,\r\n        }, 'SubscriptionAPI');\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            paymentId: paymentRef.id,\r\n            subscription: subscriptionData,\r\n            amount,\r\n            discountApplied,\r\n            message: `Successfully subscribed to ${tierConfig.name}!`,\r\n        });\r\n    } catch (error) {\r\n        console.error('âŒ Subscription error:', error);\r\n        return safeErrorResponse(error, 'Subscription failed');\r\n    }\r\n});\r\n\r\n// GET - Check subscription status\r\nexport const GET = withAuthTracked(async (request, { user }) => {\r\n    try {\r\n        const admin = initAdmin();\r\n        if (!admin) {\r\n            return NextResponse.json({ error: 'Firebase Admin not initialized' }, { status: 500 });\r\n        }\r\n\r\n        const db = admin.firestore();\r\n        const userId = user.id;\r\n\r\n        const userDoc = await db.collection('users').doc(userId).get();\r\n        const userData = userDoc.data();\r\n\r\n        const subscription = userData?.subscription || {\r\n            tier: 'free',\r\n            status: 'active',\r\n        };\r\n\r\n        return NextResponse.json({\r\n            subscription,\r\n            tierConfig: SUBSCRIPTION_TIERS[subscription.tier as SubscriptionTier],\r\n        });\r\n    } catch (error) {\r\n        return safeErrorResponse(error, 'Failed to get subscription status');\r\n    }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\recommendations\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\subscriptions\\create\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DEFAULT_SUBSCRIPTION' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAuth, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\nimport { DEFAULT_SUBSCRIPTION, SubscriptionTier, SUBSCRIPTION_TIERS } from '@/lib/constants/subscription';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(request: NextRequest) {\r\n    // Require authentication\r\n    const authResult = await requireAuth(request);\r\n    if (!authResult.authenticated) {\r\n        return authResult.response;\r\n    }\r\n\r\n    try {\r\n        const body = await request.json();\r\n        const { tier, billingCycle, couponCode, amount } = body;\r\n\r\n        // Validate tier\r\n        if (!tier || !SUBSCRIPTION_TIERS[tier as SubscriptionTier]) {\r\n            return NextResponse.json({ error: 'Invalid subscription tier' }, { status: 400 });\r\n        }\r\n\r\n        if (!billingCycle || !['monthly', 'yearly'].includes(billingCycle)) {\r\n            return NextResponse.json({ error: 'Invalid billing cycle' }, { status: 400 });\r\n        }\r\n\r\n        const admin = initAdmin();\r\n        if (!admin) {\r\n            return NextResponse.json({ error: 'Firebase Admin not initialized' }, { status: 500 });\r\n        }\r\n\r\n        const db = admin.firestore();\r\n        const userId = authResult.user.id;\r\n\r\n        // Simulate payment processing delay\r\n        await new Promise(resolve => setTimeout(resolve, 1500));\r\n\r\n        // Calculate subscription dates\r\n        const startDate = new Date();\r\n        const endDate = new Date();\r\n        if (billingCycle === 'yearly') {\r\n            endDate.setFullYear(endDate.getFullYear() + 1);\r\n        } else {\r\n            endDate.setMonth(endDate.getMonth() + 1);\r\n        }\r\n\r\n        // Create subscription object\r\n        const subscription = {\r\n            tier,\r\n            status: 'active',\r\n            startDate: startDate.toISOString(),\r\n            endDate: endDate.toISOString(),\r\n            billingCycle,\r\n            aiUsage: {\r\n                proRequestsToday: 0,\r\n                flashRequestsToday: 0,\r\n                lastResetDate: new Date().toISOString().split('T')[0],\r\n            },\r\n            purchasedCourses: [],\r\n            purchasedBundles: [],\r\n        };\r\n\r\n        // Save subscription to user document\r\n        const userRef = db.collection('users').doc(userId);\r\n        await userRef.update({\r\n            subscription,\r\n            updatedAt: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        // Create payment record\r\n        const paymentRef = await db.collection('payments').add({\r\n            userId,\r\n            type: 'subscription',\r\n            tier,\r\n            billingCycle,\r\n            amount,\r\n            couponCode: couponCode || null,\r\n            status: 'completed',\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        console.log(`âœ… Subscription created: ${tier} for user ${userId}, payment ${paymentRef.id}`);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            subscriptionId: paymentRef.id,\r\n            tier,\r\n            endDate: endDate.toISOString(),\r\n        });\r\n    } catch (error) {\r\n        console.error('âŒ Subscription error:', error);\r\n        return safeErrorResponse(error, 'Failed to create subscription');\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\translate\\batch\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeErrorResponse' is defined but never used.","line":5,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { batchTranslate } from \"@/lib/ai/gemini-flash\";\r\nimport { initAdmin } from \"@/lib/auth/firebase-admin\";\r\nimport { trackAPICall } from \"@/lib/analytics/firestore-analytics\";\r\nimport { requireAuth, safeErrorResponse } from \"@/lib/api/auth-guard\";\r\nimport type { Language } from \"@/lib/i18n/translations\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nconst CACHE_TTL_DAYS = 7;\r\n\r\n/**\r\n * POST /api/translate/batch\r\n * Batch translate multiple texts for a lesson with SHARED CACHING\r\n * Cache is shared across all users - first user pays, rest get free\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    // ðŸ”’ SECURITY: Require authentication (uses AI credits)\r\n    const auth = await requireAuth(request);\r\n    if (!auth.authenticated) return auth.response;\r\n\r\n    try {\r\n        const body = await request.json();\r\n        const { lessonId, texts, targetLanguage, sourceLanguage = \"en\" } = body;\r\n\r\n        // Validate required fields\r\n        if (!lessonId || !texts || !Array.isArray(texts) || !targetLanguage) {\r\n            return NextResponse.json(\r\n                { error: \"Missing required fields: lessonId, texts (array), targetLanguage\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Validate language\r\n        const validLanguages: Language[] = [\"en\", \"ja\", \"ko\", \"id\"];\r\n        if (!validLanguages.includes(targetLanguage)) {\r\n            return NextResponse.json(\r\n                { error: `Invalid target language. Must be one of: ${validLanguages.join(\", \")}` },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // If same language, return originals\r\n        if (targetLanguage === sourceLanguage) {\r\n            return NextResponse.json({\r\n                success: true,\r\n                translations: texts,\r\n                cached: false,\r\n            });\r\n        }\r\n\r\n        // Check SHARED cache first (Firestore)\r\n        const cacheKey = `batch_${lessonId}_${targetLanguage}`;\r\n        const cached = await getFromCache(cacheKey);\r\n\r\n        if (cached && !isStale(cached.timestamp)) {\r\n            console.log(`âœ… Cache HIT for lesson ${lessonId} (${targetLanguage})`);\r\n            return NextResponse.json({\r\n                success: true,\r\n                translations: cached.translations,\r\n                cached: true,\r\n            });\r\n        }\r\n\r\n        console.log(`ðŸ”„ Cache MISS for lesson ${lessonId} (${targetLanguage}) - calling Gemini`);\r\n\r\n        // Filter out empty texts\r\n        const textsToTranslate = texts.filter((t: string) => t && t.trim());\r\n\r\n        if (textsToTranslate.length === 0) {\r\n            return NextResponse.json({\r\n                success: true,\r\n                translations: texts,\r\n                cached: false,\r\n            });\r\n        }\r\n\r\n        // Batch translate with Gemini\r\n        const translations = await batchTranslate(\r\n            textsToTranslate,\r\n            targetLanguage,\r\n            sourceLanguage,\r\n            \"Educational lesson content\"\r\n        );\r\n\r\n        // Map back to original indices (preserve empty positions)\r\n        let translationIdx = 0;\r\n        const result = texts.map((t: string) => {\r\n            if (!t || !t.trim()) return t;\r\n            return translations[translationIdx++] || t;\r\n        });\r\n\r\n        // Save to SHARED cache for all future users\r\n        await saveToCache(cacheKey, result);\r\n\r\n        // Track API usage for analytics\r\n        await trackAPICall({\r\n            endpoint: \"/api/translate/batch\",\r\n            method: \"POST\",\r\n            duration: 0, // We could time this\r\n            statusCode: 200,\r\n            model: \"gemini-2.5-flash-lite\",\r\n            cost: textsToTranslate.length * 0.00001, // Estimate\r\n        });\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            translations: result,\r\n            cached: false,\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Batch translation API error:\", error);\r\n        return NextResponse.json(\r\n            { error: error instanceof Error ? error.message : \"Translation failed\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n/**\r\n * Get translation from shared Firestore cache\r\n */\r\nasync function getFromCache(cacheKey: string): Promise<{ translations: string[]; timestamp: Date } | null> {\r\n    try {\r\n        const admin = initAdmin();\r\n        if (!admin) return null;\r\n\r\n        const db = admin.firestore();\r\n        const doc = await db.collection(\"translationCache\").doc(cacheKey).get();\r\n\r\n        if (!doc.exists) return null;\r\n\r\n        const data = doc.data();\r\n        return {\r\n            translations: data?.translations || [],\r\n            timestamp: data?.timestamp?.toDate() || new Date(0),\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Cache read error:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Save translation to shared Firestore cache\r\n */\r\nasync function saveToCache(cacheKey: string, translations: string[]): Promise<void> {\r\n    try {\r\n        const admin = initAdmin();\r\n        if (!admin) return;\r\n\r\n        const db = admin.firestore();\r\n        const { FieldValue } = await import('firebase-admin/firestore');\r\n\r\n        await db.collection(\"translationCache\").doc(cacheKey).set({\r\n            translations,\r\n            timestamp: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        console.log(`ðŸ’¾ Cached translations for ${cacheKey}`);\r\n    } catch (error) {\r\n        console.error(\"Cache write error:\", error);\r\n    }\r\n}\r\n\r\n/**\r\n * Check if cache is stale\r\n */\r\nfunction isStale(timestamp: Date): boolean {\r\n    const now = new Date();\r\n    const diffDays = (now.getTime() - timestamp.getTime()) / (1000 * 60 * 60 * 24);\r\n    return diffDays > CACHE_TTL_DAYS;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\translate\\course\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeErrorResponse' is defined but never used.","line":3,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { translateCourse } from \"@/lib/ai/translation\";\r\nimport { requireAuth, safeErrorResponse } from \"@/lib/api/auth-guard\";\r\nimport type { Language } from \"@/lib/i18n/translations\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * POST /api/translate/course\r\n * Translate course title and description\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    // ðŸ”’ SECURITY: Require authentication (uses AI credits)\r\n    const auth = await requireAuth(request);\r\n    if (!auth.authenticated) return auth.response;\r\n\r\n    try {\r\n        const body = await request.json();\r\n        const { courseId, title, description, targetLanguage, sourceLanguage = \"en\" } = body;\r\n\r\n        // Validate required fields\r\n        if (!courseId || !title || !description || !targetLanguage) {\r\n            return NextResponse.json(\r\n                { error: \"Missing required fields: courseId, title, description, targetLanguage\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Validate language\r\n        const validLanguages: Language[] = [\"en\", \"ja\", \"ko\", \"id\"];\r\n        if (!validLanguages.includes(targetLanguage)) {\r\n            return NextResponse.json(\r\n                { error: `Invalid target language. Must be one of: ${validLanguages.join(\", \")}` },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Translate\r\n        const translation = await translateCourse(\r\n            courseId,\r\n            title,\r\n            description,\r\n            targetLanguage,\r\n            sourceLanguage\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            translation,\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Course translation API error:\", error);\r\n        return NextResponse.json(\r\n            { error: error instanceof Error ? error.message : \"Translation failed\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\translate\\lesson\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeErrorResponse' is defined but never used.","line":3,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { translateLesson } from \"@/lib/ai/translation\";\r\nimport { requireAuth, safeErrorResponse } from \"@/lib/api/auth-guard\";\r\nimport type { Language } from \"@/lib/i18n/translations\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * POST /api/translate/lesson\r\n * Translate lesson title and content\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    // ðŸ”’ SECURITY: Require authentication (uses AI credits)\r\n    const auth = await requireAuth(request);\r\n    if (!auth.authenticated) return auth.response;\r\n\r\n    try {\r\n        const body = await request.json();\r\n        const { lessonId, title, content, targetLanguage, sourceLanguage = \"en\" } = body;\r\n\r\n        // Validate required fields\r\n        if (!lessonId || !title || !content || !targetLanguage) {\r\n            return NextResponse.json(\r\n                { error: \"Missing required fields: lessonId, title, content, targetLanguage\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Validate language\r\n        const validLanguages: Language[] = [\"en\", \"ja\", \"ko\", \"id\"];\r\n        if (!validLanguages.includes(targetLanguage)) {\r\n            return NextResponse.json(\r\n                { error: `Invalid target language. Must be one of: ${validLanguages.join(\", \")}` },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Translate\r\n        const translation = await translateLesson(\r\n            lessonId,\r\n            title,\r\n            content,\r\n            targetLanguage,\r\n            sourceLanguage\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            translation,\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Lesson translation API error:\", error);\r\n        return NextResponse.json(\r\n            { error: error instanceof Error ? error.message : \"Translation failed\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\upload-image\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\api\\upload\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NextRequest' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport sharp from 'sharp';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { withAuthTracked, safeErrorResponse } from '@/lib/api/auth-guard';\r\nimport { validateFileType } from '@/lib/api/validators';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// Upload types (maps to Drive folders)\r\ntype UploadType = 'avatar' | 'course' | 'lesson' | 'cms';\r\n\r\n// Drive folder mapping\r\nconst DRIVE_FOLDERS: Record<UploadType, 'avatars' | 'courses' | 'lessons' | 'cms'> = {\r\n    avatar: 'avatars',\r\n    course: 'courses',\r\n    lesson: 'lessons',\r\n    cms: 'cms'\r\n};\r\n\r\n// Max file sizes per type (in bytes)\r\nconst MAX_SIZES: Record<UploadType, number> = {\r\n    avatar: 2 * 1024 * 1024,    // 2MB\r\n    course: 5 * 1024 * 1024,    // 5MB  \r\n    lesson: 5 * 1024 * 1024,    // 5MB\r\n    cms: 5 * 1024 * 1024,       // 5MB\r\n};\r\n\r\nexport const POST = withAuthTracked(async (request, { user }) => {\r\n    try {\r\n        const formData = await request.formData();\r\n        const file = formData.get('file') as File;\r\n        const type = (formData.get('type') as UploadType) || 'cms';\r\n\r\n        if (!file) {\r\n            return NextResponse.json({ error: 'Missing file' }, { status: 400 });\r\n        }\r\n\r\n        // ðŸ”’ SECURITY: Validate file type\r\n        const fileValidation = validateFileType(file);\r\n        if (!fileValidation.valid) {\r\n            return NextResponse.json({ error: fileValidation.error }, { status: 400 });\r\n        }\r\n\r\n        // ðŸ”’ SECURITY: Validate file size\r\n        const maxSize = MAX_SIZES[type] || MAX_SIZES.cms;\r\n        if (file.size > maxSize) {\r\n            return NextResponse.json({\r\n                error: `File too large. Max size: ${Math.round(maxSize / 1024 / 1024)}MB`\r\n            }, { status: 400 });\r\n        }\r\n\r\n        // Get file buffer\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n\r\n        // Process with Sharp - convert to WebP, 85% quality\r\n        const imageToProcess = buffer;\r\n        let wasReplaced = false;\r\n\r\n        const processedBuffer = await sharp(imageToProcess)\r\n            .resize({\r\n                width: type === 'avatar' ? 400 : 1200,\r\n                height: type === 'avatar' ? 400 : undefined,\r\n                fit: 'inside',\r\n                withoutEnlargement: true\r\n            })\r\n            .webp({ quality: 85 })\r\n            .toBuffer();\r\n\r\n        // Get image metadata\r\n        const metadata = await sharp(processedBuffer).metadata();\r\n\r\n        // Generate unique filename\r\n        const filename = `${uuidv4().slice(0, 8)}-${Date.now()}.webp`;\r\n\r\n        // Try Google Drive first, fallback to base64\r\n        const { isDriveEnabled, uploadToDrive } = await import('@/lib/storage/google-drive');\r\n\r\n        if (isDriveEnabled()) {\r\n            // ðŸ”’ SECURITY: Only run NSFW moderation for public Drive uploads\r\n            const { moderateImage } = await import('@/lib/moderation/content-filter');\r\n            const moderation = await moderateImage(buffer);\r\n\r\n            let bufferToUpload = processedBuffer;\r\n\r\n            // If NSFW detected, replace with meme image\r\n            if (moderation.shouldReplace) {\r\n                console.log(`ðŸŽ­ Replacing NSFW upload from user ${user.id} with meme: ${moderation.reason}`);\r\n                const fs = await import('fs/promises');\r\n                const path = await import('path');\r\n                const memePath = path.join(process.cwd(), 'public', 'images', 'nsfw-replacement.jpg');\r\n                const memeBuffer = await fs.readFile(memePath);\r\n                bufferToUpload = await sharp(memeBuffer).webp({ quality: 85 }).toBuffer();\r\n                wasReplaced = true;\r\n            }\r\n\r\n            try {\r\n                const driveFolder = DRIVE_FOLDERS[type];\r\n                const { url, fileId } = await uploadToDrive(\r\n                    bufferToUpload,\r\n                    filename,\r\n                    driveFolder,\r\n                    'image/webp'\r\n                );\r\n\r\n                return NextResponse.json({\r\n                    url,\r\n                    fileId,\r\n                    width: metadata.width,\r\n                    height: metadata.height,\r\n                    size: processedBuffer.length,\r\n                    filename,\r\n                    storage: 'drive',\r\n                    replaced: wasReplaced  // True if NSFW was replaced with meme\r\n                });\r\n            } catch (driveError) {\r\n                console.error('Drive upload failed, falling back to base64:', driveError);\r\n                // Fall through to base64\r\n            }\r\n        }\r\n\r\n        // Fallback: Convert to base64 data URL\r\n        const base64 = processedBuffer.toString('base64');\r\n        const dataUrl = `data:image/webp;base64,${base64}`;\r\n\r\n        return NextResponse.json({\r\n            url: dataUrl,\r\n            width: metadata.width,\r\n            height: metadata.height,\r\n            size: processedBuffer.length,\r\n            filename,\r\n            storage: 'base64',\r\n            replaced: wasReplaced\r\n        });\r\n\r\n    } catch (error: unknown) {\r\n        console.error('Upload error:', error);\r\n        return safeErrorResponse(error, 'Upload failed');\r\n    }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\contact\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used.","line":5,"column":68,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":74},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Phone' is defined but never used.","line":5,"column":83,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":88}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, FormEvent } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { ArrowLeft, Mail, MessageSquare, AlertCircle, Send, Check, MapPin, Clock, Phone } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nexport default function ContactPage() {\r\n    const [formData, setFormData] = useState({\r\n        name: \"\",\r\n        email: \"\",\r\n        subject: \"general\",\r\n        message: \"\"\r\n    });\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [isSubmitted, setIsSubmitted] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    const handleSubmit = async (e: FormEvent) => {\r\n        e.preventDefault();\r\n        setIsSubmitting(true);\r\n        setError(null);\r\n\r\n        // Simulate form submission\r\n        await new Promise(resolve => setTimeout(resolve, 1500));\r\n\r\n        // In production, send to your backend/email service\r\n        console.log(\"Form submitted:\", formData);\r\n\r\n        setIsSubmitting(false);\r\n        setIsSubmitted(true);\r\n    };\r\n\r\n    if (isSubmitted) {\r\n        return (\r\n            <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950 flex items-center justify-center p-6\">\r\n                <div className=\"max-w-md w-full text-center\">\r\n                    <div className=\"w-20 h-20 mx-auto mb-6 rounded-full bg-emerald-100 dark:bg-emerald-500/20 flex items-center justify-center\">\r\n                        <Check className=\"w-10 h-10 text-emerald-600 dark:text-emerald-400\" />\r\n                    </div>\r\n                    <h1 className=\"text-2xl font-bold text-neutral-900 dark:text-white mb-2\">Message Sent!</h1>\r\n                    <p className=\"text-neutral-600 dark:text-neutral-400 mb-8\">\r\n                        Thank you for reaching out. We&apos;ll get back to you within 1-2 business days.\r\n                    </p>\r\n                    <Link\r\n                        href=\"/\"\r\n                        className=\"inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline font-medium\"\r\n                    >\r\n                        <ArrowLeft className=\"w-4 h-4\" />\r\n                        Back to Home\r\n                    </Link>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950\">\r\n            {/* Header */}\r\n            <header className=\"sticky top-0 z-10 bg-neutral-50/80 dark:bg-neutral-950/80 backdrop-blur-md border-b border-neutral-200 dark:border-white/10\">\r\n                <div className=\"max-w-6xl mx-auto px-6 py-4 flex items-center gap-4\">\r\n                    <Link\r\n                        href=\"/\"\r\n                        className=\"flex items-center gap-2 text-sm text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors\"\r\n                    >\r\n                        <ArrowLeft className=\"w-4 h-4\" />\r\n                        Back to Home\r\n                    </Link>\r\n                </div>\r\n            </header>\r\n\r\n            <main className=\"max-w-6xl mx-auto px-6 py-16\">\r\n                <div className=\"text-center mb-12\">\r\n                    <h1 className=\"text-4xl font-bold text-neutral-900 dark:text-white mb-4\">Contact Us</h1>\r\n                    <p className=\"text-lg text-neutral-600 dark:text-neutral-400 max-w-2xl mx-auto\">\r\n                        Have a question, concern, or feedback? We&apos;re here to help.\r\n                        Fill out the form below or reach us through other channels.\r\n                    </p>\r\n                </div>\r\n\r\n                <div className=\"grid lg:grid-cols-3 gap-12\">\r\n                    {/* Contact Form */}\r\n                    <div className=\"lg:col-span-2\">\r\n                        <div className=\"bg-white dark:bg-white/5 rounded-2xl border border-neutral-200 dark:border-white/10 p-8\">\r\n                            <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n                                <div className=\"grid md:grid-cols-2 gap-6\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <label htmlFor=\"name\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                            Your Name\r\n                                        </label>\r\n                                        <input\r\n                                            id=\"name\"\r\n                                            type=\"text\"\r\n                                            value={formData.name}\r\n                                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                                            placeholder=\"John Doe\"\r\n                                            required\r\n                                            className=\"w-full px-4 py-3 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-2\">\r\n                                        <label htmlFor=\"email\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                            Email Address\r\n                                        </label>\r\n                                        <input\r\n                                            id=\"email\"\r\n                                            type=\"email\"\r\n                                            value={formData.email}\r\n                                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}\r\n                                            placeholder=\"john@example.com\"\r\n                                            required\r\n                                            className=\"w-full px-4 py-3 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    <label htmlFor=\"subject\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                        Subject\r\n                                    </label>\r\n                                    <select\r\n                                        id=\"subject\"\r\n                                        value={formData.subject}\r\n                                        onChange={(e) => setFormData({ ...formData, subject: e.target.value })}\r\n                                        className=\"w-full px-4 py-3 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                                    >\r\n                                        <option value=\"general\">General Inquiry</option>\r\n                                        <option value=\"support\">Technical Support</option>\r\n                                        <option value=\"billing\">Billing & Payments</option>\r\n                                        <option value=\"copyright\">Copyright / Content Issue</option>\r\n                                        <option value=\"partnership\">Partnership Opportunity</option>\r\n                                        <option value=\"feedback\">Feedback / Suggestion</option>\r\n                                    </select>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    <label htmlFor=\"message\" className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300\">\r\n                                        Message\r\n                                    </label>\r\n                                    <textarea\r\n                                        id=\"message\"\r\n                                        value={formData.message}\r\n                                        onChange={(e) => setFormData({ ...formData, message: e.target.value })}\r\n                                        placeholder=\"Please describe your question or concern in detail...\"\r\n                                        required\r\n                                        rows={6}\r\n                                        className=\"w-full px-4 py-3 bg-neutral-100 dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-lg text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all resize-none\"\r\n                                    />\r\n                                </div>\r\n\r\n                                {error && (\r\n                                    <div className=\"flex items-center gap-2 p-3 bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/20 rounded-lg\">\r\n                                        <AlertCircle className=\"h-4 w-4 text-red-500 dark:text-red-400 flex-shrink-0\" />\r\n                                        <p className=\"text-sm text-red-600 dark:text-red-400\">{error}</p>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <Button\r\n                                    type=\"submit\"\r\n                                    disabled={isSubmitting}\r\n                                    className=\"w-full h-12 bg-blue-600 hover:bg-blue-700 dark:bg-white dark:hover:bg-neutral-200 text-white dark:text-black font-medium\"\r\n                                >\r\n                                    {isSubmitting ? (\r\n                                        <>Sending...</>\r\n                                    ) : (\r\n                                        <>\r\n                                            <Send className=\"mr-2 h-4 w-4\" />\r\n                                            Send Message\r\n                                        </>\r\n                                    )}\r\n                                </Button>\r\n                            </form>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Contact Info */}\r\n                    <div className=\"space-y-6\">\r\n                        <div className=\"p-6 bg-white dark:bg-white/5 rounded-2xl border border-neutral-200 dark:border-white/10\">\r\n                            <div className=\"flex items-start gap-4\">\r\n                                <div className=\"w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-500/20 flex items-center justify-center flex-shrink-0\">\r\n                                    <Mail className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h3 className=\"font-bold text-neutral-900 dark:text-white mb-1\">Email</h3>\r\n                                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                        General: <a href=\"mailto:support@gakuen.edu\" className=\"text-blue-600 dark:text-blue-400 hover:underline\">support@gakuen.edu</a>\r\n                                    </p>\r\n                                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                        Legal: <a href=\"mailto:legal@gakuen.edu\" className=\"text-blue-600 dark:text-blue-400 hover:underline\">legal@gakuen.edu</a>\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-6 bg-white dark:bg-white/5 rounded-2xl border border-neutral-200 dark:border-white/10\">\r\n                            <div className=\"flex items-start gap-4\">\r\n                                <div className=\"w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-500/20 flex items-center justify-center flex-shrink-0\">\r\n                                    <Clock className=\"w-5 h-5 text-emerald-600 dark:text-emerald-400\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h3 className=\"font-bold text-neutral-900 dark:text-white mb-1\">Response Time</h3>\r\n                                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                        We typically respond within 1-2 business days. For urgent issues, please indicate so in your message.\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-6 bg-white dark:bg-white/5 rounded-2xl border border-neutral-200 dark:border-white/10\">\r\n                            <div className=\"flex items-start gap-4\">\r\n                                <div className=\"w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-500/20 flex items-center justify-center flex-shrink-0\">\r\n                                    <MessageSquare className=\"w-5 h-5 text-amber-600 dark:text-amber-400\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h3 className=\"font-bold text-neutral-900 dark:text-white mb-1\">Content Issues</h3>\r\n                                    <p className=\"text-sm text-neutral-600 dark:text-neutral-400\">\r\n                                        If you believe our AI-generated content resembles your copyrighted work, select &quot;Copyright / Content Issue&quot; above.\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-6 bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-500/10 dark:to-cyan-500/10 rounded-2xl border border-blue-200 dark:border-blue-500/20\">\r\n                            <h3 className=\"font-bold text-blue-800 dark:text-blue-300 mb-2\">Legal Links</h3>\r\n                            <div className=\"space-y-2 text-sm\">\r\n                                <Link href=\"/terms\" className=\"block text-blue-600 dark:text-blue-400 hover:underline\">\r\n                                    Terms of Service â†’\r\n                                </Link>\r\n                                <Link href=\"/privacy\" className=\"block text-blue-600 dark:text-blue-400 hover:underline\">\r\n                                    Privacy Policy â†’\r\n                                </Link>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\editor\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'draggedComponentId' is assigned a value but never used.","line":116,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":116,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleDeleteLesson' is assigned a value but never used.","line":223,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":223,"endColumn":29}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'copiedComponent' is assigned a value but never used.","line":108,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":108,"endColumn":27,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setCopiedComponent' is assigned a value but never used.","line":108,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":108,"endColumn":47,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_saveTimeoutRef' is assigned a value but never used.","line":117,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":117,"endColumn":26,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Lesson, Course } from \"@/lib/types\";\r\nimport { Component } from \"@/lib/cms/types\";\r\nimport {\r\n    ChevronDown,\r\n    Eye,\r\n    Save,\r\n    ChevronLeft,\r\n    Plus,\r\n    GripVertical,\r\n    Trash2\r\n} from \"lucide-react\";\r\nimport { useState, useEffect, useRef, use } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { DragDropContext, Droppable, Draggable } from \"@hello-pangea/dnd\";\r\nimport { ComponentRenderer } from \"@/components/cms/ComponentRenderer\";\r\nimport { ComponentPalette } from \"@/components/cms/ComponentPalette\";\r\nimport { DesignControls } from \"@/components/cms/DesignControls\";\r\nimport { ContextMenu } from \"@/components/cms/ContextMenu\";\r\nimport { CourseSettings } from \"@/components/cms/CourseSettings\";\r\nimport { fetchCourse, updateCourse } from \"@/lib/api/courseApi\";\r\nimport { saveCourseMetadata } from \"@/lib/firebase/firestore\";\r\nimport { createComponent } from \"@/lib/cms/registry\";\r\n\r\n\r\nconst TopBar = ({\r\n    onSave,\r\n    isSaving,\r\n    onPreview,\r\n    isPreview,\r\n    activeView,\r\n    onViewChange,\r\n    isPublished\r\n}: {\r\n    onSave: () => void;\r\n    isSaving: boolean;\r\n    onPreview: () => void;\r\n    isPreview: boolean;\r\n    activeView: 'content' | 'settings';\r\n    onViewChange: (view: 'content' | 'settings') => void;\r\n    isPublished: boolean;\r\n}) => (\r\n    <header className=\"h-14 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between px-4 shrink-0\">\r\n        <div className=\"flex items-center space-x-3\">\r\n            <Link href=\"/courses\" className=\"text-zinc-500 hover:text-white transition-colors\">\r\n                <ChevronLeft size={20} />\r\n            </Link>\r\n            <div className=\"flex space-x-1 bg-zinc-900/50 p-1 rounded-lg border border-zinc-800/50\">\r\n                <button\r\n                    onClick={() => onViewChange('content')}\r\n                    className={`px-3 py-1 text-xs font-semibold rounded-md transition-colors ${activeView === 'content' ? 'bg-zinc-800 text-white shadow-sm border border-zinc-700' : 'text-zinc-500 hover:text-zinc-300'}`}\r\n                >\r\n                    Content\r\n                </button>\r\n                <button\r\n                    onClick={() => onViewChange('settings')}\r\n                    className={`px-3 py-1 text-xs font-semibold rounded-md transition-colors ${activeView === 'settings' ? 'bg-zinc-800 text-white shadow-sm border border-zinc-700' : 'text-zinc-500 hover:text-zinc-300'}`}\r\n                >\r\n                    Settings\r\n                </button>\r\n            </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center space-x-3\">\r\n            <span className=\"text-xs text-zinc-500 bg-zinc-900 px-2.5 py-1 rounded-full border border-zinc-800 hidden md:inline-block\">\r\n                {isSaving ? \"Saving...\" : \"Saved\"}\r\n            </span>\r\n\r\n            <button\r\n                onClick={onPreview}\r\n                className={`text-zinc-400 hover:text-white transition-colors p-1.5 rounded ${isPreview ? 'bg-indigo-500/10 text-indigo-400' : ''}`}\r\n                title=\"Toggle Preview\"\r\n            >\r\n                <Eye size={18} />\r\n            </button>\r\n\r\n            <button\r\n                onClick={onSave}\r\n                disabled={isSaving}\r\n                className={`flex items-center space-x-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-colors shadow-lg ${isPublished\r\n                    ? 'bg-green-600 hover:bg-green-500 text-white shadow-green-900/20'\r\n                    : 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-900/20'\r\n                    }`}\r\n            >\r\n                <Save size={14} />\r\n                <span>{isSaving ? 'Saving...' : isPublished ? 'Update' : 'Publish'}</span>\r\n            </button>\r\n\r\n            <div className=\"w-7 h-7 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-full border border-zinc-800\"></div>\r\n        </div>\r\n    </header>\r\n);\r\n\r\n// --- Main Page Component ---\r\n\r\nexport default function CourseEditorPage({ params }: { params: Promise<{ id: string }> }) {\r\n    const { id: courseId } = use(params);\r\n\r\n    const [course, setCourse] = useState<Course | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [lessons, setLessons] = useState<Lesson[]>([]);\r\n    const [editingIndex, setEditingIndex] = useState<number | null>(null);\r\n    const [selectedComponentId, setSelectedComponentId] = useState<string | null>(null);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [previewMode, setPreviewMode] = useState(false);\r\n    const [contextMenu, setContextMenu] = useState<{ x: number; y: number; componentId: string } | null>(null);\r\n    const [copiedComponent, setCopiedComponent] = useState<Component | null>(null); // eslint-disable-line @typescript-eslint/no-unused-vars\r\n    const [activeView, setActiveView] = useState<'content' | 'settings'>('content');\r\n    const [courseTitle, setCourseTitle] = useState('');\r\n    const [courseDescription, setCourseDescription] = useState('');\r\n    const [courseThumbnail, setCourseThumbnail] = useState('');\r\n    const [courseAuthor, setCourseAuthor] = useState('');\r\n    const [isPublished, setIsPublished] = useState(false);\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [draggedComponentId, setDraggedComponentId] = useState<string | null>(null);\r\n    const _saveTimeoutRef = useRef<NodeJS.Timeout | null>(null); // eslint-disable-line @typescript-eslint/no-unused-vars\r\n    const idCounterRef = useRef(0);\r\n\r\n\r\n    // Load course from API\r\n    useEffect(() => {\r\n        fetchCourse(courseId).then(serverCourse => {\r\n            if (serverCourse) {\r\n                setCourse(serverCourse);\r\n                setLessons(serverCourse.lessons || []);\r\n                setCourseTitle(serverCourse.title);\r\n                setCourseDescription(serverCourse.description);\r\n                setCourseThumbnail(serverCourse.thumbnail || '');\r\n                setCourseAuthor(serverCourse.instructor || '');\r\n                setIsPublished(serverCourse.isPublished || false);\r\n\r\n                if (serverCourse.lessons && serverCourse.lessons.length > 0) {\r\n                    setEditingIndex(0);\r\n                }\r\n            }\r\n            setIsLoading(false);\r\n        }).catch(() => setIsLoading(false));\r\n    }, [courseId]);\r\n\r\n    if (isLoading) {\r\n        return <div className=\"flex items-center justify-center h-screen bg-zinc-950 text-zinc-500\">Loading...</div>;\r\n    }\r\n\r\n    if (!course) return <div className=\"text-zinc-500 p-10\">Course not found</div>;\r\n\r\n    const currentLesson = editingIndex !== null ? lessons[editingIndex] : null;\r\n    const components = currentLesson?.components || [];\r\n    const selectedComponent = components.find(c => c.id === selectedComponentId);\r\n\r\n    const handleSave = async () => {\r\n        setIsSaving(true);\r\n\r\n        const updatedCourse = {\r\n            ...course,\r\n            title: courseTitle,\r\n            description: courseDescription,\r\n            thumbnail: courseThumbnail,\r\n            instructor: courseAuthor,\r\n            lessons,\r\n            isPublished: true,\r\n            publishedAt: new Date().toISOString(),\r\n        };\r\n\r\n        // Publish to server\r\n        const success = await updateCourse(courseId, updatedCourse);\r\n\r\n        if (success) {\r\n            setIsPublished(true);\r\n            console.log('âœ… Course published');\r\n        } else {\r\n            console.error('âŒ Publish failed');\r\n        }\r\n\r\n        // Fire-and-forget Firebase sync\r\n        saveCourseMetadata({\r\n            courseId,\r\n            title: courseTitle,\r\n            description: courseDescription,\r\n            instructor: courseAuthor,\r\n            isPublished: true,\r\n            lessonsCount: lessons.length,\r\n            enrolledCount: course.enrolledCount || 0,\r\n            createdBy: \"admin\",\r\n        }).catch(() => {\r\n            // Intentional silent fail - metadata save is non-critical, main save already succeeded\r\n        });\r\n\r\n        setIsSaving(false);\r\n    };\r\n\r\n    const handleAddLesson = () => {\r\n        const newLesson: Lesson = {\r\n            id: `${courseId}-lesson-${lessons.length + 1}`,\r\n            title: `Lesson ${lessons.length + 1}`,\r\n            type: \"cms\",\r\n            duration: \"10 min\",\r\n            content: \"\",\r\n            order: lessons.length + 1,\r\n            components: [],\r\n        };\r\n        setLessons([...lessons, newLesson]);\r\n        setEditingIndex(lessons.length);\r\n    };\r\n\r\n    const handleUpdateLesson = async (index: number, updates: Partial<Lesson>) => {\r\n        setIsSaving(true); // Show saving state\r\n        const updated = [...lessons];\r\n        updated[index] = { ...updated[index], ...updates };\r\n        setLessons(updated);\r\n\r\n        const updatedCourse = {\r\n            ...course,\r\n            title: courseTitle,\r\n            description: courseDescription,\r\n            lessons: updated,\r\n        };\r\n\r\n        await updateCourse(courseId, updatedCourse);\r\n        setIsSaving(false); // Hide saving state\r\n    };\r\n\r\n    const handleDeleteLesson = (index: number) => {\r\n        if (confirm(\"Delete this lesson?\")) {\r\n            const newLessons = lessons.filter((_, i) => i !== index);\r\n            setLessons(newLessons);\r\n            setEditingIndex(newLessons.length > 0 ? 0 : null);\r\n\r\n            // Trigger save\r\n            const updatedCourse = {\r\n                ...course,\r\n                title: courseTitle,\r\n                description: courseDescription,\r\n                lessons: newLessons,\r\n            };\r\n            updateCourse(courseId, updatedCourse);\r\n        }\r\n    };\r\n\r\n    const handleAddComponent = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const newComponents = [...components, component];\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setSelectedComponentId(component.id);\r\n    };\r\n\r\n    const handleUpdateComponent = (updatedComponent: Component) => {\r\n        if (editingIndex === null) return;\r\n        const newComponents = components.map(c =>\r\n            c.id === updatedComponent.id ? updatedComponent : c\r\n        );\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n    };\r\n\r\n    const handleDeleteComponent = () => {\r\n        if (editingIndex === null || !selectedComponentId) return;\r\n        const newComponents = components.filter(c => c.id !== selectedComponentId);\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setSelectedComponentId(null);\r\n    };\r\n\r\n    // Context menu handlers\r\n    const handleDuplicateComponent = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        idCounterRef.current += 1;\r\n        const newComponent = { ...component, id: `${component.type}-dup-${idCounterRef.current}` };\r\n        const index = components.findIndex(c => c.id === component.id);\r\n        const newComponents = [...components];\r\n        newComponents.splice(index + 1, 0, newComponent);\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleDeleteFromContextMenu = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const newComponents = components.filter(c => c.id !== component.id);\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleMoveComponentUp = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const index = components.findIndex(c => c.id === component.id);\r\n        if (index <= 0) return;\r\n        const newComponents = [...components];\r\n        [newComponents[index - 1], newComponents[index]] = [newComponents[index], newComponents[index - 1]];\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleMoveComponentDown = (component: Component) => {\r\n        if (editingIndex === null) return;\r\n        const index = components.findIndex(c => c.id === component.id);\r\n        if (index >= components.length - 1) return;\r\n        const newComponents = [...components];\r\n        [newComponents[index], newComponents[index + 1]] = [newComponents[index + 1], newComponents[index]];\r\n        handleUpdateLesson(editingIndex, { components: newComponents });\r\n        setContextMenu(null);\r\n    };\r\n\r\n    const handleCopyComponent = (component: Component) => {\r\n        navigator.clipboard.writeText(JSON.stringify(component, null, 2));\r\n        setContextMenu(null);\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-screen bg-zinc-950 text-gray-300 font-sans antialiased overflow-hidden selection:bg-indigo-500/30 selection:text-indigo-200\">\r\n            <style>{`\r\n                .custom-scrollbar::-webkit-scrollbar { width: 5px; }\r\n                .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }\r\n                .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 20px; }\r\n                .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #52525b; }\r\n            `}</style>\r\n\r\n            <TopBar\r\n                onSave={handleSave}\r\n                isSaving={isSaving}\r\n                onPreview={() => setPreviewMode(!previewMode)}\r\n                isPreview={previewMode}\r\n                activeView={activeView}\r\n                onViewChange={setActiveView}\r\n                isPublished={isPublished}\r\n            />\r\n\r\n            <div className=\"flex-1 flex overflow-hidden\">\r\n                <main\r\n                    className=\"flex-1 overflow-y-auto bg-zinc-900/30 custom-scrollbar p-0\"\r\n                    onClick={(e) => {\r\n                        // Deselect if clicking on blank area (not a component)\r\n                        if (!(e.target as HTMLElement).closest('[data-component-wrapper]')) {\r\n                            setSelectedComponentId(null);\r\n                        }\r\n                    }}\r\n                    onContextMenu={(e) => {\r\n                        // Always prevent browser context menu in editor\r\n                        e.preventDefault();\r\n                    }}\r\n                >\r\n                    {activeView === 'content' ? (\r\n                        <div\r\n                            className=\"max-w-5xl mx-auto\"\r\n                            onDragOver={(e) => {\r\n                                e.preventDefault();\r\n                                e.dataTransfer.dropEffect = 'copy';\r\n                            }}\r\n                            onDrop={(e) => {\r\n                                e.preventDefault();\r\n                                const componentType = e.dataTransfer.getData('componentType');\r\n                                if (componentType && editingIndex !== null) {\r\n                                    const newComponent = createComponent(componentType);\r\n                                    handleAddComponent(newComponent);\r\n                                }\r\n                            }}\r\n                        >\r\n                            {/* Lesson Header */}\r\n                            {currentLesson && (\r\n                                <div className=\"flex items-center justify-between mb-4 pb-3 border-b border-zinc-800/50\">\r\n                                    <div className=\"flex-1\">\r\n                                        <div className=\"flex items-center space-x-2 text-zinc-500 text-xs mb-1.5\">\r\n                                            <span className=\"text-zinc-600\">{course.title}</span>\r\n                                            <ChevronDown size={10} className=\"-rotate-90\" />\r\n                                            <span className=\"text-indigo-400\">{currentLesson.title}</span>\r\n                                        </div>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={currentLesson.title}\r\n                                            onChange={(e) => {\r\n                                                const updated = [...lessons];\r\n                                                updated[editingIndex!] = { ...updated[editingIndex!], title: e.target.value };\r\n                                                setLessons(updated);\r\n                                            }}\r\n                                            onBlur={() => handleUpdateLesson(editingIndex!, { title: currentLesson.title })}\r\n                                            className=\"text-xl font-bold text-white tracking-tight bg-transparent border-none focus:outline-none focus:ring-0 placeholder-zinc-700 w-full\"\r\n                                            placeholder=\"Lesson Title\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2 ml-4\">\r\n                                        <select\r\n                                            className=\"bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500\"\r\n                                            value={editingIndex ?? \"\"}\r\n                                            onChange={(e) => {\r\n                                                setEditingIndex(Number(e.target.value));\r\n                                                setSelectedComponentId(null);\r\n                                            }}\r\n                                        >\r\n                                            {lessons.map((l, idx) => (\r\n                                                <option key={l.id} value={idx}>{l.title}</option>\r\n                                            ))}\r\n                                        </select>\r\n                                        <button onClick={handleAddLesson} className=\"p-1 bg-zinc-800 hover:bg-zinc-700 rounded-md text-zinc-400 hover:text-white transition-colors\">\r\n                                            <Plus size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Components Canvas */}\r\n                            <div className=\"space-y-4\">\r\n                                {components.length === 0 ? (\r\n                                    <div\r\n                                        className=\"flex flex-col items-center justify-center py-16 border-2 border-dashed border-zinc-800 rounded-lg bg-zinc-900/20 cursor-context-menu\"\r\n                                        onContextMenu={(e) => {\r\n                                            if (!previewMode) {\r\n                                                e.preventDefault();\r\n                                                document.querySelector<HTMLButtonElement>('[data-add-block-btn]')?.click();\r\n                                            }\r\n                                        }}\r\n                                    >\r\n                                        <p className=\"text-zinc-500 mb-3 text-sm\">Start building your lesson</p>\r\n                                        <p className=\"text-zinc-600 text-xs mb-3\">Right-click or use button below to add components</p>\r\n                                        <ComponentPalette onAddComponent={handleAddComponent} />\r\n                                    </div>\r\n                                ) : (\r\n                                    <DragDropContext\r\n                                        onDragStart={(start) => {\r\n                                            setIsDragging(true);\r\n                                            setDraggedComponentId(start.draggableId);\r\n                                        }}\r\n                                        onDragEnd={(result) => {\r\n                                            setIsDragging(false);\r\n                                            setDraggedComponentId(null);\r\n\r\n                                            // Check if dropped in trash zone\r\n                                            if (result.destination?.droppableId === 'trash') {\r\n                                                if (editingIndex === null) return;\r\n                                                const newComponents = components.filter(c => c.id !== result.draggableId);\r\n                                                handleUpdateLesson(editingIndex, { components: newComponents });\r\n                                                setSelectedComponentId(null);\r\n                                                return;\r\n                                            }\r\n\r\n                                            if (!result.destination || editingIndex === null) return;\r\n                                            const newComponents = Array.from(components);\r\n                                            const [removed] = newComponents.splice(result.source.index, 1);\r\n                                            newComponents.splice(result.destination.index, 0, removed);\r\n                                            handleUpdateLesson(editingIndex, { components: newComponents });\r\n                                        }}>\r\n                                        <Droppable droppableId=\"components\">\r\n                                            {(provided) => (\r\n                                                <div ref={provided.innerRef} {...provided.droppableProps} className=\"space-y-4\">\r\n                                                    {components.map((component, index) => (\r\n                                                        <Draggable key={component.id} draggableId={component.id} index={index}>\r\n                                                            {(dragProvided, snapshot) => (\r\n                                                                <div\r\n                                                                    ref={dragProvided.innerRef}\r\n                                                                    {...dragProvided.draggableProps}\r\n                                                                    className={`group relative flex items-center gap-2 ${snapshot.isDragging ? 'opacity-75 z-50' : ''}`}\r\n                                                                >\r\n                                                                    {/* VISIBLE Drag Handle */}\r\n                                                                    <div\r\n                                                                        {...dragProvided.dragHandleProps}\r\n                                                                        className=\"p-2 bg-zinc-800 border border-zinc-700 rounded-lg text-zinc-400 hover:text-white hover:bg-zinc-700 cursor-grab active:cursor-grabbing transition-all shrink-0 flex items-center justify-center\"\r\n                                                                        title=\"Drag to reorder or drop in trash\"\r\n                                                                    >\r\n                                                                        <GripVertical size={20} />\r\n                                                                    </div>\r\n                                                                    <div\r\n                                                                        className=\"flex-1 min-w-0\"\r\n                                                                        data-component-wrapper\r\n                                                                        onContextMenu={(e) => {\r\n                                                                            e.preventDefault();\r\n                                                                            e.stopPropagation();\r\n                                                                            console.log('ðŸŽ¯ Context menu triggered for:', component.id);\r\n                                                                            setSelectedComponentId(component.id);\r\n                                                                            setContextMenu({ x: e.clientX, y: e.clientY, componentId: component.id });\r\n                                                                        }}\r\n                                                                    >\r\n                                                                        <ComponentRenderer\r\n                                                                            component={component}\r\n                                                                            isEditing={!previewMode}\r\n                                                                            isSelected={selectedComponentId === component.id}\r\n                                                                            onUpdate={handleUpdateComponent}\r\n                                                                            onSelect={() => setSelectedComponentId(component.id)}\r\n                                                                        />\r\n                                                                    </div>\r\n                                                                </div>\r\n                                                            )}\r\n                                                        </Draggable>\r\n                                                    ))}\r\n                                                    {provided.placeholder}\r\n                                                </div>\r\n                                            )}\r\n                                        </Droppable>\r\n\r\n                                        {/* Trash Zone - fixed overlay during drag */}\r\n                                        <Droppable droppableId=\"trash\">\r\n                                            {(trashProvided, trashSnapshot) => (\r\n                                                <div\r\n                                                    ref={trashProvided.innerRef}\r\n                                                    {...trashProvided.droppableProps}\r\n                                                    className={`fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 rounded-xl border-2 border-dashed transition-all z-[100] flex items-center gap-3 ${!isDragging ? 'opacity-0 pointer-events-none scale-90' : 'opacity-100 scale-100'\r\n                                                        } ${trashSnapshot.isDraggingOver\r\n                                                            ? 'bg-red-500/40 border-red-500 scale-110'\r\n                                                            : 'bg-zinc-900/95 border-zinc-500 backdrop-blur-md shadow-2xl'\r\n                                                        }`}\r\n                                                >\r\n                                                    <Trash2 size={24} className={trashSnapshot.isDraggingOver ? 'text-red-400' : 'text-zinc-300'} />\r\n                                                    <span className={`text-sm font-semibold ${trashSnapshot.isDraggingOver ? 'text-red-300' : 'text-zinc-300'}`}>\r\n                                                        {trashSnapshot.isDraggingOver ? 'Release to delete!' : 'Drop here to delete'}\r\n                                                    </span>\r\n                                                    <div style={{ display: 'none' }}>{trashProvided.placeholder}</div>\r\n                                                </div>\r\n                                            )}\r\n                                        </Droppable>\r\n                                    </DragDropContext>\r\n                                )}\r\n\r\n                                {!previewMode && components.length > 0 && (\r\n                                    <div className=\"mt-4 pt-4 border-t border-zinc-800/50 flex justify-center\">\r\n                                        <ComponentPalette onAddComponent={handleAddComponent} />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <CourseSettings\r\n                            courseTitle={courseTitle}\r\n                            courseDescription={courseDescription}\r\n                            courseThumbnail={courseThumbnail}\r\n                            courseAuthor={courseAuthor}\r\n                            onTitleChange={setCourseTitle}\r\n                            onDescriptionChange={setCourseDescription}\r\n                            onThumbnailChange={setCourseThumbnail}\r\n                            onAuthorChange={setCourseAuthor}\r\n                            createdAt={course.createdAt}\r\n                            lastModified={new Date().toISOString()}\r\n                            isPublished={isPublished}\r\n                        />\r\n                    )}\r\n                </main>\r\n\r\n                {/* Right Panel */}\r\n                <aside className=\"w-80 shrink-0\">\r\n                    <DesignControls\r\n                        component={selectedComponent || null}\r\n                        onUpdate={handleUpdateComponent}\r\n                        onDelete={handleDeleteComponent}\r\n                        onAddComponent={handleAddComponent}\r\n                    />\r\n                </aside>\r\n            </div>\r\n\r\n            {/* Context Menu */}\r\n            {contextMenu && (() => {\r\n                const component = components.find(c => c.id === contextMenu.componentId) || null;\r\n                return (\r\n                    <ContextMenu\r\n                        x={contextMenu.x}\r\n                        y={contextMenu.y}\r\n                        component={component}\r\n                        onClose={() => setContextMenu(null)}\r\n                        onDuplicate={() => component && handleDuplicateComponent(component)}\r\n                        onDelete={() => component && handleDeleteFromContextMenu(component)}\r\n                        onMoveUp={() => component && handleMoveComponentUp(component)}\r\n                        onMoveDown={() => component && handleMoveComponentDown(component)}\r\n                        onCopy={() => component && handleCopyComponent(component)}\r\n                        canMoveUp={components.findIndex(c => c.id === contextMenu.componentId) > 0}\r\n                        canMoveDown={components.findIndex(c => c.id === contextMenu.componentId) < components.length - 1}\r\n                    />\r\n                );\r\n            })()}\r\n        </div>\r\n    );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\editor\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\herosection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowRight' is defined but never used.","line":2,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[433,436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[433,436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":290,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14090,14093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14090,14093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FeaturesSection' is assigned a value but never used.","line":325,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":325,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RosterSection' is assigned a value but never used.","line":401,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":401,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'WarpSection' is assigned a value but never used.","line":539,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":539,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo } from 'react';\r\nimport { Play, ArrowRight, Star, Hexagon, Zap, Globe, Sparkles, ChevronRight, Database, Shield, Radio, Crosshair, Activity, Ticket } from 'lucide-react';\r\n\r\n// --- HSR UI Components ---\r\n\r\nconst HsrButton = React.memo(({ \r\n  children, \r\n  variant = 'primary', \r\n  icon: Icon \r\n}: { \r\n  children: React.ReactNode; \r\n  variant?: 'primary' | 'secondary' | 'gold';\r\n  icon?: any;\r\n}) => {\r\n  const baseStyles = \"relative group px-8 py-3 font-bold uppercase tracking-wider text-sm transition-all duration-300 transform hover:-translate-y-1 overflow-hidden\";\r\n  \r\n  const variants = {\r\n    primary: \"bg-white text-black hover:bg-cyan-50 clip-path-slant-right\",\r\n    secondary: \"bg-black/40 backdrop-blur-md border border-white/20 text-white hover:bg-black/60 clip-path-slant-left\",\r\n    gold: \"bg-gradient-to-r from-amber-200 to-amber-500 text-black hover:brightness-110 clip-path-slant-right\"\r\n  };\r\n\r\n  return (\r\n    <button className={`${baseStyles} ${variants[variant]}`}>\r\n      <div className=\"flex items-center gap-2 relative z-10\">\r\n        {Icon && <Icon size={16} className={variant === 'gold' ? 'animate-pulse' : ''} />}\r\n        {children}\r\n      </div>\r\n      {/* Hover Flash Effect */}\r\n      <div className=\"absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500 skew-x-12\" />\r\n    </button>\r\n  );\r\n});\r\nHsrButton.displayName = 'HsrButton';\r\n\r\nconst TechDecoration = React.memo(({ className }: { className?: string }) => (\r\n  <div className={`absolute pointer-events-none opacity-40 ${className}`}>\r\n    <div className=\"flex gap-1\">\r\n      <div className=\"w-1 h-1 bg-white rounded-full animate-ping\" />\r\n      <div className=\"w-16 h-[1px] bg-gradient-to-r from-transparent via-white to-transparent\" />\r\n      <div className=\"w-1 h-1 bg-white rounded-full\" />\r\n    </div>\r\n  </div>\r\n));\r\nTechDecoration.displayName = 'TechDecoration';\r\n\r\nconst Navbar = React.memo(() => (\r\n  <nav className=\"fixed top-0 w-full z-50 h-20 flex items-center border-b border-white/5 bg-gradient-to-b from-black/80 to-transparent backdrop-blur-sm\">\r\n    <div className=\"max-w-7xl mx-auto w-full px-6 flex justify-between items-center\">\r\n      {/* Brand */}\r\n      <div className=\"flex items-center gap-3\">\r\n        <div className=\"w-10 h-10 bg-white text-black flex items-center justify-center font-black text-xl clip-path-hexagon\">\r\n          <Star fill=\"black\" size={20} />\r\n        </div>\r\n        <div className=\"flex flex-col\">\r\n          <span className=\"text-white font-bold tracking-[0.2em] text-lg uppercase leading-none\">Astral</span>\r\n          <span className=\"text-cyan-400 text-[10px] tracking-[0.3em] uppercase\">Express UI</span>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Nav Items */}\r\n      <div className=\"hidden md:flex items-center gap-8\">\r\n        {['Missions', 'Characters', 'Warp', 'Archives'].map((item) => (\r\n          <a key={item} href=\"#\" className=\"text-gray-400 hover:text-white uppercase text-xs font-bold tracking-widest transition-colors relative group\">\r\n            {item}\r\n            <span className=\"absolute -bottom-1 left-0 w-0 h-[2px] bg-cyan-400 group-hover:w-full transition-all duration-300\" />\r\n          </a>\r\n        ))}\r\n      </div>\r\n\r\n      {/* CTA */}\r\n      <div className=\"hidden md:block\">\r\n        <button className=\"bg-white/10 hover:bg-white/20 border border-white/20 text-white px-6 py-2 text-xs font-bold uppercase tracking-widest backdrop-blur-md clip-path-slant-right transition-all\">\r\n          Launch Game\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </nav>\r\n));\r\nNavbar.displayName = 'Navbar';\r\n\r\nconst Hero = () => {\r\n  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });\r\n  const rafRef = React.useRef<number | null>(null);\r\n  const latestMousePos = React.useRef({ x: 0, y: 0 });\r\n  \r\n  // Mouse sensitivity for parallax effect (lower = more subtle)\r\n  const MOUSE_SENSITIVITY = 0.5;\r\n  \r\n  // Memoize transform style to avoid recreation on every render\r\n  const cardTransformStyle = useMemo(() => ({\r\n    transform: `perspective(1000px) rotateY(${mousePos.x * MOUSE_SENSITIVITY}deg) rotateX(${mousePos.y * -MOUSE_SENSITIVITY}deg)`,\r\n    boxShadow: '0 0 50px rgba(0, 200, 255, 0.1)',\r\n    backfaceVisibility: 'hidden' as const\r\n  }), [mousePos.x, mousePos.y]);\r\n\r\n  useEffect(() => {\r\n    const handleMouseMove = (e: MouseEvent) => {\r\n      // Store latest mouse coordinates\r\n      latestMousePos.current = {\r\n        x: (e.clientX / window.innerWidth) * 20,\r\n        y: (e.clientY / window.innerHeight) * 20\r\n      };\r\n\r\n      // Throttle with requestAnimationFrame for performance\r\n      if (rafRef.current) return;\r\n\r\n      rafRef.current = requestAnimationFrame(() => {\r\n        setMousePos(latestMousePos.current);\r\n        rafRef.current = null;\r\n      });\r\n    };\r\n    window.addEventListener('mousemove', handleMouseMove, { passive: true });\r\n    return () => {\r\n      window.removeEventListener('mousemove', handleMouseMove);\r\n      if (rafRef.current) cancelAnimationFrame(rafRef.current);\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"relative min-h-screen bg-[#050510] text-white overflow-hidden font-sans selection:bg-cyan-500/30\">\r\n      \r\n      {/* --- Dynamic Space Background --- */}\r\n      <div className=\"absolute inset-0 z-0\">\r\n        {/* Deep Space Gradient */}\r\n        <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-[#050510] to-black\" />\r\n        \r\n        {/* Animated Stars/Particles (CSS substitute) */}\r\n        <div className=\"absolute inset-0 opacity-30\" \r\n             style={{ backgroundImage: 'radial-gradient(white 1px, transparent 1px)', backgroundSize: '50px 50px' }}></div>\r\n        \r\n        {/* Planet/Orb Element */}\r\n        <div className=\"absolute top-1/2 right-0 -translate-y-1/2 translate-x-1/3 w-[800px] h-[800px] rounded-full bg-gradient-to-b from-cyan-500/10 to-purple-600/10 blur-[100px]\" />\r\n        \r\n        {/* Grid overlay */}\r\n        <div className=\"absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]\" />\r\n      </div>\r\n\r\n      {/* --- Main Content --- */}\r\n      <div className=\"relative z-10 max-w-7xl mx-auto px-6 pt-32 pb-20 flex flex-col md:flex-row items-center min-h-screen\">\r\n        \r\n        {/* Left: Text Content */}\r\n        <div className=\"w-full md:w-1/2 space-y-8\" style={{ transform: `translate(${mousePos.x * -1}px, ${mousePos.y * -1}px)` }}>\r\n          \r\n          {/* Decorative Label */}\r\n          <div className=\"flex items-center gap-3 animate-fade-in-up\">\r\n            <div className=\"h-[1px] w-12 bg-amber-400/50\" />\r\n            <span className=\"text-amber-400 text-xs font-bold tracking-[0.2em] uppercase\">Version 2.0 Update</span>\r\n            <div className=\"h-[1px] w-12 bg-amber-400/50\" />\r\n          </div>\r\n\r\n          {/* Headline */}\r\n          <h1 className=\"text-6xl md:text-8xl font-black italic tracking-tighter leading-[0.9] text-transparent bg-clip-text bg-gradient-to-br from-white via-gray-200 to-gray-500 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]\">\r\n            JOURNEY <br />\r\n            <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600\">BEYOND</span> <br />\r\n            STARS\r\n          </h1>\r\n\r\n          {/* Description Glass Panel */}\r\n          <div className=\"relative max-w-md p-6 bg-gradient-to-r from-black/60 to-black/20 backdrop-blur-md border-l-2 border-cyan-500\">\r\n            <p className=\"text-gray-300 leading-relaxed text-sm\">\r\n              Embark on an astral adventure. The galaxy is vast, and the data is infinite. \r\n              Manage your fleet with the new Nexus dashboard system.\r\n            </p>\r\n            {/* Corner Deco */}\r\n            <div className=\"absolute top-0 right-0 p-1\">\r\n              <div className=\"w-2 h-2 border-t border-r border-white/30\" />\r\n            </div>\r\n            <div className=\"absolute bottom-0 right-0 p-1\">\r\n              <div className=\"w-2 h-2 border-b border-r border-white/30\" />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Action Buttons */}\r\n          <div className=\"flex flex-wrap gap-4 pt-4\">\r\n            <HsrButton variant=\"gold\" icon={Sparkles}>\r\n              Start Journey\r\n            </HsrButton>\r\n            <HsrButton variant=\"secondary\" icon={Play}>\r\n              Watch Trailer\r\n            </HsrButton>\r\n          </div>\r\n\r\n          {/* Stat Readouts */}\r\n          <div className=\"flex gap-8 pt-8 border-t border-white/10\">\r\n            {[\r\n              { label: 'Active Users', value: '1.2M+' },\r\n              { label: 'Systems', value: '840+' },\r\n              { label: 'Latency', value: '12ms' }\r\n            ].map((stat) => (\r\n              <div key={stat.label}>\r\n                <div className=\"text-2xl font-bold font-mono text-white\">{stat.value}</div>\r\n                <div className=\"text-[10px] uppercase tracking-widest text-gray-500\">{stat.label}</div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Right: Character/Feature Graphic */}\r\n        <div className=\"w-full md:w-1/2 relative mt-12 md:mt-0 h-[600px] flex items-center justify-center perspective-1000\">\r\n          \r\n          {/* Rotating Rings (Simulated) - GPU accelerated */}\r\n          <div className=\"absolute w-[500px] h-[500px] rounded-full border border-white/10 animate-[spin_10s_linear_infinite] gpu-accelerate\" />\r\n          <div className=\"absolute w-[400px] h-[400px] rounded-full border border-cyan-500/20 animate-[spin_15s_linear_infinite_reverse] gpu-accelerate\" />\r\n          <div className=\"absolute w-[600px] h-[600px] rounded-full border border-dashed border-white/5 animate-[spin_30s_linear_infinite] gpu-accelerate\" />\r\n\r\n          {/* Main Card Floating - GPU accelerated */}\r\n          <div className=\"relative w-[320px] h-[480px] bg-gray-900/80 backdrop-blur-xl border border-white/10 rotate-y-12 transition-transform duration-500 hover:rotate-y-0 group gpu-accelerate\"\r\n               style={cardTransformStyle}>\r\n            \r\n            {/* Card Header */}\r\n            <div className=\"h-1/2 bg-gradient-to-b from-indigo-900 to-black relative overflow-hidden p-6 flex flex-col justify-end\">\r\n               <div className=\"absolute top-4 right-4\">\r\n                  <Hexagon className=\"text-white/20\" size={32} />\r\n               </div>\r\n               <h3 className=\"text-2xl font-bold text-white italic\">ASTRAL CARD</h3>\r\n               <p className=\"text-cyan-400 text-xs font-mono\">LV. 80 // MAX</p>\r\n               \r\n               {/* Shine Effect */}\r\n               <div className=\"absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000\" />\r\n            </div>\r\n\r\n            {/* Card Body */}\r\n            <div className=\"p-6 space-y-4\">\r\n               <div className=\"flex justify-between items-center pb-4 border-b border-white/10\">\r\n                 <span className=\"text-xs text-gray-400 uppercase\">Attributes</span>\r\n                 <Zap size={14} className=\"text-amber-400\" />\r\n               </div>\r\n               \r\n               <div className=\"space-y-2\">\r\n                 {['ATK', 'DEF', 'SPD'].map(stat => (\r\n                   <div key={stat} className=\"flex items-center gap-2 text-sm\">\r\n                     <span className=\"w-8 text-gray-500 font-mono text-xs\">{stat}</span>\r\n                     <div className=\"h-1 flex-1 bg-white/10 rounded-full overflow-hidden\">\r\n                       <div className=\"h-full bg-cyan-400 w-3/4\" />\r\n                     </div>\r\n                   </div>\r\n                 ))}\r\n               </div>\r\n\r\n               <button className=\"w-full mt-4 bg-white text-black font-bold py-2 text-xs uppercase hover:bg-cyan-400 transition-colors\">\r\n                 Details\r\n               </button>\r\n            </div>\r\n\r\n            {/* Floating Badges */}\r\n            <div className=\"absolute -right-12 top-20 bg-black/80 backdrop-blur border border-amber-500/50 p-2 transform rotate-12\">\r\n               <Star className=\"text-amber-400 fill-amber-400\" size={20} />\r\n            </div>\r\n            <div className=\"absolute -left-8 bottom-20 bg-black/80 backdrop-blur border border-cyan-500/50 p-3 transform -rotate-6\">\r\n               <Globe className=\"text-cyan-400\" size={20} />\r\n            </div>\r\n          </div>\r\n\r\n        </div>\r\n      </div>\r\n\r\n      {/* Floating UI Elements */}\r\n      <TechDecoration className=\"top-1/4 left-10\" />\r\n      <TechDecoration className=\"bottom-1/4 right-10 rotate-180\" />\r\n      \r\n      {/* Bottom Ticker */}\r\n      <div className=\"absolute bottom-0 w-full h-12 border-t border-white/10 bg-black/80 backdrop-blur flex items-center overflow-hidden\">\r\n        <div className=\"flex animate-marquee whitespace-nowrap gap-12 px-4\">\r\n           {[1,2,3,4].map(i => (\r\n             <span key={i} className=\"text-[10px] font-mono text-gray-500 flex items-center gap-2\">\r\n               <span className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\r\n               SYSTEM STATUS: NORMAL // SECTOR {i}4-X // CONNECTED\r\n             </span>\r\n           ))}\r\n        </div>\r\n      </div>\r\n\r\n      <style jsx global>{`\r\n        .clip-path-slant-right { clip-path: polygon(15% 0, 100% 0, 100% 100%, 0% 100%); }\r\n        .clip-path-slant-left { clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%); }\r\n        .clip-path-hexagon { clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }\r\n        @keyframes marquee {\r\n          0% { transform: translateX(0); }\r\n          100% { transform: translateX(-50%); }\r\n        }\r\n        .animate-marquee {\r\n          animation: marquee 20s linear infinite;\r\n        }\r\n      `}</style>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst FeatureCard = ({ title, sub, icon: Icon, color, delay }: any) => (\r\n  <div className={`relative group p-1 ${delay}`}>\r\n    {/* Hover Border Glow */}\r\n    <div className={`absolute inset-0 bg-gradient-to-r ${color} opacity-0 group-hover:opacity-100 blur-xl transition-opacity duration-500`} />\r\n    \r\n    {/* Card Container */}\r\n    <div className=\"relative h-full bg-black/60 backdrop-blur-xl border border-white/10 p-8 clip-path-slant-left hover:bg-white/5 transition-all duration-300 group-hover:-translate-y-2\">\r\n      \r\n      {/* Top Decoration */}\r\n      <div className=\"absolute top-0 right-0 p-2 opacity-50\">\r\n        <Icon className=\"text-white/20\" size={64} />\r\n      </div>\r\n\r\n      <div className=\"relative z-10 space-y-4\">\r\n        {/* Icon Badge */}\r\n        <div className=\"w-12 h-12 bg-white/10 flex items-center justify-center border border-white/20 rotate-45 group-hover:rotate-90 transition-transform duration-500\">\r\n          <Icon className=\"text-white -rotate-45 group-hover:-rotate-90 transition-transform duration-500\" size={24} />\r\n        </div>\r\n\r\n        <div className=\"pt-4\">\r\n          <h3 className=\"text-xl font-black italic uppercase tracking-wider text-white mb-2\">{title}</h3>\r\n          <p className=\"text-sm text-gray-400 leading-relaxed font-mono\">{sub}</p>\r\n        </div>\r\n\r\n        <div className=\"pt-4 flex items-center text-xs font-bold text-cyan-400 uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity translate-x-[-10px] group-hover:translate-x-0\">\r\n          Access Module <ChevronRight size={14} />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Corner Accents */}\r\n      <div className=\"absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/10 group-hover:border-cyan-400/50 transition-colors\" />\r\n    </div>\r\n  </div>\r\n);\r\n\r\nconst FeaturesSection = () => {\r\n  return (\r\n    <div className=\"relative py-32 border-t border-white/5 bg-black/40\">\r\n      {/* Background Grid Accent */}\r\n      <div className=\"absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.02)_50%,transparent_75%,transparent_100%)] bg-[length:20px_20px]\" />\r\n\r\n      <div className=\"max-w-7xl mx-auto px-6\">\r\n        {/* Section Header */}\r\n        <div className=\"mb-20 flex flex-col md:flex-row md:items-end justify-between gap-6\">\r\n          <div>\r\n             <div className=\"flex items-center gap-2 mb-4\">\r\n               <div className=\"w-2 h-2 bg-amber-400 rotate-45\" />\r\n               <span className=\"text-amber-400 font-mono text-xs tracking-widest uppercase\">System Architecture</span>\r\n             </div>\r\n             <h2 className=\"text-4xl md:text-5xl font-black italic text-white uppercase tracking-tighter\">\r\n               Main <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500\">Modules</span>\r\n             </h2>\r\n          </div>\r\n          <p className=\"max-w-md text-gray-400 text-sm md:text-right font-mono border-r-2 border-white/20 pr-4\">\r\n            Initialize core protocols. Accessing database... <br />\r\n            Select a module to begin simulation.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Grid */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8\">\r\n           <FeatureCard \r\n             title=\"Stellar Warp\"\r\n             sub=\"High-probability quantum rendering engine. Calculate drop rates and simulate gacha probabilities with 99.9% accuracy.\"\r\n             icon={Star}\r\n             color=\"from-purple-500 to-pink-500\"\r\n             delay=\"delay-0\"\r\n           />\r\n           <FeatureCard \r\n             title=\"Relic Analysis\"\r\n             sub=\"AI-powered artifact scoring. Optimize your build with deep-learning algorithms trained on top-tier player data.\"\r\n             icon={Database}\r\n             color=\"from-amber-400 to-orange-500\"\r\n             delay=\"delay-100\"\r\n           />\r\n           <FeatureCard \r\n             title=\"Security Matrix\"\r\n             sub=\"End-to-end encryption for user data. Your UID and inventory stats are protected by quantum-key distribution.\"\r\n             icon={Shield}\r\n             color=\"from-cyan-400 to-blue-500\"\r\n             delay=\"delay-200\"\r\n           />\r\n        </div>\r\n\r\n        {/* Secondary Info Bar */}\r\n        <div className=\"mt-20 p-6 border border-white/10 bg-white/5 backdrop-blur-sm flex flex-col md:flex-row items-center justify-between gap-6 clip-path-slant-right\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 bg-cyan-500/20 rounded-full flex items-center justify-center animate-pulse\">\r\n              <Radio className=\"text-cyan-400\" />\r\n            </div>\r\n            <div>\r\n              <h4 className=\"font-bold text-white uppercase\">Live Signal Detected</h4>\r\n              <p className=\"text-xs text-gray-400 font-mono\">Incoming transmission from Astral Express...</p>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex gap-8\">\r\n             <div className=\"text-center\">\r\n               <div className=\"text-2xl font-black text-white\">88%</div>\r\n               <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Download</div>\r\n             </div>\r\n             <div className=\"text-center\">\r\n               <div className=\"text-2xl font-black text-white\">12ms</div>\r\n               <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Ping</div>\r\n             </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst RosterSection = () => {\r\n  const [activeUnit, setActiveUnit] = useState(0);\r\n\r\n  const units = [\r\n    {\r\n      id: 0,\r\n      name: \"Void Drifter\",\r\n      role: \"Quantum / Hunt\",\r\n      desc: \"Specializes in single-target burst damage. Can manipulate quantum entanglement fields.\",\r\n      stats: { atk: 90, def: 40, spd: 85 },\r\n      color: \"from-indigo-500 to-purple-600\",\r\n      icon: Crosshair\r\n    },\r\n    {\r\n      id: 1,\r\n      name: \"Solar Cleric\",\r\n      role: \"Imaginary / Abundance\",\r\n      desc: \"Provides team-wide healing and buffs. Harnesses the power of dying stars.\",\r\n      stats: { atk: 30, def: 80, spd: 60 },\r\n      color: \"from-amber-300 to-yellow-500\",\r\n      icon: Activity\r\n    },\r\n    {\r\n      id: 2,\r\n      name: \"Null Tank\",\r\n      role: \"Physical / Preservation\",\r\n      desc: \"Generates massive shields. Reflects incoming damage back to attackers.\",\r\n      stats: { atk: 50, def: 95, spd: 30 },\r\n      color: \"from-gray-400 to-slate-600\",\r\n      icon: Shield\r\n    }\r\n  ];\r\n\r\n  const current = units[activeUnit];\r\n\r\n  return (\r\n    <div className=\"relative py-20 overflow-hidden\">\r\n      <div className=\"max-w-7xl mx-auto px-6\">\r\n         {/* Header */}\r\n         <div className=\"flex items-center gap-4 mb-12\">\r\n            <div className=\"w-16 h-1 bg-cyan-500\" />\r\n            <h2 className=\"text-3xl font-black italic uppercase tracking-tighter\">Deployable Units</h2>\r\n         </div>\r\n\r\n         <div className=\"flex flex-col lg:flex-row gap-8 min-h-[500px]\">\r\n            {/* List Selection (Left) */}\r\n            <div className=\"w-full lg:w-1/3 space-y-2\">\r\n               {units.map((unit, idx) => (\r\n                 <button \r\n                   key={unit.id}\r\n                   onClick={() => setActiveUnit(idx)}\r\n                   className={`w-full group relative h-20 flex items-center px-6 transition-all duration-300 ${\r\n                     activeUnit === idx \r\n                       ? 'bg-gradient-to-r from-white/10 to-transparent border-l-4 border-cyan-400 translate-x-2' \r\n                       : 'bg-black/40 hover:bg-white/5 border-l-4 border-transparent hover:border-white/20'\r\n                   }`}\r\n                 >\r\n                    <div className=\"mr-4\">\r\n                       <div className={`w-10 h-10 rounded-full bg-gradient-to-br ${unit.color} flex items-center justify-center`}>\r\n                          <unit.icon size={20} className=\"text-white\" />\r\n                       </div>\r\n                    </div>\r\n                    <div className=\"text-left\">\r\n                       <h3 className={`font-bold uppercase text-sm ${activeUnit === idx ? 'text-white' : 'text-gray-400 group-hover:text-white'}`}>\r\n                         {unit.name}\r\n                       </h3>\r\n                       <p className=\"text-[10px] text-gray-500 font-mono tracking-widest\">{unit.role}</p>\r\n                    </div>\r\n                    \r\n                    {/* Active Indicator Arrow */}\r\n                    {activeUnit === idx && (\r\n                      <ChevronRight className=\"absolute right-4 text-cyan-400 animate-pulse\" size={16} />\r\n                    )}\r\n                 </button>\r\n               ))}\r\n            </div>\r\n\r\n            {/* Main Display (Right) */}\r\n            <div className=\"w-full lg:w-2/3 relative\">\r\n               {/* Background Card */}\r\n               <div className=\"absolute inset-0 bg-white/5 clip-path-slant-right backdrop-blur-sm border border-white/10\" />\r\n               \r\n               {/* Content */}\r\n               <div className=\"relative z-10 p-12 flex flex-col md:flex-row gap-8 h-full items-center\">\r\n                  \r\n                  {/* Character \"Image\" Placeholder (Abstract) */}\r\n                  <div className=\"w-64 h-64 md:w-80 md:h-full flex-shrink-0 relative group\">\r\n                     <div className={`absolute inset-0 bg-gradient-to-b ${current.color} opacity-20 rounded-full blur-3xl group-hover:opacity-40 transition-opacity`} />\r\n                     <div className=\"relative w-full h-full border-2 border-white/10 bg-black/50 flex items-center justify-center clip-path-hexagon\">\r\n                        <current.icon size={80} className={`text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]`} />\r\n                     </div>\r\n                     \r\n                     {/* Floating Particles */}\r\n                     <div className=\"absolute top-0 right-0 w-4 h-4 bg-white rounded-full animate-ping\" />\r\n                     <div className=\"absolute bottom-10 left-0 w-2 h-2 bg-cyan-400 rounded-full animate-bounce\" />\r\n                  </div>\r\n\r\n                  {/* Details */}\r\n                  <div className=\"flex-1 space-y-6\">\r\n                     <div>\r\n                        <h3 className=\"text-4xl font-black italic text-white mb-2\">{current.name}</h3>\r\n                        <div className=\"inline-block px-3 py-1 bg-white/10 rounded text-xs font-mono text-cyan-400 border border-cyan-500/30\">\r\n                           {current.role}\r\n                        </div>\r\n                     </div>\r\n                     \r\n                     <p className=\"text-gray-400 leading-relaxed text-sm border-l-2 border-white/10 pl-4\">\r\n                        {current.desc}\r\n                     </p>\r\n\r\n                     {/* Stats Bars */}\r\n                     <div className=\"space-y-3 pt-4\">\r\n                        {Object.entries(current.stats).map(([key, val]) => (\r\n                           <div key={key} className=\"flex items-center gap-3\">\r\n                              <span className=\"w-8 text-xs font-bold uppercase text-gray-500\">{key}</span>\r\n                              <div className=\"flex-1 h-2 bg-white/10 skew-x-[-20deg] overflow-hidden\">\r\n                                 <div \r\n                                    className={`h-full bg-gradient-to-r ${current.color}`} \r\n                                    style={{ width: `${val}%` }} \r\n                                 />\r\n                              </div>\r\n                              <span className=\"text-xs font-mono text-white\">{val}</span>\r\n                           </div>\r\n                        ))}\r\n                     </div>\r\n                     \r\n                     <button className=\"mt-4 px-8 py-2 bg-white text-black font-bold uppercase text-xs hover:bg-cyan-400 transition-colors skew-x-[-20deg]\">\r\n                        <span className=\"inline-block skew-x-[20deg]\">View Profile</span>\r\n                     </button>\r\n                  </div>\r\n               </div>\r\n            </div>\r\n         </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst WarpSection = () => {\r\n  return (\r\n    <div className=\"relative py-32 overflow-hidden flex items-center justify-center\">\r\n      {/* Background with warp tunnel effect */}\r\n      <div className=\"absolute inset-0 bg-black\">\r\n         <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-black to-black\" />\r\n         {/* Speed lines */}\r\n         <div className=\"absolute inset-0 opacity-20\" \r\n              style={{ \r\n                backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(255,255,255,0.1) 50px)' \r\n              }} \r\n         />\r\n      </div>\r\n\r\n      <div className=\"relative z-10 max-w-4xl mx-auto px-6 text-center\">\r\n        \r\n        {/* Ticket Visual */}\r\n        <div className=\"relative mx-auto w-full max-w-2xl bg-gradient-to-r from-amber-200 to-amber-500 rounded-lg p-1 shadow-[0_0_50px_rgba(251,191,36,0.3)] transform hover:scale-105 transition-transform duration-500 mb-12 cursor-pointer group\">\r\n           <div className=\"bg-black/90 h-full w-full rounded border border-amber-300/50 p-8 flex flex-col md:flex-row items-center gap-8 relative overflow-hidden\">\r\n              \r\n              {/* Ticket Stub (Left) */}\r\n              <div className=\"flex-1 text-left space-y-2 relative z-10\">\r\n                 <div className=\"flex items-center gap-2 text-amber-400 font-mono text-xs uppercase tracking-widest\">\r\n                    <Ticket size={12} fill=\"currentColor\" />\r\n                    <span>Star Rail Pass</span>\r\n                 </div>\r\n                 <h2 className=\"text-3xl md:text-4xl font-black italic text-white uppercase\">\r\n                    Board the <br/> <span className=\"text-amber-400\">Express</span>\r\n                 </h2>\r\n                 <p className=\"text-gray-400 text-sm max-w-sm\">\r\n                    Get the latest updates, character leaks, and design resources sent to your inbox.\r\n                 </p>\r\n              </div>\r\n\r\n              {/* QR / Barcode Decoration (Right) */}\r\n              <div className=\"hidden md:block w-32 h-32 border-l-2 border-dashed border-white/20 pl-8 relative\">\r\n                 <div className=\"w-full h-full bg-white/5 rounded flex items-center justify-center\">\r\n                    <div className=\"text-5xl font-black text-white/10\">QR</div>\r\n                 </div>\r\n              </div>\r\n\r\n              {/* Shine Effect */}\r\n              <div className=\"absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent translate-x-[-150%] group-hover:translate-x-[150%] transition-transform duration-1000 ease-in-out\" />\r\n           </div>\r\n        </div>\r\n\r\n        {/* Input Field */}\r\n        <div className=\"flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto\">\r\n           <input \r\n             type=\"email\" \r\n             placeholder=\"Enter your email...\" \r\n             className=\"flex-1 bg-white/5 border border-white/10 px-4 py-3 rounded text-sm text-white focus:outline-none focus:border-cyan-400 focus:bg-white/10 transition-all placeholder:text-gray-600\"\r\n           />\r\n           <button className=\"bg-white text-black font-bold uppercase text-xs px-8 py-3 hover:bg-cyan-400 transition-colors clip-path-slant-right\">\r\n             Subscribe\r\n           </button>\r\n        </div>\r\n        \r\n        <p className=\"mt-6 text-[10px] text-gray-600 font-mono uppercase tracking-widest\">\r\n           Join 50,000+ Trailblazers\r\n        </p>\r\n\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\nexport default Hero;","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SessionProvider' is defined but never used.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata, Viewport } from \"next\";\r\nimport \"./globals.css\";\r\nimport { ModernBackground } from \"@/components/animations/ModernBackground\";\r\nimport { AuthProvider } from \"@/components/auth/AuthContext\";\r\nimport { ErrorBoundary } from \"@/components/ErrorBoundary\";\r\nimport { GlobalErrorHandler } from \"@/components/GlobalErrorHandler\";\r\nimport { ThemeProvider } from \"@/components/theme\";\r\nimport { LanguageProvider } from \"@/lib/i18n\";\r\nimport { CookieConsent } from \"@/components/CookieConsent\";\r\nimport { SessionProvider } from \"@/components/providers/SessionProvider\";\r\n\r\n// SEO Metadata\r\nexport const metadata: Metadata = {\r\n  metadataBase: new URL(process.env.NEXT_PUBLIC_APP_URL || \"https://gakuen.app\"),\r\n  title: {\r\n    default: \"Gakuen - Modern Learning Platform\",\r\n    template: \"%s | Gakuen\"\r\n  },\r\n  description: \"Gakuen is a modern online learning platform offering interactive courses in programming, design, and more. Learn at your own pace with AI-powered tutoring.\",\r\n  keywords: [\"learning\", \"online courses\", \"education\", \"programming\", \"design\", \"AI tutor\", \"e-learning\"],\r\n  authors: [{ name: \"Gakuen Team\" }],\r\n  creator: \"Gakuen\",\r\n  publisher: \"Gakuen\",\r\n  robots: {\r\n    index: true,\r\n    follow: true,\r\n    googleBot: {\r\n      index: true,\r\n      follow: true,\r\n      'max-video-preview': -1,\r\n      'max-image-preview': 'large',\r\n      'max-snippet': -1,\r\n    },\r\n  },\r\n  openGraph: {\r\n    type: \"website\",\r\n    locale: \"en_US\",\r\n    url: \"https://gakuen.app\",\r\n    siteName: \"Gakuen\",\r\n    title: \"Gakuen - Modern Learning Platform\",\r\n    description: \"Learn programming, design, and more with AI-powered tutoring\",\r\n    images: [\r\n      {\r\n        url: \"/og-image.png\",\r\n        width: 1200,\r\n        height: 630,\r\n        alt: \"Gakuen Learning Platform\",\r\n      }\r\n    ],\r\n  },\r\n  twitter: {\r\n    card: \"summary_large_image\",\r\n    title: \"Gakuen - Modern Learning Platform\",\r\n    description: \"Learn programming, design, and more with AI-powered tutoring\",\r\n    images: [\"/og-image.png\"],\r\n  },\r\n  manifest: \"/manifest.json\",\r\n  icons: {\r\n    icon: \"/favicon.ico\",\r\n    shortcut: \"/favicon-16x16.png\",\r\n    apple: \"/apple-touch-icon.png\",\r\n  },\r\n  appleWebApp: {\r\n    capable: true,\r\n    statusBarStyle: \"black-translucent\",\r\n    title: \"Gakuen\",\r\n  },\r\n};\r\n\r\n// Viewport configuration (separate from metadata in Next.js 14+)\r\nexport const viewport: Viewport = {\r\n  themeColor: [\r\n    { media: \"(prefers-color-scheme: light)\", color: \"#fbfbfd\" },\r\n    { media: \"(prefers-color-scheme: dark)\", color: \"#0a0a0a\" },\r\n  ],\r\n  width: \"device-width\",\r\n  initialScale: 1,\r\n  maximumScale: 5,\r\n  userScalable: true,\r\n  viewportFit: \"cover\",\r\n};\r\n\r\nexport default function RootLayout({\r\n  children,\r\n}: Readonly<{\r\n  children: React.ReactNode;\r\n}>) {\r\n  return (\r\n    <html lang=\"en\" suppressHydrationWarning>\r\n      <head>\r\n        {/* Prevent flash of wrong theme */}\r\n        <script\r\n          dangerouslySetInnerHTML={{\r\n            __html: `\r\n              (function() {\r\n                const saved = localStorage.getItem('gakuen-theme');\r\n                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\r\n                const hour = new Date().getHours();\r\n                const timeBasedDark = hour < 6 || hour >= 18;\r\n                \r\n                let isDark = false;\r\n                if (saved === 'dark') isDark = true;\r\n                else if (saved === 'light') isDark = false;\r\n                else if (saved === 'system') isDark = prefersDark;\r\n                else if (saved === 'auto') isDark = timeBasedDark;\r\n                else isDark = prefersDark;\r\n                \r\n                document.documentElement.classList.add(isDark ? 'dark' : 'light');\r\n                document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';\r\n                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');\r\n              })();\r\n            `,\r\n          }}\r\n        />\r\n        {/* Preconnect to external services */}\r\n        <link rel=\"dns-prefetch\" href=\"https://www.youtube-nocookie.com\" />\r\n      </head>\r\n      <body\r\n        className=\"font-sans antialiased bg-white dark:bg-neutral-950 text-neutral-900 dark:text-neutral-100 transition-colors duration-300\"\r\n      >\r\n        <ThemeProvider>\r\n          <LanguageProvider>\r\n            <AuthProvider>\r\n              <ErrorBoundary>\r\n                <GlobalErrorHandler />\r\n                <div className=\"relative min-h-screen\">\r\n                  {/* Only show background in dark mode */}\r\n                  <div className=\"hidden dark:block\">\r\n                    <ModernBackground />\r\n                  </div>\r\n                  <main className=\"relative z-10\">\r\n                    {children}\r\n                  </main>\r\n                  <CookieConsent />\r\n                </div>\r\n              </ErrorBoundary>\r\n            </AuthProvider>\r\n          </LanguageProvider>\r\n        </ThemeProvider>\r\n      </body>\r\n    </html>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":6,"column":70,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":76},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BookOpen' is defined but never used.","line":6,"column":90,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":98}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React from \"react\";\r\nimport Link from \"next/link\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { ArrowRight, Sparkles, Brain, Zap, Target, BarChart3, Users, Shield, Play, Star, BookOpen, Hexagon, Globe, ChevronRight } from \"lucide-react\";\r\nimport { motion, useScroll, useTransform } from \"framer-motion\";\r\nimport { useRef, useState, useEffect } from \"react\";\r\n\r\n// --- HSR UI Components ---\r\nconst HsrButton = React.memo(({\r\n  children,\r\n  variant = 'primary',\r\n  icon: Icon,\r\n  href\r\n}: {\r\n  children: React.ReactNode;\r\n  variant?: 'primary' | 'secondary' | 'gold';\r\n  icon?: React.ComponentType<{ size?: number; className?: string }>;\r\n  href?: string;\r\n}) => {\r\n  const baseStyles = \"relative group px-8 py-3 font-bold uppercase tracking-wider text-sm transition-all duration-300 transform hover:-translate-y-1 overflow-hidden\";\r\n\r\n  const variants = {\r\n    primary: \"bg-white text-black hover:bg-cyan-50 clip-path-slant-right\",\r\n    secondary: \"bg-black/40 backdrop-blur-md border border-white/20 text-white hover:bg-black/60 clip-path-slant-left\",\r\n    gold: \"bg-gradient-to-r from-amber-200 to-amber-500 text-black hover:brightness-110 clip-path-slant-right\"\r\n  };\r\n\r\n  const content = (\r\n    <button className={`${baseStyles} ${variants[variant]}`}>\r\n      <div className=\"flex items-center gap-2 relative z-10\">\r\n        {Icon && <Icon size={16} className={variant === 'gold' ? 'animate-pulse' : ''} />}\r\n        {children}\r\n      </div>\r\n      <div className=\"absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500 skew-x-12\" />\r\n    </button>\r\n  );\r\n\r\n  return href ? <Link href={href}>{content}</Link> : content;\r\n});\r\nHsrButton.displayName = 'HsrButton';\r\n\r\nconst TechDecoration = React.memo(({ className }: { className?: string }) => (\r\n  <div className={`absolute pointer-events-none opacity-40 ${className}`}>\r\n    <div className=\"flex gap-1\">\r\n      <div className=\"w-1 h-1 bg-white rounded-full animate-ping\" />\r\n      <div className=\"w-16 h-[1px] bg-gradient-to-r from-transparent via-white to-transparent\" />\r\n      <div className=\"w-1 h-1 bg-white rounded-full\" />\r\n    </div>\r\n  </div>\r\n));\r\nTechDecoration.displayName = 'TechDecoration';\r\n\r\n// Typing animation component\r\nconst TypingText = React.memo(({ text, className }: { text: string; className?: string }) => {\r\n  const [displayText, setDisplayText] = useState('');\r\n  const [isDeleting, setIsDeleting] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const typeSpeed = isDeleting ? 30 : 80;\r\n    const pauseTime = isDeleting ? 500 : 2000;\r\n\r\n    if (!isDeleting && displayText === text) {\r\n      setTimeout(() => setIsDeleting(true), pauseTime);\r\n      return;\r\n    }\r\n\r\n    if (isDeleting && displayText === '') {\r\n      setIsDeleting(false);\r\n      return;\r\n    }\r\n\r\n    const timeout = setTimeout(() => {\r\n      setDisplayText(prev =>\r\n        isDeleting\r\n          ? prev.slice(0, -1)\r\n          : text.slice(0, prev.length + 1)\r\n      );\r\n    }, typeSpeed);\r\n\r\n    return () => clearTimeout(timeout);\r\n  }, [displayText, isDeleting, text]);\r\n\r\n  return (\r\n    <span className={className}>\r\n      {displayText}\r\n      <span className=\"animate-pulse\">_</span>\r\n    </span>\r\n  );\r\n});\r\nTypingText.displayName = 'TypingText';\r\n\r\n// Roster Section for AI Learning Modes\r\nconst RosterSection = React.memo(() => {\r\n  const [activeUnit, setActiveUnit] = useState(0);\r\n\r\n  const units = [\r\n    {\r\n      id: 0,\r\n      name: \"Standard Mode\",\r\n      role: \"Gemini 3.0 / Learning\",\r\n      desc: \"Perfect for everyday learning. Fast responses, clear explanations, and adaptive difficulty.\",\r\n      stats: { speed: 95, clarity: 85, depth: 70 },\r\n      color: \"from-cyan-500 to-blue-600\",\r\n      icon: Brain\r\n    },\r\n    {\r\n      id: 1,\r\n      name: \"Pro Mode\",\r\n      role: \"Gemini 3.0 Pro / Advanced\",\r\n      desc: \"Deep analysis and complex problem solving. Handles multi-step reasoning and research tasks.\",\r\n      stats: { speed: 75, clarity: 90, depth: 95 },\r\n      color: \"from-amber-400 to-orange-500\",\r\n      icon: Zap\r\n    },\r\n    {\r\n      id: 2,\r\n      name: \"Adaptive Mode\",\r\n      role: \"Auto-Select / Personalized\",\r\n      desc: \"AI automatically selects the best model based on your question complexity and learning history.\",\r\n      stats: { speed: 85, clarity: 90, depth: 85 },\r\n      color: \"from-emerald-400 to-teal-500\",\r\n      icon: Target\r\n    }\r\n  ];\r\n\r\n  const current = units[activeUnit];\r\n\r\n  return (\r\n    <div className=\"relative py-20 overflow-hidden border-t border-white/5\">\r\n      <div className=\"max-w-7xl mx-auto px-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center gap-4 mb-12\">\r\n          <div className=\"w-16 h-1 bg-cyan-500\" />\r\n          <h2 className=\"text-3xl font-black italic uppercase tracking-tighter\">AI Learning Modes</h2>\r\n        </div>\r\n\r\n        <div className=\"flex flex-col lg:flex-row gap-8 min-h-[500px]\">\r\n          {/* List Selection */}\r\n          <div className=\"w-full lg:w-1/3 space-y-2\">\r\n            {units.map((unit, idx) => (\r\n              <button\r\n                key={unit.id}\r\n                onClick={() => setActiveUnit(idx)}\r\n                className={`w-full group relative h-20 flex items-center px-6 transition-all duration-300 ${activeUnit === idx\r\n                  ? 'bg-gradient-to-r from-white/10 to-transparent border-l-4 border-cyan-400 translate-x-2'\r\n                  : 'bg-black/40 hover:bg-white/5 border-l-4 border-transparent hover:border-white/20'\r\n                  }`}\r\n              >\r\n                <div className=\"mr-4\">\r\n                  <div className={`w-10 h-10 rounded-full bg-gradient-to-br ${unit.color} flex items-center justify-center`}>\r\n                    <unit.icon size={20} className=\"text-white\" />\r\n                  </div>\r\n                </div>\r\n                <div className=\"text-left\">\r\n                  <h3 className={`font-bold uppercase text-sm ${activeUnit === idx ? 'text-white' : 'text-gray-400 group-hover:text-white'}`}>\r\n                    {unit.name}\r\n                  </h3>\r\n                  <p className=\"text-[10px] text-gray-500 font-mono tracking-widest\">{unit.role}</p>\r\n                </div>\r\n\r\n                {activeUnit === idx && (\r\n                  <ChevronRight className=\"absolute right-4 text-cyan-400 animate-pulse\" size={16} />\r\n                )}\r\n              </button>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Main Display */}\r\n          <div className=\"w-full lg:w-2/3 relative\">\r\n            <div className=\"absolute inset-0 bg-white/5 clip-path-slant-right backdrop-blur-sm border border-white/10\" />\r\n\r\n            <div className=\"relative z-10 p-12 flex flex-col md:flex-row gap-8 h-full items-center\">\r\n              {/* Mode Icon Display */}\r\n              <div className=\"w-64 h-64 md:w-80 md:h-full flex-shrink-0 relative group\">\r\n                <div className={`absolute inset-0 bg-gradient-to-b ${current.color} opacity-20 rounded-full blur-3xl group-hover:opacity-40 transition-opacity`} />\r\n                <div className=\"relative w-full h-full border-2 border-white/10 bg-black/50 flex items-center justify-center clip-path-hexagon\">\r\n                  <current.icon size={80} className=\"text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]\" />\r\n                </div>\r\n\r\n                <div className=\"absolute top-0 right-0 w-4 h-4 bg-white rounded-full animate-ping\" />\r\n                <div className=\"absolute bottom-10 left-0 w-2 h-2 bg-cyan-400 rounded-full animate-bounce\" />\r\n              </div>\r\n\r\n              {/* Details */}\r\n              <div className=\"flex-1 space-y-6\">\r\n                <div>\r\n                  <h3 className=\"text-4xl font-black italic text-white mb-2\">{current.name}</h3>\r\n                  <div className=\"inline-block px-3 py-1 bg-white/10 rounded text-xs font-mono text-cyan-400 border border-cyan-500/30\">\r\n                    {current.role}\r\n                  </div>\r\n                </div>\r\n\r\n                <p className=\"text-gray-400 leading-relaxed text-sm border-l-2 border-white/10 pl-4\">\r\n                  {current.desc}\r\n                </p>\r\n\r\n                {/* Stats Bars */}\r\n                <div className=\"space-y-3 pt-4\">\r\n                  {Object.entries(current.stats).map(([key, val]) => (\r\n                    <div key={key} className=\"flex items-center gap-3\">\r\n                      <span className=\"w-12 text-xs font-bold uppercase text-gray-500\">{key}</span>\r\n                      <div className=\"flex-1 h-2 bg-white/10 skew-x-[-20deg] overflow-hidden\">\r\n                        <div\r\n                          className={`h-full bg-gradient-to-r ${current.color}`}\r\n                          style={{ width: `${val}%` }}\r\n                        />\r\n                      </div>\r\n                      <span className=\"text-xs font-mono text-white\">{val}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n\r\n                <Link href=\"/login\">\r\n                  <button className=\"mt-4 px-8 py-2 bg-white text-black font-bold uppercase text-xs hover:bg-cyan-400 transition-colors skew-x-[-20deg]\">\r\n                    <span className=\"inline-block skew-x-[20deg]\">Try This Mode</span>\r\n                  </button>\r\n                </Link>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\nRosterSection.displayName = 'RosterSection';\r\n\r\nexport default function LandingPage() {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const { scrollYProgress } = useScroll({\r\n    target: containerRef,\r\n    offset: [\"start start\", \"end end\"]\r\n  });\r\n\r\n  const heroOpacity = useTransform(scrollYProgress, [0, 0.2], [1, 0]);\r\n  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });\r\n  const rafRef = useRef<number | null>(null);\r\n\r\n  useEffect(() => {\r\n    const handleMouseMove = (e: MouseEvent) => {\r\n      // Throttle with requestAnimationFrame for performance\r\n      if (rafRef.current) return;\r\n\r\n      rafRef.current = requestAnimationFrame(() => {\r\n        setMousePos({\r\n          x: (e.clientX / window.innerWidth) * 20,\r\n          y: (e.clientY / window.innerHeight) * 20\r\n        });\r\n        rafRef.current = null;\r\n      });\r\n    };\r\n\r\n    window.addEventListener('mousemove', handleMouseMove, { passive: true });\r\n    return () => {\r\n      window.removeEventListener('mousemove', handleMouseMove);\r\n      if (rafRef.current) cancelAnimationFrame(rafRef.current);\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div ref={containerRef} className=\"min-h-screen bg-[#050510] text-white overflow-x-hidden selection:bg-cyan-500/30\">\r\n      {/* Premium Floating Navbar - KEEPING AS REQUESTED */}\r\n      <motion.header\r\n        initial={{ y: -20, opacity: 0 }}\r\n        animate={{ y: 0, opacity: 1 }}\r\n        transition={{ duration: 0.6, ease: [0.25, 0.4, 0.25, 1] }}\r\n        className=\"fixed top-4 left-1/2 -translate-x-1/2 z-50\"\r\n      >\r\n        <nav className=\"flex items-center gap-1 px-2 py-2 bg-white/5 backdrop-blur-xl rounded-full border border-white/10 shadow-2xl shadow-black/50\">\r\n          <Link href=\"/\" className=\"px-4 py-2 text-sm font-semibold text-white\">\r\n            Gakuen\r\n          </Link>\r\n          <div className=\"hidden sm:flex items-center gap-1\">\r\n            <Link href=\"#features\" className=\"px-3 py-1.5 text-sm text-neutral-400 hover:text-white transition-colors rounded-full hover:bg-white/5\">\r\n              Features\r\n            </Link>\r\n            <Link href=\"#ai\" className=\"px-3 py-1.5 text-sm text-neutral-400 hover:text-white transition-colors rounded-full hover:bg-white/5\">\r\n              AI\r\n            </Link>\r\n          </div>\r\n          <Link href=\"/login\">\r\n            <Button size=\"sm\" className=\"bg-white text-black hover:bg-neutral-200 rounded-full px-4 h-8 text-sm font-medium\">\r\n              Sign In\r\n            </Button>\r\n          </Link>\r\n        </nav>\r\n      </motion.header>\r\n\r\n      {/* HERO: HSR-Style with Space Background */}\r\n      <section className=\"relative min-h-screen overflow-hidden\">\r\n        {/* --- Dynamic Space Background --- */}\r\n        <div className=\"absolute inset-0 z-0\">\r\n          <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-[#050510] to-black\" />\r\n          <div className=\"absolute inset-0 opacity-30\" style={{ backgroundImage: 'radial-gradient(white 1px, transparent 1px)', backgroundSize: '50px 50px' }} />\r\n          <div className=\"absolute top-1/2 right-0 -translate-y-1/2 translate-x-1/3 w-[800px] h-[800px] rounded-full bg-gradient-to-b from-cyan-500/10 to-purple-600/10 blur-[100px]\" />\r\n          <div className=\"absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]\" />\r\n        </div>\r\n\r\n        {/* --- Main Content --- */}\r\n        <motion.div style={{ opacity: heroOpacity }} className=\"relative z-10 max-w-7xl mx-auto px-6 pt-32 pb-20 flex flex-col md:flex-row items-center min-h-screen\">\r\n\r\n          {/* Left: Text Content */}\r\n          <div className=\"w-full md:w-1/2 space-y-8\" style={{ transform: `translate(${mousePos.x * -1}px, ${mousePos.y * -1}px)` }}>\r\n\r\n            {/* Decorative Label */}\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"h-[1px] w-12 bg-amber-400/50\" />\r\n              <span className=\"text-amber-400 text-xs font-bold tracking-[0.2em] uppercase\">Version 2.0 Live</span>\r\n              <div className=\"h-[1px] w-12 bg-amber-400/50\" />\r\n            </div>\r\n\r\n            {/* Headline */}\r\n            <h1 className=\"text-6xl md:text-8xl font-black italic tracking-tighter leading-[0.9] text-transparent bg-clip-text bg-gradient-to-br from-white via-gray-200 to-gray-500 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]\">\r\n              MASTER <br />\r\n              <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600\">ANY</span> <br />\r\n              SUBJECT\r\n            </h1>\r\n\r\n            {/* Description Glass Panel */}\r\n            <div className=\"relative max-w-md p-6 bg-gradient-to-r from-black/60 to-black/20 backdrop-blur-md border-l-2 border-cyan-500\">\r\n              <p className=\"text-gray-300 leading-relaxed text-sm\">\r\n                Your personal AI tutor is here. Adaptive learning, instant explanations,\r\n                and unlimited knowledge at your fingertips.\r\n              </p>\r\n              <div className=\"absolute top-0 right-0 p-1\">\r\n                <div className=\"w-2 h-2 border-t border-r border-white/30\" />\r\n              </div>\r\n              <div className=\"absolute bottom-0 right-0 p-1\">\r\n                <div className=\"w-2 h-2 border-b border-r border-white/30\" />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Action Buttons */}\r\n            <div className=\"flex flex-wrap gap-4 pt-4\">\r\n              <HsrButton variant=\"gold\" icon={Sparkles} href=\"/login\">\r\n                Start Learning\r\n              </HsrButton>\r\n              <HsrButton variant=\"secondary\" icon={Play} href=\"/browse\">\r\n                Browse Courses\r\n              </HsrButton>\r\n            </div>\r\n\r\n            {/* Stat Readouts */}\r\n            <div className=\"flex gap-8 pt-8 border-t border-white/10\">\r\n              {[\r\n                { label: 'Active Learners', value: '10K+' },\r\n                { label: 'Completion', value: '95%' },\r\n                { label: 'Rating', value: '4.9â˜…' }\r\n              ].map((stat) => (\r\n                <div key={stat.label}>\r\n                  <div className=\"text-2xl font-bold font-mono text-white\">{stat.value}</div>\r\n                  <div className=\"text-[10px] uppercase tracking-widest text-gray-500\">{stat.label}</div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Right: Floating Card with Rings */}\r\n          <div className=\"w-full md:w-1/2 relative mt-12 md:mt-0 h-[600px] flex items-center justify-center\">\r\n\r\n            {/* Rotating Rings - GPU accelerated */}\r\n            <div className=\"absolute w-[500px] h-[500px] rounded-full border border-white/10 animate-[spin_10s_linear_infinite] will-change-transform\" style={{ transform: 'translateZ(0)' }} />\r\n            <div className=\"absolute w-[400px] h-[400px] rounded-full border border-cyan-500/20 animate-[spin_15s_linear_infinite_reverse] will-change-transform\" style={{ transform: 'translateZ(0)' }} />\r\n            <div className=\"absolute w-[600px] h-[600px] rounded-full border border-dashed border-white/5 animate-[spin_30s_linear_infinite] will-change-transform\" style={{ transform: 'translateZ(0)' }} />\r\n\r\n            {/* Main Card - GPU accelerated */}\r\n            <div\r\n              className=\"relative w-[320px] h-[480px] bg-gray-900/80 backdrop-blur-xl border border-white/10 transition-transform duration-500 group will-change-transform\"\r\n              style={{\r\n                transform: `perspective(1000px) rotateY(${mousePos.x * 0.5}deg) rotateX(${mousePos.y * -0.5}deg) translateZ(0)`,\r\n                boxShadow: '0 0 50px rgba(0, 200, 255, 0.1)',\r\n                backfaceVisibility: 'hidden'\r\n              }}\r\n            >\r\n              {/* Card Header */}\r\n              <div className=\"h-1/2 bg-gradient-to-b from-indigo-900 to-black relative overflow-hidden p-6 flex flex-col justify-end\">\r\n                <div className=\"absolute top-4 right-4\">\r\n                  <Hexagon className=\"text-white/20\" size={32} />\r\n                </div>\r\n                <h3 className=\"text-2xl font-bold text-white italic\">AI TUTOR</h3>\r\n                <p className=\"text-cyan-400 text-xs font-mono\">GEMINI 3.0 // PRO</p>\r\n                <div className=\"absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000\" />\r\n              </div>\r\n\r\n              {/* Card Body */}\r\n              <div className=\"p-6 space-y-4\">\r\n                <div className=\"flex justify-between items-center pb-4 border-b border-white/10\">\r\n                  <span className=\"text-xs text-gray-400 uppercase\">Capabilities</span>\r\n                  <Zap size={14} className=\"text-amber-400\" />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  {['Explain', 'Quiz', 'Adapt'].map(stat => (\r\n                    <div key={stat} className=\"flex items-center gap-2 text-sm\">\r\n                      <span className=\"w-12 text-gray-500 font-mono text-xs\">{stat}</span>\r\n                      <div className=\"h-1 flex-1 bg-white/10 rounded-full overflow-hidden\">\r\n                        <div className=\"h-full bg-cyan-400 w-[90%]\" />\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n\r\n                <Link href=\"/login\">\r\n                  <button className=\"w-full mt-4 bg-white text-black font-bold py-2 text-xs uppercase hover:bg-cyan-400 transition-colors\">\r\n                    Try Now\r\n                  </button>\r\n                </Link>\r\n              </div>\r\n\r\n              {/* Floating Badges */}\r\n              <div className=\"absolute -right-12 top-20 bg-black/80 backdrop-blur border border-amber-500/50 p-2 transform rotate-12\">\r\n                <Star className=\"text-amber-400 fill-amber-400\" size={20} />\r\n              </div>\r\n              <div className=\"absolute -left-8 bottom-20 bg-black/80 backdrop-blur border border-cyan-500/50 p-3 transform -rotate-6\">\r\n                <Globe className=\"text-cyan-400\" size={20} />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </motion.div>\r\n\r\n        {/* Floating UI Elements */}\r\n        <TechDecoration className=\"top-1/4 left-10\" />\r\n        <TechDecoration className=\"bottom-1/4 right-10 rotate-180\" />\r\n\r\n        {/* Bottom Ticker */}\r\n        <div className=\"absolute bottom-0 w-full h-12 border-t border-white/10 bg-black/80 backdrop-blur flex items-center overflow-hidden z-20\">\r\n          <div className=\"flex animate-marquee whitespace-nowrap gap-12 px-4\">\r\n            {[1, 2, 3, 4].map(i => (\r\n              <span key={i} className=\"text-[10px] font-mono text-gray-500 flex items-center gap-2\">\r\n                <span className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\r\n                AI TUTOR: ONLINE // 10,000+ LEARNERS // 95% COMPLETION RATE\r\n              </span>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* STATS SECTION - HSR Terminal Style */}\r\n      <section className=\"relative py-16 border-y border-white/10 overflow-hidden\">\r\n        {/* Background Grid */}\r\n        <div className=\"absolute inset-0 bg-[linear-gradient(90deg,transparent_24px,rgba(255,255,255,0.03)_1px),linear-gradient(0deg,transparent_24px,rgba(255,255,255,0.03)_1px)] bg-[length:25px_25px]\" />\r\n\r\n        <div className=\"relative z-10 max-w-7xl mx-auto px-6\">\r\n          {/* Header Tag - Typing Animation */}\r\n          <div className=\"flex items-center gap-2 mb-8 justify-center\">\r\n            <div className=\"w-2 h-2 bg-green-400 rounded-full animate-pulse\" />\r\n            <TypingText\r\n              text=\"SYSTEM STATUS // ALL SYSTEMS NOMINAL\"\r\n              className=\"text-[10px] font-mono text-green-400 uppercase tracking-widest\"\r\n            />\r\n          </div>\r\n\r\n          {/* Stats Grid */}\r\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n            {[\r\n              { value: \"10,847\", label: \"ACTIVE USERS\", icon: Users, color: \"cyan\", suffix: \"\" },\r\n              { value: \"2.4\", label: \"REVENUE\", icon: Zap, color: \"emerald\", suffix: \"M\" },\r\n              { value: \"95.7\", label: \"COMPLETION\", icon: Target, color: \"amber\", suffix: \"%\" },\r\n              { value: \"4.9\", label: \"AVG RATING\", icon: Star, color: \"purple\", suffix: \"/5\" },\r\n            ].map((stat, i) => (\r\n              <motion.div\r\n                key={i}\r\n                initial={{ opacity: 0, scale: 0.9 }}\r\n                whileInView={{ opacity: 1, scale: 1 }}\r\n                viewport={{ once: true }}\r\n                transition={{ duration: 0.5, delay: i * 0.1 }}\r\n                className=\"group relative\"\r\n              >\r\n                {/* Card */}\r\n                <div className=\"relative bg-black/60 backdrop-blur-sm border border-white/10 p-6 hover:border-white/20 transition-all duration-300\">\r\n                  {/* Top Glow Line */}\r\n                  <div className={`absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-${stat.color}-500 to-transparent opacity-50 group-hover:opacity-100 transition-opacity`} />\r\n\r\n                  {/* Icon */}\r\n                  <div className=\"flex items-center gap-2 mb-4\">\r\n                    <stat.icon className={`text-${stat.color}-400`} size={16} />\r\n                    <span className=\"text-[10px] font-mono text-gray-500 uppercase tracking-widest\">{stat.label}</span>\r\n                  </div>\r\n\r\n                  {/* Value */}\r\n                  <div className=\"flex items-baseline gap-1\">\r\n                    <span className={`text-4xl md:text-5xl font-black text-white tabular-nums`}>\r\n                      {stat.value}\r\n                    </span>\r\n                    <span className={`text-xl font-bold text-${stat.color}-400`}>{stat.suffix}</span>\r\n                  </div>\r\n\r\n                  {/* Bottom Bar - Animated Fill */}\r\n                  <div className=\"mt-4 h-1 bg-white/5 rounded overflow-hidden\">\r\n                    <motion.div\r\n                      initial={{ width: 0 }}\r\n                      whileInView={{ width: `${70 + i * 8}%` }}\r\n                      viewport={{ once: true }}\r\n                      transition={{ duration: 1.5, delay: 0.3 + i * 0.2, ease: \"easeOut\" }}\r\n                      className={`h-full bg-gradient-to-r from-${stat.color}-500 to-${stat.color}-400`}\r\n                    />\r\n                  </div>\r\n\r\n                  {/* Corner Accent */}\r\n                  <div className=\"absolute bottom-0 right-0 w-6 h-6 border-b border-r border-white/10 group-hover:border-white/30 transition-colors\" />\r\n                </div>\r\n              </motion.div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* AI FEATURES - HSR Style */}\r\n      <section id=\"ai\" className=\"relative py-32 border-t border-white/5 bg-black/40\">\r\n        {/* Background Grid Accent */}\r\n        <div className=\"absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.02)_50%,transparent_75%,transparent_100%)] bg-[length:20px_20px]\" />\r\n\r\n        <div className=\"max-w-7xl mx-auto px-6 relative z-10\">\r\n          {/* Section Header */}\r\n          <div className=\"mb-20 flex flex-col md:flex-row md:items-end justify-between gap-6\">\r\n            <div>\r\n              <div className=\"flex items-center gap-2 mb-4\">\r\n                <div className=\"w-2 h-2 bg-amber-400 rotate-45\" />\r\n                <span className=\"text-amber-400 font-mono text-xs tracking-widest uppercase\">AI Architecture</span>\r\n              </div>\r\n              <h2 className=\"text-4xl md:text-5xl font-black italic text-white uppercase tracking-tighter\">\r\n                Core <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500\">Modules</span>\r\n              </h2>\r\n            </div>\r\n            <div className=\"max-w-md text-sm md:text-right font-mono border-r-2 border-green-400/50 pr-4\">\r\n              <TypingText\r\n                text=\"Initialize learning protocols. Accessing AI... Select a module to begin.\"\r\n                className=\"text-green-400\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Grid */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8\">\r\n            {[\r\n              { title: \"Smart Tutor\", sub: \"24/7 AI-powered tutoring. Ask any question, get instant explanations tailored to your level.\", icon: Brain, color: \"from-cyan-400 to-blue-500\" },\r\n              { title: \"Adaptive Engine\", sub: \"Courses that adapt in real-time. Struggle with a topic? Get more practice automatically.\", icon: Target, color: \"from-amber-400 to-orange-500\" },\r\n              { title: \"Progress Matrix\", sub: \"Deep analytics on your learning patterns. See exactly where you stand and what to focus on.\", icon: BarChart3, color: \"from-emerald-400 to-green-500\" },\r\n            ].map((feature, i) => (\r\n              <div key={i} className=\"relative group p-1\">\r\n                {/* Hover Border Glow */}\r\n                <div className={`absolute inset-0 bg-gradient-to-r ${feature.color} opacity-0 group-hover:opacity-100 blur-xl transition-opacity duration-500`} />\r\n\r\n                {/* Card Container */}\r\n                <div className=\"relative h-full bg-black/60 backdrop-blur-xl border border-white/10 p-8 clip-path-slant-left hover:bg-white/5 transition-all duration-300 group-hover:-translate-y-2\">\r\n\r\n                  {/* Top Decoration */}\r\n                  <div className=\"absolute top-0 right-0 p-2 opacity-50\">\r\n                    <feature.icon className=\"text-white/20\" size={64} />\r\n                  </div>\r\n\r\n                  <div className=\"relative z-10 space-y-4\">\r\n                    {/* Icon Badge */}\r\n                    <div className=\"w-12 h-12 bg-white/10 flex items-center justify-center border border-white/20 rotate-45 group-hover:rotate-90 transition-transform duration-500\">\r\n                      <feature.icon className=\"text-white -rotate-45 group-hover:-rotate-90 transition-transform duration-500\" size={24} />\r\n                    </div>\r\n\r\n                    <div className=\"pt-4\">\r\n                      <h3 className=\"text-xl font-black italic uppercase tracking-wider text-white mb-2\">{feature.title}</h3>\r\n                      <p className=\"text-sm text-gray-400 leading-relaxed font-mono\">{feature.sub}</p>\r\n                    </div>\r\n\r\n                    <div className=\"pt-4 flex items-center text-xs font-bold text-cyan-400 uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity translate-x-[-10px] group-hover:translate-x-0\">\r\n                      Access Module <ArrowRight size={14} className=\"ml-1\" />\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Corner Accents */}\r\n                  <div className=\"absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/10 group-hover:border-cyan-400/50 transition-colors\" />\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Secondary Info Bar */}\r\n          <div className=\"mt-20 relative overflow-hidden group\">\r\n            {/* Skewed background */}\r\n            <div className=\"absolute inset-0 bg-white/5 backdrop-blur-sm border border-white/10 skew-x-[-2deg]\" />\r\n\r\n            {/* Shine effect - sweeps left to right */}\r\n            <div className=\"absolute inset-0 overflow-hidden\">\r\n              <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full animate-shine\" />\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"relative p-6 flex flex-col md:flex-row items-center justify-between gap-6\">\r\n              <div className=\"flex items-center gap-4\">\r\n                <div className=\"w-12 h-12 bg-cyan-500/20 rounded-full flex items-center justify-center animate-pulse\">\r\n                  <Sparkles className=\"text-cyan-400\" size={20} />\r\n                </div>\r\n                <div>\r\n                  <h4 className=\"font-bold text-white uppercase\">AI Tutor Online</h4>\r\n                  <p className=\"text-xs text-gray-400 font-mono\">Gemini 3.0 Flash ready for your questions...</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex gap-8\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl font-black text-white\">95%</div>\r\n                  <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Completion</div>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl font-black text-white\">24/7</div>\r\n                  <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Available</div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* AI LEARNING MODES - Roster Style */}\r\n      <RosterSection />\r\n\r\n      {/* REVIEWS - HSR Style */}\r\n      <section className=\"relative py-32 overflow-hidden border-t border-white/5\">\r\n        {/* Background */}\r\n        <div className=\"absolute inset-0 bg-gradient-to-b from-black via-indigo-950/20 to-black\" />\r\n\r\n        <div className=\"relative z-10 max-w-7xl mx-auto px-6\">\r\n          {/* Header */}\r\n          <div className=\"flex items-center gap-4 mb-16\">\r\n            <div className=\"w-16 h-1 bg-amber-400\" />\r\n            <h2 className=\"text-3xl font-black italic uppercase tracking-tighter\">Trailblazer Reviews</h2>\r\n            <div className=\"flex items-center gap-1 ml-auto\">\r\n              {[1, 2, 3, 4, 5].map(i => (\r\n                <Star key={i} className=\"w-5 h-5 fill-amber-400 text-amber-400\" />\r\n              ))}\r\n              <span className=\"text-amber-400 font-bold ml-2\">4.9</span>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Review Cards Grid */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n            {[\r\n              {\r\n                name: \"Sarah Chen\",\r\n                rank: \"Lv. 70\",\r\n                role: \"Software Engineer\",\r\n                avatar: \"S\",\r\n                color: \"from-cyan-500 to-blue-600\",\r\n                quote: \"Finally, an AI tutor that actually understands how I learn. Like having a brilliant friend who's always free.\",\r\n                rating: 5,\r\n              },\r\n              {\r\n                name: \"Marcus Rivera\",\r\n                rank: \"Lv. 45\",\r\n                role: \"CS Student\",\r\n                avatar: \"M\",\r\n                color: \"from-amber-400 to-orange-500\",\r\n                quote: \"Went from struggling in algorithms to acing my interviews. The adaptive learning is game-changing.\",\r\n                rating: 5,\r\n              },\r\n              {\r\n                name: \"Emily Zhang\",\r\n                rank: \"Lv. 82\",\r\n                role: \"Tech Lead @ Meta\",\r\n                avatar: \"E\",\r\n                color: \"from-purple-500 to-pink-500\",\r\n                quote: \"I've tried every learning platform. This is the only one that feels like it was built for engineers.\",\r\n                rating: 5,\r\n              },\r\n            ].map((review, i) => (\r\n              <motion.div\r\n                key={i}\r\n                initial={{ opacity: 0, y: 30 }}\r\n                whileInView={{ opacity: 1, y: 0 }}\r\n                viewport={{ once: true }}\r\n                transition={{ duration: 0.6, delay: i * 0.15 }}\r\n                className=\"group relative\"\r\n              >\r\n                {/* Card */}\r\n                <div className=\"relative bg-black/60 backdrop-blur-sm border border-white/10 p-6 hover:border-white/20 transition-all duration-300 clip-path-slant-left\">\r\n\r\n                  {/* Rating */}\r\n                  <div className=\"flex gap-0.5 mb-4\">\r\n                    {[...Array(review.rating)].map((_, j) => (\r\n                      <Star key={j} className=\"w-4 h-4 fill-amber-400 text-amber-400\" />\r\n                    ))}\r\n                  </div>\r\n\r\n                  {/* Quote */}\r\n                  <blockquote className=\"text-gray-300 text-sm leading-relaxed mb-6 italic\">\r\n                    \"{review.quote}\"\r\n                  </blockquote>\r\n\r\n                  {/* User Info */}\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${review.color} flex items-center justify-center text-white font-bold text-lg`}>\r\n                      {review.avatar}\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"font-bold text-white\">{review.name}</span>\r\n                        <span className=\"text-[10px] font-mono text-cyan-400 bg-cyan-400/10 px-2 py-0.5 rounded\">{review.rank}</span>\r\n                      </div>\r\n                      <span className=\"text-xs text-gray-500\">{review.role}</span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Corner Accent */}\r\n                  <div className=\"absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white/10 group-hover:border-amber-400/50 transition-colors\" />\r\n                </div>\r\n              </motion.div>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Bottom Stats Bar */}\r\n          <div className=\"mt-16 flex flex-col md:flex-row items-center justify-center gap-8 text-center\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <Users className=\"text-cyan-400\" size={24} />\r\n              <div>\r\n                <div className=\"text-2xl font-black text-white\">50,000+</div>\r\n                <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Active Users</div>\r\n              </div>\r\n            </div>\r\n            <div className=\"w-px h-12 bg-white/10 hidden md:block\" />\r\n            <div className=\"flex items-center gap-3\">\r\n              <Star className=\"text-amber-400 fill-amber-400\" size={24} />\r\n              <div>\r\n                <div className=\"text-2xl font-black text-white\">4.9/5.0</div>\r\n                <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Average Rating</div>\r\n              </div>\r\n            </div>\r\n            <div className=\"w-px h-12 bg-white/10 hidden md:block\" />\r\n            <div className=\"flex items-center gap-3\">\r\n              <Zap className=\"text-emerald-400\" size={24} />\r\n              <div>\r\n                <div className=\"text-2xl font-black text-white\">1M+ Hours</div>\r\n                <div className=\"text-[10px] text-gray-500 uppercase tracking-widest\">Learning Time</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* NEWSLETTER - Warp Style */}\r\n      <section className=\"relative py-32 overflow-hidden flex items-center justify-center\">\r\n        {/* Background with warp tunnel effect */}\r\n        <div className=\"absolute inset-0 bg-black\">\r\n          <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-black to-black\" />\r\n          <div className=\"absolute inset-0 opacity-20\"\r\n            style={{\r\n              backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(255,255,255,0.1) 50px)'\r\n            }}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"relative z-10 max-w-4xl mx-auto px-6 text-center\">\r\n\r\n          {/* Ticket Visual */}\r\n          <div className=\"relative mx-auto w-full max-w-2xl bg-gradient-to-r from-amber-200 to-amber-500 rounded-lg p-1 shadow-[0_0_50px_rgba(251,191,36,0.3)] transform hover:scale-105 transition-transform duration-500 mb-12 cursor-pointer group\">\r\n            <div className=\"bg-black/90 h-full w-full rounded border border-amber-300/50 p-8 flex flex-col md:flex-row items-center gap-8 relative overflow-hidden\">\r\n\r\n              {/* Ticket Stub (Left) */}\r\n              <div className=\"flex-1 text-left space-y-2 relative z-10\">\r\n                <div className=\"flex items-center gap-2 text-amber-400 font-mono text-xs uppercase tracking-widest\">\r\n                  <Star size={12} fill=\"currentColor\" />\r\n                  <span>Gakuen Newsletter</span>\r\n                </div>\r\n                <h2 className=\"text-3xl md:text-4xl font-black italic text-white uppercase\">\r\n                  Join the <br /> <span className=\"text-amber-400\">Learning</span>\r\n                </h2>\r\n                <p className=\"text-gray-400 text-sm max-w-sm\">\r\n                  Get AI learning tips, new course drops, and platform updates delivered to your inbox.\r\n                </p>\r\n              </div>\r\n\r\n              {/* QR Decoration (Right) */}\r\n              <div className=\"hidden md:block w-32 h-32 border-l-2 border-dashed border-white/20 pl-8 relative\">\r\n                <div className=\"w-full h-full bg-white/5 rounded flex items-center justify-center\">\r\n                  <div className=\"text-5xl font-black text-white/10\">QR</div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Shine Effect */}\r\n              <div className=\"absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent translate-x-[-150%] group-hover:translate-x-[150%] transition-transform duration-1000 ease-in-out\" />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Input Field */}\r\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto\">\r\n            <input\r\n              type=\"email\"\r\n              placeholder=\"Enter your email...\"\r\n              className=\"flex-1 bg-white/5 border border-white/10 px-4 py-3 rounded text-sm text-white focus:outline-none focus:border-cyan-400 focus:bg-white/10 transition-all placeholder:text-gray-600\"\r\n            />\r\n            <button className=\"bg-white text-black font-bold uppercase text-xs px-8 py-3 hover:bg-cyan-400 transition-colors clip-path-slant-right\">\r\n              Subscribe\r\n            </button>\r\n          </div>\r\n\r\n          <p className=\"mt-6 text-[10px] text-gray-600 font-mono uppercase tracking-widest\">\r\n            Join 50,000+ Learners\r\n          </p>\r\n\r\n        </div>\r\n      </section>\r\n\r\n      {/* FOOTER */}\r\n      <footer className=\"border-t border-white/10 py-16 px-6\">\r\n        <div className=\"max-w-6xl mx-auto\">\r\n          <div className=\"flex flex-col md:flex-row justify-between items-center gap-8\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-xl font-bold\">Gakuen</span>\r\n              <span className=\"px-2 py-0.5 text-xs bg-cyan-500/20 text-cyan-400 rounded-full\">AI</span>\r\n            </div>\r\n            <div className=\"flex items-center gap-8 text-neutral-500 text-sm\">\r\n              <Link href=\"/privacy\" className=\"hover:text-white transition-colors\">Privacy</Link>\r\n              <Link href=\"/terms\" className=\"hover:text-white transition-colors\">Terms</Link>\r\n              <Link href=\"/contact\" className=\"hover:text-white transition-colors\">Contact</Link>\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-8 pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-4 text-neutral-600 text-sm\">\r\n            <div>Â© 2025 Gakuen. AI-powered learning.</div>\r\n            <div className=\"text-xs text-neutral-500\">All educational content is AI-generated and not protected by copyright.</div>\r\n          </div>\r\n        </div>\r\n      </footer>\r\n\r\n      {/* Custom Styles for HSR Elements */}\r\n      <style jsx global>{`\r\n        .clip-path-slant-right { clip-path: polygon(15% 0, 100% 0, 100% 100%, 0% 100%); }\r\n        .clip-path-slant-left { clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%); }\r\n        \r\n        /* GPU-accelerated marquee */\r\n        @keyframes marquee {\r\n          0% { transform: translateX(0) translateZ(0); }\r\n          100% { transform: translateX(-50%) translateZ(0); }\r\n        }\r\n        .animate-marquee {\r\n          animation: marquee 20s linear infinite;\r\n          will-change: transform;\r\n        }\r\n        \r\n        .clip-path-hexagon { \r\n          clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); \r\n        }\r\n        \r\n        /* GPU-accelerated shine */\r\n        @keyframes shine {\r\n          0% { transform: translateX(-100%) translateZ(0); }\r\n          100% { transform: translateX(200%) translateZ(0); }\r\n        }\r\n        .animate-shine {\r\n          animation: shine 3s ease-in-out infinite;\r\n          will-change: transform;\r\n        }\r\n        \r\n        /* Optimize backdrop-blur for large elements */\r\n        .backdrop-blur-xl { \r\n          -webkit-backface-visibility: hidden;\r\n          backface-visibility: hidden;\r\n        }\r\n      `}</style>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\pricing\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SubscriptionTier' is defined but never used.","line":9,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Check, Sparkles, Zap, Crown, ArrowRight, X } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { SUBSCRIPTION_TIERS, SubscriptionTier } from \"@/lib/constants/subscription\";\r\nimport { motion } from \"framer-motion\";\r\nimport Link from \"next/link\";\r\n\r\nexport default function PricingPage() {\r\n    const router = useRouter();\r\n    const [billingCycle, setBillingCycle] = useState<'monthly' | 'yearly'>('monthly');\r\n\r\n    const tiers = Object.values(SUBSCRIPTION_TIERS).filter(t => t.id !== 'free');\r\n\r\n    const getTierIcon = (tierId: string) => {\r\n        switch (tierId) {\r\n            case 'basic': return Zap;\r\n            case 'mid': return Sparkles;\r\n            case 'pro': return Crown;\r\n            default: return Zap;\r\n        }\r\n    };\r\n\r\n    const getPrice = (tier: { priceYearly: number; priceMonthly: number }) => {\r\n        return billingCycle === 'yearly' ? tier.priceYearly : tier.priceMonthly;\r\n    };\r\n\r\n    const getMonthlyEquivalent = (tier: { priceYearly: number; priceMonthly: number }) => {\r\n        if (billingCycle === 'yearly') {\r\n            return (tier.priceYearly / 12).toFixed(2);\r\n        }\r\n        return tier.priceMonthly.toFixed(2);\r\n    };\r\n\r\n    const { user } = useAuth();\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-gradient-to-b from-neutral-50 to-white dark:from-neutral-950 dark:to-neutral-900\">\r\n            {/* Header */}\r\n            <header className=\"border-b border-neutral-200 dark:border-neutral-800 bg-white/80 dark:bg-neutral-950/80 backdrop-blur-lg sticky top-0 z-50\">\r\n                <div className=\"max-w-7xl mx-auto px-6 py-4 flex items-center justify-between\">\r\n                    <Link href=\"/\" className=\"text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent\">\r\n                        Gakuen\r\n                    </Link>\r\n                    <Link href={user ? (user.role === \"admin\" ? \"/dashboard\" : \"/user\") : \"/\"}>\r\n                        <Button variant=\"outline\">\r\n                            {user ? \"Back to Dashboard\" : \"Back to Home\"}\r\n                        </Button>\r\n                    </Link>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Hero */}\r\n            <section className=\"pt-16 pb-12 px-6 text-center\">\r\n                <motion.div\r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className=\"max-w-3xl mx-auto\"\r\n                >\r\n                    <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight text-neutral-900 dark:text-white mb-4\">\r\n                        Choose Your Learning Path\r\n                    </h1>\r\n                    <p className=\"text-lg text-neutral-600 dark:text-neutral-400 mb-8\">\r\n                        Unlock unlimited potential with our flexible subscription plans\r\n                    </p>\r\n\r\n                    {/* Billing Toggle */}\r\n                    <div className=\"inline-flex items-center gap-4 bg-neutral-100 dark:bg-neutral-800 p-1.5 rounded-full\">\r\n                        <button\r\n                            onClick={() => setBillingCycle('monthly')}\r\n                            className={cn(\r\n                                \"px-6 py-2 rounded-full text-sm font-medium transition-all\",\r\n                                billingCycle === 'monthly'\r\n                                    ? \"bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white shadow-sm\"\r\n                                    : \"text-neutral-600 dark:text-neutral-400\"\r\n                            )}\r\n                        >\r\n                            Monthly\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setBillingCycle('yearly')}\r\n                            className={cn(\r\n                                \"px-6 py-2 rounded-full text-sm font-medium transition-all flex items-center gap-2\",\r\n                                billingCycle === 'yearly'\r\n                                    ? \"bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white shadow-sm\"\r\n                                    : \"text-neutral-600 dark:text-neutral-400\"\r\n                            )}\r\n                        >\r\n                            Yearly\r\n                            <span className=\"text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-2 py-0.5 rounded-full\">\r\n                                Save 17%\r\n                            </span>\r\n                        </button>\r\n                    </div>\r\n                </motion.div>\r\n            </section>\r\n\r\n            {/* Pricing Cards */}\r\n            <section className=\"px-6 pb-20\">\r\n                <div className=\"max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                    {tiers.map((tier, index) => {\r\n                        const Icon = getTierIcon(tier.id);\r\n                        const isRecommended = tier.recommended;\r\n\r\n                        return (\r\n                            <motion.div\r\n                                key={tier.id}\r\n                                initial={{ opacity: 0, y: 20 }}\r\n                                animate={{ opacity: 1, y: 0 }}\r\n                                transition={{ delay: index * 0.1 }}\r\n                                className={cn(\r\n                                    \"relative rounded-3xl overflow-hidden\",\r\n                                    isRecommended\r\n                                        ? \"bg-gradient-to-b from-blue-600 to-indigo-600 p-[2px]\"\r\n                                        : \"bg-neutral-200 dark:bg-neutral-800 p-[1px]\"\r\n                                )}\r\n                            >\r\n                                {/* Badge */}\r\n                                {tier.badge && (\r\n                                    <div className={cn(\r\n                                        \"absolute top-4 right-4 text-[10px] font-bold uppercase tracking-wider px-3 py-1 rounded-full z-10\",\r\n                                        isRecommended\r\n                                            ? \"bg-white text-indigo-600\"\r\n                                            : \"bg-neutral-900 dark:bg-white text-white dark:text-neutral-900\"\r\n                                    )}>\r\n                                        {tier.badge}\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className={cn(\r\n                                    \"h-full rounded-[22px] p-6 flex flex-col\",\r\n                                    isRecommended\r\n                                        ? \"bg-white dark:bg-neutral-900\"\r\n                                        : \"bg-white dark:bg-neutral-900\"\r\n                                )}>\r\n                                    {/* Header */}\r\n                                    <div className=\"mb-6\">\r\n                                        <div className={cn(\r\n                                            \"w-12 h-12 rounded-2xl flex items-center justify-center mb-4\",\r\n                                            tier.id === 'basic' && \"bg-blue-100 dark:bg-blue-900/30\",\r\n                                            tier.id === 'mid' && \"bg-indigo-100 dark:bg-indigo-900/30\",\r\n                                            tier.id === 'pro' && \"bg-amber-100 dark:bg-amber-900/30\"\r\n                                        )}>\r\n                                            <Icon className={cn(\r\n                                                \"w-6 h-6\",\r\n                                                tier.id === 'basic' && \"text-blue-600\",\r\n                                                tier.id === 'mid' && \"text-indigo-600\",\r\n                                                tier.id === 'pro' && \"text-amber-600\"\r\n                                            )} />\r\n                                        </div>\r\n                                        <h3 className=\"text-xl font-bold text-neutral-900 dark:text-white\">\r\n                                            {tier.name}\r\n                                        </h3>\r\n                                        <p className=\"text-sm text-neutral-500 mt-1\">\r\n                                            {tier.description}\r\n                                        </p>\r\n                                    </div>\r\n\r\n                                    {/* Price */}\r\n                                    <div className=\"mb-6\">\r\n                                        <div className=\"flex items-baseline gap-1\">\r\n                                            <span className=\"text-4xl font-bold text-neutral-900 dark:text-white\">\r\n                                                ${getMonthlyEquivalent(tier)}\r\n                                            </span>\r\n                                            <span className=\"text-neutral-500\">/mo</span>\r\n                                        </div>\r\n                                        {billingCycle === 'yearly' && (\r\n                                            <p className=\"text-sm text-neutral-500 mt-1\">\r\n                                                Billed ${getPrice(tier)} yearly\r\n                                            </p>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    {/* Features */}\r\n                                    <ul className=\"space-y-3 mb-8 flex-1\">\r\n                                        {tier.features.map((feature, i) => (\r\n                                            <li key={i} className=\"flex items-start gap-3 text-sm\">\r\n                                                <Check className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" />\r\n                                                <span className=\"text-neutral-600 dark:text-neutral-400\">{feature}</span>\r\n                                            </li>\r\n                                        ))}\r\n                                    </ul>\r\n\r\n                                    {/* CTA */}\r\n                                    <Button\r\n                                        onClick={() => router.push(`/checkout/subscribe/${tier.id}?billing=${billingCycle}`)}\r\n                                        className={cn(\r\n                                            \"w-full h-12 text-base font-semibold\",\r\n                                            isRecommended\r\n                                                ? \"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white\"\r\n                                                : \"bg-neutral-900 dark:bg-white text-white dark:text-neutral-900 hover:bg-neutral-800 dark:hover:bg-neutral-100\"\r\n                                        )}\r\n                                    >\r\n                                        Get Started\r\n                                        <ArrowRight className=\"ml-2 w-4 h-4\" />\r\n                                    </Button>\r\n                                </div>\r\n                            </motion.div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </section>\r\n\r\n            {/* Free Tier Section */}\r\n            <section className=\"px-6 pb-20\">\r\n                <div className=\"max-w-6xl mx-auto\">\r\n                    <div className=\"bg-neutral-100 dark:bg-neutral-800/50 rounded-3xl p-8 flex flex-col md:flex-row items-center justify-between gap-6\">\r\n                        <div>\r\n                            <h3 className=\"text-xl font-bold text-neutral-900 dark:text-white mb-2\">\r\n                                Just Starting Out?\r\n                            </h3>\r\n                            <p className=\"text-neutral-600 dark:text-neutral-400\">\r\n                                Try our free tier with limited AI access and course previews\r\n                            </p>\r\n                        </div>\r\n                        <Link href=\"/browse\">\r\n                            <Button variant=\"outline\" size=\"lg\">\r\n                                Browse Free Content\r\n                            </Button>\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* Comparison Table */}\r\n            <section className=\"px-6 pb-20\">\r\n                <div className=\"max-w-6xl mx-auto\">\r\n                    <h2 className=\"text-2xl font-bold text-center text-neutral-900 dark:text-white mb-8\">\r\n                        Compare Plans\r\n                    </h2>\r\n\r\n                    <div className=\"overflow-x-auto\">\r\n                        <table className=\"w-full\">\r\n                            <thead>\r\n                                <tr className=\"border-b border-neutral-200 dark:border-neutral-800\">\r\n                                    <th className=\"text-left py-4 px-4 font-medium text-neutral-500\">Features</th>\r\n                                    <th className=\"text-center py-4 px-4 font-medium text-neutral-500\">Free</th>\r\n                                    <th className=\"text-center py-4 px-4 font-medium text-neutral-500\">Basic</th>\r\n                                    <th className=\"text-center py-4 px-4 font-medium text-indigo-600\">Standard</th>\r\n                                    <th className=\"text-center py-4 px-4 font-medium text-neutral-500\">Pro</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"text-sm\">\r\n                                <tr className=\"border-b border-neutral-100 dark:border-neutral-800/50\">\r\n                                    <td className=\"py-4 px-4 text-neutral-600 dark:text-neutral-400\">Course Access</td>\r\n                                    <td className=\"py-4 px-4 text-center\">Preview only</td>\r\n                                    <td className=\"py-4 px-4 text-center\">30%</td>\r\n                                    <td className=\"py-4 px-4 text-center font-medium text-indigo-600\">50%</td>\r\n                                    <td className=\"py-4 px-4 text-center font-medium\">100%</td>\r\n                                </tr>\r\n                                <tr className=\"border-b border-neutral-100 dark:border-neutral-800/50\">\r\n                                    <td className=\"py-4 px-4 text-neutral-600 dark:text-neutral-400\">AI Model</td>\r\n                                    <td className=\"py-4 px-4 text-center\">Flash Lite</td>\r\n                                    <td className=\"py-4 px-4 text-center\">Flash</td>\r\n                                    <td className=\"py-4 px-4 text-center font-medium text-indigo-600\">Pro + Flash</td>\r\n                                    <td className=\"py-4 px-4 text-center font-medium\">Pro + Flash</td>\r\n                                </tr>\r\n                                <tr className=\"border-b border-neutral-100 dark:border-neutral-800/50\">\r\n                                    <td className=\"py-4 px-4 text-neutral-600 dark:text-neutral-400\">AI Requests/Day</td>\r\n                                    <td className=\"py-4 px-4 text-center\">20</td>\r\n                                    <td className=\"py-4 px-4 text-center\">60</td>\r\n                                    <td className=\"py-4 px-4 text-center font-medium text-indigo-600\">30 Pro + âˆž Flash</td>\r\n                                    <td className=\"py-4 px-4 text-center font-medium\">120 Pro + âˆž Flash</td>\r\n                                </tr>\r\n                                <tr className=\"border-b border-neutral-100 dark:border-neutral-800/50\">\r\n                                    <td className=\"py-4 px-4 text-neutral-600 dark:text-neutral-400\">Certificates</td>\r\n                                    <td className=\"py-4 px-4 text-center\"><X className=\"w-5 h-5 mx-auto text-neutral-300\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><Check className=\"w-5 h-5 mx-auto text-green-500\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><Check className=\"w-5 h-5 mx-auto text-green-500\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><Check className=\"w-5 h-5 mx-auto text-green-500\" /></td>\r\n                                </tr>\r\n                                <tr className=\"border-b border-neutral-100 dark:border-neutral-800/50\">\r\n                                    <td className=\"py-4 px-4 text-neutral-600 dark:text-neutral-400\">Priority Support</td>\r\n                                    <td className=\"py-4 px-4 text-center\"><X className=\"w-5 h-5 mx-auto text-neutral-300\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><X className=\"w-5 h-5 mx-auto text-neutral-300\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><Check className=\"w-5 h-5 mx-auto text-green-500\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><Check className=\"w-5 h-5 mx-auto text-green-500\" /></td>\r\n                                </tr>\r\n                                <tr className=\"border-b border-neutral-100 dark:border-neutral-800/50\">\r\n                                    <td className=\"py-4 px-4 text-neutral-600 dark:text-neutral-400\">1-on-1 Mentoring</td>\r\n                                    <td className=\"py-4 px-4 text-center\"><X className=\"w-5 h-5 mx-auto text-neutral-300\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><X className=\"w-5 h-5 mx-auto text-neutral-300\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><X className=\"w-5 h-5 mx-auto text-neutral-300\" /></td>\r\n                                    <td className=\"py-4 px-4 text-center\"><Check className=\"w-5 h-5 mx-auto text-green-500\" /></td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* FAQ or Footer */}\r\n            <footer className=\"border-t border-neutral-200 dark:border-neutral-800 py-8 px-6\">\r\n                <div className=\"max-w-6xl mx-auto text-center text-sm text-neutral-500\">\r\n                    <p>Questions? Contact us at support@gakuen.edu</p>\r\n                </div>\r\n            </footer>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\app\\terms\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Mail' is defined but never used.","line":4,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { ArrowLeft, FileText, Mail, Shield } from \"lucide-react\";\r\n\r\nexport default function TermsPage() {\r\n    return (\r\n        <div className=\"min-h-screen bg-neutral-50 dark:bg-neutral-950\">\r\n            {/* Header */}\r\n            <header className=\"sticky top-0 z-10 bg-neutral-50/80 dark:bg-neutral-950/80 backdrop-blur-md border-b border-neutral-200 dark:border-white/10\">\r\n                <div className=\"max-w-4xl mx-auto px-6 py-4 flex items-center gap-4\">\r\n                    <Link\r\n                        href=\"/\"\r\n                        className=\"flex items-center gap-2 text-sm text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors\"\r\n                    >\r\n                        <ArrowLeft className=\"w-4 h-4\" />\r\n                        Back to Home\r\n                    </Link>\r\n                </div>\r\n            </header>\r\n\r\n            <main className=\"max-w-4xl mx-auto px-6 py-16\">\r\n                <div className=\"flex items-center gap-4 mb-8\">\r\n                    <div className=\"w-14 h-14 rounded-2xl bg-blue-100 dark:bg-blue-500/20 flex items-center justify-center\">\r\n                        <FileText className=\"w-7 h-7 text-blue-600 dark:text-blue-400\" />\r\n                    </div>\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold text-neutral-900 dark:text-white\">Terms of Service</h1>\r\n                        <p className=\"text-neutral-500 dark:text-neutral-400\">Last updated: January 2025</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"prose prose-neutral dark:prose-invert max-w-none space-y-8\">\r\n                    <div className=\"p-6 bg-amber-50 dark:bg-amber-500/10 border border-amber-200 dark:border-amber-500/20 rounded-xl\">\r\n                        <div className=\"flex items-start gap-3\">\r\n                            <Shield className=\"w-5 h-5 text-amber-600 dark:text-amber-400 mt-0.5\" />\r\n                            <div>\r\n                                <h3 className=\"font-bold text-amber-800 dark:text-amber-300 m-0 mb-2\">Important Notice About AI-Generated Content</h3>\r\n                                <p className=\"text-amber-700 dark:text-amber-400 text-sm m-0\">\r\n                                    All educational content on Gakuen is generated by artificial intelligence. AI-generated content is not protected by copyright.\r\n                                    If you believe any content resembles your copyrighted work, please <Link href=\"/contact\" className=\"underline font-medium\">contact us</Link> immediately\r\n                                    and we will review and remove it if necessary.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">1. Acceptance of Terms</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            By accessing or using Gakuen (&quot;the Service&quot;), you agree to be bound by these Terms of Service.\r\n                            If you do not agree to these terms, you may not access or use the Service. These terms constitute\r\n                            a legally binding agreement between you and Gakuen.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">2. Description of Service</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            Gakuen provides an AI-powered educational platform including but not limited to: AI tutoring services,\r\n                            course materials, progress tracking, and personalized learning experiences. The Service is provided\r\n                            &quot;as is&quot; and we reserve the right to modify, suspend, or discontinue any part of the Service at any time.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">3. AI-Generated Content</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            <strong>All content on this platform is generated by artificial intelligence.</strong> This includes but is not limited to:\r\n                        </p>\r\n                        <ul className=\"text-neutral-600 dark:text-neutral-300 list-disc pl-6 space-y-2\">\r\n                            <li>Course materials and lessons</li>\r\n                            <li>Explanations and tutoring responses</li>\r\n                            <li>Practice problems and assessments</li>\r\n                            <li>Recommendations and suggestions</li>\r\n                        </ul>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            AI-generated content may contain errors or inaccuracies. You should verify important information\r\n                            from authoritative sources. We are not liable for decisions made based on AI-generated content.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">4. Copyright & Intellectual Property</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            Under current law, AI-generated content is generally not eligible for copyright protection.\r\n                            The AI-generated educational materials provided through this Service are offered for your personal\r\n                            educational use. If you believe any content on our platform infringes your copyright or intellectual\r\n                            property rights, please contact us immediately at <Link href=\"/contact\" className=\"text-blue-600 dark:text-blue-400 hover:underline\">our contact page</Link>.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">5. User Accounts</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            You are responsible for maintaining the confidentiality of your account credentials and for all\r\n                            activities that occur under your account. You must provide accurate, current, and complete\r\n                            information during registration. You may not share your account with others or allow unauthorized access.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">6. Privacy & Data Collection</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            We collect and process personal data as described in our <Link href=\"/privacy\" className=\"text-blue-600 dark:text-blue-400 hover:underline\">Privacy Policy</Link>.\r\n                            By using the Service, you consent to:\r\n                        </p>\r\n                        <ul className=\"text-neutral-600 dark:text-neutral-300 list-disc pl-6 space-y-2\">\r\n                            <li>Collection of usage data, learning progress, and interaction patterns</li>\r\n                            <li>Processing of data by AI systems for personalization</li>\r\n                            <li>Storage of data on secure cloud servers</li>\r\n                            <li>Use of anonymized data for service improvement</li>\r\n                        </ul>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">7. Payment & Refunds</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            Paid features are billed in advance on a subscription basis. Refunds are provided in accordance\r\n                            with applicable law. We reserve the right to change pricing with 30 days notice. Continued use\r\n                            after price changes constitutes acceptance.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">8. Limitation of Liability</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300 uppercase text-sm\">\r\n                            TO THE MAXIMUM EXTENT PERMITTED BY LAW, GAKUEN SHALL NOT BE LIABLE FOR ANY INDIRECT, INCIDENTAL,\r\n                            SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, INCLUDING BUT NOT LIMITED TO LOSS OF PROFITS, DATA,\r\n                            OR GOODWILL. OUR TOTAL LIABILITY SHALL NOT EXCEED THE AMOUNT PAID BY YOU IN THE PAST 12 MONTHS.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">9. Indemnification</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            You agree to indemnify and hold harmless Gakuen and its officers, directors, employees, and agents\r\n                            from any claims, damages, losses, or expenses arising from your use of the Service or violation of these Terms.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">10. Governing Law</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            These Terms shall be governed by and construed in accordance with the laws of the jurisdiction\r\n                            in which Gakuen operates, without regard to conflict of law principles. Any disputes shall be\r\n                            resolved through binding arbitration.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">11. Changes to Terms</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            We reserve the right to modify these Terms at any time. We will notify users of material changes\r\n                            via email or through the Service. Continued use after changes constitute acceptance of the new Terms.\r\n                        </p>\r\n                    </section>\r\n\r\n                    <section>\r\n                        <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">12. Contact</h2>\r\n                        <p className=\"text-neutral-600 dark:text-neutral-300\">\r\n                            For questions about these Terms, please visit our <Link href=\"/contact\" className=\"text-blue-600 dark:text-blue-400 hover:underline\">Contact Page</Link> or\r\n                            email us at <a href=\"mailto:legal@gakuen.edu\" className=\"text-blue-600 dark:text-blue-400 hover:underline\">legal@gakuen.edu</a>.\r\n                        </p>\r\n                    </section>\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\CookieConsent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\GlobalErrorHandler.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\admin\\CourseEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1169,1172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1169,1172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6491,6494],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6491,6494],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":212,"column":59,"nodeType":null,"messageId":"unusedVar","endLine":212,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Course, Lesson } from \"@/lib/types\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { X, Plus, Trash2, GripVertical, Edit2 } from \"lucide-react\";\r\nimport { useState, useEffect } from \"react\";\r\n\r\ninterface CourseEditorProps {\r\n    course: Course | null;\r\n    onClose: () => void;\r\n    onSave: (course: Course) => void;\r\n}\r\n\r\nexport function CourseEditor({ course, onClose, onSave }: CourseEditorProps) {\r\n    const [formData, setFormData] = useState<Partial<Course>>({});\r\n    const [currentTab, setCurrentTab] = useState<\"details\" | \"content\">(\"details\");\r\n    const [editingLesson, setEditingLesson] = useState<Lesson | null>(null);\r\n    const [lessons, setLessons] = useState<Lesson[]>([]);\r\n\r\n    useEffect(() => {\r\n        if (course) {\r\n            setFormData(course);\r\n            setLessons(course.lessons || []);\r\n        }\r\n    }, [course]);\r\n\r\n    if (!course) return null;\r\n\r\n    const handleSubmit = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        const updatedCourse = { ...formData, lessons } as Course;\r\n        onSave(updatedCourse);\r\n    };\r\n\r\n    const handleChange = (field: keyof Course, value: any) => {\r\n        setFormData(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    const handleAddLesson = () => {\r\n        const newLesson: Lesson = {\r\n            id: `lesson-${Date.now()}`,\r\n            title: \"New Lesson\",\r\n            type: \"article\",\r\n            duration: \"10 min\",\r\n            content: \"Lesson content goes here...\",\r\n            order: lessons.length + 1,\r\n        };\r\n        setLessons([...lessons, newLesson]);\r\n        setEditingLesson(newLesson);\r\n    };\r\n\r\n    const handleUpdateLesson = (updatedLesson: Lesson) => {\r\n        setLessons(lessons.map(l => l.id === updatedLesson.id ? updatedLesson : l));\r\n        setEditingLesson(null);\r\n    };\r\n\r\n    const handleDeleteLesson = (lessonId: string) => {\r\n        if (confirm(\"Delete this lesson?\")) {\r\n            setLessons(lessons.filter(l => l.id !== lessonId));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-neutral-900 border border-white/10 rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-in fade-in zoom-in-95 duration-300\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-6 border-b border-white/10\">\r\n                    <div>\r\n                        <h2 className=\"text-xl font-bold text-white\">Course Editor</h2>\r\n                        <p className=\"text-sm text-neutral-400 mt-1\">Edit course details and content</p>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"p-2 rounded-lg hover:bg-white/10 text-neutral-400 hover:text-white transition-colors\"\r\n                    >\r\n                        <X className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Tabs */}\r\n                <div className=\"flex gap-4 px-6 pt-4 border-b border-white/10\">\r\n                    <button\r\n                        onClick={() => setCurrentTab(\"details\")}\r\n                        className={`pb-3 px-1 text-sm font-medium transition-all ${currentTab === \"details\"\r\n                            ? \"text-white border-b-2 border-blue-500\"\r\n                            : \"text-neutral-400 hover:text-white\"\r\n                            }`}\r\n                    >\r\n                        Course Details\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setCurrentTab(\"content\")}\r\n                        className={`pb-3 px-1 text-sm font-medium transition-all ${currentTab === \"content\"\r\n                            ? \"text-white border-b-2 border-blue-500\"\r\n                            : \"text-neutral-400 hover:text-white\"\r\n                            }`}\r\n                    >\r\n                        Lessons & Content ({lessons.length})\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"flex-1 overflow-y-auto p-6\">\r\n                    {currentTab === \"details\" ? (\r\n                        <form className=\"space-y-6\">\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                                <div className=\"md:col-span-2\">\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Title</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={formData.title || \"\"}\r\n                                        onChange={(e) => handleChange(\"title\", e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Category</label>\r\n                                    <select\r\n                                        value={formData.category || \"\"}\r\n                                        onChange={(e) => handleChange(\"category\", e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    >\r\n                                        <option value=\"Computer Science\">Computer Science</option>\r\n                                        <option value=\"Web Development\">Web Development</option>\r\n                                        <option value=\"Data Science\">Data Science</option>\r\n                                    </select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Level</label>\r\n                                    <select\r\n                                        value={formData.level || \"\"}\r\n                                        onChange={(e) => handleChange(\"level\", e.target.value as any)}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    >\r\n                                        <option value=\"Beginner\">Beginner</option>\r\n                                        <option value=\"Intermediate\">Intermediate</option>\r\n                                        <option value=\"Advanced\">Advanced</option>\r\n                                    </select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Instructor</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={formData.instructor || \"\"}\r\n                                        onChange={(e) => handleChange(\"instructor\", e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Duration</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={formData.duration || \"\"}\r\n                                        onChange={(e) => handleChange(\"duration\", e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Rating</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        step=\"0.1\"\r\n                                        min=\"0\"\r\n                                        max=\"5\"\r\n                                        value={formData.rating || 0}\r\n                                        onChange={(e) => handleChange(\"rating\", parseFloat(e.target.value))}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div className=\"md:col-span-2\">\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Thumbnail URL</label>\r\n                                    <input\r\n                                        type=\"url\"\r\n                                        value={formData.thumbnail || \"\"}\r\n                                        onChange={(e) => handleChange(\"thumbnail\", e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div className=\"md:col-span-2\">\r\n                                    <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Description</label>\r\n                                    <textarea\r\n                                        value={formData.description || \"\"}\r\n                                        onChange={(e) => handleChange(\"description\", e.target.value)}\r\n                                        rows={3}\r\n                                        className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </form>\r\n                    ) : (\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"flex items-center justify-between\">\r\n                                <p className=\"text-sm text-neutral-400\">Manage course lessons and content</p>\r\n                                <Button\r\n                                    onClick={handleAddLesson}\r\n                                    className=\"bg-blue-600 hover:bg-700 text-white\"\r\n                                >\r\n                                    <Plus className=\"w-4 h-4 mr-2\" />\r\n                                    Add Lesson\r\n                                </Button>\r\n                            </div>\r\n\r\n                            {lessons.length > 0 ? (\r\n                                <div className=\"space-y-2\">\r\n                                    {lessons.map((lesson, index) => (\r\n                                        <div\r\n                                            key={lesson.id}\r\n                                            className=\"p-4 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-all group\"\r\n                                        >\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                <GripVertical className=\"w-4 h-4 text-neutral-600 cursor-move\" />\r\n                                                <div className=\"flex-1\">\r\n                                                    <p className=\"text-white font-medium\">{lesson.title}</p>\r\n                                                    <p className=\"text-xs text-neutral-400 mt-0.5\">\r\n                                                        {lesson.type} â€¢ {lesson.duration}\r\n                                                    </p>\r\n                                                </div>\r\n                                                <div className=\"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                                    <button\r\n                                                        onClick={() => setEditingLesson(lesson)}\r\n                                                        className=\"p-2 rounded hover:bg-white/10 text-neutral-400 hover:text-white\"\r\n                                                    >\r\n                                                        <Edit2 className=\"w-4 h-4\" />\r\n                                                    </button>\r\n                                                    <button\r\n                                                        onClick={() => handleDeleteLesson(lesson.id)}\r\n                                                        className=\"p-2 rounded hover:bg-white/10 text-red-400 hover:text-red-300\"\r\n                                                    >\r\n                                                        <Trash2 className=\"w-4 h-4\" />\r\n                                                    </button>\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"py-16 text-center\">\r\n                                    <p className=\"text-neutral-400 mb-4\">No lessons yet</p>\r\n                                    <Button onClick={handleAddLesson} variant=\"outline\">\r\n                                        <Plus className=\"w-4 h-4 mr-2\" />\r\n                                        Add First Lesson\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"flex items-center justify-end gap-3 p-6 border-t border-white/10\">\r\n                    <Button variant=\"ghost\" onClick={onClose} className=\"text-neutral-400 hover:text-white\">\r\n                        Cancel\r\n                    </Button>\r\n                    <Button onClick={handleSubmit} className=\"bg-blue-600 hover:bg-blue-700 text-white\">\r\n                        Save Course\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Lesson Editor Modal */}\r\n            {editingLesson && (\r\n                <LessonEditor\r\n                    lesson={editingLesson}\r\n                    onClose={() => setEditingLesson(null)}\r\n                    onSave={handleUpdateLesson}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n// Lesson Editor Component\r\ninterface LessonEditorProps {\r\n    lesson: Lesson;\r\n    onClose: () => void;\r\n    onSave: (lesson: Lesson) => void;\r\n}\r\n\r\nfunction LessonEditor({ lesson, onClose, onSave }: LessonEditorProps) {\r\n    const [formData, setFormData] = useState<Lesson>(lesson);\r\n\r\n    const handleSubmit = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        onSave(formData);\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[60] p-4\">\r\n            <div className=\"bg-neutral-900 border border-white/10 rounded-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col\">\r\n                <div className=\"flex items-center justify-between p-6 border-b border-white/10\">\r\n                    <h3 className=\"text-lg font-bold text-white\">Edit Lesson</h3>\r\n                    <button onClick={onClose} className=\"p-2 rounded-lg hover:bg-white/10 text-neutral-400 hover:text-white\">\r\n                        <X className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"flex-1 overflow-y-auto p-6 space-y-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Title</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={formData.title}\r\n                            onChange={(e) => setFormData({ ...formData, title: e.target.value })}\r\n                            className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Type</label>\r\n                            <select\r\n                                value={formData.type}\r\n                                onChange={(e) => setFormData({ ...formData, type: e.target.value as \"article\" | \"image\" })}\r\n                                className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                            >\r\n                                <option value=\"article\">Article</option>\r\n                                <option value=\"image\">Image</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Duration</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={formData.duration}\r\n                                onChange={(e) => setFormData({ ...formData, duration: e.target.value })}\r\n                                placeholder=\"e.g., 10 min\"\r\n                                className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {formData.type === \"image\" && (\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Image URL</label>\r\n                            <input\r\n                                type=\"url\"\r\n                                value={formData.imageUrl || \"\"}\r\n                                onChange={(e) => setFormData({ ...formData, imageUrl: e.target.value })}\r\n                                className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    <div>\r\n                        <label className=\"block text-sm font-medium text-neutral-300 mb-2\">Content</label>\r\n                        <textarea\r\n                            value={formData.content}\r\n                            onChange={(e) => setFormData({ ...formData, content: e.target.value })}\r\n                            rows={12}\r\n                            className=\"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none font-mono text-sm\"\r\n                            placeholder={formData.type === \"article\" ? \"Write your lesson content here (supports HTML)...\" : \"Image description or caption...\"}\r\n                        />\r\n                    </div>\r\n                </form>\r\n\r\n                <div className=\"flex items-center justify-end gap-3 p-6 border-t border-white/10\">\r\n                    <Button variant=\"ghost\" onClick={onClose} className=\"text-neutral-400 hover:text-white\">\r\n                        Cancel\r\n                    </Button>\r\n                    <Button onClick={handleSubmit} className=\"bg-blue-600 hover:bg-blue-700 text-white\">\r\n                        Save Lesson\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ai\\AICourseSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cn' is defined but never used.","line":8,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\nimport { useState } from \"react\";\r\nimport { Course } from \"@/lib/types\";\r\nimport { Sparkles, ArrowRight, Loader2 } from \"lucide-react\";\r\nimport { CourseCard } from \"@/components/course/CourseCard\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\n\r\ninterface AICourseSelectorProps {\r\n    courses: Course[];\r\n}\r\n\r\nexport function AICourseSelector({ courses }: AICourseSelectorProps) {\r\n    const [query, setQuery] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [recommendation, setRecommendation] = useState<{ courseId: string; reason: string } | null>(null);\r\n    const { t } = useTranslation();\r\n\r\n    const handleAskAI = async () => {\r\n        if (!query.trim()) return;\r\n\r\n        setIsLoading(true);\r\n        try {\r\n            const res = await authenticatedFetch('/api/ai/recommend', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ query, courses }),\r\n            });\r\n            const data = await res.json();\r\n            setRecommendation(data);\r\n        } catch {\r\n            // Silent fail - recommendation is optional\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const recommendedCourse = recommendation\r\n        ? courses.find(c => c.id === recommendation.courseId)\r\n        : null;\r\n\r\n    return (\r\n        <div className=\"relative overflow-hidden rounded-2xl border border-neutral-200 dark:border-white/10 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-black/40 dark:to-black/40 backdrop-blur-xl p-6 md:p-8 mb-8 transition-all duration-500\">\r\n            {/* Ambient Background Glow */}\r\n            <div className=\"absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl pointer-events-none\" />\r\n\r\n            <div className=\"relative z-10 flex flex-col md:flex-row gap-8 items-start\">\r\n                {/* Input Section */}\r\n                <div className=\"flex-1 w-full\">\r\n                    <div className=\"flex items-center gap-2 mb-4\">\r\n                        <div className=\"p-1.5 bg-blue-500/20 rounded-lg\">\r\n                            <Sparkles className=\"w-5 h-5 text-blue-400\" />\r\n                        </div>\r\n                        <h3 className=\"text-xl font-bold text-neutral-900 dark:text-white\">{t.ai.notSureTitle}</h3>\r\n                    </div>\r\n\r\n                    <p className=\"text-neutral-600 dark:text-zinc-400 mb-6\">\r\n                        {t.ai.notSureDesc}\r\n                    </p>\r\n\r\n                    <div className=\"flex flex-col sm:flex-row gap-2\">\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder={t.ai.inputPlaceholder}\r\n                            value={query}\r\n                            onChange={(e) => setQuery(e.target.value)}\r\n                            onKeyDown={(e) => e.key === 'Enter' && handleAskAI()}\r\n                            className=\"flex-1 bg-white dark:bg-white/5 border border-neutral-200 dark:border-white/10 rounded-xl py-3 px-4 text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-zinc-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all\"\r\n                        />\r\n                        <button\r\n                            onClick={handleAskAI}\r\n                            disabled={isLoading || !query.trim()}\r\n                            className=\"px-4 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-neutral-200 dark:disabled:bg-zinc-800 disabled:text-neutral-400 dark:disabled:text-zinc-500 text-white rounded-xl text-sm font-semibold transition-colors flex items-center justify-center gap-2 whitespace-nowrap\"\r\n                        >\r\n                            {isLoading ? (\r\n                                <>\r\n                                    <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                                    <span className=\"hidden sm:inline\">{t.ai.thinking}</span>\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    {t.ai.askAi}\r\n                                    <ArrowRight className=\"w-4 h-4\" />\r\n                                </>\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n\r\n                    {recommendation && (\r\n                        <div className=\"mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 animate-in fade-in slide-in-from-top-2\">\r\n                            <p className=\"text-blue-200 text-sm\">\r\n                                <span className=\"font-bold text-blue-400\">{t.ai.aiSays}:</span> \" {recommendation.reason} \"\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Result Section - Only shows when result exists */}\r\n                {recommendedCourse && (\r\n                    <div className=\"w-full md:w-80 flex-shrink-0 animate-in fade-in slide-in-from-right-4 duration-700\">\r\n                        <div className=\"relative\">\r\n                            <div className=\"absolute -inset-1 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl blur opacity-30\"></div>\r\n                            <CourseCard course={recommendedCourse} index={0} />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ai\\CourseChatBot.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2544,2547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2544,2547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":67,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":67,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { MessageCircle, X, Send, Maximize2, Minimize2, Sparkles, Bot } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\n\r\ninterface Message {\r\n    role: 'user' | 'assistant';\r\n    content: string;\r\n    modelUsed?: string;\r\n}\r\n\r\n// Modern iMessage-style bubble\r\nfunction MessageBubble({ msg }: { msg: Message }) {\r\n    const [expanded, setExpanded] = useState(false);\r\n    const isLong = msg.role === 'assistant' && msg.content.length > 400;\r\n    const displayContent = isLong && !expanded\r\n        ? msg.content.slice(0, 400) + '...'\r\n        : msg.content;\r\n\r\n    return (\r\n        <div className={cn(\"flex\", msg.role === 'user' ? \"justify-end\" : \"justify-start\")}>\r\n            <div className={cn(\r\n                \"max-w-[85%] px-4 py-3\",\r\n                msg.role === 'user'\r\n                    ? \"bg-blue-500 text-white rounded-[20px] rounded-br-[4px]\"\r\n                    : \"bg-zinc-800/80 text-zinc-100 rounded-[20px] rounded-bl-[4px] border border-zinc-700/50\"\r\n            )}>\r\n                <div className=\"text-[15px] leading-[1.6] [&>p]:mb-3 [&>p:last-child]:mb-0 [&>ul]:mb-3 [&>ol]:mb-3 [&>li]:mb-1.5\">\r\n                    <ReactMarkdown>{displayContent}</ReactMarkdown>\r\n                </div>\r\n                {isLong && (\r\n                    <button\r\n                        onClick={() => setExpanded(!expanded)}\r\n                        className={cn(\r\n                            \"text-sm mt-2 hover:underline font-medium\",\r\n                            msg.role === 'user' ? \"text-blue-200\" : \"text-blue-400\"\r\n                        )}\r\n                    >\r\n                        {expanded ? 'Show less' : 'Show more'}\r\n                    </button>\r\n                )}\r\n                {msg.modelUsed && (\r\n                    <div className={cn(\r\n                        \"mt-2 text-[11px] flex items-center gap-1.5\",\r\n                        msg.role === 'user' ? \"text-blue-200/70\" : \"text-zinc-500\"\r\n                    )}>\r\n                        <Sparkles className=\"w-3 h-3\" />\r\n                        {msg.modelUsed.includes('flash') ? 'Flash' : 'Pro'}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\ninterface CourseChatBotProps {\r\n    course: any;\r\n    onToggleSidebar: (isOpen: boolean) => void;\r\n}\r\n\r\nexport function CourseChatBot({ course, onToggleSidebar }: CourseChatBotProps) {\r\n    const { user } = useAuth();\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [isSidebarMode, setIsSidebarMode] = useState(false);\r\n    const [messages, setMessages] = useState<Message[]>([\r\n        { role: 'assistant', content: `Hi! I'm your AI tutor for **${course.title}**. Ask me anything about the lessons!` }\r\n    ]);\r\n    const [input, setInput] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [isDeepMode, setIsDeepMode] = useState(false);\r\n\r\n    const scrollRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Auto-scroll to bottom\r\n    useEffect(() => {\r\n        if (scrollRef.current) {\r\n            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\r\n        }\r\n    }, [messages, isOpen]);\r\n\r\n    const handleSend = async () => {\r\n        if (!input.trim() || isLoading) return;\r\n\r\n        const userMsg = { role: 'user' as const, content: input };\r\n        setMessages(prev => [...prev, userMsg]);\r\n        setInput(\"\");\r\n        setIsLoading(true);\r\n\r\n        try {\r\n            const res = await authenticatedFetch('/api/ai/chat', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    messages: [...messages, userMsg],\r\n                    course: { ...course },\r\n                    mode: isDeepMode ? 'deep' : 'auto'\r\n                }),\r\n            });\r\n\r\n            const data = await res.json();\r\n\r\n            if (data.error) throw new Error(data.error);\r\n\r\n            setMessages(prev => [...prev, {\r\n                role: 'assistant',\r\n                content: data.content,\r\n                modelUsed: data.modelUsed\r\n            }]);\r\n        } catch {\r\n            setMessages(prev => [...prev, { role: 'assistant', content: \"Sorry, I encountered an error. Please try again.\" }]);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const toggleSidebar = () => {\r\n        const newState = !isSidebarMode;\r\n        setIsSidebarMode(newState);\r\n        onToggleSidebar(newState);\r\n    };\r\n\r\n    return (\r\n        <>\r\n            {/* FAB Trigger */}\r\n            <AnimatePresence>\r\n                {!isOpen && (\r\n                    <motion.button\r\n                        initial={{ scale: 0, opacity: 0 }}\r\n                        animate={{ scale: 1, opacity: 1 }}\r\n                        exit={{ scale: 0, opacity: 0 }}\r\n                        onClick={() => setIsOpen(true)}\r\n                        className=\"fixed bottom-6 right-6 z-50 p-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 transition-all hover:scale-105 group\"\r\n                    >\r\n                        <MessageCircle className=\"w-6 h-6 text-white\" />\r\n                        <span className=\"absolute right-full mr-3 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-zinc-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-zinc-700\">\r\n                            Ask AI Tutor\r\n                        </span>\r\n                    </motion.button>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Chat Window */}\r\n            <AnimatePresence>\r\n                {isOpen && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, y: 20, scale: 0.95 }}\r\n                        animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                        exit={{ opacity: 0, y: 20, scale: 0.95 }}\r\n                        transition={{ duration: 0.2 }}\r\n                        className={cn(\r\n                            \"fixed z-50 bg-zinc-950 border border-zinc-800 shadow-2xl shadow-black/50 flex flex-col overflow-hidden\",\r\n                            // Mobile: full screen\r\n                            \"inset-4 rounded-2xl\",\r\n                            // Tablet and up: fixed size bottom right\r\n                            \"sm:inset-auto sm:bottom-4 sm:right-4 sm:w-[380px] sm:h-[500px] sm:rounded-2xl\",\r\n                            // Desktop sidebar mode\r\n                            isSidebarMode && \"lg:inset-y-0 lg:right-0 lg:left-auto lg:w-[420px] lg:h-full lg:rounded-none lg:border-l\"\r\n                        )}\r\n                    >\r\n                        {/* Header */}\r\n                        <div className=\"px-4 py-3 border-b border-zinc-800 bg-zinc-900/80 backdrop-blur-xl flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center\">\r\n                                    <Bot className=\"w-5 h-5 text-white\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h3 className=\"font-semibold text-white text-[15px]\">AI Tutor</h3>\r\n                                    <p className=\"text-[12px] text-zinc-500\">Powered by Gemini</p>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-0.5\">\r\n                                <button\r\n                                    onClick={() => setIsDeepMode(!isDeepMode)}\r\n                                    className={cn(\r\n                                        \"p-2.5 rounded-full transition-all\",\r\n                                        isDeepMode\r\n                                            ? \"bg-indigo-500/20 text-indigo-400\"\r\n                                            : \"hover:bg-zinc-800 text-zinc-500 hover:text-zinc-300\"\r\n                                    )}\r\n                                    title=\"Deep Explain Mode\"\r\n                                >\r\n                                    <Sparkles className=\"w-4 h-4\" />\r\n                                </button>\r\n                                <button\r\n                                    onClick={toggleSidebar}\r\n                                    className=\"p-2.5 hover:bg-zinc-800 rounded-full text-zinc-500 hover:text-zinc-300 transition-all\"\r\n                                >\r\n                                    {isSidebarMode ? <Minimize2 className=\"w-4 h-4\" /> : <Maximize2 className=\"w-4 h-4\" />}\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => { setIsOpen(false); if (isSidebarMode) toggleSidebar(); }}\r\n                                    className=\"p-2.5 hover:bg-red-500/20 rounded-full text-zinc-500 hover:text-red-400 transition-all\"\r\n                                >\r\n                                    <X className=\"w-4 h-4\" />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Messages */}\r\n                        <div ref={scrollRef} className=\"flex-1 overflow-y-auto p-4 space-y-3 bg-zinc-950\">\r\n                            {messages.map((msg, idx) => (\r\n                                <MessageBubble key={idx} msg={msg} />\r\n                            ))}\r\n                            {isLoading && (\r\n                                <div className=\"flex justify-start\">\r\n                                    <div className=\"bg-zinc-800/80 border border-zinc-700/50 rounded-[20px] rounded-bl-[4px] px-4 py-3 flex items-center gap-2\">\r\n                                        <span className=\"w-2 h-2 bg-zinc-500 rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\r\n                                        <span className=\"w-2 h-2 bg-zinc-500 rounded-full animate-bounce\" style={{ animationDelay: '150ms' }} />\r\n                                        <span className=\"w-2 h-2 bg-zinc-500 rounded-full animate-bounce\" style={{ animationDelay: '300ms' }} />\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Input */}\r\n                        <div className=\"p-3 bg-zinc-900 border-t border-zinc-800\">\r\n                            <div className=\"flex items-center gap-2 bg-zinc-800 rounded-full px-4 py-2\">\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={input}\r\n                                    onChange={(e) => setInput(e.target.value)}\r\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}\r\n                                    placeholder={isDeepMode ? \"Ask for detailed explanation...\" : \"Ask a question...\"}\r\n                                    className=\"flex-1 bg-transparent text-[15px] text-white placeholder:text-zinc-500 focus:outline-none\"\r\n                                />\r\n                                <button\r\n                                    onClick={handleSend}\r\n                                    disabled={!input.trim() || isLoading}\r\n                                    className=\"p-2 bg-blue-500 hover:bg-blue-400 disabled:bg-zinc-700 disabled:text-zinc-500 rounded-full text-white transition-colors\"\r\n                                >\r\n                                    <Send className=\"w-4 h-4\" />\r\n                                </button>\r\n                            </div>\r\n                            <div className=\"mt-2 flex items-center justify-center text-[11px] text-zinc-600\">\r\n                                <span>{isDeepMode ? \"Pro Mode\" : \"Flash Mode\"} Â· RAG Enabled</span>\r\n                            </div>\r\n                        </div>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\AppleParallax.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\AppleScaleSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cardHeight' is assigned a value but never used.","line":113,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":113,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { motion, useScroll, useTransform, useReducedMotion } from \"framer-motion\";\r\nimport { ReactNode, useRef } from \"react\";\r\n\r\ninterface AppleScaleSectionProps {\r\n    children: ReactNode;\r\n    /** Initial scale (default: 1) */\r\n    initialScale?: number;\r\n    /** Final scale when scrolled past (default: 0.85) */\r\n    finalScale?: number;\r\n    /** Initial border radius (default: 0) */\r\n    initialRadius?: number;\r\n    /** Final border radius (default: 40) */\r\n    finalRadius?: number;\r\n    /** Height of the scrollable area */\r\n    height?: string;\r\n    /** CSS class for the wrapper */\r\n    className?: string;\r\n    /** CSS class for the content */\r\n    contentClassName?: string;\r\n}\r\n\r\n/**\r\n * Apple-style sticky scale section\r\n * Content stays sticky and scales down as user scrolls past\r\n * Similar to Apple's product page transitions\r\n */\r\nexport function AppleScaleSection({\r\n    children,\r\n    initialScale = 1,\r\n    finalScale = 0.85,\r\n    initialRadius = 0,\r\n    finalRadius = 40,\r\n    height = \"200vh\",\r\n    className = \"\",\r\n    contentClassName = \"\",\r\n}: AppleScaleSectionProps) {\r\n    const ref = useRef<HTMLDivElement>(null);\r\n    const prefersReducedMotion = useReducedMotion();\r\n\r\n    const { scrollYProgress } = useScroll({\r\n        target: ref,\r\n        offset: [\"start start\", \"end start\"],\r\n    });\r\n\r\n    const scale = useTransform(scrollYProgress, [0, 0.5], [initialScale, finalScale]);\r\n    const borderRadius = useTransform(scrollYProgress, [0, 0.5], [initialRadius, finalRadius]);\r\n    const opacity = useTransform(scrollYProgress, [0.3, 0.8], [1, 0.6]);\r\n\r\n    if (prefersReducedMotion) {\r\n        return (\r\n            <div ref={ref} className={className} style={{ height }}>\r\n                <div className={`sticky top-0 h-screen ${contentClassName}`}>\r\n                    {children}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div ref={ref} className={className} style={{ height }}>\r\n            <div className=\"sticky top-0 h-screen flex items-center justify-center overflow-hidden\">\r\n                <motion.div\r\n                    style={{ scale, borderRadius, opacity }}\r\n                    className={`w-full h-full will-change-transform ${contentClassName}`}\r\n                >\r\n                    {children}\r\n                </motion.div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\ninterface AppleCardStackProps {\r\n    /** Array of card contents */\r\n    cards: ReactNode[];\r\n    /** CSS class for the wrapper */\r\n    className?: string;\r\n    /** CSS class for each card */\r\n    cardClassName?: string;\r\n}\r\n\r\n/**\r\n * Apple-style stacking cards on scroll\r\n * Cards stack on top of each other as user scrolls\r\n */\r\nexport function AppleCardStack({\r\n    cards,\r\n    className = \"\",\r\n    cardClassName = \"\",\r\n}: AppleCardStackProps) {\r\n    const ref = useRef<HTMLDivElement>(null);\r\n    const prefersReducedMotion = useReducedMotion();\r\n\r\n    const { scrollYProgress } = useScroll({\r\n        target: ref,\r\n        offset: [\"start start\", \"end end\"],\r\n    });\r\n\r\n    if (prefersReducedMotion) {\r\n        return (\r\n            <div ref={ref} className={`relative ${className}`}>\r\n                {cards.map((card, index) => (\r\n                    <div key={index} className={cardClassName}>\r\n                        {card}\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const cardHeight = 100 / cards.length;\r\n\r\n    return (\r\n        <div\r\n            ref={ref}\r\n            className={`relative ${className}`}\r\n            style={{ height: `${cards.length * 100}vh` }}\r\n        >\r\n            {cards.map((card, index) => (\r\n                <Card\r\n                    key={index}\r\n                    index={index}\r\n                    totalCards={cards.length}\r\n                    progress={scrollYProgress}\r\n                    className={cardClassName}\r\n                >\r\n                    {card}\r\n                </Card>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction Card({\r\n    children,\r\n    index,\r\n    totalCards,\r\n    progress,\r\n    className,\r\n}: {\r\n    children: ReactNode;\r\n    index: number;\r\n    totalCards: number;\r\n    progress: ReturnType<typeof useScroll>[\"scrollYProgress\"];\r\n    className: string;\r\n}) {\r\n    const start = index / totalCards;\r\n    const end = (index + 1) / totalCards;\r\n\r\n    const scale = useTransform(\r\n        progress,\r\n        [start, end],\r\n        [1, 0.9 - index * 0.02]\r\n    );\r\n    const y = useTransform(\r\n        progress,\r\n        [start, end],\r\n        [0, -30 * (totalCards - index)]\r\n    );\r\n    const zIndex = totalCards - index;\r\n\r\n    return (\r\n        <motion.div\r\n            className={`sticky top-20 will-change-transform ${className}`}\r\n            style={{\r\n                scale,\r\n                y,\r\n                zIndex,\r\n            }}\r\n        >\r\n            {children}\r\n        </motion.div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\AppleScrollReveal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\AppleTextReveal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Children' is defined but never used.","line":4,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ReactNode' is defined but never used.","line":4,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { motion, useScroll, useTransform, useReducedMotion } from \"framer-motion\";\r\nimport { useRef, Children, ReactNode } from \"react\";\r\n\r\ninterface AppleTextRevealProps {\r\n    /** Text to reveal (string or ReactNode with text) */\r\n    children: string;\r\n    /** Type of reveal animation */\r\n    type?: \"words\" | \"chars\" | \"lines\";\r\n    /** CSS class for the wrapper */\r\n    className?: string;\r\n    /** CSS class for each word/char */\r\n    itemClassName?: string;\r\n    /** Whether to only animate once */\r\n    once?: boolean;\r\n}\r\n\r\n/**\r\n * Apple-style text reveal animation\r\n * Text reveals word-by-word or character-by-character as user scrolls\r\n */\r\nexport function AppleTextReveal({\r\n    children,\r\n    type = \"words\",\r\n    className = \"\",\r\n    itemClassName = \"\",\r\n    once = true,\r\n}: AppleTextRevealProps) {\r\n    const prefersReducedMotion = useReducedMotion();\r\n    const text = typeof children === \"string\" ? children : \"\";\r\n\r\n    const items = type === \"chars\"\r\n        ? text.split(\"\")\r\n        : type === \"lines\"\r\n            ? text.split(\"\\n\")\r\n            : text.split(\" \");\r\n\r\n    if (prefersReducedMotion) {\r\n        return <span className={className}>{text}</span>;\r\n    }\r\n\r\n    return (\r\n        <motion.span\r\n            initial=\"hidden\"\r\n            whileInView=\"visible\"\r\n            viewport={{ once, margin: \"-50px\" }}\r\n            className={`inline-flex flex-wrap ${className}`}\r\n            variants={{\r\n                visible: {\r\n                    transition: {\r\n                        staggerChildren: type === \"chars\" ? 0.02 : 0.08,\r\n                    },\r\n                },\r\n            }}\r\n        >\r\n            {items.map((item, index) => (\r\n                <motion.span\r\n                    key={index}\r\n                    variants={{\r\n                        hidden: { opacity: 0, y: 20 },\r\n                        visible: {\r\n                            opacity: 1,\r\n                            y: 0,\r\n                            transition: {\r\n                                duration: 0.5,\r\n                                ease: [0.25, 0.4, 0.25, 1],\r\n                            },\r\n                        },\r\n                    }}\r\n                    className={`inline-block ${itemClassName}`}\r\n                >\r\n                    {item}\r\n                    {type === \"words\" && index < items.length - 1 ? \"\\u00A0\" : \"\"}\r\n                </motion.span>\r\n            ))}\r\n        </motion.span>\r\n    );\r\n}\r\n\r\ninterface AppleTextHighlightProps {\r\n    children: string;\r\n    /** Color to highlight with */\r\n    highlightColor?: string;\r\n    /** CSS class for the wrapper */\r\n    className?: string;\r\n}\r\n\r\n/**\r\n * Apple-style text highlight on scroll\r\n * Text gradually highlights as user scrolls past it\r\n */\r\nexport function AppleTextHighlight({\r\n    children,\r\n    highlightColor = \"rgb(255, 255, 255)\",\r\n    className = \"\",\r\n}: AppleTextHighlightProps) {\r\n    const ref = useRef<HTMLSpanElement>(null);\r\n    const prefersReducedMotion = useReducedMotion();\r\n\r\n    const { scrollYProgress } = useScroll({\r\n        target: ref,\r\n        offset: [\"start 0.9\", \"start 0.25\"],\r\n    });\r\n\r\n    const text = typeof children === \"string\" ? children : \"\";\r\n    const words = text.split(\" \");\r\n\r\n    if (prefersReducedMotion) {\r\n        return <span className={className}>{text}</span>;\r\n    }\r\n\r\n    return (\r\n        <span ref={ref} className={`inline-flex flex-wrap ${className}`}>\r\n            {words.map((word, index) => {\r\n                const start = index / words.length;\r\n                const end = start + 1 / words.length;\r\n\r\n                return (\r\n                    <Word\r\n                        key={index}\r\n                        progress={scrollYProgress}\r\n                        range={[start, end]}\r\n                        highlightColor={highlightColor}\r\n                    >\r\n                        {word}\r\n                    </Word>\r\n                );\r\n            })}\r\n        </span>\r\n    );\r\n}\r\n\r\nfunction Word({\r\n    children,\r\n    progress,\r\n    range,\r\n    highlightColor,\r\n}: {\r\n    children: string;\r\n    progress: ReturnType<typeof useScroll>[\"scrollYProgress\"];\r\n    range: [number, number];\r\n    highlightColor: string;\r\n}) {\r\n    const opacity = useTransform(progress, range, [0.3, 1]);\r\n    const color = useTransform(progress, range, [\"rgb(100, 100, 100)\", highlightColor]);\r\n\r\n    return (\r\n        <motion.span\r\n            style={{ opacity, color }}\r\n            className=\"mr-[0.25em] inline-block will-change-[opacity,color]\"\r\n        >\r\n            {children}\r\n        </motion.span>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\ModernBackground.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[726,729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[726,729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[760,763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[760,763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState } from \"react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\n// Detect if device is low-powered\r\nconst isLowPowerDevice = () => {\r\n    if (typeof window === 'undefined') return false;\r\n\r\n    // Check for mobile\r\n    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\r\n        navigator.userAgent\r\n    );\r\n\r\n    // Check for reduced motion preference\r\n    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\r\n\r\n    // Check hardware concurrency (CPU cores)\r\n    const lowCores = (navigator.hardwareConcurrency || 4) <= 4;\r\n\r\n    // Check device memory (if available)\r\n    const lowMemory = (navigator as any).deviceMemory ? (navigator as any).deviceMemory <= 4 : false;\r\n\r\n    return isMobile || prefersReducedMotion || (lowCores && lowMemory);\r\n};\r\n\r\nexport const ModernBackground = ({ className }: { className?: string }) => {\r\n    const [mounted, setMounted] = useState(false);\r\n    const [isLowPower, setIsLowPower] = useState(true); // Default to low power (safer)\r\n\r\n    useEffect(() => {\r\n        setMounted(true);\r\n        setIsLowPower(isLowPowerDevice());\r\n    }, []);\r\n\r\n    // Don't render anything until after hydration to prevent mismatch\r\n    if (!mounted) {\r\n        return null;\r\n    }\r\n\r\n    // Ultra-lightweight mode for mobile/low-power devices\r\n    if (isLowPower) {\r\n        return (\r\n            <div className={cn(\"fixed inset-0 -z-10 bg-neutral-950\", className)}>\r\n                {/* Static gradient - no animation, no blur */}\r\n                <div className=\"absolute inset-0 bg-gradient-to-br from-blue-950/30 via-neutral-950 to-indigo-950/30\" />\r\n\r\n                {/* Subtle grid - static, no mask */}\r\n                <div\r\n                    className=\"absolute inset-0 opacity-[0.03]\"\r\n                    style={{\r\n                        backgroundImage: 'linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px)',\r\n                        backgroundSize: '4rem 4rem',\r\n                    }}\r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Full experience for desktop/high-power devices\r\n    return (\r\n        <div className={cn(\"fixed inset-0 -z-10 overflow-hidden bg-neutral-950\", className)}>\r\n            {/* CSS-only animated orbs - no JavaScript */}\r\n            <div\r\n                className=\"absolute top-1/4 left-1/4 h-96 w-96 rounded-full bg-blue-900/20 blur-2xl animate-float-slow\"\r\n                style={{ willChange: 'transform' }}\r\n            />\r\n            <div\r\n                className=\"absolute bottom-1/4 right-1/4 h-96 w-96 rounded-full bg-indigo-900/20 blur-2xl opacity-70 animate-float-slow-delay\"\r\n                style={{ willChange: 'transform' }}\r\n            />\r\n            <div\r\n                className=\"absolute top-1/2 left-1/2 h-80 w-80 rounded-full bg-slate-800/20 blur-2xl -translate-x-1/2 -translate-y-1/2 animate-pulse-slow\"\r\n                style={{ willChange: 'transform' }}\r\n            />\r\n\r\n            {/* Grid overlay - simplified */}\r\n            <div\r\n                className=\"absolute inset-0\"\r\n                style={{\r\n                    backgroundImage: 'linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px)',\r\n                    backgroundSize: '4rem 4rem',\r\n                    maskImage: 'radial-gradient(ellipse 60% 50% at 50% 0%, #000 70%, transparent 110%)',\r\n                    WebkitMaskImage: 'radial-gradient(ellipse 60% 50% at 50% 0%, #000 70%, transparent 110%)',\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\animations\\useAnime.ts","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'parameters' and 'targets'. Either include them or remove the dependency array.","line":31,"column":6,"nodeType":"ArrayExpression","endLine":31,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [parameters, targets]","fix":{"range":[895,897],"text":"[parameters, targets]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\auth\\AuthContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\ComponentPalette.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\ComponentRenderer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\ContextMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\CourseSettings.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":110,"column":25,"nodeType":"JSXOpeningElement","endLine":114,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\nimport { useState } from \"react\";\r\nimport { Upload, Wand2, Loader2, X } from \"lucide-react\";\r\n\r\ninterface CourseSettingsProps {\r\n    courseTitle: string;\r\n    courseDescription: string;\r\n    courseThumbnail?: string;\r\n    courseAuthor?: string;\r\n    onTitleChange: (title: string) => void;\r\n    onDescriptionChange: (description: string) => void;\r\n    onThumbnailChange?: (url: string) => void;\r\n    onAuthorChange?: (author: string) => void;\r\n    createdAt?: string;\r\n    lastModified?: string;\r\n    isPublished?: boolean;\r\n}\r\n\r\nexport function CourseSettings({\r\n    courseTitle,\r\n    courseDescription,\r\n    courseThumbnail,\r\n    courseAuthor,\r\n    onTitleChange,\r\n    onDescriptionChange,\r\n    onThumbnailChange,\r\n    onAuthorChange,\r\n    createdAt,\r\n    lastModified,\r\n    isPublished,\r\n}: CourseSettingsProps) {\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n    const [showPrompt, setShowPrompt] = useState(false);\r\n    const [prompt, setPrompt] = useState(\"\");\r\n\r\n    const formatDate = (dateString?: string) => {\r\n        if (!dateString) return \"N/A\";\r\n        return new Date(dateString).toLocaleDateString(\"en-US\", {\r\n            year: \"numeric\",\r\n            month: \"long\",\r\n            day: \"numeric\",\r\n        });\r\n    };\r\n\r\n    const handleGenerateThumbnail = async () => {\r\n        if (!prompt.trim()) return;\r\n\r\n        setIsGenerating(true);\r\n        try {\r\n            // Generate image\r\n            const response = await authenticatedFetch('/api/ai/generate-image', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ prompt }),\r\n            });\r\n\r\n            if (!response.ok) throw new Error('Failed to generate');\r\n\r\n            const data = await response.json();\r\n\r\n            // Upload to get permanent URL\r\n            const uploadResponse = await authenticatedFetch('/api/upload-image', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ image: data.imageUrl }),\r\n            });\r\n\r\n            if (uploadResponse.ok) {\r\n                const { url } = await uploadResponse.json();\r\n                onThumbnailChange?.(url);\r\n                setShowPrompt(false);\r\n                setPrompt(\"\");\r\n            } else {\r\n                const error = await uploadResponse.text();\r\n                alert(`Upload failed: ${error}`);\r\n            }\r\n        } catch (error: unknown) {\r\n            const message = error instanceof Error ? error.message : 'Unknown error';\r\n            alert(`Failed to generate thumbnail: ${message}`);\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"max-w-3xl mx-auto px-8 py-6 space-y-6\">\r\n            {/* Status Badge */}\r\n            <div className=\"flex items-center gap-2\">\r\n                <span className=\"text-sm text-zinc-400\">Status:</span>\r\n                <span\r\n                    className={`px-2 py-1 rounded text-xs font-medium ${isPublished\r\n                        ? \"bg-green-500/20 text-green-400\"\r\n                        : \"bg-blue-500/20 text-blue-400\"\r\n                        }`}\r\n                >\r\n                    {isPublished ? \"Published\" : \"Draft\"}\r\n                </span>\r\n            </div>\r\n\r\n            {/* Thumbnail */}\r\n            <div>\r\n                <label className=\"block text-sm font-medium text-zinc-300 mb-2\">\r\n                    Course Thumbnail\r\n                </label>\r\n                <div className=\"relative w-full h-64 bg-zinc-800 rounded-xl overflow-hidden group\">\r\n                    {/* Image or Placeholder */}\r\n                    {courseThumbnail && courseThumbnail !== 'https://placehold.co/800x400' ? (\r\n                        <img\r\n                            src={courseThumbnail}\r\n                            alt=\"Course thumbnail\"\r\n                            className=\"w-full h-full object-cover\"\r\n                        />\r\n                    ) : (\r\n                        /* Same decorative background as ImageBlock */\r\n                        <div className=\"absolute inset-0 bg-[#0f1014]\">\r\n                            <div className=\"absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-orange-500/20 to-transparent\"></div>\r\n                            <div className=\"absolute bottom-0 left-0 w-full h-full bg-gradient-to-tr from-blue-600/10 to-transparent\"></div>\r\n                            <div className=\"absolute top-10 right-10 w-40 h-40 bg-orange-500/30 rounded-full blur-3xl\"></div>\r\n                            <div className=\"absolute bottom-10 left-10 w-60 h-60 bg-indigo-600/20 rounded-full blur-3xl\"></div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Controls Overlay - Same as ImageBlock */}\r\n                    {!showPrompt && (\r\n                        <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 backdrop-blur-sm\">\r\n                            {/* Upload Button */}\r\n                            <div className=\"flex flex-col items-center justify-center space-y-2 text-white cursor-pointer hover:scale-105 transition-transform\">\r\n                                <div className=\"p-3 bg-white/10 rounded-full backdrop-blur-md border border-white/20 shadow-xl\">\r\n                                    <Upload size={24} />\r\n                                </div>\r\n                                <span className=\"text-sm font-medium\">Upload</span>\r\n                            </div>\r\n\r\n                            {/* AI Generate Button */}\r\n                            <div className=\"flex flex-col items-center justify-center space-y-2 text-white cursor-pointer hover:scale-105 transition-transform\"\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    setShowPrompt(true);\r\n                                }}>\r\n                                <div className=\"p-3 bg-indigo-500/20 rounded-full backdrop-blur-md border border-indigo-400/30 shadow-xl text-indigo-300\">\r\n                                    <Wand2 size={24} />\r\n                                </div>\r\n                                <span className=\"text-sm font-medium text-indigo-300\">Generate</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* AI Prompt Overlay - Same as ImageBlock */}\r\n                    {showPrompt && (\r\n                        <div className=\"absolute inset-0 bg-zinc-900/95 flex flex-col items-center justify-center p-6 z-10\" onClick={e => e.stopPropagation()}>\r\n                            <div className=\"w-full max-w-sm space-y-3\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <h4 className=\"text-white font-medium flex items-center gap-2\">\r\n                                        <Wand2 size={16} className=\"text-indigo-400\" />\r\n                                        Generate Thumbnail\r\n                                    </h4>\r\n                                    <button onClick={() => setShowPrompt(false)} className=\"text-zinc-500 hover:text-white\">\r\n                                        <X size={16} />\r\n                                    </button>\r\n                                </div>\r\n                                <textarea\r\n                                    value={prompt}\r\n                                    onChange={(e) => setPrompt(e.target.value)}\r\n                                    placeholder=\"Describe the thumbnail image...\"\r\n                                    className=\"w-full h-20 bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-indigo-500 resize-none\"\r\n                                    onKeyDown={(e) => {\r\n                                        if (e.key === 'Enter' && !e.shiftKey) {\r\n                                            e.preventDefault();\r\n                                            handleGenerateThumbnail();\r\n                                        }\r\n                                    }}\r\n                                />\r\n                                <button\r\n                                    onClick={handleGenerateThumbnail}\r\n                                    disabled={isGenerating || !prompt.trim()}\r\n                                    className=\"w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\r\n                                >\r\n                                    {isGenerating ? (\r\n                                        <>\r\n                                            <Loader2 size={16} className=\"animate-spin\" />\r\n                                            Generating...\r\n                                        </>\r\n                                    ) : (\r\n                                        'Generate'\r\n                                    )}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Title */}\r\n            <div>\r\n                <label className=\"block text-sm font-medium text-zinc-300 mb-2\">\r\n                    Course Title\r\n                </label>\r\n                <input\r\n                    type=\"text\"\r\n                    value={courseTitle}\r\n                    onChange={(e) => onTitleChange(e.target.value)}\r\n                    className=\"w-full px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-indigo-500\"\r\n                    placeholder=\"Enter course title\"\r\n                />\r\n            </div>\r\n\r\n            {/* Author */}\r\n            <div>\r\n                <label className=\"block text-sm font-medium text-zinc-300 mb-2\">\r\n                    Author / Instructor\r\n                </label>\r\n                <input\r\n                    type=\"text\"\r\n                    value={courseAuthor || ''}\r\n                    onChange={(e) => onAuthorChange?.(e.target.value)}\r\n                    className=\"w-full px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-indigo-500\"\r\n                    placeholder=\"Enter instructor name\"\r\n                />\r\n            </div>\r\n\r\n            {/* Description */}\r\n            <div>\r\n                <label className=\"block text-sm font-medium text-zinc-300 mb-2\">\r\n                    Description\r\n                </label>\r\n                <textarea\r\n                    value={courseDescription}\r\n                    onChange={(e) => onDescriptionChange(e.target.value)}\r\n                    rows={4}\r\n                    className=\"w-full px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-indigo-500 resize-none\"\r\n                    placeholder=\"Enter course description\"\r\n                />\r\n            </div>\r\n\r\n            {/* Metadata */}\r\n            <div className=\"pt-4 border-t border-zinc-800\">\r\n                <h3 className=\"text-sm font-medium text-zinc-300 mb-3\">Metadata</h3>\r\n                <div className=\"space-y-2 text-sm\">\r\n                    <div className=\"flex justify-between\">\r\n                        <span className=\"text-zinc-500\">Created:</span>\r\n                        <span className=\"text-zinc-300\">{formatDate(createdAt)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                        <span className=\"text-zinc-500\">Last Modified:</span>\r\n                        <span className=\"text-zinc-300\">{formatDate(lastModified)}</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\DesignControls.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Plus' is defined but never used.","line":26,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":9},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[936,939],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[936,939],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Component, HeaderComponent, TextComponent, ImageComponent, VideoComponent, CodeComponent, CTAComponent, DividerComponent, SpacerComponent, Spacing } from \"@/lib/cms/types\";\r\nimport {\r\n    InputLabel,\r\n    SectionHeader,\r\n    TextInput,\r\n    Select,\r\n    IconButton,\r\n    ColorInput,\r\n    TextArea\r\n} from \"@/components/cms/ui-primitives\";\r\nimport {\r\n    AlignLeft,\r\n    AlignCenter,\r\n    AlignRight,\r\n    AlignJustify,\r\n    Trash2,\r\n    Type,\r\n    Image,\r\n    Video,\r\n    Code,\r\n    MousePointerClick,\r\n    Minus,\r\n    MoveVertical,\r\n    Plus\r\n} from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { COMPONENT_REGISTRY, createComponent } from \"@/lib/cms/registry\";\r\n\r\ninterface DesignControlsProps {\r\n    component: Component | null;\r\n    onUpdate: (component: Component) => void;\r\n    onDelete: () => void;\r\n    onAddComponent?: (component: Component) => void;\r\n}\r\n\r\nconst iconMap: Record<string, any> = {\r\n    Type,\r\n    AlignLeft,\r\n    Image,\r\n    Video,\r\n    Code,\r\n    MousePointerClick,\r\n    Minus,\r\n    MoveVertical,\r\n};\r\n\r\nexport function DesignControls({ component, onUpdate, onDelete, onAddComponent }: DesignControlsProps) {\r\n    const [activeTab, setActiveTab] = useState<'design' | 'settings'>('design');\r\n\r\n    if (!component) {\r\n        return (\r\n            <div className=\"flex flex-col h-full bg-zinc-950 border-l border-zinc-800 overflow-hidden\">\r\n                <div className=\"p-4 border-b border-zinc-800\">\r\n                    <h3 className=\"text-sm font-semibold text-white\">Components</h3>\r\n                    <p className=\"text-xs text-zinc-500 mt-1\">Drag or click to add</p>\r\n                </div>\r\n                <div className=\"flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar\">\r\n                    {COMPONENT_REGISTRY.map((meta) => {\r\n                        const Icon = iconMap[meta.icon] || Type;\r\n                        return (\r\n                            <button\r\n                                key={meta.type}\r\n                                onClick={() => {\r\n                                    if (onAddComponent) {\r\n                                        const newComponent = createComponent(meta.type);\r\n                                        onAddComponent(newComponent);\r\n                                    }\r\n                                }}\r\n                                draggable\r\n                                onDragStart={(e) => {\r\n                                    e.dataTransfer.setData('componentType', meta.type);\r\n                                    e.dataTransfer.effectAllowed = 'copy';\r\n                                }}\r\n                                className=\"flex items-center gap-3 w-full px-3 py-2.5 rounded-lg bg-zinc-900/50 border border-zinc-800/50 hover:bg-zinc-800 hover:border-zinc-700 transition-colors text-left group cursor-grab active:cursor-grabbing\"\r\n                            >\r\n                                <div className=\"w-8 h-8 rounded-md bg-zinc-950 border border-zinc-800 flex items-center justify-center text-zinc-500 group-hover:text-indigo-400 group-hover:border-indigo-500/30 transition-colors shrink-0\">\r\n                                    <Icon size={16} />\r\n                                </div>\r\n                                <div className=\"min-w-0\">\r\n                                    <div className=\"text-sm font-medium text-zinc-300 group-hover:text-white\">{meta.name}</div>\r\n                                    <div className=\"text-[10px] text-zinc-500 truncate\">{meta.description}</div>\r\n                                </div>\r\n                            </button>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-zinc-950 border-l border-zinc-800 overflow-hidden\">\r\n            {/* Tabs */}\r\n            <div className=\"flex border-b border-zinc-800 shrink-0\">\r\n                <button\r\n                    className={`flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'design' ? 'text-white border-indigo-500' : 'text-zinc-500 border-transparent hover:text-zinc-300'}`}\r\n                    onClick={() => setActiveTab('design')}\r\n                >\r\n                    Design\r\n                </button>\r\n                <button\r\n                    className={`flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'settings' ? 'text-white border-indigo-500' : 'text-zinc-500 border-transparent hover:text-zinc-300'}`}\r\n                    onClick={() => setActiveTab('settings')}\r\n                >\r\n                    Settings\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <span className=\"text-xs font-bold text-zinc-500 uppercase tracking-wider\">{component.type}</span>\r\n                    <button\r\n                        onClick={onDelete}\r\n                        className=\"p-1.5 rounded-md hover:bg-red-500/10 text-zinc-500 hover:text-red-500 transition-colors\"\r\n                        title=\"Delete Component\"\r\n                    >\r\n                        <Trash2 size={14} />\r\n                    </button>\r\n                </div>\r\n\r\n                {activeTab === 'design' ? (\r\n                    <>\r\n                        {component.type === \"header\" && <HeaderControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"text\" && <TextControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"image\" && <ImageControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"video\" && <VideoControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"code\" && <CodeControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"cta\" && <CTAControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"divider\" && <DividerControls component={component} onUpdate={onUpdate} />}\r\n                        {component.type === \"spacer\" && <SpacerControls component={component} onUpdate={onUpdate} />}\r\n\r\n                        {component.type !== \"spacer\" && (\r\n                            <MarginControls\r\n                                margin={component.margin}\r\n                                onChange={(margin) => onUpdate({ ...component, margin })}\r\n                            />\r\n                        )}\r\n                    </>\r\n                ) : (\r\n                    <div className=\"space-y-4\">\r\n                        <SectionHeader title=\"Component ID\" />\r\n                        <div className=\"p-3 bg-zinc-900 rounded border border-zinc-800 text-xs font-mono text-zinc-500 break-all\">\r\n                            {component.id}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n// --- Specific Controls ---\r\n\r\nfunction HeaderControls({ component, onUpdate }: { component: HeaderComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Typography\" />\r\n\r\n            <Select\r\n                label=\"Level\"\r\n                value={component.level}\r\n                onChange={(e) => onUpdate({ ...component, level: Number(e.target.value) as 1 | 2 | 3 | 4 | 5 | 6 })}\r\n                options={[1, 2, 3, 4, 5, 6].map(i => ({ label: `Heading ${i}`, value: i }))}\r\n            />\r\n\r\n            <div>\r\n                <InputLabel>Alignment</InputLabel>\r\n                <div className=\"flex bg-zinc-900 p-1 rounded-lg border border-zinc-800\">\r\n                    <IconButton icon={<AlignLeft size={16} />} active={component.align === 'left' || !component.align} onClick={() => onUpdate({ ...component, align: 'left' })} />\r\n                    <IconButton icon={<AlignCenter size={16} />} active={component.align === 'center'} onClick={() => onUpdate({ ...component, align: 'center' })} />\r\n                    <IconButton icon={<AlignRight size={16} />} active={component.align === 'right'} onClick={() => onUpdate({ ...component, align: 'right' })} />\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n                <TextInput label=\"Size\" unit=\"px\" type=\"number\" value={component.fontSize || \"\"} onChange={(e) => onUpdate({ ...component, fontSize: Number(e.target.value) })} />\r\n                <TextInput label=\"Weight\" type=\"number\" step=\"100\" value={component.fontWeight || 600} onChange={(e) => onUpdate({ ...component, fontWeight: Number(e.target.value) })} />\r\n            </div>\r\n\r\n            <ColorInput label=\"Color\" value={component.color || \"#ffffff\"} onChange={(color) => onUpdate({ ...component, color })} />\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction TextControls({ component, onUpdate }: { component: TextComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Typography\" />\r\n\r\n            <div>\r\n                <InputLabel>Alignment</InputLabel>\r\n                <div className=\"flex bg-zinc-900 p-1 rounded-lg border border-zinc-800\">\r\n                    <IconButton icon={<AlignLeft size={16} />} active={component.align === 'left' || !component.align} onClick={() => onUpdate({ ...component, align: 'left' })} />\r\n                    <IconButton icon={<AlignCenter size={16} />} active={component.align === 'center'} onClick={() => onUpdate({ ...component, align: 'center' })} />\r\n                    <IconButton icon={<AlignRight size={16} />} active={component.align === 'right'} onClick={() => onUpdate({ ...component, align: 'right' })} />\r\n                    <IconButton icon={<AlignJustify size={16} />} active={component.align === 'justify'} onClick={() => onUpdate({ ...component, align: 'justify' })} />\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n                <TextInput label=\"Size\" unit=\"px\" type=\"number\" value={component.fontSize || 16} onChange={(e) => onUpdate({ ...component, fontSize: Number(e.target.value) })} />\r\n                <TextInput label=\"Line Height\" step=\"0.1\" type=\"number\" value={component.lineHeight || 1.6} onChange={(e) => onUpdate({ ...component, lineHeight: Number(e.target.value) })} />\r\n            </div>\r\n\r\n            <ColorInput label=\"Color\" value={component.color || \"#d4d4d8\"} onChange={(color) => onUpdate({ ...component, color })} />\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction ImageControls({ component, onUpdate }: { component: ImageComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Source\" />\r\n            <TextInput label=\"Image URL\" value={component.url} onChange={(e) => onUpdate({ ...component, url: e.target.value })} />\r\n            <TextInput label=\"Alt Text\" value={component.alt || \"\"} onChange={(e) => onUpdate({ ...component, alt: e.target.value })} />\r\n            <TextInput label=\"Caption\" value={component.caption || \"\"} onChange={(e) => onUpdate({ ...component, caption: e.target.value })} />\r\n\r\n            <SectionHeader title=\"Appearance\" />\r\n            <div>\r\n                <InputLabel>Alignment</InputLabel>\r\n                <div className=\"flex bg-zinc-900 p-1 rounded-lg border border-zinc-800\">\r\n                    <IconButton icon={<AlignLeft size={16} />} active={component.align === 'left'} onClick={() => onUpdate({ ...component, align: 'left' })} />\r\n                    <IconButton icon={<AlignCenter size={16} />} active={component.align === 'center' || !component.align} onClick={() => onUpdate({ ...component, align: 'center' })} />\r\n                    <IconButton icon={<AlignRight size={16} />} active={component.align === 'right'} onClick={() => onUpdate({ ...component, align: 'right' })} />\r\n                </div>\r\n            </div>\r\n\r\n            <TextInput label=\"Border Radius\" unit=\"px\" type=\"number\" value={component.borderRadius || 8} onChange={(e) => onUpdate({ ...component, borderRadius: Number(e.target.value) })} />\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction VideoControls({ component, onUpdate }: { component: VideoComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Video\" />\r\n            <TextInput label=\"URL\" placeholder=\"YouTube / Vimeo\" value={component.url} onChange={(e) => onUpdate({ ...component, url: e.target.value })} />\r\n\r\n            <Select\r\n                label=\"Aspect Ratio\"\r\n                value={component.aspectRatio || \"16:9\"}\r\n                onChange={(e) => onUpdate({ ...component, aspectRatio: e.target.value as \"16:9\" | \"4:3\" | \"1:1\" })}\r\n                options={[\r\n                    { label: \"16:9\", value: \"16:9\" },\r\n                    { label: \"4:3\", value: \"4:3\" },\r\n                    { label: \"1:1\", value: \"1:1\" },\r\n                ]}\r\n            />\r\n            <TextInput label=\"Caption\" value={component.caption || \"\"} onChange={(e) => onUpdate({ ...component, caption: e.target.value })} />\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction CodeControls({ component, onUpdate }: { component: CodeComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Code Settings\" />\r\n            <TextArea label=\"Code\" rows={8} value={component.code} onChange={(e) => onUpdate({ ...component, code: e.target.value })} className=\"font-mono text-xs\" />\r\n\r\n            <TextInput label=\"Language\" value={component.language || \"javascript\"} onChange={(e) => onUpdate({ ...component, language: e.target.value })} />\r\n\r\n            <Select\r\n                label=\"Show Line Numbers\"\r\n                value={component.showLineNumbers ? \"yes\" : \"no\"}\r\n                onChange={(e) => onUpdate({ ...component, showLineNumbers: e.target.value === \"yes\" })}\r\n                options={[{ label: \"Show\", value: \"yes\" }, { label: \"Hide\", value: \"no\" }]}\r\n            />\r\n            <TextInput label=\"Font Size\" unit=\"px\" type=\"number\" value={component.fontSize || 14} onChange={(e) => onUpdate({ ...component, fontSize: Number(e.target.value) })} />\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction CTAControls({ component, onUpdate }: { component: CTAComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Button\" />\r\n            <TextInput label=\"Text\" value={component.text} onChange={(e) => onUpdate({ ...component, text: e.target.value })} />\r\n            <TextInput label=\"Link URL\" value={component.url || \"\"} onChange={(e) => onUpdate({ ...component, url: e.target.value })} />\r\n\r\n            <Select\r\n                label=\"Size\"\r\n                value={component.size || \"medium\"}\r\n                onChange={(e) => onUpdate({ ...component, size: e.target.value as \"small\" | \"medium\" | \"large\" })}\r\n                options={[\r\n                    { label: \"Small\", value: \"small\" },\r\n                    { label: \"Medium\", value: \"medium\" },\r\n                    { label: \"Large\", value: \"large\" },\r\n                ]}\r\n            />\r\n\r\n            <div>\r\n                <InputLabel>Alignment</InputLabel>\r\n                <div className=\"flex bg-zinc-900 p-1 rounded-lg border border-zinc-800\">\r\n                    <IconButton icon={<AlignLeft size={16} />} active={component.align === 'left'} onClick={() => onUpdate({ ...component, align: 'left' })} />\r\n                    <IconButton icon={<AlignCenter size={16} />} active={component.align === 'center' || !component.align} onClick={() => onUpdate({ ...component, align: 'center' })} />\r\n                    <IconButton icon={<AlignRight size={16} />} active={component.align === 'right'} onClick={() => onUpdate({ ...component, align: 'right' })} />\r\n                </div>\r\n            </div>\r\n\r\n            <SectionHeader title=\"Colors\" />\r\n            <ColorInput label=\"Background\" value={component.bgColor || \"#3b82f6\"} onChange={(val) => onUpdate({ ...component, bgColor: val })} />\r\n            <ColorInput label=\"Text\" value={component.textColor || \"#ffffff\"} onChange={(val) => onUpdate({ ...component, textColor: val })} />\r\n\r\n            <TextInput label=\"Border Radius\" unit=\"px\" type=\"number\" value={component.borderRadius || 8} onChange={(e) => onUpdate({ ...component, borderRadius: Number(e.target.value) })} />\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction DividerControls({ component, onUpdate }: { component: DividerComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Divider\" />\r\n            <Select\r\n                label=\"Style\"\r\n                value={component.style || \"solid\"}\r\n                onChange={(e) => onUpdate({ ...component, style: e.target.value as \"solid\" | \"dashed\" | \"dotted\" })}\r\n                options={[\r\n                    { label: \"Solid\", value: \"solid\" },\r\n                    { label: \"Dashed\", value: \"dashed\" },\r\n                    { label: \"Dotted\", value: \"dotted\" },\r\n                ]}\r\n            />\r\n            <ColorInput label=\"Color\" value={component.color || \"#404040\"} onChange={(val) => onUpdate({ ...component, color: val })} />\r\n            <TextInput label=\"Width\" unit=\"%\" type=\"number\" min=\"0\" max=\"100\" value={component.width || 100} onChange={(e) => onUpdate({ ...component, width: Number(e.target.value) })} />\r\n            <TextInput label=\"Thickness\" unit=\"px\" type=\"number\" value={component.thickness || 1} onChange={(e) => onUpdate({ ...component, thickness: Number(e.target.value) })} />\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction SpacerControls({ component, onUpdate }: { component: SpacerComponent; onUpdate: (c: Component) => void }) {\r\n    return (\r\n        <div className=\"space-y-5\">\r\n            <SectionHeader title=\"Dimensions\" />\r\n            <TextInput label=\"Height\" unit=\"px\" type=\"number\" value={component.height} onChange={(e) => onUpdate({ ...component, height: Number(e.target.value) })} />\r\n        </div>\r\n    )\r\n}\r\n\r\n\r\nfunction MarginControls({ margin, onChange }: { margin?: Spacing; onChange: (margin: Spacing) => void }) {\r\n    const current = margin || {};\r\n    return (\r\n        <div className=\"pt-2\">\r\n            <SectionHeader title=\"Margin\" />\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n                <TextInput label=\"Top\" unit=\"px\" type=\"number\" value={current.top || \"\"} onChange={(e) => onChange({ ...current, top: Number(e.target.value) })} />\r\n                <TextInput label=\"Right\" unit=\"px\" type=\"number\" value={current.right || \"\"} onChange={(e) => onChange({ ...current, right: Number(e.target.value) })} />\r\n                <TextInput label=\"Bottom\" unit=\"px\" type=\"number\" value={current.bottom || \"\"} onChange={(e) => onChange({ ...current, bottom: Number(e.target.value) })} />\r\n                <TextInput label=\"Left\" unit=\"px\" type=\"number\" value={current.left || \"\"} onChange={(e) => onChange({ ...current, left: Number(e.target.value) })} />\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\CTABlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\CodeBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\DividerBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\HeaderBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\ImageBlock.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":123,"column":25,"nodeType":"JSXOpeningElement","endLine":128,"endColumn":27},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":239,"column":17,"nodeType":"JSXOpeningElement","endLine":244,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\nimport { ImageComponent } from \"@/lib/cms/types\";\r\nimport { Upload, ImageIcon, Wand2, Loader2, X } from \"lucide-react\";\r\nimport { useState, useRef } from \"react\";\r\nimport { useUpload } from \"@/lib/hooks/useUpload\";\r\n\r\ninterface ImageBlockProps {\r\n    component: ImageComponent;\r\n    isEditing?: boolean;\r\n    isSelected?: boolean;\r\n    onUpdate?: (component: ImageComponent) => void;\r\n    onSelect?: () => void;\r\n}\r\n\r\nexport function ImageBlock({\r\n    component,\r\n    isEditing,\r\n    isSelected,\r\n    onUpdate,\r\n    onSelect,\r\n}: ImageBlockProps) {\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n    const [showPromptInput, setShowPromptInput] = useState(false);\r\n    const [prompt, setPrompt] = useState(\"\");\r\n\r\n    // File upload\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n    const { upload, isUploading, progress } = useUpload({\r\n        type: 'cms',\r\n        id: component.id,\r\n        onSuccess: (result) => {\r\n            if (onUpdate) {\r\n                onUpdate({ ...component, url: result.url });\r\n            }\r\n        }\r\n    });\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n        await upload(file);\r\n    };\r\n\r\n    const handleGenerate = async () => {\r\n        if (!prompt.trim()) return;\r\n\r\n        setIsGenerating(true);\r\n        try {\r\n            const response = await authenticatedFetch('/api/ai/generate-image', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ prompt }),\r\n            });\r\n\r\n            const data = await response.json();\r\n\r\n            if (!response.ok) {\r\n                throw new Error(data.error || 'Failed to generate image');\r\n            }\r\n\r\n            if (data.imageUrl && onUpdate) {\r\n                // Upload image to get permanent URL\r\n                const uploadResponse = await authenticatedFetch('/api/upload-image', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ image: data.imageUrl }),\r\n                });\r\n\r\n                if (uploadResponse.ok) {\r\n                    const { url } = await uploadResponse.json();\r\n                    onUpdate({ ...component, url });\r\n                } else {\r\n                    // Fallback to data URL if upload fails\r\n                    onUpdate({ ...component, url: data.imageUrl });\r\n                }\r\n\r\n                setShowPromptInput(false);\r\n                setPrompt(\"\");\r\n            }\r\n        } catch (error: unknown) {\r\n            const message = error instanceof Error ? error.message : 'Unknown error';\r\n            alert(`Failed to generate image: ${message}`);\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    const containerStyle = {\r\n        textAlign: component.align || \"center\",\r\n        marginTop: component.margin?.top ? `${component.margin.top}px` : undefined,\r\n        marginRight: component.margin?.right ? `${component.margin.right}px` : undefined,\r\n        marginBottom: component.margin?.bottom ? `${component.margin.bottom}px` : undefined,\r\n        marginLeft: component.margin?.left ? `${component.margin.left}px` : undefined,\r\n    };\r\n\r\n    const imgStyle = {\r\n        width: component.width === \"auto\" ? \"100%\" : `${component.width}px`,\r\n        borderRadius: component.borderRadius ? `${component.borderRadius}px` : undefined,\r\n    };\r\n\r\n    if (isEditing) {\r\n        return (\r\n            <div\r\n                onClick={onSelect}\r\n                style={containerStyle}\r\n                className={`group relative rounded-xl transition-all ${isSelected ? \"ring-2 ring-indigo-500 ring-offset-2 ring-offset-zinc-950\" : \"hover:ring-1 hover:ring-zinc-700\"\r\n                    }`}\r\n            >\r\n                {/* Hidden file input */}\r\n                <input\r\n                    ref={fileInputRef}\r\n                    type=\"file\"\r\n                    accept=\"image/*\"\r\n                    onChange={handleFileSelect}\r\n                    className=\"hidden\"\r\n                />\r\n\r\n                {/* Image or Placeholder */}\r\n                <div className={`relative overflow-hidden bg-zinc-800 ${!component.url || component.url === \"https://placehold.co/800x400\" ? \"h-64\" : \"\"}`} style={{ borderRadius: component.borderRadius ? `${component.borderRadius}px` : '8px' }}>\r\n                    {component.url && component.url !== \"https://placehold.co/800x400\" ? (\r\n                        <img\r\n                            src={component.url}\r\n                            alt={component.alt || \"Image\"}\r\n                            style={imgStyle}\r\n                            className=\"max-w-full h-auto\"\r\n                        />\r\n                    ) : (\r\n                        /* Abstract decorative background from reference */\r\n                        <div className=\"absolute inset-0 bg-[#0f1014]\">\r\n                            <div className=\"absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-orange-500/20 to-transparent\"></div>\r\n                            <div className=\"absolute bottom-0 left-0 w-full h-full bg-gradient-to-tr from-blue-600/10 to-transparent\"></div>\r\n                            <div className=\"absolute top-10 right-10 w-40 h-40 bg-orange-500/30 rounded-full blur-3xl\"></div>\r\n                            <div className=\"absolute bottom-10 left-10 w-60 h-60 bg-indigo-600/20 rounded-full blur-3xl\"></div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Upload Progress Overlay */}\r\n                    {isUploading && (\r\n                        <div className=\"absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20\">\r\n                            <Loader2 size={32} className=\"text-blue-500 animate-spin mb-3\" />\r\n                            <div className=\"w-32 h-1.5 bg-zinc-700 rounded-full overflow-hidden\">\r\n                                <div\r\n                                    className=\"h-full bg-blue-500 transition-all duration-300\"\r\n                                    style={{ width: `${progress}%` }}\r\n                                />\r\n                            </div>\r\n                            <span className=\"text-xs text-zinc-400 mt-2\">Converting to WebP...</span>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Controls Overlay */}\r\n                    {!showPromptInput && !isUploading && (\r\n                        <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 backdrop-blur-sm\">\r\n                            {/* Upload Button */}\r\n                            <div\r\n                                className=\"flex flex-col items-center justify-center space-y-2 text-white cursor-pointer hover:scale-105 transition-transform\"\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    fileInputRef.current?.click();\r\n                                }}\r\n                            >\r\n                                <div className=\"p-3 bg-white/10 rounded-full backdrop-blur-md border border-white/20 shadow-xl\">\r\n                                    <Upload size={24} />\r\n                                </div>\r\n                                <span className=\"text-sm font-medium\">Upload</span>\r\n                            </div>\r\n\r\n                            {/* AI Generate Button */}\r\n                            <div className=\"flex flex-col items-center justify-center space-y-2 text-white cursor-pointer hover:scale-105 transition-transform\"\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    setShowPromptInput(true);\r\n                                }}>\r\n                                <div className=\"p-3 bg-indigo-500/20 rounded-full backdrop-blur-md border border-indigo-400/30 shadow-xl text-indigo-300\">\r\n                                    <Wand2 size={24} />\r\n                                </div>\r\n                                <span className=\"text-sm font-medium text-indigo-300\">Generate</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* AI Prompt Input Overlay */}\r\n                    {showPromptInput && (\r\n                        <div className=\"absolute inset-0 bg-zinc-900/95 flex flex-col items-center justify-center p-6 z-10\" onClick={e => e.stopPropagation()}>\r\n                            <div className=\"w-full max-w-sm space-y-3\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <h4 className=\"text-white font-medium flex items-center gap-2\">\r\n                                        <Wand2 size={16} className=\"text-indigo-400\" />\r\n                                        Generate Image\r\n                                    </h4>\r\n                                    <button onClick={() => setShowPromptInput(false)} className=\"text-zinc-500 hover:text-white\">\r\n                                        <X size={16} />\r\n                                    </button>\r\n                                </div>\r\n                                <textarea\r\n                                    value={prompt}\r\n                                    onChange={(e) => setPrompt(e.target.value)}\r\n                                    placeholder=\"Describe the image you want...\"\r\n                                    className=\"w-full h-20 bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-indigo-500 resize-none\"\r\n                                    onKeyDown={(e) => {\r\n                                        if (e.key === 'Enter' && !e.shiftKey) {\r\n                                            e.preventDefault();\r\n                                            handleGenerate();\r\n                                        }\r\n                                    }}\r\n                                />\r\n                                <button\r\n                                    onClick={handleGenerate}\r\n                                    disabled={isGenerating || !prompt.trim()}\r\n                                    className=\"w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\r\n                                >\r\n                                    {isGenerating ? (\r\n                                        <>\r\n                                            <Loader2 size={16} className=\"animate-spin\" />\r\n                                            Generating...\r\n                                        </>\r\n                                    ) : (\r\n                                        'Generate'\r\n                                    )}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {component.caption && (\r\n                    <p className=\"text-sm text-zinc-500 mt-2 text-center\">{component.caption}</p>\r\n                )}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // View Mode\r\n    return (\r\n        <div style={containerStyle}>\r\n            {component.url && component.url !== \"https://placehold.co/800x400\" ? (\r\n                <img\r\n                    src={component.url}\r\n                    alt={component.alt || \"Image\"}\r\n                    style={imgStyle}\r\n                    className=\"max-w-full h-auto\"\r\n                />\r\n            ) : (\r\n                <div className=\"w-full h-64 bg-zinc-800 rounded-lg flex items-center justify-center text-zinc-600\">\r\n                    <ImageIcon size={48} />\r\n                </div>\r\n            )}\r\n            {component.caption && (\r\n                <p className=\"text-sm text-zinc-500 mt-2 text-center\">{component.caption}</p>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\SpacerBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\TextBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\blocks\\VideoBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\cms\\ui-primitives.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\course\\CourseCard.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":98,"column":29,"nodeType":"JSXOpeningElement","endLine":103,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Course } from \"@/lib/types\";\r\nimport { hybridStorage } from \"@/lib/storage/hybrid-storage\";\r\nimport { enrollmentManager } from \"@/lib/storage/enrollment\";\r\nimport { Clock, BarChart, Check, Plus, ChevronRight, ShoppingCart } from \"lucide-react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { useRef, useEffect, useState } from \"react\";\r\nimport { animate } from \"@/components/animations/useAnime\";\r\nimport { useAuth } from \"../auth/AuthContext\";\r\nimport { useTranslation } from \"@/lib/i18n\";\r\nimport { useTranslatedCourse } from \"@/lib/hooks/useTranslatedCourse\";\r\n\r\ninterface CourseCardProps {\r\n    course: Course;\r\n    index?: number;\r\n    onEnrollChange?: () => void;\r\n}\r\n\r\nexport function CourseCard({ course, index = 0, onEnrollChange }: CourseCardProps) {\r\n    const cardRef = useRef<HTMLDivElement>(null);\r\n    const router = useRouter();\r\n    const { user, refreshUser } = useAuth();\r\n    const [isEnrolled, setIsEnrolled] = useState(false);\r\n    const [isEnrolling, setIsEnrolling] = useState(false);\r\n    const [imageError, setImageError] = useState(false);\r\n    const progress = hybridStorage.progress.getCourseProgress(course.id);\r\n    const { t } = useTranslation();\r\n\r\n    // Auto-translate course content\r\n    const translated = useTranslatedCourse(course.id, course.title, course.description);\r\n\r\n    // Check if user has subscription that grants full course access\r\n    const subscriptionTier = user?.subscription?.tier || 'free';\r\n    const hasActiveSubscription = user?.subscription?.status === 'active' && subscriptionTier !== 'free';\r\n    // Pro = 100% access, Mid = 50% access, Basic = 30% access - for simplicity, treat active subscription as having access\r\n    const hasSubscriptionAccess = hasActiveSubscription && (subscriptionTier === 'pro' || subscriptionTier === 'mid');\r\n\r\n    useEffect(() => {\r\n        // User has access if: enrolled, OR has active paid subscription (mid/pro)\r\n        const enrolled = enrollmentManager.isEnrolled(course.id);\r\n        setIsEnrolled(enrolled || hasSubscriptionAccess);\r\n    }, [course.id, user, hasSubscriptionAccess]);\r\n\r\n    // Reset image error state when thumbnail changes\r\n    useEffect(() => {\r\n        setImageError(false);\r\n    }, [course.thumbnail]);\r\n\r\n    useEffect(() => {\r\n        if (cardRef.current) {\r\n            animate(cardRef.current, {\r\n                opacity: [0, 1],\r\n                translateY: [20, 0],\r\n                delay: index * 100,\r\n                ease: \"out-quad\",\r\n                duration: 800,\r\n            });\r\n        }\r\n    }, [index]);\r\n\r\n    const handleEnroll = async (e: React.MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        if (!user) return;\r\n\r\n        setIsEnrolling(true);\r\n        try {\r\n            await enrollmentManager.enrollInCourse(user.id, course.id);\r\n            setIsEnrolled(true);\r\n            refreshUser();\r\n            onEnrollChange?.();\r\n        } catch (error) {\r\n            console.error(\"Enrollment failed:\", error);\r\n        } finally {\r\n            setIsEnrolling(false);\r\n        }\r\n    };\r\n\r\n    // Determine if we should show the fallback\r\n    const showFallback = !course.thumbnail || imageError;\r\n\r\n    return (\r\n        <div ref={cardRef} className=\"h-full group\">\r\n            <Link href={isEnrolled ? `/class/${course.id}` : '#'} onClick={(e) => !isEnrolled && e.preventDefault()}>\r\n                <div className=\"relative h-full flex flex-col overflow-hidden rounded-2xl bg-white dark:bg-zinc-900/40 border border-neutral-200 dark:border-white/5 shadow-lg dark:shadow-2xl transition-all duration-500 hover:-translate-y-1 hover:shadow-xl dark:hover:shadow-blue-900/10 hover:border-neutral-300 dark:hover:border-white/10\">\r\n\r\n                    {/* Image Section - The Hero */}\r\n                    <div className=\"relative h-48 w-full overflow-hidden bg-gradient-to-br from-blue-100 dark:from-blue-900/50 to-indigo-100 dark:to-indigo-900/50\">\r\n                        {/* Always render the fallback behind the image */}\r\n                        <div className={`absolute inset-0 flex items-center justify-center transition-opacity duration-300 ${showFallback ? 'opacity-100' : 'opacity-0'}`}>\r\n                            <span className=\"text-4xl font-bold text-neutral-300 dark:text-white/20\">{course.title.charAt(0)}</span>\r\n                        </div>\r\n                        {/* Render image on top if thumbnail exists */}\r\n                        {course.thumbnail && !imageError && (\r\n                            <img\r\n                                src={course.thumbnail}\r\n                                alt={course.title}\r\n                                className=\"absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110\"\r\n                                onError={() => setImageError(true)}\r\n                            />\r\n                        )}\r\n                        {/* Gradient Overlay */}\r\n                        <div className=\"absolute inset-0 bg-gradient-to-t from-white dark:from-zinc-950 via-white/20 dark:via-zinc-950/20 to-transparent opacity-90\" />\r\n\r\n                        {/* Status Badge */}\r\n                        <div className=\"absolute top-3 left-3 flex gap-2\">\r\n                            <span className=\"text-[10px] font-bold uppercase tracking-widest text-neutral-700 dark:text-white/90 bg-white/80 dark:bg-white/10 backdrop-blur-md px-2.5 py-1 rounded-full border border-neutral-200 dark:border-white/10 shadow-sm\">\r\n                                {course.level || 'Beginner'}\r\n                            </span>\r\n                            {isEnrolled && (\r\n                                <span className=\"text-[10px] font-bold uppercase tracking-widest text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-500/10 backdrop-blur-md px-2.5 py-1 rounded-full border border-emerald-200 dark:border-emerald-500/20 shadow-sm flex items-center gap-1\">\r\n                                    <Check className=\"w-3 h-3\" /> Enrolled\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Price Badge */}\r\n                        <div className=\"absolute top-3 right-3\">\r\n                            {course.isFree || course.price === 0 ? (\r\n                                <span className=\"text-xs font-bold text-white bg-green-500 px-2.5 py-1 rounded-full shadow-lg\">\r\n                                    Free\r\n                                </span>\r\n                            ) : (\r\n                                <span className=\"text-xs font-bold text-white bg-gradient-to-r from-blue-600 to-indigo-600 px-2.5 py-1 rounded-full shadow-lg\">\r\n                                    ${course.price}\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Content Section - Glassmorphic */}\r\n                    <div className=\"flex-1 p-5 pt-2 flex flex-col\">\r\n                        <div className=\"flex items-center justify-between text-neutral-500 dark:text-zinc-500 text-xs font-medium mb-3\">\r\n                            <span className=\"uppercase tracking-wider\">{course.category}</span>\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <span className=\"flex items-center gap-1\"><Clock size={12} /> {course.duration}</span>\r\n                                <span className=\"flex items-center gap-1\"><BarChart size={12} /> {course.rating}</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Title with loading skeleton */}\r\n                        <h3 className=\"text-lg font-bold text-neutral-900 dark:text-white leading-tight mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\">\r\n                            {translated.loading ? (\r\n                                <span className=\"inline-block w-3/4 h-5 bg-neutral-200 dark:bg-neutral-700 rounded animate-pulse\" />\r\n                            ) : (\r\n                                translated.title\r\n                            )}\r\n                        </h3>\r\n\r\n                        {/* Description with loading skeleton */}\r\n                        <p className=\"text-sm text-neutral-600 dark:text-zinc-400 line-clamp-2 mb-6 flex-1\">\r\n                            {translated.loading ? (\r\n                                <span className=\"space-y-2 block\">\r\n                                    <span className=\"inline-block w-full h-4 bg-neutral-200 dark:bg-neutral-700 rounded animate-pulse\" />\r\n                                    <span className=\"inline-block w-2/3 h-4 bg-neutral-200 dark:bg-neutral-700 rounded animate-pulse\" />\r\n                                </span>\r\n                            ) : (\r\n                                translated.description\r\n                            )}\r\n                        </p>\r\n\r\n                        {/* Footer Action */}\r\n                        <div className=\"mt-auto pt-4 border-t border-neutral-100 dark:border-white/5 flex items-center justify-between\">\r\n                            {isEnrolled ? (\r\n                                <div className=\"flex-1\">\r\n                                    <div className=\"flex items-center justify-between text-[10px] text-neutral-500 dark:text-zinc-400 uppercase tracking-wider mb-2\">\r\n                                        <span>{t.course.progress}</span>\r\n                                        <span>{progress}%</span>\r\n                                    </div>\r\n                                    <div className=\"h-1 w-full bg-neutral-200 dark:bg-zinc-800 rounded-full overflow-hidden\">\r\n                                        <div\r\n                                            className=\"h-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)] transition-all duration-500\"\r\n                                            style={{ width: `${progress}%` }}\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"mt-4 flex justify-end\">\r\n                                        <div className=\"flex items-center gap-2 text-xs font-semibold text-neutral-900 dark:text-white group-hover:translate-x-1 transition-transform\">\r\n                                            {t.course.continueLearning} <ChevronRight size={14} className=\"text-blue-500\" />\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <div className=\"h-8 w-8 rounded-full bg-neutral-100 dark:bg-zinc-800 border border-neutral-200 dark:border-white/5 flex items-center justify-center text-xs font-bold text-neutral-400 dark:text-white/50\">\r\n                                            {(course.instructor || \"A\")[0]}\r\n                                        </div>\r\n                                        <div className=\"text-xs text-neutral-500 dark:text-zinc-500\">\r\n                                            <span className=\"block text-neutral-700 dark:text-zinc-300 font-medium\">{t.course.instructor}</span>\r\n                                            {(course.instructor || \"Admin\").split(' ')[0]}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {course.isFree || course.price === 0 ? (\r\n                                        <button\r\n                                            onClick={handleEnroll}\r\n                                            disabled={isEnrolling}\r\n                                            className=\"relative overflow-hidden bg-neutral-900 dark:bg-white text-white dark:text-black px-5 py-2 rounded-full text-xs font-bold uppercase tracking-wider hover:bg-neutral-700 dark:hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed group/btn\"\r\n                                        >\r\n                                            <span className=\"relative z-10 flex items-center gap-2\">\r\n                                                {isEnrolling ? '...' : t.course.enroll}\r\n                                                {!isEnrolling && <Plus size={14} className=\"transition-transform group-hover/btn:rotate-90\" />}\r\n                                            </span>\r\n                                        </button>\r\n                                    ) : (\r\n                                        <button\r\n                                            onClick={(e) => {\r\n                                                e.preventDefault();\r\n                                                e.stopPropagation();\r\n                                                router.push(`/checkout/${course.id}`);\r\n                                            }}\r\n                                            className=\"relative overflow-hidden bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-2 rounded-full text-xs font-bold uppercase tracking-wider hover:from-blue-700 hover:to-indigo-700 transition-colors group/btn\"\r\n                                        >\r\n                                            <span className=\"relative z-10 flex items-center gap-2\">\r\n                                                ${course.price}\r\n                                                <ShoppingCart size={14} />\r\n                                            </span>\r\n                                        </button>\r\n                                    )}\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </Link>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\course\\MaterialViewer.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'isCompleted' and 'triggerCompletion'. Either include them or remove the dependency array.","line":92,"column":8,"nodeType":"ArrayExpression","endLine":92,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [isCompleted, lesson.id, triggerCompletion]","fix":{"range":[3249,3260],"text":"[isCompleted, lesson.id, triggerCompletion]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":196,"column":21,"nodeType":"JSXOpeningElement","endLine":200,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Lesson } from \"@/lib/types\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport { animate } from \"@/components/animations/useAnime\";\r\nimport { ComponentRenderer } from \"@/components/cms/ComponentRenderer\";\r\nimport { useTimeTracker } from \"@/lib/hooks/useTimeTracker\";\r\nimport { useTranslatedLesson } from \"@/lib/hooks/useTranslatedCourse\";\r\nimport { useTranslatedComponents } from \"@/lib/hooks/useTranslatedComponents\";\r\nimport DOMPurify from \"dompurify\";\r\n\r\ninterface MaterialViewerProps {\r\n    lesson: Lesson;\r\n    onComplete: () => void;\r\n    isCompleted: boolean;\r\n}\r\n\r\nexport function MaterialViewer({ lesson, onComplete, isCompleted }: MaterialViewerProps) {\r\n    useTimeTracker();\r\n\r\n    // Auto-translate lesson content based on selected language\r\n    const translated = useTranslatedLesson(\r\n        lesson.id,\r\n        lesson.title,\r\n        lesson.content || \"\"\r\n    );\r\n\r\n    // Auto-translate CMS component content\r\n    const translatedCms = useTranslatedComponents(lesson.id, lesson.components);\r\n\r\n    const contentRef = useRef<HTMLDivElement>(null);\r\n    const [scrollProgress, setScrollProgress] = useState(0);\r\n    const [hasReachedEnd, setHasReachedEnd] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (contentRef.current) {\r\n            animate(contentRef.current, {\r\n                opacity: [0, 1],\r\n                translateY: [20, 0],\r\n                ease: \"out-quad\",\r\n                duration: 600\r\n            });\r\n        }\r\n\r\n        setScrollProgress(0);\r\n        setHasReachedEnd(false);\r\n    }, [lesson.id]);\r\n\r\n    // Event-driven completion: Auto-complete when scrolled to end\r\n    const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {\r\n        const { scrollTop, scrollHeight, clientHeight } = e.currentTarget;\r\n\r\n        // If content is shorter than or equal to view, we are technically \"at the end\"\r\n        // Prevent division by zero if no scroll is possible\r\n        const maxScroll = scrollHeight - clientHeight;\r\n        const scrolled = maxScroll <= 0 ? 100 : (scrollTop / maxScroll) * 100;\r\n\r\n        setScrollProgress(Math.min(100, Math.max(0, scrolled)));\r\n\r\n        if (scrolled >= 90 && !hasReachedEnd && !isCompleted) {\r\n            triggerCompletion();\r\n        }\r\n    };\r\n\r\n    const triggerCompletion = () => {\r\n        setHasReachedEnd(true);\r\n        setTimeout(() => {\r\n            onComplete();\r\n        }, 1000);\r\n    };\r\n\r\n    // Check once on mount if content is already short enough to be \"complete\"\r\n    useEffect(() => {\r\n        if (!contentRef.current || isCompleted) return;\r\n\r\n        const checkHeight = () => {\r\n            if (contentRef.current) {\r\n                const { scrollHeight, clientHeight } = contentRef.current;\r\n                // If no scrollbar needed (content fits), mark complete\r\n                if (scrollHeight <= clientHeight + 1) { // +1 for pixel rounding safety\r\n                    triggerCompletion();\r\n                }\r\n            }\r\n        };\r\n\r\n        // Check immediately and after a short delay (for images/layout to settle)\r\n        checkHeight();\r\n        const timer = setTimeout(checkHeight, 500);\r\n\r\n        return () => clearTimeout(timer);\r\n    }, [lesson.id]);\r\n\r\n    // Auto-complete for image lessons\r\n    useEffect(() => {\r\n        if (lesson.type === \"image\" && !isCompleted) {\r\n            const timer = setTimeout(() => {\r\n                onComplete();\r\n            }, 5000);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [lesson.id, lesson.type, isCompleted, onComplete]);\r\n\r\n    // Debug: Log lesson data to understand what's being passed\r\n    console.log('ðŸ“š MaterialViewer lesson:', {\r\n        id: lesson.id,\r\n        title: lesson.title,\r\n        type: lesson.type,\r\n        hasComponents: !!(lesson.components && lesson.components.length > 0),\r\n        componentsCount: lesson.components?.length || 0,\r\n    });\r\n\r\n    // Render component-based lessons with translation\r\n    if (lesson.components && lesson.components.length > 0) {\r\n        return (\r\n            <div className=\"flex-1 relative\">\r\n                <div\r\n                    ref={contentRef}\r\n                    onScroll={handleScroll}\r\n                    className=\"h-full overflow-y-auto p-8\"\r\n                >\r\n                    <div className=\"max-w-4xl mx-auto space-y-6\">\r\n                        {/* Loading skeleton while translating CMS components */}\r\n                        {translatedCms.loading ? (\r\n                            <div className=\"space-y-6 animate-pulse\">\r\n                                <div className=\"h-8 bg-neutral-700 rounded w-2/3\" />\r\n                                <div className=\"space-y-3\">\r\n                                    <div className=\"h-4 bg-neutral-700 rounded w-full\" />\r\n                                    <div className=\"h-4 bg-neutral-700 rounded w-5/6\" />\r\n                                    <div className=\"h-4 bg-neutral-700 rounded w-4/5\" />\r\n                                </div>\r\n                                <div className=\"h-6 bg-neutral-700 rounded w-1/2\" />\r\n                                <div className=\"space-y-3\">\r\n                                    <div className=\"h-4 bg-neutral-700 rounded w-full\" />\r\n                                    <div className=\"h-4 bg-neutral-700 rounded w-3/4\" />\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            translatedCms.components.map((component) => (\r\n                                <ComponentRenderer\r\n                                    key={component.id}\r\n                                    component={component}\r\n                                    isEditing={false}\r\n                                />\r\n                            ))\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Legacy content rendering (for old lessons)\r\n    if (lesson.type === \"article\") {\r\n        return (\r\n            <div className=\"flex-1 relative\">\r\n                <div\r\n                    ref={contentRef}\r\n                    onScroll={handleScroll}\r\n                    className=\"h-full overflow-y-auto p-8\"\r\n                >\r\n                    <div className=\"max-w-3xl mx-auto prose prose-invert prose-neutral\">\r\n                        {/* Loading skeleton while translating */}\r\n                        {translated.loading ? (\r\n                            <div className=\"space-y-4 animate-pulse\">\r\n                                <div className=\"h-6 bg-neutral-700 rounded w-2/3\" />\r\n                                <div className=\"h-4 bg-neutral-700 rounded w-full\" />\r\n                                <div className=\"h-4 bg-neutral-700 rounded w-5/6\" />\r\n                                <div className=\"h-4 bg-neutral-700 rounded w-4/5\" />\r\n                            </div>\r\n                        ) : (\r\n                            <div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(translated.content || lesson.content || \"\") }} />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Scroll Progress Indicator */}\r\n                <div className=\"absolute bottom-0 left-0 right-0 h-1 bg-neutral-800\">\r\n                    <div\r\n                        className={cn(\r\n                            \"h-full transition-all\",\r\n                            scrollProgress >= 90 ? \"bg-green-500\" : \"bg-blue-500\"\r\n                        )}\r\n                        style={{ width: `${scrollProgress}%` }}\r\n                    />\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Image lessons\r\n    if (lesson.type === \"image\") {\r\n        return (\r\n            <div className=\"flex-1 flex items-center justify-center p-8\">\r\n                <div ref={contentRef} className=\"max-w-4xl w-full\">\r\n                    <img\r\n                        src={lesson.imageUrl}\r\n                        alt={lesson.title}\r\n                        className=\"w-full rounded-xl\"\r\n                    />\r\n                    {lesson.content && (\r\n                        <div className=\"mt-4 prose prose-invert prose-neutral\">\r\n                            <div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(lesson.content) }} />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Fallback for empty or CMS lessons with no content\r\n    return (\r\n        <div className=\"flex-1 flex items-center justify-center p-8\">\r\n            <div className=\"text-center text-neutral-500\">\r\n                <p className=\"text-lg\">This lesson is being prepared.</p>\r\n                <p className=\"text-sm mt-2\">Check back soon for content!</p>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\course\\RecommendedCourses.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchRecommendations'. Either include it or remove the dependency array.","line":57,"column":8,"nodeType":"ArrayExpression","endLine":57,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [user, limit, fetchRecommendations]","fix":{"range":[1726,1739],"text":"[user, limit, fetchRecommendations]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Course } from \"@/lib/types\";\r\nimport { CourseCard } from \"@/components/course/CourseCard\";\r\nimport { Sparkles, RefreshCw } from \"lucide-react\";\r\nimport { useEffect, useState, useRef } from \"react\";\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\n\r\ninterface RecommendedCoursesProps {\r\n    limit?: number;\r\n    showTitle?: boolean;\r\n    className?: string;\r\n}\r\n\r\nexport function RecommendedCourses({\r\n    limit = 4,\r\n    showTitle = true,\r\n    className = \"\"\r\n}: RecommendedCoursesProps) {\r\n    const { user } = useAuth();\r\n    const [courses, setCourses] = useState<Course[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [, setError] = useState<string | null>(null);\r\n    const scrollRef = useRef<HTMLDivElement>(null);\r\n\r\n    const fetchRecommendations = async () => {\r\n        if (!user) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setError(null);\r\n\r\n        try {\r\n            const response = await authenticatedFetch(`/api/recommendations?limit=${limit}`);\r\n            const data = await response.json();\r\n\r\n            if (data.recommendations && Array.isArray(data.recommendations)) {\r\n                setCourses(data.recommendations);\r\n            } else {\r\n                setCourses([]);\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Failed to fetch recommendations:\", err);\r\n            setError(\"Couldn't load recommendations\");\r\n            setCourses([]);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n     \r\n    useEffect(() => {\r\n        fetchRecommendations();\r\n    }, [user, limit]);\r\n\r\n    // Don't render if not logged in\r\n    if (!user) return null;\r\n\r\n    // Loading state\r\n    if (loading) {\r\n        return (\r\n            <div className={`${className}`}>\r\n                {showTitle && (\r\n                    <div className=\"flex items-center gap-2 mb-4\">\r\n                        <Sparkles className=\"w-5 h-5 text-amber-500 animate-pulse\" />\r\n                        <h2 className=\"text-lg font-bold text-neutral-900 dark:text-white\">\r\n                            Finding recommendations...\r\n                        </h2>\r\n                    </div>\r\n                )}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n                    {[...Array(limit)].map((_, i) => (\r\n                        <div\r\n                            key={i}\r\n                            className=\"h-80 rounded-2xl bg-neutral-100 dark:bg-zinc-800/50 animate-pulse\"\r\n                        />\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // No recommendations\r\n    if (courses.length === 0) {\r\n        return null; // Don't show section if no recommendations\r\n    }\r\n\r\n    return (\r\n        <div className={`${className}`}>\r\n            {showTitle && (\r\n                <div className=\"flex items-center justify-between mb-6\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 shadow-lg shadow-orange-500/25\">\r\n                            <Sparkles className=\"w-5 h-5 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-xl font-bold text-neutral-900 dark:text-white\">\r\n                                Recommended for You\r\n                            </h2>\r\n                            <p className=\"text-sm text-neutral-500 dark:text-zinc-400\">\r\n                                Based on your learning journey\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => {\r\n                            // Refresh recommendations\r\n                            authenticatedFetch('/api/recommendations', { method: 'POST' })\r\n                                .then(() => fetchRecommendations());\r\n                        }}\r\n                        className=\"p-2 rounded-full bg-neutral-100 dark:bg-zinc-800 hover:bg-neutral-200 dark:hover:bg-zinc-700 transition-colors\"\r\n                        title=\"Refresh recommendations\"\r\n                    >\r\n                        <RefreshCw className=\"w-4 h-4 text-neutral-500 dark:text-zinc-400\" />\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* Horizontal scrollable on mobile, grid on desktop */}\r\n            <div\r\n                ref={scrollRef}\r\n                className=\"flex gap-4 overflow-x-auto pb-4 snap-x snap-mandatory md:grid md:grid-cols-2 lg:grid-cols-4 md:overflow-visible md:pb-0\"\r\n                style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\r\n            >\r\n                {courses.map((course, index) => (\r\n                    <div\r\n                        key={course.id}\r\n                        className=\"min-w-[280px] md:min-w-0 snap-start\"\r\n                    >\r\n                        <CourseCard course={course} index={index} />\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\layout\\DashboardShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\layout\\NotificationCenter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\layout\\UserMenu.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Settings' is defined but never used.","line":7,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":63},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":7,"column":65,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":76},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":64,"column":21,"nodeType":"JSXOpeningElement","endLine":68,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":110,"column":37,"nodeType":"JSXOpeningElement","endLine":110,"endColumn":126}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { useAuth } from \"@/components/auth/AuthContext\";\r\nimport { useTheme } from \"@/components/theme/ThemeProvider\";\r\nimport { useLanguage, useTranslation } from \"@/lib/i18n\";\r\nimport { LogOut, Sun, Moon, Globe, ChevronDown, User, Settings, AlertCircle, Sparkles } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport Link from \"next/link\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\n\r\ninterface UserMenuProps {\r\n    collapsed?: boolean;\r\n}\r\n\r\nconst FLAG_ICONS: Record<string, string> = {\r\n    en: \"ðŸ‡ºðŸ‡¸\",\r\n    ja: \"ðŸ‡¯ðŸ‡µ\",\r\n    ko: \"ðŸ‡°ðŸ‡·\",\r\n    id: \"ðŸ‡®ðŸ‡©\",\r\n};\r\n\r\nexport function UserMenu({ collapsed = false }: UserMenuProps) {\r\n    const { user, logout } = useAuth();\r\n    const { resolvedTheme, setTheme } = useTheme();\r\n    const { language, setLanguage, languages } = useLanguage();\r\n    const { t } = useTranslation();\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [showLanguages, setShowLanguages] = useState(false);\r\n    const menuRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Close menu when clicking outside\r\n    useEffect(() => {\r\n        const handleClickOutside = (e: MouseEvent) => {\r\n            if (menuRef.current && !menuRef.current.contains(e.target as Node)) {\r\n                setIsOpen(false);\r\n                setShowLanguages(false);\r\n            }\r\n        };\r\n        document.addEventListener(\"mousedown\", handleClickOutside);\r\n        return () => document.removeEventListener(\"mousedown\", handleClickOutside);\r\n    }, []);\r\n\r\n    const toggleTheme = () => {\r\n        setTheme(resolvedTheme === \"dark\" ? \"light\" : \"dark\");\r\n    };\r\n\r\n    if (!user) return null;\r\n\r\n    // Check if profile is incomplete\r\n    const isProfileIncomplete = !user.firstName || !user.lastName || !user.phone;\r\n\r\n    return (\r\n        <div ref={menuRef} className=\"relative\">\r\n            <button\r\n                onClick={() => setIsOpen(!isOpen)}\r\n                className={cn(\r\n                    \"relative flex items-center gap-3 p-2 rounded-xl transition-all hover:bg-neutral-100 dark:hover:bg-white/5\",\r\n                    collapsed && \"justify-center\",\r\n                    isOpen && \"bg-neutral-100 dark:bg-white/5\"\r\n                )}\r\n            >\r\n                {user.avatar ? (\r\n                    <img\r\n                        src={user.avatar}\r\n                        alt={user.name}\r\n                        className=\"h-9 w-9 rounded-full object-cover ring-2 ring-neutral-200 dark:ring-white/10\"\r\n                    />\r\n                ) : (\r\n                    <div className=\"h-9 w-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-sm font-bold text-white\">\r\n                        {user.name?.[0]?.toUpperCase() || \"U\"}\r\n                    </div>\r\n                )}\r\n                {/* Profile Incomplete Indicator */}\r\n                {isProfileIncomplete && (\r\n                    <div className=\"absolute -top-0.5 -right-0.5 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-neutral-900 animate-pulse\" />\r\n                )}\r\n                {!collapsed && (\r\n                    <>\r\n                        <div className=\"text-left flex-1 min-w-0\">\r\n                            <p className=\"text-sm font-medium text-neutral-900 dark:text-white truncate\">\r\n                                {user.name || \"User\"}\r\n                            </p>\r\n                        </div>\r\n                        <ChevronDown className={cn(\r\n                            \"w-4 h-4 text-neutral-400 transition-transform\",\r\n                            isOpen && \"rotate-180\"\r\n                        )} />\r\n                    </>\r\n                )}\r\n            </button>\r\n\r\n            {/* Dropdown Menu */}\r\n            <AnimatePresence>\r\n                {isOpen && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, y: -10, scale: 0.95 }}\r\n                        animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                        exit={{ opacity: 0, y: -10, scale: 0.95 }}\r\n                        transition={{ duration: 0.15, ease: \"easeOut\" }}\r\n                        className={cn(\r\n                            \"absolute bottom-full mb-2 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl shadow-xl overflow-hidden z-[100]\",\r\n                            collapsed ? \"left-0 w-56\" : \"left-0 right-0\"\r\n                        )}\r\n                    >\r\n                        {/* User Info Header */}\r\n                        <div className=\"p-4 border-b border-neutral-100 dark:border-neutral-800\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                {user.avatar ? (\r\n                                    <img src={user.avatar} alt={user.name} className=\"h-10 w-10 rounded-full object-cover\" />\r\n                                ) : (\r\n                                    <div className=\"h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-sm font-bold text-white\">\r\n                                        {user.name?.[0]?.toUpperCase() || \"U\"}\r\n                                    </div>\r\n                                )}\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                    <p className=\"text-sm font-medium text-neutral-900 dark:text-white truncate\">{user.name}</p>\r\n                                    <p className=\"text-xs text-neutral-500 truncate\">{user.email}</p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Menu Items */}\r\n                        <div className=\"p-2\">\r\n                            {/* Profile Link */}\r\n                            <Link href=\"/settings/profile\" onClick={() => setIsOpen(false)}>\r\n                                <button className=\"w-full flex items-center justify-between px-3 py-2.5 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-white/5 rounded-lg transition-colors\">\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        <User className=\"w-4 h-4\" />\r\n                                        <span>Profile</span>\r\n                                    </div>\r\n                                    {isProfileIncomplete && (\r\n                                        <span className=\"w-2 h-2 bg-red-500 rounded-full\" />\r\n                                    )}\r\n                                </button>\r\n                            </Link>\r\n\r\n                            {/* Subscription Status */}\r\n                            {user.subscription?.tier && user.subscription.tier !== 'free' ? (\r\n                                <div className=\"flex items-center justify-between px-3 py-2.5 text-sm\">\r\n                                    <div className=\"flex items-center gap-3 text-indigo-600 dark:text-indigo-400\">\r\n                                        <Sparkles className=\"w-4 h-4\" />\r\n                                        <span className=\"font-medium capitalize\">{user.subscription.tier} Plan</span>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <Link href=\"/pricing\" onClick={() => setIsOpen(false)}>\r\n                                    <button className=\"w-full flex items-center gap-3 px-3 py-2.5 text-sm text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/10 rounded-lg transition-colors\">\r\n                                        <Sparkles className=\"w-4 h-4\" />\r\n                                        <span>Upgrade Plan</span>\r\n                                    </button>\r\n                                </Link>\r\n                            )}\r\n\r\n                            {/* Theme Toggle */}\r\n                            <button\r\n                                onClick={toggleTheme}\r\n                                className=\"w-full flex items-center justify-between px-3 py-2.5 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-white/5 rounded-lg transition-colors\"\r\n                            >\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    {resolvedTheme === \"dark\" ? (\r\n                                        <Moon className=\"w-4 h-4\" />\r\n                                    ) : (\r\n                                        <Sun className=\"w-4 h-4\" />\r\n                                    )}\r\n                                    <span>Appearance</span>\r\n                                </div>\r\n                                <div className=\"text-xs text-neutral-500 capitalize\">{resolvedTheme}</div>\r\n                            </button>\r\n\r\n                            {/* Language Selector */}\r\n                            <div className=\"relative\">\r\n                                <button\r\n                                    onClick={() => setShowLanguages(!showLanguages)}\r\n                                    className=\"w-full flex items-center justify-between px-3 py-2.5 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-white/5 rounded-lg transition-colors\"\r\n                                >\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        <Globe className=\"w-4 h-4\" />\r\n                                        <span>Language</span>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-1.5\">\r\n                                        <span className=\"text-lg\">{FLAG_ICONS[language]}</span>\r\n                                        <span className=\"text-xs text-neutral-500 uppercase\">{language}</span>\r\n                                    </div>\r\n                                </button>\r\n\r\n                                {/* Language Options */}\r\n                                <AnimatePresence>\r\n                                    {showLanguages && (\r\n                                        <motion.div\r\n                                            initial={{ height: 0, opacity: 0 }}\r\n                                            animate={{ height: \"auto\", opacity: 1 }}\r\n                                            exit={{ height: 0, opacity: 0 }}\r\n                                            className=\"overflow-hidden\"\r\n                                        >\r\n                                            <div className=\"py-1 pl-10 space-y-1\">\r\n                                                {languages.map((lang) => (\r\n                                                    <button\r\n                                                        key={lang.code}\r\n                                                        onClick={() => {\r\n                                                            setLanguage(lang.code);\r\n                                                            setShowLanguages(false);\r\n                                                        }}\r\n                                                        className={cn(\r\n                                                            \"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg transition-colors\",\r\n                                                            language === lang.code\r\n                                                                ? \"bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400\"\r\n                                                                : \"text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-white/5\"\r\n                                                        )}\r\n                                                    >\r\n                                                        <span className=\"text-lg\">{FLAG_ICONS[lang.code]}</span>\r\n                                                        <span>{lang.name}</span>\r\n                                                    </button>\r\n                                                ))}\r\n                                            </div>\r\n                                        </motion.div>\r\n                                    )}\r\n                                </AnimatePresence>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Sign Out */}\r\n                        <div className=\"p-2 border-t border-neutral-100 dark:border-neutral-800\">\r\n                            <button\r\n                                onClick={() => {\r\n                                    setIsOpen(false);\r\n                                    logout();\r\n                                }}\r\n                                className=\"w-full flex items-center gap-3 px-3 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg transition-colors\"\r\n                            >\r\n                                <LogOut className=\"w-4 h-4\" />\r\n                                <span>{t.logout}</span>\r\n                            </button>\r\n                        </div>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\payment\\CardBrandIcon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\payment\\PaymentModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TEST_CARDS' is defined but never used.","line":21,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardBrandConfig' is defined but never used.","line":22,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7306,7309],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7306,7309],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { authenticatedFetch } from \"@/lib/api/authenticated-fetch\";\r\n\r\nimport { useState, useMemo, useRef } from \"react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { X, Lock, CheckCircle, Loader2, AlertCircle, CreditCard as CreditCardIcon } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport Image from \"next/image\";\r\nimport {\r\n    detectCardBrand,\r\n    validateCardNumber,\r\n    validateExpiry,\r\n    validateCVV,\r\n    formatCardNumber,\r\n    formatExpiry,\r\n    shouldDecline,\r\n    TEST_CARDS,\r\n    type CardBrandConfig,\r\n} from \"@/lib/payment/card-validator\";\r\n\r\ninterface PaymentModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSuccess: (paymentId: string) => void;\r\n    course: {\r\n        id: string;\r\n        title: string;\r\n        thumbnail: string;\r\n        price: number;\r\n        originalPrice?: number;\r\n    };\r\n}\r\n\r\ntype PaymentStep = 'form' | 'processing' | 'success' | 'declined';\r\n\r\n// Card brand colors for visual feedback\r\nconst BRAND_COLORS: Record<string, string> = {\r\n    visa: 'from-blue-600 to-blue-800',\r\n    mastercard: 'from-red-500 to-orange-500',\r\n    amex: 'from-blue-500 to-cyan-500',\r\n    discover: 'from-orange-500 to-amber-500',\r\n    diners: 'from-blue-700 to-indigo-700',\r\n    maestro: 'from-blue-500 to-blue-700',\r\n    unionpay: 'from-red-600 to-red-800',\r\n};\r\n\r\n// Card brand icons as simple SVG components\r\nfunction CardBrandIcon({ brand, className }: { brand: string | undefined; className?: string }) {\r\n    if (!brand || brand === 'unknown') {\r\n        return <CreditCardIcon className={cn(\"text-neutral-400\", className)} />;\r\n    }\r\n\r\n    const colors: Record<string, string> = {\r\n        visa: '#1A1F71',\r\n        mastercard: '#EB001B',\r\n        amex: '#006FCF',\r\n        discover: '#FF6600',\r\n        diners: '#004A97',\r\n        maestro: '#0066CC',\r\n        unionpay: '#E21836',\r\n    };\r\n\r\n    return (\r\n        <svg viewBox=\"0 0 24 24\" className={className} fill={colors[brand] || '#666'}>\r\n            {brand === 'visa' && (\r\n                <path d=\"M9.5 4h5c.83 0 1.5.67 1.5 1.5v13c0 .83-.67 1.5-1.5 1.5h-5c-.83 0-1.5-.67-1.5-1.5v-13c0-.83.67-1.5 1.5-1.5z\" />\r\n            )}\r\n            {brand === 'mastercard' && (\r\n                <>\r\n                    <circle cx=\"9\" cy=\"12\" r=\"5\" fill=\"#EB001B\" />\r\n                    <circle cx=\"15\" cy=\"12\" r=\"5\" fill=\"#F79E1B\" />\r\n                    <path d=\"M12 8.5c1.38 1.12 2 2.12 2 3.5s-.62 2.38-2 3.5c-1.38-1.12-2-2.12-2-3.5s.62-2.38 2-3.5z\" fill=\"#FF5F00\" />\r\n                </>\r\n            )}\r\n            {brand === 'amex' && (\r\n                <path d=\"M4 6h16v12H4V6zm2 2v8h12V8H6z\" />\r\n            )}\r\n            {brand === 'discover' && (\r\n                <circle cx=\"12\" cy=\"12\" r=\"8\" />\r\n            )}\r\n            {brand === 'diners' && (\r\n                <>\r\n                    <circle cx=\"12\" cy=\"12\" r=\"9\" fill=\"none\" stroke={colors.diners} strokeWidth=\"2\" />\r\n                    <circle cx=\"12\" cy=\"12\" r=\"5\" />\r\n                </>\r\n            )}\r\n            {brand === 'maestro' && (\r\n                <>\r\n                    <circle cx=\"9\" cy=\"12\" r=\"5\" fill=\"#0066CC\" />\r\n                    <circle cx=\"15\" cy=\"12\" r=\"5\" fill=\"#CC0000\" />\r\n                    <path d=\"M12 8c1.1.9 1.8 2.4 1.8 4s-.7 3.1-1.8 4c-1.1-.9-1.8-2.4-1.8-4s.7-3.1 1.8-4z\" fill=\"#7700AA\" />\r\n                </>\r\n            )}\r\n            {brand === 'unionpay' && (\r\n                <path d=\"M4 6h16v12H4V6zm2 2v8h12V8H6zm2 2h3v4H8v-4z\" />\r\n            )}\r\n        </svg>\r\n    );\r\n}\r\n\r\nexport function PaymentModal({ isOpen, onClose, onSuccess, course }: PaymentModalProps) {\r\n    const [step, setStep] = useState<PaymentStep>('form');\r\n    const [cardNumber, setCardNumber] = useState(\"\");\r\n    const [expiry, setExpiry] = useState(\"\");\r\n    const [cvv, setCvv] = useState(\"\");\r\n    const [name, setName] = useState(\"\");\r\n    const [error, setError] = useState(\"\");\r\n    const [touched, setTouched] = useState<Record<string, boolean>>({});\r\n\r\n    // Detect card brand in real-time\r\n    const cardBrand = useMemo(() => detectCardBrand(cardNumber), [cardNumber]);\r\n\r\n    // Validate fields in real-time\r\n    const cardValidation = useMemo(() => validateCardNumber(cardNumber), [cardNumber]);\r\n    const expiryValidation = useMemo(() => validateExpiry(expiry), [expiry]);\r\n    const cvvValidation = useMemo(() => validateCVV(cvv, cardBrand), [cvv, cardBrand]);\r\n    const nameValid = name.trim().length >= 2;\r\n\r\n    // Overall form validity\r\n    const isFormValid = cardValidation.isValid && expiryValidation.isValid && cvvValidation.isValid && nameValid;\r\n\r\n    // CRITICAL: Ref-based lock to prevent double payment\r\n    const paymentInFlightRef = useRef(false);\r\n\r\n    const handleCardNumberChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const formatted = formatCardNumber(e.target.value, cardBrand);\r\n        setCardNumber(formatted);\r\n    };\r\n\r\n    const handleExpiryChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        setExpiry(formatExpiry(e.target.value));\r\n    };\r\n\r\n    const handleCvvChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const maxLen = cardBrand?.cvvLength ?? 4;\r\n        setCvv(e.target.value.replace(/\\D/g, '').slice(0, maxLen));\r\n    };\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setError(\"\");\r\n\r\n        // CRITICAL: Double-click prevention\r\n        if (paymentInFlightRef.current) {\r\n            console.warn('âš ï¸ Payment already in flight, ignoring duplicate click');\r\n            return;\r\n        }\r\n\r\n        // Mark all fields as touched\r\n        setTouched({ cardNumber: true, expiry: true, cvv: true, name: true });\r\n\r\n        if (!isFormValid) {\r\n            setError(\"Please fix the errors above\");\r\n            return;\r\n        }\r\n\r\n        // Check if this is a decline test card\r\n        if (shouldDecline(cardNumber)) {\r\n            setStep('processing');\r\n            await new Promise(resolve => setTimeout(resolve, 1500));\r\n            setStep('declined');\r\n            return;\r\n        }\r\n\r\n        // Start processing\r\n        paymentInFlightRef.current = true;\r\n        setStep('processing');\r\n\r\n        try {\r\n            const response = await authenticatedFetch('/api/payments/process', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    courseId: course.id,\r\n                    amount: course.price,\r\n                    // Demo mode - don't send real card data\r\n                    cardLast4: cardNumber.replace(/\\D/g, '').slice(-4),\r\n                    cardBrand: cardBrand?.brand || 'unknown',\r\n                }),\r\n            });\r\n\r\n            const data = await response.json();\r\n\r\n            if (!response.ok) {\r\n                throw new Error(data.error || 'Payment failed');\r\n            }\r\n\r\n            // Show success\r\n            setStep('success');\r\n\r\n            // Wait a moment then callback\r\n            setTimeout(() => {\r\n                onSuccess(data.paymentId);\r\n            }, 2000);\r\n        } catch (err: any) {\r\n            paymentInFlightRef.current = false;\r\n            setError(err.message);\r\n            setStep('form');\r\n        }\r\n    };\r\n\r\n    const resetAndClose = () => {\r\n        paymentInFlightRef.current = false;\r\n        setStep('form');\r\n        setCardNumber(\"\");\r\n        setExpiry(\"\");\r\n        setCvv(\"\");\r\n        setName(\"\");\r\n        setError(\"\");\r\n        setTouched({});\r\n        onClose();\r\n    };\r\n\r\n    const getInputStyles = (field: string, validation: { isValid: boolean; isPotentiallyValid?: boolean }) => {\r\n        if (!touched[field]) return '';\r\n        if (validation.isValid) return 'border-green-500 focus:ring-green-500';\r\n        if (validation.isPotentiallyValid === false) return 'border-red-500 focus:ring-red-500';\r\n        return '';\r\n    };\r\n\r\n    return (\r\n        <AnimatePresence>\r\n            {isOpen && (\r\n                <motion.div\r\n                    initial={{ opacity: 0 }}\r\n                    animate={{ opacity: 1 }}\r\n                    exit={{ opacity: 0 }}\r\n                    className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4\"\r\n                    onClick={resetAndClose}\r\n                >\r\n                    <motion.div\r\n                        initial={{ scale: 0.95, opacity: 0 }}\r\n                        animate={{ scale: 1, opacity: 1 }}\r\n                        exit={{ scale: 0.95, opacity: 0 }}\r\n                        className=\"bg-white dark:bg-neutral-900 rounded-3xl shadow-2xl w-full max-w-md overflow-hidden\"\r\n                        onClick={e => e.stopPropagation()}\r\n                    >\r\n                        {/* Header */}\r\n                        <div className=\"relative p-6 border-b border-neutral-100 dark:border-neutral-800\">\r\n                            <button\r\n                                onClick={resetAndClose}\r\n                                className=\"absolute right-4 top-4 p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-full transition-colors\"\r\n                            >\r\n                                <X size={20} />\r\n                            </button>\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className=\"relative w-16 h-16 rounded-xl overflow-hidden bg-neutral-100\">\r\n                                    <Image\r\n                                        src={course.thumbnail}\r\n                                        alt={course.title}\r\n                                        fill\r\n                                        className=\"object-cover\"\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <p className=\"text-sm text-neutral-500\">Purchasing</p>\r\n                                    <h3 className=\"font-semibold text-lg line-clamp-1\">{course.title}</h3>\r\n                                    <div className=\"flex items-center gap-2 mt-1\">\r\n                                        <span className=\"text-xl font-bold text-green-600\">${course.price.toFixed(2)}</span>\r\n                                        {course.originalPrice && (\r\n                                            <span className=\"text-sm text-neutral-400 line-through\">${course.originalPrice.toFixed(2)}</span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Content */}\r\n                        <div className=\"p-6\">\r\n                            <AnimatePresence mode=\"wait\">\r\n                                {step === 'form' && (\r\n                                    <motion.form\r\n                                        key=\"form\"\r\n                                        initial={{ opacity: 0, x: -20 }}\r\n                                        animate={{ opacity: 1, x: 0 }}\r\n                                        exit={{ opacity: 0, x: 20 }}\r\n                                        onSubmit={handleSubmit}\r\n                                        className=\"space-y-4\"\r\n                                    >\r\n                                        {/* Demo Mode Notice */}\r\n                                        <div className=\"p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl text-sm\">\r\n                                            <div className=\"flex items-center gap-2 text-amber-700 dark:text-amber-400 font-medium mb-1\">\r\n                                                <AlertCircle size={16} />\r\n                                                Demo Mode\r\n                                            </div>\r\n                                            <p className=\"text-amber-600 dark:text-amber-500 text-xs\">\r\n                                                Use test card: <code className=\"bg-amber-100 dark:bg-amber-900/50 px-1 rounded\">4242 4242 4242 4242</code>\r\n                                            </p>\r\n                                        </div>\r\n\r\n                                        {error && (\r\n                                            <div className=\"p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm rounded-xl flex items-center gap-2\">\r\n                                                <AlertCircle size={16} />\r\n                                                {error}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        <div className=\"space-y-2\">\r\n                                            <Label>Cardholder Name</Label>\r\n                                            <Input\r\n                                                placeholder=\"John Doe\"\r\n                                                value={name}\r\n                                                onChange={(e) => setName(e.target.value)}\r\n                                                onBlur={() => setTouched(t => ({ ...t, name: true }))}\r\n                                                className={cn(touched.name && !nameValid && 'border-red-500')}\r\n                                                required\r\n                                            />\r\n                                            {touched.name && !nameValid && (\r\n                                                <p className=\"text-xs text-red-500\">Name is required</p>\r\n                                            )}\r\n                                        </div>\r\n\r\n                                        <div className=\"space-y-2\">\r\n                                            <Label>Card Number</Label>\r\n                                            <div className=\"relative\">\r\n                                                {/* Card brand icon */}\r\n                                                <div className=\"absolute left-3 top-1/2 -translate-y-1/2 w-6 h-6 flex items-center justify-center\">\r\n                                                    <CardBrandIcon brand={cardBrand?.brand} className=\"w-6 h-6\" />\r\n                                                </div>\r\n                                                <Input\r\n                                                    placeholder=\"4242 4242 4242 4242\"\r\n                                                    className={cn(\r\n                                                        \"pl-12 pr-10 font-mono\",\r\n                                                        getInputStyles('cardNumber', cardValidation)\r\n                                                    )}\r\n                                                    value={cardNumber}\r\n                                                    onChange={handleCardNumberChange}\r\n                                                    onBlur={() => setTouched(t => ({ ...t, cardNumber: true }))}\r\n                                                    required\r\n                                                />\r\n                                                {touched.cardNumber && cardValidation.isValid && (\r\n                                                    <CheckCircle className=\"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-green-500\" />\r\n                                                )}\r\n                                            </div>\r\n                                            {touched.cardNumber && cardValidation.error && (\r\n                                                <p className=\"text-xs text-red-500\">{cardValidation.error}</p>\r\n                                            )}\r\n                                        </div>\r\n\r\n                                        <div className=\"grid grid-cols-2 gap-4\">\r\n                                            <div className=\"space-y-2\">\r\n                                                <Label>Expiry</Label>\r\n                                                <Input\r\n                                                    placeholder=\"MM/YY\"\r\n                                                    className={cn(\r\n                                                        \"font-mono\",\r\n                                                        getInputStyles('expiry', expiryValidation)\r\n                                                    )}\r\n                                                    value={expiry}\r\n                                                    onChange={handleExpiryChange}\r\n                                                    onBlur={() => setTouched(t => ({ ...t, expiry: true }))}\r\n                                                    required\r\n                                                />\r\n                                                {touched.expiry && expiryValidation.error && (\r\n                                                    <p className=\"text-xs text-red-500\">{expiryValidation.error}</p>\r\n                                                )}\r\n                                            </div>\r\n                                            <div className=\"space-y-2\">\r\n                                                <Label>CVV</Label>\r\n                                                <Input\r\n                                                    placeholder={cardBrand?.brand === 'amex' ? '1234' : '123'}\r\n                                                    className={cn(\r\n                                                        \"font-mono\",\r\n                                                        getInputStyles('cvv', cvvValidation)\r\n                                                    )}\r\n                                                    type=\"password\"\r\n                                                    value={cvv}\r\n                                                    onChange={handleCvvChange}\r\n                                                    onBlur={() => setTouched(t => ({ ...t, cvv: true }))}\r\n                                                    required\r\n                                                />\r\n                                                {touched.cvv && cvvValidation.error && (\r\n                                                    <p className=\"text-xs text-red-500\">{cvvValidation.error}</p>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"pt-2\">\r\n                                            <Button\r\n                                                type=\"submit\"\r\n                                                disabled={!isFormValid}\r\n                                                className={cn(\r\n                                                    \"w-full h-12 text-base transition-all\",\r\n                                                    cardBrand ? `bg-gradient-to-r ${BRAND_COLORS[cardBrand.brand] || 'from-green-600 to-emerald-600'}` : 'bg-gradient-to-r from-green-600 to-emerald-600',\r\n                                                    \"hover:opacity-90 disabled:opacity-50\"\r\n                                                )}\r\n                                            >\r\n                                                <Lock size={16} className=\"mr-2\" />\r\n                                                Pay ${course.price.toFixed(2)}\r\n                                            </Button>\r\n                                        </div>\r\n\r\n                                        <p className=\"text-xs text-center text-neutral-400 flex items-center justify-center gap-1\">\r\n                                            <Lock size={12} />\r\n                                            Demo payment - no real charges\r\n                                        </p>\r\n                                    </motion.form>\r\n                                )}\r\n\r\n                                {step === 'processing' && (\r\n                                    <motion.div\r\n                                        key=\"processing\"\r\n                                        initial={{ opacity: 0, scale: 0.9 }}\r\n                                        animate={{ opacity: 1, scale: 1 }}\r\n                                        exit={{ opacity: 0, scale: 0.9 }}\r\n                                        className=\"py-12 text-center\"\r\n                                    >\r\n                                        <Loader2 className=\"w-16 h-16 mx-auto text-green-600 animate-spin mb-4\" />\r\n                                        <h3 className=\"text-xl font-semibold mb-2\">Processing Payment</h3>\r\n                                        <p className=\"text-neutral-500\">Please wait while we process your payment...</p>\r\n                                    </motion.div>\r\n                                )}\r\n\r\n                                {step === 'success' && (\r\n                                    <motion.div\r\n                                        key=\"success\"\r\n                                        initial={{ opacity: 0, scale: 0.9 }}\r\n                                        animate={{ opacity: 1, scale: 1 }}\r\n                                        exit={{ opacity: 0, scale: 0.9 }}\r\n                                        className=\"py-12 text-center\"\r\n                                    >\r\n                                        <motion.div\r\n                                            initial={{ scale: 0 }}\r\n                                            animate={{ scale: 1 }}\r\n                                            transition={{ delay: 0.2, type: \"spring\" }}\r\n                                            className=\"w-20 h-20 mx-auto bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-4\"\r\n                                        >\r\n                                            <CheckCircle className=\"w-10 h-10 text-green-600\" />\r\n                                        </motion.div>\r\n                                        <h3 className=\"text-xl font-semibold mb-2\">Payment Successful!</h3>\r\n                                        <p className=\"text-neutral-500\">Redirecting to your course...</p>\r\n                                    </motion.div>\r\n                                )}\r\n\r\n                                {step === 'declined' && (\r\n                                    <motion.div\r\n                                        key=\"declined\"\r\n                                        initial={{ opacity: 0, scale: 0.9 }}\r\n                                        animate={{ opacity: 1, scale: 1 }}\r\n                                        exit={{ opacity: 0, scale: 0.9 }}\r\n                                        className=\"py-12 text-center\"\r\n                                    >\r\n                                        <motion.div\r\n                                            initial={{ scale: 0 }}\r\n                                            animate={{ scale: 1, rotate: [0, -10, 10, 0] }}\r\n                                            transition={{ delay: 0.2, type: \"spring\" }}\r\n                                            className=\"w-20 h-20 mx-auto bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-4\"\r\n                                        >\r\n                                            <X className=\"w-10 h-10 text-red-600\" />\r\n                                        </motion.div>\r\n                                        <h3 className=\"text-xl font-semibold mb-2 text-red-600\">Payment Declined</h3>\r\n                                        <p className=\"text-neutral-500 mb-4\">Your card was declined. Please try a different card.</p>\r\n                                        <Button\r\n                                            variant=\"outline\"\r\n                                            onClick={() => {\r\n                                                setStep('form');\r\n                                                setCardNumber('');\r\n                                            }}\r\n                                        >\r\n                                            Try Again\r\n                                        </Button>\r\n                                    </motion.div>\r\n                                )}\r\n                            </AnimatePresence>\r\n                        </div>\r\n                    </motion.div>\r\n                </motion.div>\r\n            )}\r\n        </AnimatePresence>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\providers\\SessionProvider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":45,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":45,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":73,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'user'. Either include it or remove the dependency array.","line":179,"column":8,"nodeType":"ArrayExpression","endLine":179,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [broadcastSessionChange, user]","fix":{"range":[7706,7730],"text":"[broadcastSessionChange, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { createContext, useContext, useEffect, useState, useCallback, useRef } from \"react\";\r\nimport { onAuthStateChanged, User as FirebaseUser } from \"firebase/auth\";\r\nimport { getFirebaseAuth, isFirebaseEnabled } from \"@/lib/firebase/config\";\r\nimport { getUserProfile } from \"@/lib/firebase/firestore\";\r\nimport { firebaseAuth } from \"@/lib/firebase/auth\";\r\nimport { User } from \"@/lib/types\";\r\nimport { localCache } from \"@/lib/storage/local-cache\";\r\nimport { authCookies } from \"@/lib/auth/cookies\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\ninterface SessionContextType {\r\n    user: User | null;\r\n    isLoading: boolean;\r\n    isAuthenticated: boolean;\r\n    refreshSession: () => Promise<void>;\r\n}\r\n\r\nconst SessionContext = createContext<SessionContextType>({\r\n    user: null,\r\n    isLoading: true,\r\n    isAuthenticated: false,\r\n    refreshSession: async () => { },\r\n});\r\n\r\nexport const useSession = () => useContext(SessionContext);\r\n\r\n// Cross-tab session sync channel\r\nconst SESSION_CHANNEL = \"gakuen-session-sync\";\r\n\r\nexport function SessionProvider({ children }: { children: React.ReactNode }) {\r\n    const [user, setUser] = useState<User | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const authCheckCompleted = useRef(false);\r\n    const isMountedRef = useRef(true); // Track mounted state to prevent setState after unmount\r\n\r\n    // Broadcast session changes to other tabs\r\n    const broadcastSessionChange = useCallback((action: \"login\" | \"logout\", userData?: User) => {\r\n        if (typeof window === \"undefined\") return;\r\n        try {\r\n            const channel = new BroadcastChannel(SESSION_CHANNEL);\r\n            channel.postMessage({ action, user: userData });\r\n            channel.close();\r\n        } catch (e) {\r\n            // BroadcastChannel not supported - fallback to localStorage event\r\n            localStorage.setItem(\"session-sync\", JSON.stringify({ action, timestamp: Date.now() }));\r\n        }\r\n    }, []);\r\n\r\n    // Handle session sync from other tabs\r\n    useEffect(() => {\r\n        if (typeof window === \"undefined\") return;\r\n\r\n        const handleMessage = (event: MessageEvent) => {\r\n            if (event.data.action === \"logout\") {\r\n                setUser(null);\r\n                localCache.clear();\r\n                authCookies.clear();\r\n            } else if (event.data.action === \"login\" && event.data.user) {\r\n                setUser(event.data.user);\r\n                localCache.user.set(event.data.user);\r\n            }\r\n        };\r\n\r\n        try {\r\n            const channel = new BroadcastChannel(SESSION_CHANNEL);\r\n            channel.addEventListener(\"message\", handleMessage);\r\n            return () => {\r\n                channel.removeEventListener(\"message\", handleMessage);\r\n                channel.close();\r\n            };\r\n        } catch (e) {\r\n            // Fallback: listen to storage events\r\n            const handleStorage = (e: StorageEvent) => {\r\n                if (e.key === \"session-sync\") {\r\n                    // Reload session from cache\r\n                    const cached = localCache.user.get() as User | null;\r\n                    setUser(cached);\r\n                }\r\n            };\r\n            window.addEventListener(\"storage\", handleStorage);\r\n            return () => window.removeEventListener(\"storage\", handleStorage);\r\n        }\r\n    }, []);\r\n\r\n    // Main Firebase auth state listener\r\n    useEffect(() => {\r\n        if (!isFirebaseEnabled()) {\r\n            setIsLoading(false);\r\n            return;\r\n        }\r\n\r\n        const auth = getFirebaseAuth();\r\n        if (!auth) {\r\n            setIsLoading(false);\r\n            return;\r\n        }\r\n\r\n        // Failsafe: ensure loading completes even if Firebase hangs\r\n        const timeout = setTimeout(() => {\r\n            if (!authCheckCompleted.current) {\r\n                logger.warn('Firebase auth timeout, setting loading to false', null, 'SessionProvider');\r\n                authCheckCompleted.current = true;\r\n                setIsLoading(false);\r\n            }\r\n        }, 3000); // 3 seconds timeout\r\n\r\n        const unsubscribe = onAuthStateChanged(auth, async (firebaseUser: FirebaseUser | null) => {\r\n            // Mark auth check as completed\r\n            authCheckCompleted.current = true;\r\n\r\n            // Prevent setState on unmounted component\r\n            if (!isMountedRef.current) return;\r\n\r\n            if (firebaseUser) {\r\n                // Firebase has a user - validate/update local session\r\n                const localUser = localCache.user.get() as User | null;\r\n\r\n                if (localUser && localUser.id === firebaseUser.uid) {\r\n                    // Session matches - use local cache\r\n                    setUser(localUser);\r\n                } else {\r\n                    // Session mismatch or new login - fetch fresh profile\r\n                    // This happens after hard refresh when localStorage is cleared\r\n                    try {\r\n                        // CRITICAL: Refresh server-side httpOnly cookie first\r\n                        // The proxy checks this cookie, and it may have expired or be missing\r\n                        logger.info('Session mismatch detected, refreshing server-side cookie...', null, 'SessionProvider');\r\n                        await firebaseAuth.refreshSession();\r\n\r\n                        const profile = await getUserProfile(firebaseUser.uid);\r\n                        if (profile) {\r\n                            setUser(profile);\r\n                            localCache.user.set(profile);\r\n                            authCookies.set(profile);\r\n                            broadcastSessionChange(\"login\", profile);\r\n                            logger.info('Session regenerated successfully', { userId: profile.id }, 'SessionProvider');\r\n                        } else {\r\n                            // User exists in Auth but not Firestore - CREATE the profile (hybrid sync)\r\n                            logger.warn('User exists in Auth but not Firestore - creating profile', { uid: firebaseUser.uid }, 'SessionProvider');\r\n\r\n                            const { createUserProfile } = await import('@/lib/firebase/firestore');\r\n                            const newProfile = await createUserProfile({\r\n                                id: firebaseUser.uid,\r\n                                email: firebaseUser.email || '',\r\n                                name: firebaseUser.displayName || 'User',\r\n                                role: 'student', // Default role, will be overridden by custom claims if admin\r\n                            });\r\n\r\n                            setUser(newProfile);\r\n                            localCache.user.set(newProfile);\r\n                            authCookies.set(newProfile);\r\n                            broadcastSessionChange(\"login\", newProfile);\r\n                            logger.info('Profile created successfully', { userId: newProfile.id }, 'SessionProvider');\r\n                        }\r\n                    } catch (error) {\r\n                        console.error(\"Failed to fetch user profile:\", error);\r\n                        setUser(null);\r\n                    }\r\n                }\r\n            } else {\r\n                // Firebase logged out - clear everything\r\n                if (user) {\r\n                    broadcastSessionChange(\"logout\");\r\n                }\r\n                setUser(null);\r\n                localCache.clear();\r\n                authCookies.clear();\r\n            }\r\n            setIsLoading(false);\r\n        });\r\n\r\n        return () => {\r\n            isMountedRef.current = false;\r\n            clearTimeout(timeout);\r\n            unsubscribe();\r\n        };\r\n    }, [broadcastSessionChange]); // Removed user and isLoading from deps to prevent infinite loops\r\n\r\n    const refreshSession = useCallback(async () => {\r\n        const cached = localCache.user.get() as User | null;\r\n        setUser(cached);\r\n    }, []);\r\n\r\n    return (\r\n        <SessionContext.Provider\r\n            value={{\r\n                user,\r\n                isLoading,\r\n                isAuthenticated: !!user,\r\n                refreshSession,\r\n            }}\r\n        >\r\n            {children}\r\n        </SessionContext.Provider>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\subscription\\SubscriptionWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\theme\\ThemeProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\theme\\ThemeSwitcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\theme\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\SimpleModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Trash2' is defined but never used.","line":3,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":3,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { X, AlertTriangle, Trash2, Info, Check } from \"lucide-react\";\r\nimport { useEffect, useRef, ReactNode } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\n\r\ninterface SimpleModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onConfirm: () => void;\r\n    title: string;\r\n    description?: string;\r\n    children?: ReactNode;\r\n    isDestructive?: boolean;\r\n    isLoading?: boolean;\r\n    confirmText?: string;\r\n    cancelText?: string;\r\n    icon?: ReactNode;\r\n}\r\n\r\nexport function SimpleModal({\r\n    isOpen,\r\n    onClose,\r\n    onConfirm,\r\n    title,\r\n    description,\r\n    children,\r\n    isDestructive = false,\r\n    isLoading = false,\r\n    confirmText = \"Delete\",\r\n    cancelText = \"Cancel\",\r\n    icon\r\n}: SimpleModalProps) {\r\n    const modalRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Close on escape\r\n    useEffect(() => {\r\n        const handleEscape = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') onClose();\r\n        };\r\n        if (isOpen) window.addEventListener('keydown', handleEscape);\r\n        return () => window.removeEventListener('keydown', handleEscape);\r\n    }, [isOpen, onClose]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    // Default icon based on destructive state\r\n    const defaultIcon = isDestructive\r\n        ? <AlertTriangle size={20} />\r\n        : <Info size={20} />;\r\n\r\n    // Use portal to render at body level\r\n    return createPortal(\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n            {/* Backdrop */}\r\n            <div\r\n                className=\"absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity\"\r\n                onClick={onClose}\r\n            />\r\n\r\n            {/* Modal */}\r\n            <div\r\n                ref={modalRef}\r\n                className=\"relative bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-md shadow-2xl p-6 transform transition-all scale-100 opacity-100\"\r\n            >\r\n                <div className=\"flex items-start justify-between mb-4\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className={`p-2 rounded-full ${isDestructive\r\n                                ? 'bg-red-500/20 text-red-500'\r\n                                : 'bg-blue-500/20 text-blue-500'\r\n                            }`}>\r\n                            {icon || defaultIcon}\r\n                        </div>\r\n                        <h3 className=\"text-lg font-bold text-white\">{title}</h3>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"text-zinc-500 hover:text-white transition-colors\"\r\n                        disabled={isLoading}\r\n                    >\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                {description && (\r\n                    <p className=\"text-zinc-400 mb-6 leading-relaxed\">\r\n                        {description}\r\n                    </p>\r\n                )}\r\n\r\n                {children && (\r\n                    <div className=\"mb-6\">\r\n                        {children}\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"flex justify-end gap-3\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        disabled={isLoading}\r\n                        className=\"px-4 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-white/5 transition-colors\"\r\n                    >\r\n                        {cancelText}\r\n                    </button>\r\n                    <button\r\n                        onClick={onConfirm}\r\n                        disabled={isLoading}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2\r\n                            ${isDestructive\r\n                                ? 'bg-red-600 hover:bg-red-500 shadow-red-500/20'\r\n                                : 'bg-blue-600 hover:bg-blue-500 shadow-blue-500/20'}\r\n                            ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}\r\n                        `}\r\n                    >\r\n                        {isLoading ? (\r\n                            <>\r\n                                <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\r\n                                Processing...\r\n                            </>\r\n                        ) : (\r\n                            confirmText\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>,\r\n        document.body\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\Skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\confirm-modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\phone-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\upload\\AvatarUpload.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":62,"column":21,"nodeType":"JSXOpeningElement","endLine":66,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useRef, useState } from 'react';\r\nimport { Camera, Loader2, User } from 'lucide-react';\r\nimport { useUpload } from '@/lib/hooks/useUpload';\r\nimport { cn } from '@/lib/utils';\r\n\r\ninterface AvatarUploadProps {\r\n    userId: string;\r\n    currentAvatar?: string;\r\n    onUpload: (url: string) => void;\r\n    size?: 'sm' | 'md' | 'lg';\r\n}\r\n\r\nconst SIZES = {\r\n    sm: 'w-12 h-12',\r\n    md: 'w-20 h-20',\r\n    lg: 'w-32 h-32'\r\n};\r\n\r\nexport function AvatarUpload({ userId, currentAvatar, onUpload, size = 'md' }: AvatarUploadProps) {\r\n    const inputRef = useRef<HTMLInputElement>(null);\r\n    const [preview, setPreview] = useState<string | null>(null);\r\n\r\n    const { upload, isUploading } = useUpload({\r\n        type: 'avatar',\r\n        id: userId,\r\n        onSuccess: (result) => {\r\n            setPreview(result.url);\r\n            onUpload(result.url);\r\n        }\r\n    });\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n\r\n        // Show instant preview\r\n        const reader = new FileReader();\r\n        reader.onload = () => setPreview(reader.result as string);\r\n        reader.readAsDataURL(file);\r\n\r\n        // Upload\r\n        await upload(file);\r\n    };\r\n\r\n    const displayImage = preview || currentAvatar;\r\n\r\n    return (\r\n        <div className=\"relative group\">\r\n            <button\r\n                type=\"button\"\r\n                onClick={() => inputRef.current?.click()}\r\n                disabled={isUploading}\r\n                className={cn(\r\n                    \"rounded-full overflow-hidden bg-zinc-800 flex items-center justify-center transition-all\",\r\n                    \"hover:ring-2 hover:ring-blue-500/50\",\r\n                    SIZES[size]\r\n                )}\r\n            >\r\n                {displayImage ? (\r\n                    <img\r\n                        src={displayImage}\r\n                        alt=\"Avatar\"\r\n                        className=\"w-full h-full object-cover\"\r\n                    />\r\n                ) : (\r\n                    <User className=\"w-1/2 h-1/2 text-zinc-500\" />\r\n                )}\r\n\r\n                {/* Overlay */}\r\n                <div className={cn(\r\n                    \"absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full\",\r\n                    isUploading && \"opacity-100\"\r\n                )}>\r\n                    {isUploading ? (\r\n                        <Loader2 className=\"w-6 h-6 text-white animate-spin\" />\r\n                    ) : (\r\n                        <Camera className=\"w-6 h-6 text-white\" />\r\n                    )}\r\n                </div>\r\n            </button>\r\n\r\n            <input\r\n                ref={inputRef}\r\n                type=\"file\"\r\n                accept=\"image/*\"\r\n                onChange={handleFileSelect}\r\n                className=\"hidden\"\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\upload\\ImageUpload.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":103,"column":25,"nodeType":"JSXOpeningElement","endLine":107,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useRef, useState } from 'react';\r\nimport { ImagePlus, Loader2, X, Image as ImageIcon } from 'lucide-react';\r\nimport { useUpload } from '@/lib/hooks/useUpload';\r\nimport { cn } from '@/lib/utils';\r\n\r\ninterface ImageUploadProps {\r\n    type: 'course' | 'lesson' | 'cms';\r\n    id?: string;\r\n    courseId?: string;\r\n    currentImage?: string;\r\n    onUpload: (url: string, metadata?: { width: number; height: number }) => void;\r\n    onRemove?: () => void;\r\n    aspectRatio?: 'square' | 'video' | 'banner' | 'free';\r\n    className?: string;\r\n}\r\n\r\nconst ASPECT_RATIOS = {\r\n    square: 'aspect-square',\r\n    video: 'aspect-video',\r\n    banner: 'aspect-[3/1]',\r\n    free: ''\r\n};\r\n\r\nexport function ImageUpload({\r\n    type,\r\n    id,\r\n    courseId,\r\n    currentImage,\r\n    onUpload,\r\n    onRemove,\r\n    aspectRatio = 'video',\r\n    className\r\n}: ImageUploadProps) {\r\n    const inputRef = useRef<HTMLInputElement>(null);\r\n    const [preview, setPreview] = useState<string | null>(null);\r\n    const [isDragging, setIsDragging] = useState(false);\r\n\r\n    const { upload, isUploading, progress } = useUpload({\r\n        type,\r\n        id,\r\n        courseId,\r\n        onSuccess: (result) => {\r\n            setPreview(result.url);\r\n            onUpload(result.url, { width: result.width, height: result.height });\r\n        }\r\n    });\r\n\r\n    const handleFileSelect = async (file: File) => {\r\n        if (!file.type.startsWith('image/')) return;\r\n\r\n        // Show instant preview\r\n        const reader = new FileReader();\r\n        reader.onload = () => setPreview(reader.result as string);\r\n        reader.readAsDataURL(file);\r\n\r\n        // Upload\r\n        await upload(file);\r\n    };\r\n\r\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (file) handleFileSelect(file);\r\n    };\r\n\r\n    const handleDrop = (e: React.DragEvent) => {\r\n        e.preventDefault();\r\n        setIsDragging(false);\r\n        const file = e.dataTransfer.files[0];\r\n        if (file) handleFileSelect(file);\r\n    };\r\n\r\n    const handleDragOver = (e: React.DragEvent) => {\r\n        e.preventDefault();\r\n        setIsDragging(true);\r\n    };\r\n\r\n    const handleDragLeave = () => setIsDragging(false);\r\n\r\n    const displayImage = preview || currentImage;\r\n\r\n    return (\r\n        <div className={cn(\"relative group\", className)}>\r\n            <div\r\n                onClick={() => !displayImage && inputRef.current?.click()}\r\n                onDrop={handleDrop}\r\n                onDragOver={handleDragOver}\r\n                onDragLeave={handleDragLeave}\r\n                className={cn(\r\n                    \"relative overflow-hidden rounded-xl border-2 border-dashed transition-all cursor-pointer\",\r\n                    ASPECT_RATIOS[aspectRatio],\r\n                    displayImage\r\n                        ? \"border-transparent\"\r\n                        : isDragging\r\n                            ? \"border-blue-500 bg-blue-500/10\"\r\n                            : \"border-zinc-700 hover:border-zinc-600 bg-zinc-900\",\r\n                    isUploading && \"pointer-events-none\"\r\n                )}\r\n            >\r\n                {displayImage ? (\r\n                    <>\r\n                        <img\r\n                            src={displayImage}\r\n                            alt=\"Uploaded\"\r\n                            className=\"w-full h-full object-cover\"\r\n                        />\r\n\r\n                        {/* Actions overlay */}\r\n                        <div className=\"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2\">\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    inputRef.current?.click();\r\n                                }}\r\n                                className=\"p-2 bg-white/20 hover:bg-white/30 rounded-lg text-white transition-colors\"\r\n                            >\r\n                                <ImagePlus className=\"w-5 h-5\" />\r\n                            </button>\r\n                            {onRemove && (\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation();\r\n                                        setPreview(null);\r\n                                        onRemove();\r\n                                    }}\r\n                                    className=\"p-2 bg-red-500/50 hover:bg-red-500/70 rounded-lg text-white transition-colors\"\r\n                                >\r\n                                    <X className=\"w-5 h-5\" />\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    </>\r\n                ) : (\r\n                    <div className=\"absolute inset-0 flex flex-col items-center justify-center text-zinc-500\">\r\n                        <ImageIcon className=\"w-10 h-10 mb-2\" />\r\n                        <span className=\"text-sm\">Drop image or click to upload</span>\r\n                        <span className=\"text-xs text-zinc-600 mt-1\">Auto-converts to WebP</span>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Upload progress */}\r\n                {isUploading && (\r\n                    <div className=\"absolute inset-0 bg-black/70 flex flex-col items-center justify-center\">\r\n                        <Loader2 className=\"w-8 h-8 text-blue-500 animate-spin mb-2\" />\r\n                        <div className=\"w-32 h-1 bg-zinc-700 rounded-full overflow-hidden\">\r\n                            <div\r\n                                className=\"h-full bg-blue-500 transition-all duration-300\"\r\n                                style={{ width: `${progress}%` }}\r\n                            />\r\n                        </div>\r\n                        <span className=\"text-xs text-zinc-400 mt-2\">Compressing...</span>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <input\r\n                ref={inputRef}\r\n                type=\"file\"\r\n                accept=\"image/*\"\r\n                onChange={handleInputChange}\r\n                className=\"hidden\"\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\components\\upload\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\hooks\\useRequireAdmin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\hooks\\useRole.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\admin\\feature-flags.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\ai\\gemini-flash.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\ai\\gemini.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\ai\\recommendations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\ai\\translation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\analytics\\consent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\analytics\\firestore-analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\analytics\\tracker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\auth-guard.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[511,514],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[511,514],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { getClientIP } from './rate-limit';\r\n\r\n// Minimal User interface to replace dependency on demo-data\r\nexport interface User {\r\n    id: string;\r\n    email: string;\r\n    name: string;\r\n    role: \"admin\" | \"student\";  // 'user' is legacy\r\n    avatar?: string;\r\n    username?: string;\r\n    enrolledCourses?: string[];\r\n    completedLessons?: string[];\r\n    subscription?: {\r\n        tier: string;\r\n        status: string;\r\n    };\r\n    [key: string]: any;\r\n}\r\n\r\n// In-memory set to track users with pending/completed profile creation\r\n// Prevents log spam from concurrent API requests\r\nconst profileCreationPending = new Set<string>();\r\n\r\n/**\r\n * Authentication result type\r\n */\r\ntype AuthResult =\r\n    | { authenticated: true; user: User }\r\n    | { authenticated: false; response: NextResponse };\r\n\r\n/**\r\n * Validate user session from cookie and fetch real profile from Firestore\r\n * Returns user data if authenticated, error response if not\r\n */\r\nexport async function requireAuth(request: NextRequest): Promise<AuthResult> {\r\n    try {\r\n        // Get session cookie\r\n        const token = request.cookies.get('firebase-token')?.value;\r\n\r\n        if (!token) {\r\n            return {\r\n                authenticated: false,\r\n                response: NextResponse.json(\r\n                    { error: 'Authentication required' },\r\n                    { status: 401 }\r\n                )\r\n            };\r\n        }\r\n\r\n        // Validate token (Session Cookie - created via createSessionCookie in /api/auth/set-token)\r\n        const { verifySessionCookie } = await import('@/lib/auth/validateToken');\r\n        const decodedUser = await verifySessionCookie(token);\r\n\r\n        if (!decodedUser || !decodedUser.uid) {\r\n            return {\r\n                authenticated: false,\r\n                response: NextResponse.json(\r\n                    { error: 'Invalid session' },\r\n                    { status: 401 }\r\n                )\r\n            };\r\n        }\r\n\r\n        // Fetch user profile from Firestore using Admin SDK (secure server-side)\r\n        const { getAdminUserProfile } = await import('@/lib/firebase/firestore-admin');\r\n        const profile = await getAdminUserProfile(decodedUser.uid);\r\n\r\n        let user: User;\r\n\r\n        if (profile) {\r\n            // Use real profile data from Firestore (most common case)\r\n            // Normalize role: 'user' is legacy, map it to 'student'\r\n            const normalizedRole: \"admin\" | \"student\" = profile.role === 'admin' ? 'admin' : 'student';\r\n            user = {\r\n                id: profile.id,\r\n                name: profile.name || 'User',\r\n                email: profile.email || decodedUser.email || '',\r\n                role: normalizedRole,\r\n                avatar: profile.avatar,\r\n                username: profile.username,\r\n                enrolledCourses: profile.enrolledCourses || [],\r\n                completedLessons: profile.completedLessons || [],\r\n                subscription: profile.subscription,\r\n                createdAt: profile.createdAt,\r\n            };\r\n        } else {\r\n            // User exists in Auth but not Firestore\r\n            user = {\r\n                id: decodedUser.uid,\r\n                name: decodedUser.name || 'User',\r\n                email: decodedUser.email || '',\r\n                role: (decodedUser.role as \"admin\" | \"student\") || 'student',\r\n                enrolledCourses: [],\r\n                completedLessons: [],\r\n            };\r\n\r\n            // Only create profile if not already pending (prevents log spam from concurrent requests)\r\n            if (!profileCreationPending.has(decodedUser.uid)) {\r\n                profileCreationPending.add(decodedUser.uid);\r\n                console.log(`ðŸ“ Creating Firestore profile for legacy user: ${decodedUser.uid} (${decodedUser.email})`);\r\n\r\n                // Create profile in background using Admin SDK (secure server-side)\r\n                import('@/lib/firebase/firestore-admin').then(({ createAdminUserProfile }) => {\r\n                    createAdminUserProfile({\r\n                        id: user.id,\r\n                        email: user.email,\r\n                        name: user.name,\r\n                        role: user.role,\r\n                        enrolledCourses: [],\r\n                        completedLessons: [],\r\n                        createdAt: new Date().toISOString(),\r\n                    }).then(() => {\r\n                        console.log(`âœ… Created Firestore profile for legacy user: ${user.id}`);\r\n                    }).catch((err) => {\r\n                        console.error(`âŒ Failed to create Firestore profile for legacy user: ${user.id}`, err);\r\n                        // Remove from pending so it can be retried on next request\r\n                        profileCreationPending.delete(user.id);\r\n                    });\r\n                });\r\n            }\r\n        }\r\n\r\n        return { authenticated: true, user };\r\n    } catch (error) {\r\n        console.error('Auth guard error:', error);\r\n        return {\r\n            authenticated: false,\r\n            response: NextResponse.json(\r\n                { error: 'Authentication failed' },\r\n                { status: 401 }\r\n            )\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Check if user has admin role\r\n * Role is verified from Firestore (not just JWT claims)\r\n */\r\nexport async function requireAdmin(request: NextRequest): Promise<AuthResult> {\r\n    const authResult = await requireAuth(request);\r\n\r\n    if (!authResult.authenticated) {\r\n        return authResult;\r\n    }\r\n\r\n    // Role is now from Firestore (not JWT), making role changes immediate\r\n    if (authResult.user.role !== 'admin') {\r\n        // Log unauthorized admin access attempts\r\n        const clientIP = getClientIP(request);\r\n        console.warn(`âš ï¸ Unauthorized admin access attempt by: ${authResult.user.email} (IP: ${clientIP})`);\r\n        return {\r\n            authenticated: false,\r\n            response: NextResponse.json(\r\n                { error: 'Admin access required' },\r\n                { status: 403 }\r\n            )\r\n        };\r\n    }\r\n\r\n    return authResult;\r\n}\r\n\r\n/**\r\n * Safe error response - never expose internal details\r\n */\r\nexport function safeErrorResponse(error: unknown, defaultMessage = 'Internal server error'): NextResponse {\r\n    // Log full error internally\r\n    console.error('API Error:', error);\r\n\r\n    // Return generic message to client\r\n    return NextResponse.json(\r\n        { error: defaultMessage },\r\n        { status: 500 }\r\n    );\r\n}\r\n\r\n/**\r\n * Verify request signature (HMAC)\r\n * Use this for sensitive endpoints that need tamper-proof requests\r\n */\r\nexport async function requireSignedRequest(request: NextRequest): Promise<{ valid: boolean; response?: NextResponse }> {\r\n    const signature = request.headers.get('X-Signature');\r\n    const timestampStr = request.headers.get('X-Timestamp');\r\n\r\n    if (!signature || !timestampStr) {\r\n        return {\r\n            valid: false,\r\n            response: NextResponse.json(\r\n                { error: 'Missing request signature' },\r\n                { status: 401 }\r\n            )\r\n        };\r\n    }\r\n\r\n    const timestamp = parseInt(timestampStr, 10);\r\n    if (isNaN(timestamp)) {\r\n        return {\r\n            valid: false,\r\n            response: NextResponse.json(\r\n                { error: 'Invalid timestamp' },\r\n                { status: 400 }\r\n            )\r\n        };\r\n    }\r\n\r\n    // Get request details for signature verification\r\n    const { pathname } = new URL(request.url);\r\n    const method = request.method;\r\n\r\n    // Clone request to read body\r\n    const body = request.method !== 'GET' && request.method !== 'HEAD'\r\n        ? await request.clone().text()\r\n        : '';\r\n\r\n    // Import and verify signature\r\n    const { verifySignature } = await import('./signing');\r\n    const result = await verifySignature(method, pathname, body, timestamp, signature);\r\n\r\n    if (!result.valid) {\r\n        console.warn(`âš ï¸ Invalid signature for ${method} ${pathname}: ${result.error}`);\r\n        return {\r\n            valid: false,\r\n            response: NextResponse.json(\r\n                { error: result.error || 'Invalid signature' },\r\n                { status: 401 }\r\n            )\r\n        };\r\n    }\r\n\r\n    return { valid: true };\r\n}\r\n\r\n/**\r\n * Type for API route handler\r\n */\r\ntype APIHandler = (request: NextRequest, context?: { params?: Promise<Record<string, string>> }) => Promise<NextResponse | void>;\r\n\r\n/**\r\n * Wrapper that combines authentication + analytics tracking\r\n * Use this for all protected API routes to automatically track usage\r\n * \r\n * @example\r\n * export const POST = withAuthTracked(async (request, { user }) => {\r\n *     // Your API logic here\r\n *     return NextResponse.json({ success: true });\r\n * });\r\n */\r\nexport function withAuthTracked(\r\n    handler: (request: NextRequest, context: { user: User; params?: Record<string, string> }) => Promise<NextResponse | void>,\r\n    options?: { requireAdmin?: boolean }\r\n): APIHandler {\r\n    return async (request: NextRequest, routeContext?: { params?: Promise<Record<string, string>> }) => {\r\n        const startTime = Date.now();\r\n        const { pathname } = new URL(request.url);\r\n        const method = request.method;\r\n\r\n        // Authenticate\r\n        const authResult = options?.requireAdmin\r\n            ? await requireAdmin(request)\r\n            : await requireAuth(request);\r\n\r\n        if (!authResult.authenticated) {\r\n            // Track failed auth attempts too\r\n            trackAPICallBackground({\r\n                endpoint: pathname,\r\n                method,\r\n                duration: Date.now() - startTime,\r\n                statusCode: 401,\r\n            });\r\n            return authResult.response;\r\n        }\r\n\r\n        try {\r\n            // Await params if they are a promise (Next.js 15/16)\r\n            // Explicitly handle potentially undefined routeContext or params\r\n            const paramsPromise = routeContext?.params;\r\n            const params = paramsPromise ? await paramsPromise : undefined;\r\n\r\n            // Execute handler with resolved params\r\n            const response = await handler(request, {\r\n                user: authResult.user,\r\n                params: params\r\n            });\r\n\r\n            // Track successful call\r\n            trackAPICallBackground({\r\n                endpoint: pathname,\r\n                method,\r\n                userId: authResult.user.id,\r\n                userEmail: authResult.user.email,\r\n                duration: Date.now() - startTime,\r\n                statusCode: response?.status ?? 204,\r\n            });\r\n\r\n            return response;\r\n        } catch (error) {\r\n            // Track errors\r\n            trackAPICallBackground({\r\n                endpoint: pathname,\r\n                method,\r\n                userId: authResult.user.id,\r\n                userEmail: authResult.user.email,\r\n                duration: Date.now() - startTime,\r\n                statusCode: 500,\r\n            });\r\n            throw error;\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Track API call in background (non-blocking)\r\n */\r\nfunction trackAPICallBackground(data: {\r\n    endpoint: string;\r\n    method: string;\r\n    userId?: string;\r\n    userEmail?: string;\r\n    duration: number;\r\n    statusCode: number;\r\n    model?: string;\r\n    cost?: number;\r\n}): void {\r\n    // Import and track asynchronously to not block the response\r\n    import('@/lib/analytics/firestore-analytics').then(({ trackAPICall }) => {\r\n        trackAPICall(data).catch(err => {\r\n            console.error('Failed to track API call:', err);\r\n        });\r\n    });\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\authenticated-fetch.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\courseApi.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\pricing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\rate-limit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\signedFetch.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\signing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\api\\validators.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1211,1214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1211,1214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1513,1516],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1513,1516],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import path from 'path';\r\n\r\n/**\r\n * Allowed file MIME types for uploads\r\n */\r\nexport const ALLOWED_IMAGE_TYPES = [\r\n    'image/jpeg',\r\n    'image/png',\r\n    'image/gif',\r\n    'image/webp',\r\n    'image/svg+xml',\r\n] as const;\r\n\r\nexport const ALLOWED_FILE_EXTENSIONS = [\r\n    '.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'\r\n] as const;\r\n\r\n/**\r\n * Sanitize path to prevent traversal attacks\r\n * Removes ../, ..\\, leading slashes, and dangerous characters\r\n */\r\nexport function sanitizePath(input: string): string {\r\n    if (!input || typeof input !== 'string') {\r\n        return '';\r\n    }\r\n\r\n    return input\r\n        // Remove path traversal attempts\r\n        .replace(/\\.\\.\\//g, '')\r\n        .replace(/\\.\\.\\\\/g, '')\r\n        // Remove leading slashes\r\n        .replace(/^[/\\\\]+/, '')\r\n        // Remove null bytes\r\n        .replace(/\\0/g, '')\r\n        // Only allow alphanumeric, dash, underscore\r\n        .replace(/[^a-zA-Z0-9\\-_]/g, '-')\r\n        // Limit length\r\n        .slice(0, 100);\r\n}\r\n\r\n/**\r\n * Validate file type by MIME and extension\r\n */\r\nexport function validateFileType(file: File): { valid: boolean; error?: string } {\r\n    // Check MIME type\r\n    if (!ALLOWED_IMAGE_TYPES.includes(file.type as any)) {\r\n        return {\r\n            valid: false,\r\n            error: `Invalid file type: ${file.type}. Allowed: ${ALLOWED_IMAGE_TYPES.join(', ')}`\r\n        };\r\n    }\r\n\r\n    // Check extension\r\n    const ext = path.extname(file.name).toLowerCase();\r\n    if (!ALLOWED_FILE_EXTENSIONS.includes(ext as any)) {\r\n        return {\r\n            valid: false,\r\n            error: `Invalid file extension: ${ext}. Allowed: ${ALLOWED_FILE_EXTENSIONS.join(', ')}`\r\n        };\r\n    }\r\n\r\n    // Check file size (max 10MB)\r\n    const MAX_SIZE = 10 * 1024 * 1024;\r\n    if (file.size > MAX_SIZE) {\r\n        return {\r\n            valid: false,\r\n            error: `File too large: ${(file.size / 1024 / 1024).toFixed(2)}MB. Max: 10MB`\r\n        };\r\n    }\r\n\r\n    return { valid: true };\r\n}\r\n\r\n/**\r\n * Sanitize string for safe output (basic XSS prevention)\r\n * For HTML content, use DOMPurify on client side\r\n */\r\nexport function sanitizeString(input: string): string {\r\n    if (!input || typeof input !== 'string') {\r\n        return '';\r\n    }\r\n\r\n    return input\r\n        // Remove null bytes\r\n        .replace(/\\0/g, '')\r\n        // Escape HTML entities\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        .replace(/\"/g, '&quot;')\r\n        .replace(/'/g, '&#x27;')\r\n        // Limit length\r\n        .slice(0, 10000);\r\n}\r\n\r\n/**\r\n * Validate course ID format\r\n */\r\nexport function validateCourseId(id: string): boolean {\r\n    if (!id || typeof id !== 'string') return false;\r\n    // Allow alphanumeric with dashes, 3-100 chars\r\n    return /^[a-zA-Z0-9\\-]{3,100}$/.test(id);\r\n}\r\n\r\n/**\r\n * Sanitize log message to prevent log injection\r\n */\r\nexport function sanitizeLogMessage(message: string): string {\r\n    if (!message || typeof message !== 'string') {\r\n        return '';\r\n    }\r\n\r\n    return message\r\n        // Remove ANSI escape codes\r\n        .replace(/\\x1b\\[[0-9;]*m/g, '')\r\n        // Remove control characters\r\n        .replace(/[\\x00-\\x1f\\x7f]/g, '')\r\n        // Limit length\r\n        .slice(0, 1000);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\auth\\cookies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\auth\\firebase-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\auth\\validateToken.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1706,1709],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1706,1709],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { initAdmin } from './firebase-admin';\r\n\r\nexport interface DecodedToken {\r\n    uid: string;\r\n    email: string | undefined;\r\n    role: string;\r\n    name?: string;\r\n}\r\n\r\n/**\r\n * Validate Firebase ID token server-side\r\n * Returns decoded token with user info and custom claims\r\n */\r\n/**\r\n * Validate Firebase ID token (stateless, short-lived)\r\n * Use this for initial login/signup verification\r\n */\r\nexport async function verifyIdToken(token: string): Promise<DecodedToken> {\r\n    try {\r\n        const admin = initAdmin();\r\n        const decodedToken = await admin.auth().verifyIdToken(token);\r\n\r\n        return {\r\n            uid: decodedToken.uid,\r\n            email: decodedToken.email,\r\n            role: (decodedToken.role as string) || 'user',\r\n            name: decodedToken.name as string | undefined,\r\n        };\r\n    } catch (error) {\r\n        console.error('âŒ ID Token validation failed:', error);\r\n        throw new Error('Invalid or expired ID token');\r\n    }\r\n}\r\n\r\n/**\r\n * Validate Firebase Session Cookie (stateful, long-lived)\r\n * Use this for authenticating API requests via cookies\r\n */\r\nexport async function verifySessionCookie(token: string): Promise<DecodedToken> {\r\n    try {\r\n        const admin = initAdmin();\r\n        // verifySessionCookie(sessionCookie, checkRevoked)\r\n        const decodedToken = await admin.auth().verifySessionCookie(token, true);\r\n\r\n        return {\r\n            uid: decodedToken.uid,\r\n            email: decodedToken.email,\r\n            role: (decodedToken.role as string) || 'user',\r\n            name: decodedToken.name as string | undefined,\r\n        };\r\n    } catch (error) {\r\n        // Don't log spam for expired sessions\r\n        if ((error as any)?.code !== 'auth/session-cookie-expired') {\r\n            console.error('âŒ Session validation failed:', error);\r\n        }\r\n        throw new Error('Invalid or expired session');\r\n    }\r\n}\r\n\r\n// Deprecated alias for backward compatibility (defaults to Session Cookie as that's the primary use case now)\r\nexport const validateFirebaseToken = verifySessionCookie;\r\n\r\n/**\r\n * Set custom claims for a user (e.g., admin role)\r\n * Use this in a one-time script or admin API endpoint\r\n */\r\nexport async function setUserClaims(uid: string, claims: { role: string }) {\r\n    try {\r\n        const admin = initAdmin();\r\n        await admin.auth().setCustomUserClaims(uid, claims);\r\n        console.log(`âœ… Custom claims set for user ${uid}:`, claims);\r\n    } catch (error) {\r\n        console.error('âŒ Failed to set custom claims:', error);\r\n        throw error;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\cms\\registry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\cms\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\constants\\demo-components.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\constants\\subscription.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[648,651],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[648,651],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Firebase Auth operations - Email/Password and Google Sign-In\r\nimport {\r\n    signInWithEmailAndPassword,\r\n    signOut,\r\n    onAuthStateChanged,\r\n    User as FirebaseAuthUser,\r\n    createUserWithEmailAndPassword,\r\n    signInWithPopup,\r\n    GoogleAuthProvider,\r\n} from \"firebase/auth\";\r\nimport { getFirebaseAuth, isFirebaseEnabled } from \"./config\";\r\n// import { User } from \"@/lib/types\"; // Removed\r\nimport { getUserProfile, createUserProfile } from \"./firestore\";\r\n\r\nexport interface User {\r\n    id: string;\r\n    email: string;\r\n    name: string;\r\n    role: \"admin\" | \"student\";\r\n    avatar?: string;\r\n    username?: string;\r\n    [key: string]: any;\r\n}\r\n\r\nexport const firebaseAuth = {\r\n    // Sign in with email/password\r\n    async signIn(email: string, password: string): Promise<User | null> {\r\n        if (!isFirebaseEnabled()) return null;\r\n\r\n        const auth = getFirebaseAuth();\r\n        if (!auth) return null;\r\n\r\n        const credential = await signInWithEmailAndPassword(auth, email, password);\r\n\r\n        // Get Firebase ID token\r\n        const idToken = await credential.user.getIdToken();\r\n\r\n        // Set httpOnly cookie via API (secure)\r\n        const tokenResponse = await fetch('/api/auth/set-token', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ idToken }),\r\n        });\r\n\r\n        if (!tokenResponse.ok) {\r\n            throw new Error('Failed to set auth token');\r\n        }\r\n\r\n        let profile = await getUserProfile(credential.user.uid);\r\n\r\n        // FALLBACK: Create profile if user exists in Firebase Auth but not Firestore\r\n        // This handles legacy/migrated users who have Auth but no Firestore profile\r\n        if (!profile) {\r\n            console.log('ðŸ“ Creating Firestore profile for legacy user:', credential.user.uid);\r\n            const newUser: User = {\r\n                id: credential.user.uid,\r\n                email: credential.user.email || email,\r\n                name: credential.user.displayName || email.split('@')[0],\r\n                role: \"student\",\r\n                enrolledCourses: [],\r\n                completedLessons: [],\r\n                createdAt: new Date().toISOString(),\r\n            };\r\n            await createUserProfile(newUser);\r\n            profile = newUser;\r\n        }\r\n\r\n        return profile;\r\n    },\r\n\r\n    // Sign up new user with email/password\r\n    async signUp(email: string, password: string, name: string): Promise<User> {\r\n        if (!isFirebaseEnabled()) {\r\n            throw new Error(\"Firebase is not enabled\");\r\n        }\r\n\r\n        const auth = getFirebaseAuth();\r\n        if (!auth) throw new Error(\"Firebase auth not initialized\");\r\n\r\n        const credential = await createUserWithEmailAndPassword(auth, email, password);\r\n\r\n        // Get Firebase ID token\r\n        const idToken = await credential.user.getIdToken();\r\n\r\n        // Set httpOnly cookie via API (secure)\r\n        const tokenResponse = await fetch('/api/auth/set-token', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ idToken }),\r\n        });\r\n\r\n        if (!tokenResponse.ok) {\r\n            console.error('Failed to set auth cookie during signup');\r\n            // Don't throw - user is created, just might need to login again if middleware is strict\r\n            // But ideally we want auto-login\r\n        }\r\n\r\n        const newUser: User = {\r\n            id: credential.user.uid,\r\n            email,\r\n            name,\r\n            role: \"student\",\r\n            enrolledCourses: [],\r\n            completedLessons: [],\r\n            createdAt: new Date().toISOString(),\r\n        };\r\n\r\n        await createUserProfile(newUser);\r\n        return newUser;\r\n    },\r\n\r\n    // Sign in with Google\r\n    async signInWithGoogle(): Promise<User | null> {\r\n        if (!isFirebaseEnabled()) return null;\r\n\r\n        const auth = getFirebaseAuth();\r\n        if (!auth) return null;\r\n\r\n        const provider = new GoogleAuthProvider();\r\n        const credential = await signInWithPopup(auth, provider);\r\n\r\n        // Get Firebase ID token\r\n        const idToken = await credential.user.getIdToken();\r\n\r\n        // Set httpOnly cookie via API (secure)\r\n        const tokenResponse = await fetch('/api/auth/set-token', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ idToken }),\r\n        });\r\n\r\n        if (!tokenResponse.ok) {\r\n            throw new Error('Failed to set auth token');\r\n        }\r\n\r\n        // Check if user exists\r\n        let profile = await getUserProfile(credential.user.uid);\r\n\r\n        // Google's photo URL (always get latest from Google)\r\n        const googleAvatar = credential.user.photoURL || undefined;\r\n\r\n        // If new user, create profile\r\n        if (!profile) {\r\n            const newUser: User = {\r\n                id: credential.user.uid,\r\n                email: credential.user.email || \"\",\r\n                name: credential.user.displayName || \"User\",\r\n                role: \"student\",\r\n                avatar: googleAvatar,\r\n                enrolledCourses: [],\r\n                completedLessons: [],\r\n                createdAt: new Date().toISOString(),\r\n            };\r\n\r\n            await createUserProfile(newUser);\r\n            profile = newUser;\r\n        } else {\r\n            // Existing user - ALWAYS update avatar from Google (it might have changed)\r\n            if (googleAvatar) {\r\n                profile = { ...profile, avatar: googleAvatar };\r\n                // Update in Firestore\r\n                const { updateUserProfile } = await import('./firestore');\r\n                await updateUserProfile(credential.user.uid, { avatar: googleAvatar });\r\n            }\r\n        }\r\n\r\n        // CRITICAL: Save profile with avatar to localStorage for immediate display\r\n        const { localCache } = await import('@/lib/storage/local-cache');\r\n        localCache.user.set(profile);\r\n\r\n        return profile;\r\n    },\r\n\r\n    // Sign out\r\n    async signOut(): Promise<void> {\r\n        if (!isFirebaseEnabled()) return;\r\n\r\n        const auth = getFirebaseAuth();\r\n        if (!auth) return;\r\n\r\n        await signOut(auth);\r\n    },\r\n\r\n    // Listen to auth state changes\r\n    onAuthChange(callback: (user: FirebaseAuthUser | null) => void) {\r\n        if (!isFirebaseEnabled()) return () => { };\r\n\r\n        const auth = getFirebaseAuth();\r\n        if (!auth) return () => { };\r\n\r\n        return onAuthStateChanged(auth, callback);\r\n    },\r\n\r\n    // Get current user\r\n    getCurrentUser(): FirebaseAuthUser | null {\r\n        if (!isFirebaseEnabled()) return null;\r\n\r\n        const auth = getFirebaseAuth();\r\n        return auth?.currentUser || null;\r\n    },\r\n\r\n    // Refresh the server-side session cookie using client SDK\r\n    // Call this when you get a 401 or want to extend the session\r\n    async refreshSession(): Promise<boolean> {\r\n        if (!isFirebaseEnabled()) return false;\r\n\r\n        const auth = getFirebaseAuth();\r\n        const user = auth?.currentUser;\r\n\r\n        if (!user) return false;\r\n\r\n        try {\r\n            // Force refresh ID token\r\n            const idToken = await user.getIdToken(true);\r\n\r\n            // Set new httpOnly cookie\r\n            const res = await fetch('/api/auth/set-token', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ idToken }),\r\n            });\r\n\r\n            return res.ok;\r\n        } catch (e) {\r\n            console.error(\"Failed to refresh session\", e);\r\n            return false;\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\coupon-operations.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3234,3237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3234,3237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4179,4182],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4179,4182],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":146,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4218,4221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4218,4221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Coupon Operations - Firestore CRUD for coupon management\r\n */\r\n\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { Coupon, SubscriptionTier } from '@/lib/constants/subscription';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\n\r\n// Firestore coupon document type\r\nexport interface CouponDoc extends Coupon {\r\n    id: string;\r\n    createdAt: FirebaseFirestore.Timestamp;\r\n    updatedAt: FirebaseFirestore.Timestamp;\r\n}\r\n\r\n// Input for creating/updating coupons\r\nexport interface CouponInput {\r\n    code: string;\r\n    discountPercent: number;\r\n    discountAmount?: number;\r\n    validFrom: string;\r\n    validUntil: string;\r\n    maxUses: number;\r\n    applicableTo: 'subscription' | 'course' | 'bundle' | 'all';\r\n    applicableTiers?: SubscriptionTier[];\r\n    minPurchaseAmount?: number;\r\n    isActive: boolean;\r\n}\r\n\r\nconst COLLECTION = 'coupons';\r\n\r\n/**\r\n * Get all coupons (admin only)\r\n */\r\nexport async function getCoupons(options?: {\r\n    activeOnly?: boolean;\r\n    limit?: number;\r\n}): Promise<CouponDoc[]> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n    let query: FirebaseFirestore.Query = db.collection(COLLECTION);\r\n\r\n    if (options?.activeOnly) {\r\n        query = query.where('isActive', '==', true);\r\n    }\r\n\r\n    query = query.orderBy('createdAt', 'desc');\r\n\r\n    if (options?.limit) {\r\n        query = query.limit(options.limit);\r\n    }\r\n\r\n    const snapshot = await query.get();\r\n\r\n    return snapshot.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data(),\r\n    } as CouponDoc));\r\n}\r\n\r\n/**\r\n * Get a coupon by its code (case-insensitive)\r\n */\r\nexport async function getCouponByCode(code: string): Promise<CouponDoc | null> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n\r\n    // Query by uppercase code for consistency\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('code', '==', code.toUpperCase())\r\n        .limit(1)\r\n        .get();\r\n\r\n    if (snapshot.empty) return null;\r\n\r\n    const doc = snapshot.docs[0];\r\n    return {\r\n        id: doc.id,\r\n        ...doc.data(),\r\n    } as CouponDoc;\r\n}\r\n\r\n/**\r\n * Get a coupon by ID\r\n */\r\nexport async function getCouponById(id: string): Promise<CouponDoc | null> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n    const doc = await db.collection(COLLECTION).doc(id).get();\r\n\r\n    if (!doc.exists) return null;\r\n\r\n    return {\r\n        id: doc.id,\r\n        ...doc.data(),\r\n    } as CouponDoc;\r\n}\r\n\r\n/**\r\n * Create a new coupon\r\n */\r\nexport async function createCoupon(data: CouponInput): Promise<CouponDoc> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n\r\n    // Check for duplicate code\r\n    const existing = await getCouponByCode(data.code);\r\n    if (existing) {\r\n        throw new Error(`Coupon code \"${data.code}\" already exists`);\r\n    }\r\n\r\n    // Filter out undefined values (Firestore doesn't accept undefined)\r\n    const couponData: any = {\r\n        code: data.code.toUpperCase(), // Store uppercase for consistency\r\n        discountPercent: data.discountPercent,\r\n        validFrom: data.validFrom,\r\n        validUntil: data.validUntil,\r\n        maxUses: data.maxUses,\r\n        applicableTo: data.applicableTo,\r\n        isActive: data.isActive,\r\n        usedCount: 0,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        updatedAt: FieldValue.serverTimestamp(),\r\n    };\r\n\r\n    // Only add optional fields if defined\r\n    if (data.discountAmount !== undefined) couponData.discountAmount = data.discountAmount;\r\n    if (data.applicableTiers) couponData.applicableTiers = data.applicableTiers;\r\n    if (data.minPurchaseAmount) couponData.minPurchaseAmount = data.minPurchaseAmount;\r\n\r\n    const docRef = await db.collection(COLLECTION).add(couponData);\r\n\r\n    return {\r\n        id: docRef.id,\r\n        ...couponData,\r\n        usedCount: 0,\r\n        createdAt: new Date() as any,\r\n        updatedAt: new Date() as any,\r\n    } as CouponDoc;\r\n}\r\n\r\n/**\r\n * Update an existing coupon\r\n */\r\nexport async function updateCoupon(id: string, data: Partial<CouponInput>): Promise<CouponDoc> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n    const docRef = db.collection(COLLECTION).doc(id);\r\n\r\n    const existing = await docRef.get();\r\n    if (!existing.exists) {\r\n        throw new Error('Coupon not found');\r\n    }\r\n\r\n    // If updating code, check for duplicates\r\n    if (data.code) {\r\n        const codeCheck = await getCouponByCode(data.code);\r\n        if (codeCheck && codeCheck.id !== id) {\r\n            throw new Error(`Coupon code \"${data.code}\" already exists`);\r\n        }\r\n        data.code = data.code.toUpperCase();\r\n    }\r\n\r\n    const updateData = {\r\n        ...data,\r\n        updatedAt: FieldValue.serverTimestamp(),\r\n    };\r\n\r\n    await docRef.update(updateData);\r\n\r\n    const updated = await docRef.get();\r\n    return {\r\n        id: updated.id,\r\n        ...updated.data(),\r\n    } as CouponDoc;\r\n}\r\n\r\n/**\r\n * Delete a coupon\r\n */\r\nexport async function deleteCoupon(id: string): Promise<void> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n    await db.collection(COLLECTION).doc(id).delete();\r\n}\r\n\r\n/**\r\n * Increment coupon usage count (called when coupon is redeemed)\r\n */\r\nexport async function incrementCouponUsage(id: string): Promise<void> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const db = admin.firestore();\r\n    await db.collection(COLLECTION).doc(id).update({\r\n        usedCount: FieldValue.increment(1),\r\n        updatedAt: FieldValue.serverTimestamp(),\r\n    });\r\n}\r\n\r\n/**\r\n * Validate a coupon for use\r\n */\r\nexport async function validateCoupon(\r\n    code: string,\r\n    purchaseType: 'subscription' | 'course' | 'bundle',\r\n    tier?: SubscriptionTier,\r\n    purchaseAmount?: number\r\n): Promise<{ valid: boolean; coupon?: CouponDoc; error?: string }> {\r\n    const coupon = await getCouponByCode(code);\r\n\r\n    if (!coupon) {\r\n        return { valid: false, error: 'Invalid coupon code' };\r\n    }\r\n\r\n    if (!coupon.isActive) {\r\n        return { valid: false, error: 'This coupon is no longer active' };\r\n    }\r\n\r\n    const now = new Date();\r\n    if (new Date(coupon.validFrom) > now) {\r\n        return { valid: false, error: 'This coupon is not yet valid' };\r\n    }\r\n    if (new Date(coupon.validUntil) < now) {\r\n        return { valid: false, error: 'This coupon has expired' };\r\n    }\r\n\r\n    if (coupon.usedCount >= coupon.maxUses) {\r\n        return { valid: false, error: 'This coupon has reached its usage limit' };\r\n    }\r\n\r\n    if (coupon.applicableTo !== 'all' && coupon.applicableTo !== purchaseType) {\r\n        return { valid: false, error: `This coupon is only valid for ${coupon.applicableTo} purchases` };\r\n    }\r\n\r\n    if (coupon.applicableTiers && tier && !coupon.applicableTiers.includes(tier)) {\r\n        return { valid: false, error: 'This coupon is not valid for your subscription tier' };\r\n    }\r\n\r\n    if (coupon.minPurchaseAmount && purchaseAmount && purchaseAmount < coupon.minPurchaseAmount) {\r\n        return { valid: false, error: `Minimum purchase amount is $${coupon.minPurchaseAmount}` };\r\n    }\r\n\r\n    return { valid: true, coupon };\r\n}\r\n\r\n/**\r\n * Seed default coupons (run once to migrate hardcoded coupons)\r\n */\r\nexport async function seedDefaultCoupons(): Promise<void> {\r\n    const admin = initAdmin();\r\n    if (!admin) throw new Error('Firebase Admin not initialized');\r\n\r\n    const defaultCoupons: CouponInput[] = [\r\n        {\r\n            code: 'WELCOME20',\r\n            discountPercent: 20,\r\n            validFrom: '2024-01-01',\r\n            validUntil: '2026-12-31',\r\n            maxUses: 1000,\r\n            applicableTo: 'all',\r\n            isActive: true,\r\n        },\r\n        {\r\n            code: 'NEWYEAR50',\r\n            discountPercent: 50,\r\n            validFrom: '2024-01-01',\r\n            validUntil: '2026-01-31',\r\n            maxUses: 100,\r\n            applicableTo: 'subscription',\r\n            isActive: true,\r\n        },\r\n        {\r\n            code: 'STUDENT25',\r\n            discountPercent: 25,\r\n            validFrom: '2024-01-01',\r\n            validUntil: '2026-12-31',\r\n            maxUses: 500,\r\n            applicableTo: 'all',\r\n            isActive: true,\r\n        },\r\n        {\r\n            code: 'VIP100',\r\n            discountPercent: 100,\r\n            validFrom: '2024-01-01',\r\n            validUntil: '2026-12-31',\r\n            maxUses: 10,\r\n            applicableTo: 'subscription',\r\n            applicableTiers: ['basic'],\r\n            isActive: true,\r\n        },\r\n    ];\r\n\r\n    for (const coupon of defaultCoupons) {\r\n        const existing = await getCouponByCode(coupon.code);\r\n        if (!existing) {\r\n            await createCoupon(coupon);\r\n            console.log(`âœ… Created coupon: ${coupon.code}`);\r\n        } else {\r\n            console.log(`â­ï¸ Coupon already exists: ${coupon.code}`);\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\firestore-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\firestore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\firebase\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\hooks\\useCourse.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\hooks\\useNotifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\hooks\\useTimeTracker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\hooks\\useTranslatedComponents.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1590,1593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1590,1593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1608,1611],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1608,1611],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3287,3290],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3287,3290],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3446,3449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3446,3449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'originalComponents' and 'textsToTranslate'. Either include them or remove the dependency array. If 'setTranslatedComponents' needs the current value of 'originalComponents', you can also switch to useReducer instead of useState and read 'originalComponents' in the reducer.","line":104,"column":8,"nodeType":"ArrayExpression","endLine":104,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [lessonId, language, componentsKey, originalComponents, textsToTranslate]","fix":{"range":[4170,4205],"text":"[lessonId, language, componentsKey, originalComponents, textsToTranslate]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useMemo } from \"react\";\r\nimport { useLanguage } from \"@/lib/i18n\";\r\nimport { Component } from \"@/lib/cms/types\";\r\nimport type { Language } from \"@/lib/i18n/translations\";\r\n\r\ninterface TranslatedComponents {\r\n    components: Component[];\r\n    loading: boolean;\r\n    error: string | null;\r\n}\r\n\r\n/**\r\n * Hook to translate CMS component content\r\n * Translates all text/header components in a lesson\r\n */\r\nexport function useTranslatedComponents(\r\n    lessonId: string,\r\n    originalComponents: Component[] | undefined\r\n): TranslatedComponents {\r\n    const { language } = useLanguage();\r\n    const [translatedComponents, setTranslatedComponents] = useState<Component[]>(originalComponents || []);\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // Create a stable key based on component structure (not object reference)\r\n    // This prevents infinite loops when parent re-renders with same data\r\n    const componentsKey = useMemo(() => {\r\n        if (!originalComponents) return '';\r\n        return originalComponents.map(c => `${c.id}:${c.type}`).join('|');\r\n    }, [originalComponents]);\r\n\r\n    // Extract all translatable text from components\r\n    const textsToTranslate = useMemo(() => {\r\n        if (!originalComponents) return [];\r\n        return originalComponents\r\n            .filter(c => c.type === \"header\" || c.type === \"text\")\r\n            .map(c => ({\r\n                id: c.id,\r\n                type: c.type,\r\n                text: c.type === \"header\" ? (c as any).text : (c as any).content\r\n            }));\r\n    }, [originalComponents]);\r\n\r\n    useEffect(() => {\r\n        // If English or no components, use originals\r\n        if (language === \"en\" || !originalComponents || originalComponents.length === 0) {\r\n            setTranslatedComponents(originalComponents || []);\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        const translateComponents = async () => {\r\n            setLoading(true);\r\n            setError(null);\r\n\r\n            try {\r\n                // Batch translate all texts\r\n                const response = await fetch(\"/api/translate/batch\", {\r\n                    method: \"POST\",\r\n                    headers: { \"Content-Type\": \"application/json\" },\r\n                    body: JSON.stringify({\r\n                        lessonId,\r\n                        texts: textsToTranslate.map(t => t.text),\r\n                        targetLanguage: language,\r\n                        sourceLanguage: \"en\" as Language,\r\n                    }),\r\n                });\r\n\r\n                if (!response.ok) {\r\n                    throw new Error(\"Translation failed\");\r\n                }\r\n\r\n                const data = await response.json();\r\n                const translatedTexts = data.translations as string[];\r\n\r\n                // Map translations back to components\r\n                const translated = originalComponents.map(comp => {\r\n                    const matchIdx = textsToTranslate.findIndex(t => t.id === comp.id);\r\n                    if (matchIdx === -1) return comp;\r\n\r\n                    if (comp.type === \"header\") {\r\n                        return { ...comp, text: translatedTexts[matchIdx] || (comp as any).text };\r\n                    } else if (comp.type === \"text\") {\r\n                        return { ...comp, content: translatedTexts[matchIdx] || (comp as any).content };\r\n                    }\r\n                    return comp;\r\n                });\r\n\r\n                setTranslatedComponents(translated);\r\n            } catch (err) {\r\n                console.error(\"Component translation error:\", err);\r\n                setError(err instanceof Error ? err.message : \"Translation failed\");\r\n                setTranslatedComponents(originalComponents); // Fallback to original\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        translateComponents();\r\n        // Use stable componentsKey instead of originalComponents object reference\r\n        // textsToTranslate is derived from originalComponents, so we don't need it here\r\n    }, [lessonId, language, componentsKey]);\r\n\r\n    return {\r\n        components: translatedComponents,\r\n        loading,\r\n        error,\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\hooks\\useTranslatedCourse.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Language' is defined but never used.","line":3,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useLanguage } from \"@/lib/i18n\";\r\nimport type { Language } from \"@/lib/i18n/translations\";\r\n\r\ninterface TranslatedCourse {\r\n    title: string;\r\n    description: string;\r\n    loading: boolean;\r\n    error: string | null;\r\n}\r\n\r\n/**\r\n * Hook to get translated course content\r\n * Automatically fetches translation when language changes\r\n */\r\nexport function useTranslatedCourse(\r\n    courseId: string,\r\n    originalTitle: string,\r\n    originalDescription: string\r\n): TranslatedCourse {\r\n    const { language } = useLanguage();\r\n    const [state, setState] = useState<TranslatedCourse>({\r\n        title: originalTitle,\r\n        description: originalDescription,\r\n        loading: false,\r\n        error: null,\r\n    });\r\n\r\n    useEffect(() => {\r\n        // If English, use original\r\n        if (language === \"en\") {\r\n            setState({\r\n                title: originalTitle,\r\n                description: originalDescription,\r\n                loading: false,\r\n                error: null,\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Fetch translation\r\n        const fetchTranslation = async () => {\r\n            setState((prev) => ({ ...prev, loading: true, error: null }));\r\n\r\n            try {\r\n                const response = await fetch(\"/api/translate/course\", {\r\n                    method: \"POST\",\r\n                    headers: { \"Content-Type\": \"application/json\" },\r\n                    body: JSON.stringify({\r\n                        courseId,\r\n                        title: originalTitle,\r\n                        description: originalDescription,\r\n                        targetLanguage: language,\r\n                        sourceLanguage: \"en\",\r\n                    }),\r\n                });\r\n\r\n                if (!response.ok) {\r\n                    throw new Error(\"Translation failed\");\r\n                }\r\n\r\n                const data = await response.json();\r\n                const { translation } = data;\r\n\r\n                setState({\r\n                    title: translation.title,\r\n                    description: translation.description,\r\n                    loading: false,\r\n                    error: null,\r\n                });\r\n            } catch (error) {\r\n                console.error(\"Translation error:\", error);\r\n                setState({\r\n                    title: originalTitle,\r\n                    description: originalDescription,\r\n                    loading: false,\r\n                    error: error instanceof Error ? error.message : \"Translation failed\",\r\n                });\r\n            }\r\n        };\r\n\r\n        fetchTranslation();\r\n    }, [courseId, originalTitle, originalDescription, language]);\r\n\r\n    return state;\r\n}\r\n\r\n/**\r\n * Hook to get translated lesson content\r\n */\r\nexport function useTranslatedLesson(\r\n    lessonId: string,\r\n    originalTitle: string,\r\n    originalContent: string\r\n): { title: string; content: string; loading: boolean; error: string | null } {\r\n    const { language } = useLanguage();\r\n    const [state, setState] = useState({\r\n        title: originalTitle,\r\n        content: originalContent,\r\n        loading: false,\r\n        error: null as string | null,\r\n    });\r\n\r\n    useEffect(() => {\r\n        // If English, use original\r\n        if (language === \"en\") {\r\n            setState({\r\n                title: originalTitle,\r\n                content: originalContent,\r\n                loading: false,\r\n                error: null,\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Fetch translation\r\n        const fetchTranslation = async () => {\r\n            setState((prev) => ({ ...prev, loading: true, error: null }));\r\n\r\n            try {\r\n                const response = await fetch(\"/api/translate/lesson\", {\r\n                    method: \"POST\",\r\n                    headers: { \"Content-Type\": \"application/json\" },\r\n                    body: JSON.stringify({\r\n                        lessonId,\r\n                        title: originalTitle,\r\n                        content: originalContent,\r\n                        targetLanguage: language,\r\n                        sourceLanguage: \"en\",\r\n                    }),\r\n                });\r\n\r\n                if (!response.ok) {\r\n                    throw new Error(\"Translation failed\");\r\n                }\r\n\r\n                const data = await response.json();\r\n                const { translation } = data;\r\n\r\n                setState({\r\n                    title: translation.title,\r\n                    content: translation.content,\r\n                    loading: false,\r\n                    error: null,\r\n                });\r\n            } catch (error) {\r\n                console.error(\"Translation error:\", error);\r\n                setState({\r\n                    title: originalTitle,\r\n                    content: originalContent,\r\n                    loading: false,\r\n                    error: error instanceof Error ? error.message : \"Translation failed\",\r\n                });\r\n            }\r\n        };\r\n\r\n        fetchTranslation();\r\n    }, [lessonId, originalTitle, originalContent, language]);\r\n\r\n    return state;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\hooks\\useUpload.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1508,1511],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1508,1511],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useCallback } from 'react';\r\n\r\ninterface UploadResult {\r\n    url: string;\r\n    width: number;\r\n    height: number;\r\n    size: number;\r\n    filename: string;\r\n}\r\n\r\ninterface UseUploadOptions {\r\n    type: 'avatar' | 'course' | 'lesson' | 'cms';\r\n    id?: string;\r\n    courseId?: string; // For lesson uploads\r\n    onSuccess?: (result: UploadResult) => void;\r\n    onError?: (error: string) => void;\r\n}\r\n\r\nexport function useUpload({ type, id, courseId, onSuccess, onError }: UseUploadOptions) {\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [progress, setProgress] = useState(0);\r\n\r\n    const upload = useCallback(async (file: File): Promise<UploadResult | null> => {\r\n        setIsUploading(true);\r\n        setProgress(10);\r\n\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('file', file);\r\n            formData.append('type', type);\r\n            if (id) formData.append('id', id);\r\n            if (courseId) formData.append('courseId', courseId);\r\n\r\n            setProgress(30);\r\n\r\n            const res = await fetch('/api/upload', {\r\n                method: 'POST',\r\n                body: formData\r\n            });\r\n\r\n            setProgress(80);\r\n\r\n            const data = await res.json();\r\n\r\n            if (data.error) {\r\n                throw new Error(data.error);\r\n            }\r\n\r\n            setProgress(100);\r\n            onSuccess?.(data);\r\n            return data;\r\n\r\n        } catch (error: any) {\r\n            onError?.(error.message);\r\n            return null;\r\n        } finally {\r\n            setIsUploading(false);\r\n            setTimeout(() => setProgress(0), 500);\r\n        }\r\n    }, [type, id, courseId, onSuccess, onError]);\r\n\r\n    return { upload, isUploading, progress };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\i18n\\LanguageProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\i18n\\LanguageSwitcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\i18n\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\i18n\\translations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\ml\\server.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[163,166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[163,166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { pipeline } from '@xenova/transformers';\r\nimport { Course } from '@/lib/types';\r\n\r\n// Singleton for model loading\r\nclass MLService {\r\n    static instance: any = null;\r\n    static modelName = 'Xenova/all-MiniLM-L6-v2';\r\n\r\n    static async getExtractor() {\r\n        if (!MLService.instance) {\r\n            console.log(\"Starting ML Model Load...\");\r\n            MLService.instance = await pipeline('feature-extraction', MLService.modelName);\r\n            console.log(\"ML Model Loaded!\");\r\n        }\r\n        return MLService.instance;\r\n    }\r\n}\r\n\r\n// Cosine Similarity\r\nfunction cosineSimilarity(a: number[], b: number[]) {\r\n    let dotProduct = 0;\r\n    let normA = 0;\r\n    let normB = 0;\r\n    for (let i = 0; i < a.length; i++) {\r\n        dotProduct += a[i] * b[i];\r\n        normA += a[i] * a[i];\r\n        normB += b[i] * b[i];\r\n    }\r\n    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));\r\n}\r\n\r\nexport async function getEmbeddings(text: string) {\r\n    const extractor = await MLService.getExtractor();\r\n    const output = await extractor(text, { pooling: 'mean', normalize: true });\r\n    return Array.from(output.data) as number[];\r\n}\r\n\r\nexport async function findSimilarCourses(courseId: string, allCourses: Course[]) {\r\n    // 1. Get current course\r\n    const currentCourse = allCourses.find(c => c.id === courseId);\r\n    if (!currentCourse) return [];\r\n\r\n    // 2. Compute embeddings (Real-world: Cache these!)\r\n    const currentEmbedding = await getEmbeddings(`${currentCourse.title} ${currentCourse.description} ${currentCourse.category}`);\r\n\r\n    // 3. Compare with others\r\n    const scores = await Promise.all(allCourses\r\n        .filter(c => c.id !== courseId)\r\n        .map(async (c) => {\r\n            const embedding = await getEmbeddings(`${c.title} ${c.description} ${c.category}`);\r\n            const score = cosineSimilarity(currentEmbedding, embedding);\r\n            return { ...c, score };\r\n        })\r\n    );\r\n\r\n    // 4. Sort and return top 3\r\n    return scores.sort((a, b) => b.score - a.score).slice(0, 3);\r\n}\r\n\r\nexport async function searchCourses(query: string, allCourses: Course[]) {\r\n    // 1. Get query embedding\r\n    const queryEmbedding = await getEmbeddings(query);\r\n\r\n    // 2. Compare with all courses\r\n    const scores = await Promise.all(allCourses.map(async (c) => {\r\n        // Create a rich context string for the course\r\n        const content = `${c.title} ${c.description} ${c.category} ${c.level}`;\r\n        const embedding = await getEmbeddings(content);\r\n        // Note: score property is added to the return object, not modifying the original type permanently for this scope\r\n        const score = cosineSimilarity(queryEmbedding, embedding);\r\n        return { ...c, score };\r\n    }));\r\n\r\n    return scores.sort((a, b) => b.score - a.score);\r\n}\r\n\r\n// RAG: In-memory vector store for active course sessions\r\n// Map<CourseID, { text: string; embedding: number[] }[]>\r\nconst courseVectorStore = new Map<string, { text: string; embedding: number[] }[]>();\r\n\r\nfunction chunkText(text: string, chunkSize: number = 500): string[] {\r\n    // Simple recursive chunking\r\n    if (text.length <= chunkSize) return [text];\r\n\r\n    // Split by paragraph\r\n    const paragraphs = text.split('\\n\\n');\r\n    const chunks: string[] = [];\r\n    let currentChunk = \"\";\r\n\r\n    for (const p of paragraphs) {\r\n        if (currentChunk.length + p.length > chunkSize) {\r\n            chunks.push(currentChunk);\r\n            currentChunk = p;\r\n        } else {\r\n            currentChunk += (currentChunk ? \"\\n\\n\" : \"\") + p;\r\n        }\r\n    }\r\n    if (currentChunk) chunks.push(currentChunk);\r\n\r\n    return chunks;\r\n}\r\n\r\nexport async function indexCourse(course: Course) {\r\n    if (courseVectorStore.has(course.id)) return; // Already indexed\r\n\r\n    console.log(`ðŸ“š Indexing course: ${course.title}`);\r\n    const chunks: { text: string; embedding: number[] }[] = [];\r\n\r\n    // Index Course Info\r\n    const infoText = `Course Title: ${course.title}\\nDescription: ${course.description}`;\r\n    chunks.push({\r\n        text: infoText,\r\n        embedding: await getEmbeddings(infoText)\r\n    });\r\n\r\n    // Index Lessons\r\n    if (course.lessons) {\r\n        for (const lesson of course.lessons) {\r\n            if (!lesson.content) continue;\r\n\r\n            const lessonContext = `Lesson: ${lesson.title}\\n`;\r\n            const textChunks = chunkText(lesson.content, 800);\r\n\r\n            for (const chunk of textChunks) {\r\n                const fullText = lessonContext + chunk;\r\n                chunks.push({\r\n                    text: fullText,\r\n                    embedding: await getEmbeddings(fullText)\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    courseVectorStore.set(course.id, chunks);\r\n    console.log(`âœ… Indexed ${chunks.length} chunks for ${course.id}`);\r\n}\r\n\r\nexport async function retrieveContext(query: string, courseId: string, topK: number = 3): Promise<string> {\r\n    const courseIndex = courseVectorStore.get(courseId);\r\n    if (!courseIndex) return \"\";\r\n\r\n    const queryEmbedding = await getEmbeddings(query);\r\n\r\n    const scoredChunks = courseIndex.map(chunk => ({\r\n        text: chunk.text,\r\n        score: cosineSimilarity(queryEmbedding, chunk.embedding)\r\n    }));\r\n\r\n    // Sort descending\r\n    scoredChunks.sort((a, b) => b.score - a.score);\r\n\r\n    // Return top K text joined\r\n    return scoredChunks.slice(0, topK).map(c => c.text).join(\"\\n\\n---\\n\\n\");\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\moderation\\content-filter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\payment\\card-validator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\security\\ddos-protection.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\server\\fileOperations.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'courseId' is assigned a value but never used.","line":52,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":52,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Course storage operations using Firebase Firestore\r\n// MIGRATED FROM LOCAL FILESYSTEM (fs) FOR VERCEL COMPATIBILITY\r\n\r\nimport { initAdmin } from '@/lib/auth/firebase-admin';\r\nimport { Course } from '@/lib/types';\r\n\r\n/**\r\n * Get Firestore instance from Admin SDK\r\n */\r\nfunction getAdminFirestore() {\r\n    try {\r\n        const admin = initAdmin();\r\n        return admin.firestore();\r\n    } catch (error) {\r\n        console.error('Failed to initialize Firebase Admin:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Get course by ID\r\nexport async function getCourse(id: string): Promise<Course | null> {\r\n    const db = getAdminFirestore();\r\n    if (!db) {\r\n        console.error('Firestore not available');\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        const docRef = db.collection('courses').doc(id);\r\n        const docSnap = await docRef.get();\r\n\r\n        if (!docSnap.exists) {\r\n            return null;\r\n        }\r\n\r\n        return { id, ...docSnap.data() } as Course;\r\n    } catch (error) {\r\n        console.error(`Error reading course ${id}:`, error);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Save course\r\nexport async function saveCourse(id: string, course: Course): Promise<boolean> {\r\n    const db = getAdminFirestore();\r\n    if (!db) {\r\n        console.error('Firestore not available');\r\n        return false;\r\n    }\r\n\r\n    try {\r\n        const { id: courseId, ...courseData } = course;\r\n        await db.collection('courses').doc(id).set({\r\n            ...courseData,\r\n            updatedAt: new Date().toISOString(),\r\n        }, { merge: true });\r\n        return true;\r\n    } catch (error) {\r\n        console.error(`Error saving course ${id}:`, error);\r\n        return false;\r\n    }\r\n}\r\n\r\n// List all courses\r\nexport async function listCourses(): Promise<Course[]> {\r\n    const db = getAdminFirestore();\r\n    if (!db) {\r\n        console.error('Firestore not available');\r\n        return [];\r\n    }\r\n\r\n    try {\r\n        const snapshot = await db.collection('courses').get();\r\n        const courses: Course[] = [];\r\n\r\n        snapshot.forEach(doc => {\r\n            courses.push({ id: doc.id, ...doc.data() } as Course);\r\n        });\r\n\r\n        return courses;\r\n    } catch (error) {\r\n        console.error('Error listing courses:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Delete course\r\nexport async function deleteCourse(id: string): Promise<boolean> {\r\n    const db = getAdminFirestore();\r\n    if (!db) {\r\n        console.error('Firestore not available');\r\n        return false;\r\n    }\r\n\r\n    try {\r\n        await db.collection('courses').doc(id).delete();\r\n        return true;\r\n    } catch (error) {\r\n        console.error(`Error deleting course ${id}:`, error);\r\n        return false;\r\n    }\r\n}\r\n\r\n// Legacy function - no longer needed but kept for compatibility\r\nexport function ensureDataDir() {\r\n    // No-op: Firestore doesn't need directory initialization\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\storage\\enrollment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\storage\\google-drive.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\storage\\hybrid-storage.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":97,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":97,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5504,5507],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5504,5507],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Hybrid storage: Auth operations with signup support\r\nimport { User } from \"@/lib/types\";\r\nimport { localCache } from \"./local-cache\";\r\nimport { syncManager } from \"./sync-manager\";\r\nimport { firebaseAuth } from \"../firebase/auth\";\r\nimport { isFirebaseEnabled } from \"../firebase/config\";\r\n\r\nexport const hybridStorage = {\r\n    // Authentication\r\n    auth: {\r\n        async login(email: string, password: string): Promise<User> {\r\n            if (!isFirebaseEnabled()) {\r\n                throw new Error(\"Firebase is not configured. Please set up Firebase authentication.\");\r\n            }\r\n\r\n            // ðŸ”’ CLEAR existing session before new login (enforce single session)\r\n            localCache.clear();\r\n            if (typeof window !== 'undefined') {\r\n                const { authCookies } = await import('../auth/cookies');\r\n                authCookies.clear();\r\n            }\r\n\r\n            const user = await firebaseAuth.signIn(email, password);\r\n            if (user) {\r\n                localCache.user.set(user);\r\n\r\n                // Set cookie for middleware access\r\n                if (typeof window !== 'undefined') {\r\n                    const { authCookies } = await import('../auth/cookies');\r\n                    authCookies.set(user);\r\n                }\r\n\r\n                await syncManager.pullProgress(user.id);\r\n                return user;\r\n            }\r\n            throw new Error(\"Login failed\");\r\n        },\r\n\r\n        async signup(email: string, password: string, name: string): Promise<User> {\r\n            if (isFirebaseEnabled()) {\r\n                const user = await firebaseAuth.signUp(email, password, name);\r\n\r\n                // Set user immediately\r\n                localCache.user.set(user);\r\n\r\n                // Set cookie for middleware access (consistency with login)\r\n                if (typeof window !== 'undefined') {\r\n                    const { authCookies } = await import('../auth/cookies');\r\n                    authCookies.set(user);\r\n                }\r\n\r\n                // Initialize empty progress (don't pull - new user has none)\r\n                const emptyProgress = {\r\n                    completedLessons: [],\r\n                    courseProgress: {},\r\n                    totalHours: 0,\r\n                    currentStreak: 0,\r\n                    lastActivity: new Date().toISOString(),\r\n                };\r\n                localCache.progress.set(emptyProgress);\r\n\r\n                return user;\r\n            }\r\n\r\n            // Local signup not supported - need Firebase\r\n            throw new Error(\"Signup requires Firebase. Please enable Firebase in settings.\");\r\n        },\r\n\r\n        async signInWithGoogle(): Promise<User> {\r\n            if (!isFirebaseEnabled()) {\r\n                throw new Error(\"Google sign-in requires Firebase\");\r\n            }\r\n\r\n            // ðŸ”’ CLEAR existing session before new login (enforce single session)\r\n            localCache.clear();\r\n            if (typeof window !== 'undefined') {\r\n                const { authCookies } = await import('../auth/cookies');\r\n                authCookies.clear();\r\n            }\r\n\r\n            const user = await firebaseAuth.signInWithGoogle();\r\n            if (!user) {\r\n                throw new Error(\"Google sign-in failed\");\r\n            }\r\n\r\n            localCache.user.set(user);\r\n\r\n            // Set cookie for middleware access\r\n            if (typeof window !== 'undefined') {\r\n                const { authCookies } = await import('../auth/cookies');\r\n                authCookies.set(user);\r\n            }\r\n\r\n            // Try to pull progress, but don't fail if it doesn't exist\r\n            try {\r\n                await syncManager.pullProgress(user.id);\r\n            } catch (error) {\r\n                // First-time Google user - initialize empty progress\r\n                const emptyProgress = {\r\n                    completedLessons: [],\r\n                    courseProgress: {},\r\n                    totalHours: 0,\r\n                    currentStreak: 0,\r\n                    lastActivity: new Date().toISOString(),\r\n                };\r\n                localCache.progress.set(emptyProgress);\r\n            }\r\n\r\n            return user;\r\n        },\r\n\r\n        async logout(): Promise<void> {\r\n            // Sync with timeout - don't block logout if sync hangs\r\n            try {\r\n                await Promise.race([\r\n                    syncManager.syncNow(),\r\n                    new Promise((_, reject) => setTimeout(() => reject(new Error('Sync timeout')), 3000))\r\n                ]);\r\n            } catch (e) {\r\n                console.warn('Logout sync skipped:', e);\r\n            }\r\n\r\n            localCache.clear();\r\n\r\n            // Clear httpOnly cookie via API\r\n            try {\r\n                await fetch('/api/auth/clear-token', { method: 'POST' });\r\n            } catch (error) {\r\n                console.error('Failed to clear token cookie:', error);\r\n            }\r\n\r\n            // Clear client-side cookie (legacy)\r\n            if (typeof window !== 'undefined') {\r\n                const { authCookies } = await import('../auth/cookies');\r\n                authCookies.clear();\r\n            }\r\n\r\n            if (isFirebaseEnabled()) {\r\n                await firebaseAuth.signOut();\r\n            }\r\n\r\n            syncManager.cleanup();\r\n        },\r\n\r\n        getSession(): User | null {\r\n            return localCache.user.get() as User | null;\r\n        },\r\n    },\r\n\r\n    // Progress tracking\r\n    progress: {\r\n        get(): any {\r\n            const cached = localCache.progress.get();\r\n            if (cached) return cached;\r\n\r\n            return {\r\n                completedLessons: [],\r\n                courseProgress: {},\r\n                totalHours: 0,\r\n                currentStreak: 0,\r\n                lastActivity: new Date().toISOString(),\r\n                totalTimeMs: 0,\r\n            };\r\n        },\r\n\r\n        completeLesson(userId: string, lessonId: string, courseId: string, totalLessons: number, forceProgress?: number): void {\r\n            const progress = this.get();\r\n\r\n            // Ensure completedLessons is an array (defensive check for corrupted Firebase data)\r\n            progress.completedLessons = progress.completedLessons || [];\r\n            if (!progress.completedLessons.includes(lessonId)) {\r\n                progress.completedLessons.push(lessonId);\r\n            }\r\n\r\n            if (forceProgress !== undefined) {\r\n                progress.courseProgress[courseId] = forceProgress;\r\n            } else {\r\n                const completedInCourse = (progress.completedLessons || []).filter((id: string) =>\r\n                    id.toLowerCase().startsWith(courseId.toLowerCase())\r\n                ).length;\r\n\r\n                const validTotal = Math.max(1, totalLessons);\r\n                progress.courseProgress[courseId] = Math.round((completedInCourse / validTotal) * 100);\r\n            }\r\n            progress.lastActivity = new Date().toISOString();\r\n\r\n            localCache.progress.set(progress);\r\n\r\n            if (isFirebaseEnabled()) {\r\n                syncManager.scheduleSync({\r\n                    type: \"progress\",\r\n                    userId,\r\n                    data: progress,\r\n                    timestamp: Date.now(),\r\n                });\r\n            }\r\n        },\r\n\r\n        isLessonCompleted(lessonId: string): boolean {\r\n            const progress = this.get();\r\n            return (progress.completedLessons || []).includes(lessonId);\r\n        },\r\n\r\n        getCourseProgress(courseId: string): number {\r\n            const progress = this.get();\r\n            return progress.courseProgress[courseId] || 0;\r\n        },\r\n\r\n        trackTime(userId: string, ms: number): void {\r\n            const progress = this.get();\r\n\r\n            progress.totalTimeMs = (progress.totalTimeMs || 0) + ms;\r\n            // Update totalHours for backward compatibility/display\r\n            progress.totalHours = Math.round((progress.totalTimeMs / (1000 * 60 * 60)) * 10) / 10;\r\n\r\n            progress.lastActivity = new Date().toISOString();\r\n\r\n            localCache.progress.set(progress);\r\n\r\n            if (isFirebaseEnabled()) {\r\n                syncManager.scheduleSync({\r\n                    type: \"progress\",\r\n                    userId,\r\n                    data: progress,\r\n                    timestamp: Date.now(),\r\n                });\r\n            }\r\n        },\r\n    },\r\n\r\n    // User profile\r\n    profile: {\r\n        async update(userId: string, updates: Partial<User>): Promise<void> {\r\n            const user = localCache.user.get();\r\n            if (user) {\r\n                const updated = { ...user, ...updates };\r\n                localCache.user.set(updated);\r\n            }\r\n\r\n            if (isFirebaseEnabled()) {\r\n                syncManager.scheduleSync({\r\n                    type: \"profile\",\r\n                    userId,\r\n                    data: updates,\r\n                    timestamp: Date.now(),\r\n                });\r\n            }\r\n        },\r\n    },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\storage\\local-cache.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2474,2477],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2474,2477],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2729,2732],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2729,2732],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2781,2784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2781,2784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2952,2955],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2952,2955],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3048,3051],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3048,3051],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// localStorage cache operations\r\nimport { User } from \"@/lib/types\";\r\nconst CACHE_KEYS = {\r\n    USER: \"gakuen_user_cache\",\r\n    PROGRESS: \"gakuen_progress_cache\",\r\n    COURSES: \"gakuen_courses_cache\",\r\n    SYNC_QUEUE: \"gakuen_sync_queue\",\r\n} as const;\r\n\r\ninterface CacheEntry<T> {\r\n    data: T;\r\n    timestamp: number;\r\n    ttl?: number; // Time to live in ms\r\n}\r\n\r\nexport const localCache = {\r\n    // Set cache with optional TTL\r\n    set<T>(key: string, data: T, ttl?: number): void {\r\n        if (typeof window === 'undefined') return;\r\n        try {\r\n            const entry: CacheEntry<T> = {\r\n                data,\r\n                timestamp: Date.now(),\r\n                ttl,\r\n            };\r\n            localStorage.setItem(key, JSON.stringify(entry));\r\n        } catch (error) {\r\n            console.error(\"Cache set error:\", error);\r\n        }\r\n    },\r\n\r\n    // Get cache if not expired\r\n    get<T>(key: string): T | null {\r\n        if (typeof window === 'undefined') return null;\r\n        try {\r\n            const stored = localStorage.getItem(key);\r\n            if (!stored) return null;\r\n\r\n            const entry: CacheEntry<T> = JSON.parse(stored);\r\n\r\n            // Check if expired\r\n            if (entry.ttl && Date.now() - entry.timestamp > entry.ttl) {\r\n                this.remove(key);\r\n                return null;\r\n            }\r\n\r\n            return entry.data;\r\n        } catch (error) {\r\n            console.error(\"Cache get error:\", error);\r\n            return null;\r\n        }\r\n    },\r\n\r\n    // Remove cache entry\r\n    remove(key: string): void {\r\n        if (typeof window === 'undefined') return;\r\n        try {\r\n            localStorage.removeItem(key);\r\n        } catch (error) {\r\n            console.error(\"Cache remove error:\", error);\r\n        }\r\n    },\r\n\r\n    // Clear all cache\r\n    clear(): void {\r\n        if (typeof window === 'undefined') return;\r\n        try {\r\n            Object.values(CACHE_KEYS).forEach(key => {\r\n                localStorage.removeItem(key);\r\n            });\r\n        } catch (error) {\r\n            console.error(\"Cache clear error:\", error);\r\n        }\r\n    },\r\n\r\n    // User cache operations\r\n    user: {\r\n        set: (data: User) => localCache.set(CACHE_KEYS.USER, data, 24 * 60 * 60 * 1000), // 24h TTL\r\n        get: () => localCache.get<User>(CACHE_KEYS.USER),\r\n        remove: () => localCache.remove(CACHE_KEYS.USER),\r\n    },\r\n\r\n    // Progress cache operations\r\n    progress: {\r\n        set: (data: any) => localCache.set(CACHE_KEYS.PROGRESS, data),\r\n        get: () => localCache.get(CACHE_KEYS.PROGRESS),\r\n        remove: () => localCache.remove(CACHE_KEYS.PROGRESS),\r\n    },\r\n\r\n    // Sync queue operations\r\n    syncQueue: {\r\n        add: (operation: any) => {\r\n            const queue = localCache.get<any[]>(CACHE_KEYS.SYNC_QUEUE) || [];\r\n            queue.push(operation);\r\n            localCache.set(CACHE_KEYS.SYNC_QUEUE, queue);\r\n        },\r\n        set: (operations: any[]) => localCache.set(CACHE_KEYS.SYNC_QUEUE, operations),\r\n        get: () => localCache.get<any[]>(CACHE_KEYS.SYNC_QUEUE) || [],\r\n        clear: () => localCache.remove(CACHE_KEYS.SYNC_QUEUE),\r\n    },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\storage\\sync-manager.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[593,596],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[593,596],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Sync manager: Handles syncing between local and Firebase\r\n// OPTIMIZED FOR VERCEL FREE TIER:\r\n// - 8s timeout on all Firebase operations (Vercel has 10s limit)\r\n// - 60s sync interval to reduce function invocations\r\n// - Batch size limits to prevent timeouts\r\n// - Lazy initialization for cold starts\r\n\r\nimport { localCache } from \"./local-cache\";\r\nimport { updateProgress, getProgress, updateUserProfile } from \"../firebase/firestore\";\r\nimport { isFirebaseEnabled } from \"../firebase/config\";\r\n\r\ninterface SyncOperation {\r\n    type: \"progress\" | \"profile\";\r\n    userId: string;\r\n    data: any;\r\n    timestamp: number;\r\n}\r\n\r\n// Vercel-optimized constants\r\nconst VERCEL_FUNCTION_TIMEOUT = 8000; // 8s (Vercel free tier has 10s limit)\r\nconst SYNC_DELAY = 60000; // 60s - reduced frequency for serverless\r\nconst MAX_BATCH_SIZE = 10; // Limit operations per sync cycle\r\n\r\n/**\r\n * Wraps a promise with a timeout for Vercel serverless compatibility\r\n */\r\nfunction withTimeout<T>(promise: Promise<T>, ms: number, operation: string): Promise<T> {\r\n    return Promise.race([\r\n        promise,\r\n        new Promise<T>((_, reject) =>\r\n            setTimeout(() => reject(new Error(`${operation} timed out after ${ms}ms`)), ms)\r\n        )\r\n    ]);\r\n}\r\n\r\nclass SyncManager {\r\n    private syncTimeout: ReturnType<typeof setTimeout> | null = null;\r\n    private isSyncing = false;\r\n    private initialized = false;\r\n\r\n    // Lazy initialization for cold start optimization\r\n    private ensureInitialized(): void {\r\n        if (this.initialized) return;\r\n        this.initialized = true;\r\n        // Any one-time setup can go here\r\n    }\r\n\r\n    // Schedule a sync operation (debounced)\r\n    scheduleSync(operation: SyncOperation): void {\r\n        this.ensureInitialized();\r\n\r\n        // Add to queue\r\n        localCache.syncQueue.add(operation);\r\n\r\n        // Clear existing timeout\r\n        if (this.syncTimeout) {\r\n            clearTimeout(this.syncTimeout);\r\n        }\r\n\r\n        // Schedule new sync with increased delay for Vercel\r\n        this.syncTimeout = setTimeout(() => {\r\n            this.syncNow();\r\n        }, SYNC_DELAY);\r\n    }\r\n\r\n    // Force immediate sync with timeout safeguards\r\n    async syncNow(): Promise<void> {\r\n        if (!isFirebaseEnabled() || this.isSyncing) return;\r\n\r\n        this.isSyncing = true;\r\n        const queue = localCache.syncQueue.get();\r\n\r\n        // Limit batch size to prevent timeouts\r\n        const limitedQueue = queue.slice(0, MAX_BATCH_SIZE);\r\n        const remaining = queue.slice(MAX_BATCH_SIZE);\r\n\r\n        try {\r\n            // Group operations by type and userId\r\n            const grouped = this.groupOperations(limitedQueue);\r\n\r\n            // Sync each group with timeout protection\r\n            for (const [key, operations] of Object.entries(grouped)) {\r\n                try {\r\n                    await withTimeout(\r\n                        this.syncGroup(operations),\r\n                        VERCEL_FUNCTION_TIMEOUT,\r\n                        `Sync ${key}`\r\n                    );\r\n                } catch (error) {\r\n                    console.warn(`Sync group ${key} failed:`, error);\r\n                    // Continue with other groups, don't fail entire sync\r\n                }\r\n            }\r\n\r\n            // Clear synced items, keep remaining for next cycle\r\n            if (remaining.length > 0) {\r\n                localCache.syncQueue.set(remaining);\r\n                // Schedule next batch\r\n                this.syncTimeout = setTimeout(() => this.syncNow(), 5000);\r\n            } else {\r\n                localCache.syncQueue.clear();\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Sync error:\", error);\r\n            // Keep queue for retry\r\n        } finally {\r\n            this.isSyncing = false;\r\n        }\r\n    }\r\n\r\n    private groupOperations(operations: SyncOperation[]): Record<string, SyncOperation[]> {\r\n        const grouped: Record<string, SyncOperation[]> = {};\r\n\r\n        operations.forEach(op => {\r\n            const key = `${op.type}-${op.userId}`;\r\n            if (!grouped[key]) grouped[key] = [];\r\n            grouped[key].push(op);\r\n        });\r\n\r\n        return grouped;\r\n    }\r\n\r\n    private async syncGroup(operations: SyncOperation[]): Promise<void> {\r\n        if (operations.length === 0) return;\r\n\r\n        const latest = operations[operations.length - 1]; // Get most recent\r\n\r\n        try {\r\n            if (latest.type === \"progress\") {\r\n                await updateProgress(latest.userId, latest.data);\r\n            } else if (latest.type === \"profile\") {\r\n                await updateUserProfile(latest.userId, latest.data);\r\n            }\r\n        } catch (error) {\r\n            console.error(`Error syncing ${latest.type}:`, error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // Sync progress from Firebase to local cache (with timeout)\r\n    async pullProgress(userId: string): Promise<void> {\r\n        if (!isFirebaseEnabled()) return;\r\n\r\n        try {\r\n            const firebaseProgress = await withTimeout(\r\n                getProgress(userId),\r\n                VERCEL_FUNCTION_TIMEOUT,\r\n                \"pullProgress\"\r\n            );\r\n            if (firebaseProgress) {\r\n                localCache.progress.set(firebaseProgress);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error pulling progress:\", error);\r\n            // Don't throw - allow app to continue with local cache\r\n        }\r\n    }\r\n\r\n    // Clean up on logout\r\n    cleanup(): void {\r\n        if (this.syncTimeout) {\r\n            clearTimeout(this.syncTimeout);\r\n            this.syncTimeout = null;\r\n        }\r\n        this.initialized = false;\r\n    }\r\n}\r\n\r\nexport const syncManager = new SyncManager();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\store\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\store\\progress.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\types\\user.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\utils\\network.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[267,270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[267,270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[354,357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[354,357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[479,482],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[479,482],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3704,3707],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3704,3707],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":129,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3908,3911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3908,3911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":129,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3918,3921],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3918,3921],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4300,4303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4300,4303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4310,4313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4310,4313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":169,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4954,4957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4954,4957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":170,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4997,5000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4997,5000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":174,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5112,5115],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5112,5115],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":194,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5832,5835],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5832,5835],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Fetch with retry, timeout, and offline fallback\r\n * Designed for unreliable networks and low-end devices\r\n */\r\n\r\ninterface FetchOptions extends RequestInit {\r\n    timeout?: number;\r\n    retries?: number;\r\n    retryDelay?: number;\r\n    offlineFallback?: () => any;\r\n}\r\n\r\n// Cache for offline support\r\nconst responseCache = new Map<string, { data: any; timestamp: number }>();\r\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\r\n\r\nexport async function resilientFetch<T = any>(\r\n    url: string,\r\n    options: FetchOptions = {}\r\n): Promise<T> {\r\n    const {\r\n        timeout = 10000,\r\n        retries = 3,\r\n        retryDelay = 1000,\r\n        offlineFallback,\r\n        ...fetchOptions\r\n    } = options;\r\n\r\n    // Check if offline\r\n    if (typeof navigator !== 'undefined' && !navigator.onLine) {\r\n        // Try cache first\r\n        const cached = responseCache.get(url);\r\n        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\r\n            console.log('ðŸ“¦ Returning cached response (offline):', url);\r\n            return cached.data;\r\n        }\r\n\r\n        // Use fallback if available\r\n        if (offlineFallback) {\r\n            console.log('ðŸ“´ Offline, using fallback for:', url);\r\n            return offlineFallback();\r\n        }\r\n\r\n        throw new Error('No network connection and no cached data available');\r\n    }\r\n\r\n    let lastError: Error = new Error('Unknown error');\r\n\r\n    for (let attempt = 0; attempt < retries; attempt++) {\r\n        try {\r\n            const controller = new AbortController();\r\n            const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n            const response = await fetch(url, {\r\n                ...fetchOptions,\r\n                signal: controller.signal,\r\n            });\r\n\r\n            clearTimeout(timeoutId);\r\n\r\n            if (!response.ok) {\r\n                throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n\r\n            // Cache successful responses\r\n            responseCache.set(url, { data, timestamp: Date.now() });\r\n\r\n            return data;\r\n        } catch (error) {\r\n            lastError = error as Error;\r\n\r\n            // Don't retry on abort (timeout) or 4xx errors\r\n            if (lastError.name === 'AbortError') {\r\n                console.warn(`â±ï¸ Request timeout (${timeout}ms):`, url);\r\n            } else {\r\n                console.warn(`ðŸ”„ Retry ${attempt + 1}/${retries}:`, url, lastError.message);\r\n            }\r\n\r\n            // Wait before retry (exponential backoff)\r\n            if (attempt < retries - 1) {\r\n                await new Promise(resolve =>\r\n                    setTimeout(resolve, retryDelay * Math.pow(2, attempt))\r\n                );\r\n            }\r\n        }\r\n    }\r\n\r\n    // All retries failed, try cache\r\n    const cached = responseCache.get(url);\r\n    if (cached) {\r\n        console.log('ðŸ“¦ Returning stale cache after failures:', url);\r\n        return cached.data;\r\n    }\r\n\r\n    throw lastError;\r\n}\r\n\r\n/**\r\n * Prefetch resources for better perceived performance\r\n */\r\nexport function prefetch(urls: string[]) {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    // Use requestIdleCallback for non-blocking prefetch\r\n    const doPreload = () => {\r\n        urls.forEach(url => {\r\n            const link = document.createElement('link');\r\n            link.rel = 'prefetch';\r\n            link.href = url;\r\n            link.as = url.endsWith('.js') ? 'script' :\r\n                url.endsWith('.css') ? 'style' :\r\n                    'fetch';\r\n            document.head.appendChild(link);\r\n        });\r\n    };\r\n\r\n    if ('requestIdleCallback' in window) {\r\n        (window as any).requestIdleCallback(doPreload);\r\n    } else {\r\n        setTimeout(doPreload, 1000);\r\n    }\r\n}\r\n\r\n/**\r\n * Debounce function for expensive operations\r\n */\r\nexport function debounce<T extends (...args: any[]) => any>(\r\n    fn: T,\r\n    delay: number\r\n): (...args: Parameters<T>) => void {\r\n    let timeoutId: ReturnType<typeof setTimeout>;\r\n\r\n    return (...args: Parameters<T>) => {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = setTimeout(() => fn(...args), delay);\r\n    };\r\n}\r\n\r\n/**\r\n * Throttle function for scroll/resize handlers\r\n */\r\nexport function throttle<T extends (...args: any[]) => any>(\r\n    fn: T,\r\n    limit: number\r\n): (...args: Parameters<T>) => void {\r\n    let inThrottle = false;\r\n\r\n    return (...args: Parameters<T>) => {\r\n        if (!inThrottle) {\r\n            fn(...args);\r\n            inThrottle = true;\r\n            setTimeout(() => { inThrottle = false; }, limit);\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Detect if device is low-end\r\n */\r\nexport function isLowEndDevice(): boolean {\r\n    if (typeof window === 'undefined') return false;\r\n\r\n    // Check for low CPU cores\r\n    const lowCores = (navigator.hardwareConcurrency || 4) <= 2;\r\n\r\n    // Check for low memory (Chrome only)\r\n    const lowMemory = (navigator as any).deviceMemory\r\n        ? (navigator as any).deviceMemory <= 2\r\n        : false;\r\n\r\n    // Check for slow connection\r\n    const connection = (navigator as any).connection;\r\n    const slowConnection = connection\r\n        ? connection.effectiveType === '2g' || connection.effectiveType === 'slow-2g'\r\n        : false;\r\n\r\n    // Check for reduced motion preference\r\n    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\r\n\r\n    // Check for data saver\r\n    const dataSaver = connection?.saveData === true;\r\n\r\n    return lowCores || lowMemory || slowConnection || prefersReducedMotion || dataSaver;\r\n}\r\n\r\n/**\r\n * Get appropriate image quality based on device/network\r\n */\r\nexport function getOptimalImageQuality(): 'low' | 'medium' | 'high' {\r\n    if (typeof window === 'undefined') return 'high';\r\n\r\n    const connection = (navigator as any).connection;\r\n\r\n    if (!connection) return 'high';\r\n\r\n    if (connection.saveData) return 'low';\r\n\r\n    switch (connection.effectiveType) {\r\n        case 'slow-2g':\r\n        case '2g':\r\n            return 'low';\r\n        case '3g':\r\n            return 'medium';\r\n        default:\r\n            return 'high';\r\n    }\r\n}\r\n\r\n/**\r\n * Request animation frame with fallback\r\n */\r\nexport function raf(callback: FrameRequestCallback): number {\r\n    if (typeof window === 'undefined') return 0;\r\n\r\n    return window.requestAnimationFrame?.(callback) ||\r\n        window.setTimeout(() => callback(Date.now()), 16);\r\n}\r\n\r\n/**\r\n * Cancel animation frame with fallback\r\n */\r\nexport function cancelRaf(id: number): void {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    if (window.cancelAnimationFrame) {\r\n        window.cancelAnimationFrame(id);\r\n    } else {\r\n        window.clearTimeout(id);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\utils\\sanitize.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\lib\\validation\\schemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\proxy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\debug-firebase-admin.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\set-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\test-base64-image.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\test-content-moderation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\test-drive-folders.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\test-google-drive.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\scripts\\test-image-upload.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Xiao Fan\\Coding\\gakuen\\vitest.setup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
